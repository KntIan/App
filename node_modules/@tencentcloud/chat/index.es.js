"use strict";const e={SDK_READY:"sdkStateReady",SDK_NOT_READY:"sdkStateNotReady",SDK_DESTROY:"sdkDestroy",MESSAGE_RECEIVED:"onMessageReceived",ROOM_CUSTOM_DATA_RECEIVED:"onRoomCustomDataReceived",MESSAGE_MODIFIED:"onMessageModified",MESSAGE_REVOKED:"onMessageRevoked",MESSAGE_READ_BY_PEER:"onMessageReadByPeer",MESSAGE_READ_RECEIPT_RECEIVED:"onMessageReadReceiptReceived",MESSAGE_EXTENSIONS_UPDATED:"onMessageExtensionsUpdated",MESSAGE_EXTENSIONS_DELETED:"onMessageExtensionsDeleted",MESSAGE_REACTIONS_UPDATED:"onMessageReactionsUpdated",CONVERSATION_LIST_UPDATED:"onConversationListUpdated",TOTAL_UNREAD_MESSAGE_COUNT_UPDATED:"onTotalUnreadMessageCountUpdated",CONVERSATION_GROUP_LIST_UPDATED:"onConversationGroupListUpdated",CONVERSATION_IN_GROUP_UPDATED:"onConversationInGroupUpdated",GROUP_LIST_UPDATED:"onGroupListUpdated",GROUP_ATTRIBUTES_UPDATED:"groupAttributesUpdated",GROUP_COUNTER_UPDATED:"onGroupCounterUpdated",TOPIC_CREATED:"onTopicCreated",TOPIC_DELETED:"onTopicDeleted",TOPIC_UPDATED:"onTopicUpdated",PROFILE_UPDATED:"onProfileUpdated",USER_STATUS_UPDATED:"onUserStatusUpdated",BLACKLIST_UPDATED:"blacklistUpdated",FRIEND_LIST_UPDATED:"onFriendListUpdated",FRIEND_GROUP_LIST_UPDATED:"onFriendGroupListUpdated",FRIEND_APPLICATION_LIST_UPDATED:"onFriendApplicationListUpdated",MY_FOLLOWERS_LIST_UPDATED:"onMyFollowersListUpdated",MY_FOLLOWING_LIST_UPDATED:"onMyFollowingListUpdated",MUTUAL_FOLLOWERS_LIST_UPDATED:"onMutualFollowersListUpdated",KICKED_OUT:"kickedOut",ERROR:"error",NET_STATE_CHANGE:"netStateChange",ALL_RECEIVE_MESSAGE_OPT_UPDATED:"onAllReceiveMessageOptUpdated"},t={MSG_TEXT:"TIMTextElem",MSG_IMAGE:"TIMImageElem",MSG_SOUND:"TIMSoundElem",MSG_AUDIO:"TIMSoundElem",MSG_FILE:"TIMFileElem",MSG_FACE:"TIMFaceElem",MSG_VIDEO:"TIMVideoFileElem",MSG_GEO:"TIMLocationElem",MSG_LOCATION:"TIMLocationElem",MSG_GRP_TIP:"TIMGroupTipElem",MSG_GRP_SYS_NOTICE:"TIMGroupSystemNoticeElem",MSG_CUSTOM:"TIMCustomElem",MSG_MERGER:"TIMRelayElem",MSG_PRIORITY_HIGH:"High",MSG_PRIORITY_NORMAL:"Normal",MSG_PRIORITY_LOW:"Low",MSG_PRIORITY_LOWEST:"Lowest",CONV_C2C:"C2C",CONV_GROUP:"GROUP",CONV_TOPIC:"TOPIC",CONV_SYSTEM:"@TIM#SYSTEM",CONV_AT_ME:1,CONV_AT_ALL:2,CONV_AT_ALL_AT_ME:3,CONV_MARK_TYPE_STAR:1,CONV_MARK_TYPE_UNREAD:2,CONV_MARK_TYPE_FOLD:4,CONV_MARK_TYPE_HIDE:8,GRP_PRIVATE:"Private",GRP_WORK:"Private",GRP_PUBLIC:"Public",GRP_CHATROOM:"ChatRoom",GRP_MEETING:"ChatRoom",GRP_AVCHATROOM:"AVChatRoom",GRP_COMMUNITY:"Community",GRP_ROOM:"Room",GRP_LIVE:"Live",GRP_MBR_ROLE_OWNER:"Owner",GRP_MBR_ROLE_ADMIN:"Admin",GRP_MBR_ROLE_MEMBER:"Member",GRP_MBR_ROLE_CUSTOM:"Custom",GRP_TIP_MBR_JOIN:1,GRP_TIP_MBR_QUIT:2,GRP_TIP_MBR_KICKED_OUT:3,GRP_TIP_MBR_SET_ADMIN:4,GRP_TIP_MBR_CANCELED_ADMIN:5,GRP_TIP_GRP_PROFILE_UPDATED:6,GRP_TIP_MBR_PROFILE_UPDATED:7,GRP_TIP_BAN_AVCHATROOM_MEMBER:10,GRP_TIP_UNBAN_AVCHATROOM_MEMBER:11,MSG_REMIND_ACPT_AND_NOTE:"AcceptAndNotify",MSG_REMIND_ACPT_NOT_NOTE:"AcceptNotNotify",MSG_REMIND_DISCARD:"Discard",RECEIVE_WITH_OFFLINE_PUSH_EXCEPT_AT:"AcceptNotNotifyExceptAt",NOT_RECEIVE_OFFLINE_PUSH_EXCEPT_AT:"AcceptNotNotifyExceptAt",NOT_RECEIVE_MSG_EXCEPT_AT:"NotReceiveMsgExceptAt",GENDER_UNKNOWN:"Gender_Type_Unknown",GENDER_FEMALE:"Gender_Type_Female",GENDER_MALE:"Gender_Type_Male",KICKED_OUT_MULT_ACCOUNT:"multipleAccount",KICKED_OUT_MULT_DEVICE:"multipleDevice",KICKED_OUT_USERSIG_EXPIRED:"userSigExpired",KICKED_OUT_REST_API:"REST_API_Kick",ALLOW_TYPE_ALLOW_ANY:"AllowType_Type_AllowAny",ALLOW_TYPE_NEED_CONFIRM:"AllowType_Type_NeedConfirm",ALLOW_TYPE_DENY_ANY:"AllowType_Type_DenyAny",FORBID_TYPE_NONE:"AdminForbid_Type_None",FORBID_TYPE_SEND_OUT:"AdminForbid_Type_SendOut",JOIN_OPTIONS_FREE_ACCESS:"FreeAccess",JOIN_OPTIONS_NEED_PERMISSION:"NeedPermission",JOIN_OPTIONS_DISABLE_APPLY:"DisableApply",JOIN_STATUS_SUCCESS:"JoinedSuccess",JOIN_STATUS_ALREADY_IN_GROUP:"AlreadyInGroup",JOIN_STATUS_WAIT_APPROVAL:"WaitAdminApproval",INVITE_OPTIONS_DISABLE_INVITE:"DisableInvite",INVITE_OPTIONS_NEED_PERMISSION:"NeedPermission",INVITE_OPTIONS_FREE_ACCESS:"FreeAccess",GRP_PROFILE_OWNER_ID:"ownerID",GRP_PROFILE_CREATE_TIME:"createTime",GRP_PROFILE_LAST_INFO_TIME:"lastInfoTime",GRP_PROFILE_MEMBER_NUM:"memberNum",GRP_PROFILE_MAX_MEMBER_NUM:"maxMemberNum",GRP_PROFILE_JOIN_OPTION:"joinOption",GRP_PROFILE_INVITE_OPTION:"inviteOption",GRP_PROFILE_INTRODUCTION:"introduction",GRP_PROFILE_NOTIFICATION:"notification",GRP_PROFILE_MUTE_ALL_MBRS:"muteAllMembers",SNS_ADD_TYPE_SINGLE:"Add_Type_Single",SNS_ADD_TYPE_BOTH:"Add_Type_Both",SNS_DELETE_TYPE_SINGLE:"Delete_Type_Single",SNS_DELETE_TYPE_BOTH:"Delete_Type_Both",SNS_APPLICATION_TYPE_BOTH:"Pendency_Type_Both",SNS_APPLICATION_SENT_TO_ME:"Pendency_Type_ComeIn",SNS_APPLICATION_SENT_BY_ME:"Pendency_Type_SendOut",SNS_APPLICATION_AGREE:"Response_Action_Agree",SNS_APPLICATION_AGREE_AND_ADD:"Response_Action_AgreeAndAdd",SNS_CHECK_TYPE_BOTH:"CheckResult_Type_Both",SNS_CHECK_TYPE_SINGLE:"CheckResult_Type_Single",SNS_TYPE_NO_RELATION:"CheckResult_Type_NoRelation",SNS_TYPE_A_WITH_B:"CheckResult_Type_AWithB",SNS_TYPE_B_WITH_A:"CheckResult_Type_BWithA",SNS_TYPE_BOTH_WAY:"CheckResult_Type_BothWay",NET_STATE_CONNECTED:"connected",NET_STATE_CONNECTING:"connecting",NET_STATE_DISCONNECTED:"disconnected",MSG_AT_ALL:"__kImSDK_MesssageAtALL__",READ_ALL_C2C_MSG:"readAllC2CMessage",READ_ALL_GROUP_MSG:"readAllGroupMessage",READ_ALL_MSG:"readAllMessage",USER_STATUS_UNKNOWN:0,USER_STATUS_ONLINE:1,USER_STATUS_OFFLINE:2,USER_STATUS_UNLOGINED:3,IOS_OFFLINE_PUSH_NO_SOUND:"push.no_sound",IOS_OFFLINE_PUSH_DEFAULT_SOUND:"default"};class s{constructor(){this.cache=[],this.options=null}use(e){if("function"!=typeof e)throw"middleware must be a function";return this.cache.push(e),this}next(e){if(this.middlewares&&0<this.middlewares.length)return this.middlewares.shift().call(this,this.options,this.next.bind(this))}run(e){return this.middlewares=this.cache.map(function(e){return e}),this.options=e,this.next()}}class i{constructor(e=0,t=0){this.high=e,this.low=t}equal(e){return null!==e&&this.low===e.low&&this.high===e.high}toString(){var e=Number(this.high).toString(16);let t=Number(this.low).toString(16);if(t.length<8){let e=8-t.length;for(;e;)t="0"+t,e--}return e+t}}const n={TEST:{CHINA:{DEFAULT:"wss://wss-dev.tim.qq.com"},OVERSEA:{DEFAULT:"wss://wss-dev.tim.qq.com"},SINGAPORE:{DEFAULT:"wss://wsssgp-dev.im.qcloud.com"},KOREA:{DEFAULT:"wss://wsskr-dev.im.qcloud.com"},GERMANY:{DEFAULT:"wss://wssger-dev.im.qcloud.com"},IND:{DEFAULT:"wss://wssind-dev.im.qcloud.com"},JPN:{DEFAULT:"wss://wssjpn-dev.im.qcloud.com"},USA:{DEFAULT:"wss://wssusa-dev.im.qcloud.com"},INDONESIA:{DEFAULT:"wss://wssidn-dev.im.qcloud.com"}},PRODUCTION:{CHINA:{DEFAULT0:"wss://*w4c.my-imcloud.com",DEFAULT:"wss://wss.im.qcloud.com",BACKUP:"wss://wss.tim.qq.com",STAT:"https://events.im.qcloud.com",ANYCAST:"wss://162.14.13.203"},OVERSEA:{DEFAULT0:"wss://*w4c.my-imcloud.com",DEFAULT:"wss://wss.im.qcloud.com",BACKUP:"wss://wss.my-imcloud.com",STAT:"https://api.my-imcloud.com"},SINGAPORE:{DEFAULT0:"wss://*w4s.my-imcloud.com",DEFAULT:"wss://wsssgp.im.qcloud.com",BACKUP:"wss://wsssgp.my-imcloud.com",STAT:"https://apisgp.my-imcloud.com",ANYCAST:"wss://162.14.19.159"},KOREA:{DEFAULT0:"wss://*w4k.my-imcloud.com",DEFAULT:"wss://wsskr.im.qcloud.com",BACKUP:"wss://wsskr.my-imcloud.com",STAT:"https://apikr.my-imcloud.com",ANYCAST:"wss://162.14.13.104"},GERMANY:{DEFAULT0:"wss://*w4g.my-imcloud.com",DEFAULT:"wss://wssger.im.qcloud.com",BACKUP:"wss://wssger.my-imcloud.com",STAT:"https://apiger.my-imcloud.com",ANYCAST:"wss://162.14.3.17"},IND:{DEFAULT0:"wss://*w4i.my-imcloud.com",DEFAULT:"wss://wssind.my-imcloud.com",BACKUP:"wss://wssind.im.qcloud.com",STAT:"https://apiind.my-imcloud.com",ANYCAST:"wss://162.14.18.188"},JPN:{DEFAULT0:"wss://*w4j.my-imcloud.com",DEFAULT:"wss://wssjpn.im.qcloud.com",BACKUP:"wss://wssjpn.my-imcloud.com",STAT:"https://apijpn.my-imcloud.com"},USA:{DEFAULT0:"wss://*w4u.my-imcloud.com",DEFAULT:"wss://wssusa.im.qcloud.com",BACKUP:"wss://wssusa.my-imcloud.com",STAT:"https://apiusa.my-imcloud.com",ANYCAST:"wss://162.14.10.42"},INDONESIA:{DEFAULT0:"wss://*w4y.my-imcloud.com",DEFAULT:"wss://wssidn.im.qcloud.com",BACKUP:"wss://wssidn.my-imcloud.com",STAT:"https://apiidn.my-imcloud.com",ANYCAST:"wss://43.129.34.169"}}},o={ANDROID:2,IOS:3,MAC:4,WEB:7,WX_MP:8,QQ_MP:9,TT_MP:10,BAIDU_MP:11,ALI_MP:12,IPAD:13,UNI_NATIVE_APP:15,DONUT_NATIVE_APP:19,NS_NATIVE_APP:20,RN_NATIVE_APP:21},r="1.7.3",a=537048168,c="CHINA",l="OVERSEA",u="SINGAPORE",d="KOREA",_="GERMANY",h="IND",p="JPN",g="USA",m="INDONESIA",f={HOST:{CURRENT:{DEFAULT:"wss://wss.im.qcloud.com",STAT:"https://events.im.qcloud.com"},setCurrent(e=c){this.CURRENT=n.PRODUCTION[e]}},NAME:{OPEN_IM:"openim",OPEN_IM_MSG_EXT:"openim_msg_ext_http_svc",GRP:"group_open_http_svc",GRP_AV:"group_open_avchatroom_http_svc",GRP_COMMUNITY:"million_group_open_http_svc",GRP_ATTR:"group_open_attr_http_svc",FD:"sns",PROFILE:"profile",RECENT_CONTACT:"recentcontact",PIC:"openpic",BIG_GRP_NO_AUTH:"group_open_http_noauth_svc",BIG_GRP_POLLING:"group_open_long_polling_http_svc",BIG_GRP_POLLING_NO_AUTH:"group_open_long_polling_http_noauth_svc",IM_OPEN_STAT:"imopenstat",WEB_IM:"webim",IM_COS_SIGN:"im_cos_sign_svr",CUSTOM_UPLOAD:"im_cos_msg",HEARTBEAT:"heartbeat",IM_OPEN_PUSH:"im_open_push",IM_OPEN_STATUS:"im_open_status",IM_LONG_MSG:"im_long_msg",IM_CONFIG_MANAGER:"im_sdk_config_mgr",STAT_SERVICE:"StatSvc",OVERLOAD_PUSH:"OverLoadPush",IM_MSG_AUDIT_MGR:"im_msg_audit_mgr",TUIROOM_SVR:"tui_room_svr",IM_OPEN_TRANSLATE:"im_open_translate",IM_OPEN_SPEECH:"im_open_speech",MSG_SEARCH:"message_search",FOLLOW:"follow",OFFLINE_PUSH_REPORT:"offline_push_report",IM_MSG_LOGIC:"im_msg_db_logic"}},M={SEARCH_GRP_SNS:new i(0,Math.pow(2,1)).toString(),AV_HISTORY_MSG:new i(0,Math.pow(2,2)).toString(),GRP_COMMUNITY:new i(0,Math.pow(2,3)).toString(),MSG_TO_SPECIFIED_GRP_MBR:new i(0,Math.pow(2,4)).toString(),AV_MBR_LIST:new i(0,Math.pow(2,6)).toString(),USER_STATUS:new i(0,Math.pow(2,7)).toString(),CONV_MARK:new i(0,Math.pow(2,9)).toString(),CONV_GROUP:new i(0,Math.pow(2,10)).toString(),AV_BAN_MBR:new i(0,Math.pow(2,11)).toString(),MSG_EXT:new i(0,Math.pow(2,13)).toString(),GRP_COUNTER:new i(0,Math.pow(2,15)).toString(),PLUGIN_TRANSLATE:new i(Math.pow(2,6)).toString(),PLUGIN_VOICE_TO_TEXT:new i(Math.pow(2,7)).toString(),PLUGIN_CS:new i(Math.pow(2,8)).toString(),PLUGIN_PUSH:new i(Math.pow(2,9)).toString(),PLUGIN_BOT:new i(Math.pow(2,10)).toString(),MSG_REACTION:new i(Math.pow(2,16)).toString(),FOLLOW:new i(Math.pow(2,20)).toString()},I="c2c_text_message",C="c2c_custom_message",T="group_text_message",y="group_custom_message",v="user_profile",E="group_profile",S=(f.HOST.setCurrent(c),"undefined"!=typeof wx&&"function"==typeof wx.getSystemInfoSync&&Boolean(wx.getSystemInfoSync().fontSizeSetting)),D=S&&"function"==typeof wx.createGamePortal,R="undefined"!=typeof qq&&"function"==typeof qq.getSystemInfoSync&&Boolean(qq.getSystemInfoSync().fontSizeSetting),L="undefined"!=typeof tt&&"function"==typeof tt.getSystemInfoSync&&Boolean(tt.getSystemInfoSync().fontSizeSetting),A="undefined"!=typeof swan&&"function"==typeof swan.getSystemInfoSync&&Boolean(swan.getSystemInfoSync().fontSizeSetting),O="undefined"!=typeof my&&"function"==typeof my.getSystemInfoSync&&Boolean(my.getSystemInfoSync().fontSizeSetting),N="undefined"!=typeof jd&&"function"==typeof jd.getSystemInfoSync,P="undefined"!=typeof uni&&"undefined"==typeof window&&"function"==typeof uni.requireNativePlugin,U=S&&"object"==typeof wx.miniapp,G="undefined"!=typeof uni,k=S||R||L||A||O||P||N,w="undefined"==typeof window&&!k&&"undefined"!=typeof global&&void 0!==global.NativeScriptGlobals,F="undefined"!=typeof global&&(void 0!==global.nativeModuleProxy||void 0!==global.ReactNative),b="undefined"!=typeof uni?!k:"undefined"!=typeof window&&!k&&!F,$=R?qq:L?tt:A?swan:O?my:S?wx:P?uni:N?jd:{},q=b&&window&&window.navigator&&window.navigator.userAgent||"",x=/(micromessenger|webbrowser)/i.test(q),V=function(){let e="WEB";return x?e="WEB":R?e="QQ_MP":L?e="TT_MP":A?e="BAIDU_MP":O?e="ALI_MP":S?e=U?"DONUT_NATIVE_APP":"WX_MP":P?e="UNI_NATIVE_APP":w?e="NS_NATIVE_APP":F&&(e="RN_NATIVE_APP"),o[e]}(),B=/iPad/i.test(q),K=/iPhone/i.test(q)&&!B,H=/iPod/i.test(q),W=K||B||H,Y=function(){var e=q.match(/OS (\d+)_/i);return e&&e[1]?e[1]:null}(),z=/Android/i.test(q),j=function(){var e=q.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);if(!e)return null;var t=e[1]&&parseFloat(e[1]),s=e[2]&&parseFloat(e[2]);return t&&s?parseFloat(e[1]+"."+e[2]):t||null}(),J=/Edge/i.test(q),X=!J&&/Chrome/i.test(q),Z=/MSIE/.test(q)||-1<q.indexOf("Trident")&&-1<q.indexOf("rv:11.0"),Q=function(){var e=/MSIE\s(\d+)\.\d/.exec(q);let t=e&&parseFloat(e[1]);return t=!t&&/Trident\/7.0/i.test(q)&&/rv:11.0/.test(q)?11:t}(),ee=/Safari/i.test(q)&&!X&&!z&&!J,te=/Windows/i.test(q),se=/MAC OS X/i.test(q),ie=b&&"undefined"!=typeof Worker&&!Z,ne=z||W,oe=b&&void 0!==window.tencent_cloud_im_csig_flutter_for_web_25F_cy,re=function(){if("undefined"==typeof window||void 0===window.navigator)return!1;var e=window.navigator.standalone;return!(!W||e||ee)}();let ae,ce;ae="undefined"!=typeof console?console:"undefined"!=typeof global&&global.console?global.console:"undefined"!=typeof window&&window.console?window.console:{};const le=function(){},ue=["assert","clear","count","debug","dir","dirxml","error","group","groupCollapsed","groupEnd","info","log","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"];let de=ue.length;for(;de--;)ce=ue[de],console[ce]||(ae[ce]=le);var _e=ae;let he=0;const pe=function(){return(new Date).getTime()+he},ge=function(){he=0},me=function(){return Math.floor(pe()/1e3)};let fe=0;function Me(){return vt()?"%c Chat %c":"Chat"}function Ie(){const e=function(){const e=new Date;return e.setTime(pe()),e}();return e.toLocaleTimeString("en-US",{hour12:!1})+"."+function(e){let t;switch(e.toString().length){case 1:t="00"+e;break;case 2:t="0"+e;break;default:t=e}return t}(e.getMilliseconds())}const Ce={arguments2String(s){let i="";if(1===s.length)i=s[0];else for(let e=0,t=s.length;e<t;e++){if(qe(s[e]))try{i+=Ve(s[e])?JSON.stringify(s[e],["message","code"]):JSON.stringify(s[e])}catch(e){i+=e?e.message:"";break}else i+=s[e];i+=" "}return i},_exec(e,t){vt()?_e[e](Me(),"background:#0abf5b; padding:1px; border-radius:3px; color: #fff","background:transparent",Ie(),t):_e[e](`${Me()} ${Ie()} `+t)},d:function(){var e;fe<=-1&&(e=this.arguments2String(arguments),this._exec("debug",e))},l:function(){var e;fe<=0&&(e=this.arguments2String(arguments),this._exec("log",e))},log:function(){var e;fe<=0&&(e=this.arguments2String(arguments),this._exec("log",e))},i:function(){var e;fe<=1&&(e=this.arguments2String(arguments),this._exec("info",e))},w:function(){var e;fe<=2&&(e=this.arguments2String(arguments),this._exec("warn",e))},e:function(){var e;fe<=3&&(e=this.arguments2String(arguments),this._exec("error",e))},setLevel:function(e){e<4&&this._exec("log","set level from "+fe+" to "+e),fe=e},getLevel:function(){return fe}},Te={JPG:1,JPEG:1,GIF:2,PNG:3,BMP:4,UNKNOWN:255},ye={NICK:"Tag_Profile_IM_Nick",GENDER:"Tag_Profile_IM_Gender",BIRTHDAY:"Tag_Profile_IM_BirthDay",LOCATION:"Tag_Profile_IM_Location",SELFSIGNATURE:"Tag_Profile_IM_SelfSignature",ALLOWTYPE:"Tag_Profile_IM_AllowType",LANGUAGE:"Tag_Profile_IM_Language",AVATAR:"Tag_Profile_IM_Image",MESSAGESETTINGS:"Tag_Profile_IM_MsgSettings",ADMINFORBIDTYPE:"Tag_Profile_IM_AdminForbidType",LEVEL:"Tag_Profile_IM_Level",ROLE:"Tag_Profile_IM_Role"},ve="Gender_Type_",Ee={UNKNOWN:ve+"Unknown",FEMALE:ve+"Female",MALE:ve+"Male"},Se={NONE:"AdminForbid_Type_None",SEND_OUT:"AdminForbid_Type_SendOut"},De={NEED_CONFIRM:"AllowType_Type_NeedConfirm",ALLOW_ANY:"AllowType_Type_AllowAny",DENY_ANY:"AllowType_Type_DenyAny"},Re="@TGS#_",Le="@TOPIC#_",Ae=Object.prototype.hasOwnProperty;function Oe(e){if(null==e)return!0;if("boolean"==typeof e)return!1;if("number"==typeof e)return 0===e;if("string"==typeof e)return 0===e.length;if("function"==typeof e)return 0===e.length;if(Array.isArray(e))return 0===e.length;if(e instanceof Error)return""===e.message;if(Fe(e)){for(const t in e)if(Ae.call(e,t))return!1;return!0}return!!(Ne(e)||Pe(e)||Ue(e))&&0===e.size}const Ne=function(e){return"map"===Ke(e)},Pe=function(e){return"set"===Ke(e)},Ue=function(e){return"file"===Ke(e)},Ge=function(e){return null!==e&&("number"==typeof e&&!isNaN(+e)||"object"==typeof e&&e.constructor===Number)},ke=function(e){return"string"==typeof e},we=function(e){return null!==e&&"object"==typeof e},Fe=function(e){if("object"!=typeof e||null===e)return!1;e=Object.getPrototypeOf(e);if(null===e)return!0;let t=e;for(;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return e===t},be=function(e){return"function"==typeof Array.isArray?Array.isArray(e):"array"===Ke(e)},$e=function(e){return void 0===e},qe=function(e){return be(e)||we(e)},xe=function(e){return"function"==typeof e},Ve=function(e){return e instanceof Error},Be=function(e){return"filelist"===Ke(e)},Ke=function(e){return Object.prototype.toString.call(e).match(/^\[object (.*)\]$/)[1].toLowerCase()},He=function(e){if("string"!=typeof e)return!1;e=e[0];return!/[^a-zA-Z0-9]/.test(e)},We=(Date.now||(Date.now=function(){return(new Date).getTime()}),function(s,i,o,n){if(!qe(s)||!qe(i))return 0;let r=0;var a,c=Object.keys(i);for(let e=0,t=c.length;e<t;e++)if(a=c[e],!($e(i[a])||o&&o.includes(a)))if(qe(s[a])&&qe(i[a]))r+=We(s[a],i[a],o,n);else{if(n&&n.includes(i[a]))continue;s[a]!==i[a]&&(s[a]=i[a],r+=1)}return r}),Ye=function(e,t){const s=new Map;for(var[i,o]of e.entries())o&&s.set(i,t?JSON.stringify(o):JSON.parse(JSON.stringify(o)));return s},ze=function(e){if(0===e.length)return 0;let t=0,s=0,i;for(var o="undefined"!=typeof document&&void 0!==document.characterSet?document.characterSet:"UTF-8";void 0!==e[t];)i=e[t++].charCodeAt[t]<=255?1:!1===o?3:2,s+=i;return s},je=function(e){e=e||99999999;return Math.round(Math.random()*e)},Je="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",Xe=Je.length,Ze=function(e,t){for(const s in e)if(e[s]===t)return!0;return!1},Qe={},et=function(e){return-1===e.indexOf("http://")||-1===e.indexOf("https://")?"https://"+e:e.replace(/https|http/,"https")};function st(i,e){if(!be(i)||!be(e))return!1;let o=!1;return e.forEach(({key:t,value:e})=>{const s=i.find(e=>e.key===t);s?s.value!==e&&(s.value=e,o=!0):(i.push({key:t,value:e}),o=!0)}),o}const it=e=>e===t.GRP_AVCHATROOM,nt=({type:e,groupID:s})=>e===t.GRP_COMMUNITY||(""+s).startsWith(Re)&&!(""+s).includes(Le),ot=e=>(""+e).startsWith(Re)&&(""+e).includes(Le),rt=e=>ke(e)&&e.slice(0,3)===t.CONV_C2C,at=e=>ke(e)&&e.slice(0,5)===t.CONV_GROUP,ct=e=>ke(e)&&e===t.CONV_SYSTEM;function lt(t,s){const i={};return Object.keys(t).forEach(e=>{i[e]=s(t[e],e)}),i}function ut(i){return F?Promise.resolve({width:0,height:0}):k?new Promise((t,e)=>{$.getImageInfo({src:i,success(e){t({width:e.width,height:e.height})},fail(){t({width:0,height:0})}})}):Z&&9===Q?Promise.resolve({width:0,height:0}):new Promise((e,t)=>{let s=new Image;s.onload=function(){e({width:this.width,height:this.height}),s=null},s.onerror=function(){e({width:0,height:0}),s=null},s.src=i})}function dt(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return""+(e()+e())+e()+e()+e()+e()+e()+e()}function _t(){let e="unknown";if(se&&(e="mac"),te&&(e="windows"),W&&(e="ios"),z&&(e="android"),k)try{var t=$.getSystemInfoSync().platform;void 0!==t&&(e=t)}catch(e){}return e}function ht(t,s){t=t.split("."),s=s.split(".");const i=Math.max(t.length,s.length);for(;t.length<i;)t.push("0");for(;s.length<i;)s.push("0");for(let e=0;e<i;e++){const i=parseInt(t[e]),o=parseInt(s[e]);if(i>o)return 1;if(i<o)return-1}return 0}function pt(e){const{originUrl:t,originWidth:s,originHeight:i,min:o=198}=e,n=parseInt(s),r=parseInt(i),a={url:void 0,width:0,height:0};if((n<=r?n:r)<=o)a.url=t,a.width=n,a.height=r;else{r<=n?(a.width=Math.ceil(n*o/r),a.height=o):(a.width=o,a.height=Math.ceil(r*o/n));const e=t&&-1<t.indexOf("?")?t+"&":t+"?";a.url=198===o?e+"imageView2/3/w/198/h/198":e+"imageView2/3/w/720/h/720"}if($e(t)){const{url:e,...t}=a;return t}return a}function gt(t){var e=t[2];t[2]=t[1],t[1]=e;for(let e=0;e<t.length;e++)t[e].setType(e)}function mt(e){const t=e["servcmd"];return t.slice(t.indexOf(".")+1)}function ft(e,t){return Math.round(Number(e)*Math.pow(10,t))/Math.pow(10,t)}function Mt(e,t){return e.includes(t)}function It(e,t){return e.includes(t)}function Ct(e){return e.split(Le)[0]}const Tt=function(e,s,i){if($e(s))return"";switch(e){case t.MSG_TEXT:return s.text;case t.MSG_IMAGE:return i?"[Image]":"[图片]";case t.MSG_LOCATION:return i?"[Location]":"[位置]";case t.MSG_AUDIO:return i?"[Voice]":"[语音]";case t.MSG_VIDEO:return i?"[Video]":"[视频]";case t.MSG_FILE:return i?"[File]":"[文件]";case t.MSG_CUSTOM:return i?"[Custom Messages]":"[自定义消息]";case t.MSG_GRP_TIP:return i?"[Group Notification]":"[群提示消息]";case t.MSG_GRP_SYS_NOTICE:return i?"[Group System Message]":"[群系统通知]";case t.MSG_FACE:return i?"[Animated Sticker]":"[动画表情]";case t.MSG_MERGER:return i?"[Chat Record]":"[聊天记录]";default:return""}};function yt(t){const s=[];if(!ke(t))return s;var i=t.length;if(0===i)return s;for(let e=i-1;0<=e;e--)"1"===t[e]&&s.push(Math.pow(2,i-e-1));return s}function vt(){return!Z&&!k}function Et(e){return"the length of userIDList cannot exceed "+e}function St(e,t=!0,s=!0){var i=Date.now();return t?s?i-e+" ms":Math.round((i-e)/1e3)+" s":s?i-e:Math.round((i-e)/1e3)}function Dt(e){let t=e&&1<e?!0:!1;return t}function Rt(s,i,o){if(void 0===i)return!0;let n=!0;if(Fe(i))Object.keys(i).forEach(e=>{var t=1===s.length?s[0][e]:void 0;n=!!Lt(t,i[e],o,e)&&n});else if(be(i))for(let e=0;e<i.length;e++)n=!!Lt(s[e],i[e],o,i[e].name)&&n;if(n)return n;throw new Error("Params validate failed.")}function Lt(e,t,s,i){if(void 0===t)return!0;let o=!0;var n,r;return t.required&&Oe(e)&&(Ce.e(`[${s}] Missing required params: "${i}".`),o=!1),Oe(e)||(n=Ke(e))!==(r=t.type.toLowerCase())&&("asyncfunction"===n&&"function"===r||(Ce.e(`[${s}] Invalid params: type check failed for "${i}". Expected ${t.type}.`),o=!1)),t.validator&&!t.validator(e,s,i)&&(Ce.e(`[${s}] Invalid params: custom validator check failed for "${i}".`),o=!1),o}const At="unSend",Ot="success",Nt="fail",Pt="notStart",Ut="pending",Gt="resolved",kt="rejected",wt=function(e){if(!e)return!1;if(rt(e)||at(e)||ct(e))return!0;e=ds("InvalidConversationID",e);return e&&Ce.w(e),!1},Ft=function(e){""!==e.desc&&""!==ds("API_REFER")&&Ce.w(`[${e.api}] | ${e.paramName} | ${e.desc}, `+ds("API_REFER")+e.api)},bt=function(){return ds("StringRequiredLog")},$t=function(e){return ds("NonEmptyStringRequiredLog",e)},qt=function(){return ds("NumberRequiredLog")},xt=function(){return ds("UndefinedNotAllowedLog")},Vt=function(){return ds("FileRequiredLog")},Bt=function(){return ds("FunctionRequiredLog")},Kt=function(){return ds("ArrayRequiredLog")},Ht=function(){return ds("NonEmptyArrayLog")},Wt=function(){return ds("CallbackMissingLog")},Yt=function(){return ds("PositiveIntegerRequiredLog")},zt=function(e,t){return ds("StringNotLongerThanLog",e,t)},jt=function(e,t){return ds("NumberLessThanLog",e,t)},Jt=function(e,t){return ds("NumberGreaterOrEqualLog",e,t)},Xt=function(e){return ds("KeyValueStringRequiredLog",e)},Zt=function(){return ds("PlainObjectRequiredLog")},Qt=function(){return ds("NonEmptyContentRequiredLog")},es=function(){return ds("FileNotSelectedLog")},ts=function(){return ds("MessageInstanceRequiredLog")},ss=function(){return ds("NonAnonymousFunctionLog")},is=function(){return ds("MessageExtensionNotAvailableLog")},ns=function(){return ds("MessageReactionRequiredLog")},os=function(e,t){return ds("MaximumArrayLengthLog",e,t)},rs={type:"String",required:!0},as={type:"Array",required:!0},cs={type:"Object",required:!0},ls={type:"Boolean",required:!0},us={type:"number",required:!0};let ds=null;const _s={hookGetAPITips:function(e){ds=e},login:{userID:rs,userSig:rs},addToBlacklist:{userIDList:as},removeFromBlacklist:{userIDList:as},on:[{name:"eventName",type:"String",validator:(e,t,s)=>"string"==typeof e&&0!==e.length||(Ft({api:t,paramName:s,desc:$t(s)}),!1)},{name:"handler",type:"Function",validator:(e,t,s)=>"function"!=typeof e?(Ft({api:t,paramName:s,desc:Bt()}),!1):(""===e.name&&Ft({api:t,paramName:s,desc:ss()}),!0)}],once:[{name:"eventName",type:"String",validator:(e,t,s)=>"string"==typeof e&&0!==e.length||(Ft({api:t,paramName:s,desc:$t(s)}),!1)},{name:"handler",type:"Function",validator:(e,t,s)=>"function"!=typeof e?(Ft({api:t,paramName:s,desc:Bt()}),!1):(""===e.name&&Ft({api:t,paramName:s,desc:ss()}),!0)}],off:[{name:"eventName",type:"String",validator:(e,t,s)=>"string"==typeof e&&0!==e.length||(Ft({api:t,paramName:s,desc:$t(s)}),!1)},{name:"handler",type:"Function",validator:(e,t,s)=>"function"!=typeof e?(Ft({api:t,paramName:s,desc:Bt()}),!1):(""===e.name&&Ft({api:t,paramName:s,desc:ss()}),!0)}],sendMessage:[{name:"message",...cs}],setMessageExtensions:[{name:"message",...cs,validator:(e,t,s)=>e.status===Ot&&!0===e.isSupportExtension||(Ft({api:t,paramName:s,desc:is()}),!1)},{name:"extensions",...as}],getMessageExtensions:[{name:"message",...cs,validator:(e,t,s)=>e.status===Ot&&!0===e.isSupportExtension||(Ft({api:t,paramName:s,desc:is()}),!1)}],deleteMessageExtensions:[{name:"message",...cs,validator:(e,t,s)=>e.status===Ot&&!0===e.isSupportExtension||(Ft({api:t,paramName:s,desc:is()}),!1)}],addMessageReaction:[{name:"message",...cs,validator:(e,t,s)=>e.status===Ot||(Ft({api:t,paramName:s,desc:ns()}),!1)},{name:"reactionID",...rs}],removeMessageReaction:[{name:"message",...cs,validator:(e,t,s)=>e.status===Ot||(Ft({api:t,paramName:s,desc:ns()}),!1)},{name:"reactionID",...rs}],getMessageReactions:{messageList:{...as}},getAllUserListOfMessageReaction:{message:{...cs,validator:(e,t,s)=>e.status===Ot||(Ft({api:t,paramName:s,desc:ns()}),!1)},reactionID:{...rs},nextSeq:{type:"Number"},count:{type:"Number"}},getMessageList:{conversationID:{...rs,validator:e=>wt(e)},nextReqMessageID:{type:"String"},count:{type:"Number",validator:(e,t,s)=>!(!$e(e)&&!/^[1-9][0-9]*$/.test(e)&&(Ft({api:t,paramName:s,desc:Yt()}),1))}},getMessageListHopping:{conversationID:{...rs,validator:e=>wt(e)},sequence:{type:"Number"},time:{type:"Number"},direction:{type:"Number",validator:(e,t,s)=>!(!$e(e)&&0!==e&&1!==e&&(Ft({api:t,paramName:s,desc:ds("0Or1RequiredLog")}),1))},count:{type:"Number",validator:(e,t,s)=>!(!$e(e)&&!/^[1-9][0-9]*$/.test(e)&&(Ft({api:t,paramName:s,desc:Yt}),1))}},setMessageRead:{conversationID:{...rs,validator:e=>wt(e)}},setAllMessageRead:{scope:{type:"String",required:!1,validator:(e,s,i)=>!e||-1!==[t.READ_ALL_C2C_MSG,t.READ_ALL_GROUP_MSG,t.READ_ALL_MSG].indexOf(e)||(Ft({api:s,paramName:i,desc:ds("ValidScopeRequired")}),!1)}},getConversationProfile:[{name:"conversationID",...rs,validator:e=>wt(e)}],clearHistoryMessage:[{name:"conversationID",...rs,validator:e=>wt(e)}],pinConversation:{conversationID:{...rs,validator:e=>wt(e)},isPinned:{...ls}},setConversationDraft:{conversationID:{...rs,validator:e=>wt(e)},draftText:{type:"String",validator:(e,t,s)=>!!ke(e)||(Ft({api:t,paramName:s,desc:bt()}),!1)}},setConversationCustomData:{conversationIDList:{...as},customData:{type:"String",validator:(e,t,s)=>ke(e)?!(256<e.length&&(Ft({api:t,paramName:s,desc:zt(s,256)}),1)):(Ft({api:t,paramName:s,desc:bt()}),!1)}},markConversation:{conversationIDList:{...as},markType:{type:"number",validator:(e,t,s)=>{return Ge(e)?e<=0?(Ft({api:t,paramName:s,desc:(i=s,ds("NumberGreaterThanLog",i,0))}),!1):!(e>=Math.pow(2,64)&&(Ft({api:t,paramName:s,desc:jt(s,"Math.pow(2,64)")}),1)):(Ft({api:t,paramName:s,desc:qt()}),!1);var i}},enableMark:{...ls}},createConversationGroup:{conversationIDList:{...as},groupName:{...rs,validator:(e,t,s)=>!(!e||32<e.length&&(Ft({api:t,paramName:s,desc:zt(s,32)}),1))}},deleteConversationGroup:[{name:"groupName",...rs}],renameConversationGroup:{oldName:{...rs},newName:{...rs,validator:(e,t,s)=>!(!e||32<e.length&&(Ft({api:t,paramName:s,desc:zt(s,32)}),1))}},addConversationsToGroup:{conversationIDList:{...as},groupName:{...rs}},deleteConversationsFromGroup:{conversationIDList:{...as},groupName:{...rs}},getGroupList:{groupProfileFilter:{type:"Array"}},getGroupProfile:{groupID:rs,groupCustomFieldFilter:{type:"Array"},memberCustomFieldFilter:{type:"Array"}},getGroupProfileAdvance:{groupIDList:as},createGroup:{name:rs},joinGroup:{groupID:rs,type:{type:"String"},applyMessage:{type:"String"}},quitGroup:[{name:"groupID",...rs}],handleApplication:{message:cs,handleAction:rs,handleMessage:{type:"String"}},changeGroupOwner:{groupID:rs,newOwnerID:rs},updateGroupProfile:{groupID:rs,muteAllMembers:{type:"Boolean"}},dismissGroup:[{name:"groupID",...rs}],searchGroupByID:[{name:"groupID",...rs}],getGroupOnlineMemberCount:[{name:"groupID",...rs}],initGroupAttributes:{groupID:rs,groupAttributes:{...cs,validator:(t,s,i)=>{let o=!0;return Object.keys(t).forEach(e=>{if(!ke(t[e]))return Ft({api:s,paramName:i,desc:Xt("value")}),o=!1}),o}}},setGroupAttributes:{groupID:rs,groupAttributes:{...cs,validator:(t,s,i)=>{let o=!0;return Object.keys(t).forEach(e=>{if(!ke(t[e]))return Ft({api:s,paramName:i,desc:Xt("value")}),o=!1}),o}}},deleteGroupAttributes:{groupID:rs,keyList:{type:"Array",validator:(e,s,i)=>{if($e(e)||!be(e))return Ft({api:s,paramName:i,desc:Kt()}),!1;if(Oe(e))return!0;{let t=!0;return e.forEach(e=>{if(!ke(e))return Ft({api:s,paramName:i,desc:ds("StringArrayRequiredLog")}),t=!1}),t}}}},getGroupAttributes:{groupID:rs,keyList:{type:"Array",validator:(e,s,i)=>{if($e(e)||!be(e))return Ft({api:s,paramName:i,desc:Kt()}),!1;if(Oe(e))return!0;{let t=!0;return e.forEach(e=>{if(!ke(e))return Ft({api:s,paramName:i,desc:Xt("key")}),t=!1}),t}}}},setGroupCounters:{groupID:rs,counters:cs},increaseGroupCounter:{groupID:rs,key:rs,value:us},decreaseGroupCounter:{groupID:rs,key:rs,value:us},getGroupCounters:{groupID:rs},getGroupMemberList:{groupID:rs,count:{type:"Number"}},getGroupMemberProfile:{groupID:rs,userIDList:as,memberCustomFieldFilter:{type:"Array"}},addGroupMember:{groupID:rs,userIDList:as},setGroupMemberRole:{groupID:rs,userID:rs,role:rs},setGroupMemberMuteTime:{groupID:rs,userID:rs,muteTime:{type:"Number",validator:e=>0<=e}},setGroupMemberNameCard:{groupID:rs,userID:{type:"String"},nameCard:{type:"String",validator:(e,t,s)=>ke(e)?(e.length,!0):(Ft({api:t,paramName:s,desc:bt()}),!1)}},setGroupMemberCustomField:{groupID:rs,userID:{type:"String"},memberCustomField:as},deleteGroupMember:{groupID:rs},markGroupMemberList:{groupID:rs,markType:{type:"number",validator:(e,t,s)=>Ge(e)?!(e<1e3&&(Ft({api:t,paramName:s,desc:Jt(s,1e3)}),1)):(Ft({api:t,paramName:s,desc:qt()}),!1)},userIDList:{...as},enableMark:{...ls}},createTextMessage:{to:rs,conversationType:rs,payload:{...cs,validator:(e,t,s)=>Fe(e)?ke(e.text)?0!==e.text.length||(Ft({api:t,paramName:"payload.text",desc:Qt()}),!1):(Ft({api:t,paramName:"payload.text",desc:bt()}),!1):(Ft({api:t,paramName:s,desc:Zt()}),!1)}},createTextAtMessage:{to:rs,conversationType:rs,payload:{...cs,validator:(e,t,s)=>Fe(e)?ke(e.text)?0===e.text.length?(Ft({api:t,paramName:"payload.text",desc:Qt()}),!1):!(e.atUserList&&!be(e.atUserList)&&(Ft({api:t,paramName:"payload.atUserList",desc:Kt()}),1)):(Ft({api:t,paramName:"payload.text",desc:bt()}),!1):(Ft({api:t,paramName:s,desc:Zt()}),!1)}},createCustomMessage:{to:rs,conversationType:rs,payload:{...cs,validator:(e,t,s)=>Fe(e)?e.data&&!ke(e.data)?(Ft({api:t,paramName:"payload.data",desc:bt()}),!1):e.description&&!ke(e.description)?(Ft({api:t,paramName:"payload.description",desc:bt()}),!1):!(e.extension&&!ke(e.extension)&&(Ft({api:t,paramName:"payload.extension",desc:bt()}),1)):(Ft({api:t,paramName:"payload",desc:Zt()}),!1)}},createImageMessage:{to:rs,conversationType:rs,payload:{...cs,validator:(e,t,s)=>{if(!Fe(e))return Ft({api:t,paramName:s,desc:Zt()}),!1;if($e(e.file))return Ft({api:t,paramName:"payload.file",desc:xt()}),!1;if(b){if(!(e.file instanceof HTMLInputElement||Ue(e.file)))return Fe(e.file)&&"undefined"!=typeof uni?0!==e.file.tempFilePaths.length&&0!==e.file.tempFiles.length||(Ft({api:t,paramName:"payload.file",desc:es()}),!1):(Ft({api:t,paramName:"payload.file",desc:Vt()}),!1);if(e.file instanceof HTMLInputElement&&0===e.file.files.length)return Ft({api:t,paramName:"payload.file",desc:es()}),!1}return!0},onProgress:{type:"Function",required:!1,validator:(e,t,s)=>($e(e)&&Ft({api:t,paramName:s,desc:Wt()}),!0)}}},createAudioMessage:{to:rs,conversationType:rs,payload:{...cs,validator:(e,t,s)=>!!Fe(e)||(Ft({api:t,paramName:s,desc:Zt()}),!1)},onProgress:{type:"Function",required:!1,validator:(e,t,s)=>($e(e)&&Ft({api:t,paramName:s,desc:Wt()}),!0)}},createVideoMessage:{to:rs,conversationType:rs,payload:{...cs,validator:(e,t,s)=>{if(!Fe(e))return Ft({api:t,paramName:s,desc:Zt()}),!1;if($e(e.file))return Ft({api:t,paramName:"payload.file",desc:xt()}),!1;if(b){if(!(e.file instanceof HTMLInputElement||Ue(e.file)))return Fe(e.file)&&"undefined"!=typeof uni?!!Ue(e.file.tempFile)||(Ft({api:t,paramName:"payload.file",desc:es()}),!1):(Ft({api:t,paramName:"payload.file",desc:Vt()}),!1);if(e.file instanceof HTMLInputElement&&0===e.file.files.length)return Ft({api:t,paramName:"payload.file",desc:es()}),!1}return!0}},onProgress:{type:"Function",required:!1,validator:(e,t,s)=>($e(e)&&Ft({api:t,paramName:s,desc:Wt()}),!0)}},createFaceMessage:{to:rs,conversationType:rs,payload:{...cs,validator:(e,t,s)=>Fe(e)?Ge(e.index)?!!ke(e.data)||(Ft({api:t,paramName:"payload.data",desc:bt()}),!1):(Ft({api:t,paramName:"payload.index",desc:qt()}),!1):(Ft({api:t,paramName:s,desc:Zt()}),!1)}},createFileMessage:{to:rs,conversationType:rs,payload:{...cs,validator:(e,t,s)=>{if(!Fe(e))return Ft({api:t,paramName:s,desc:Zt()}),!1;if($e(e.file))return Ft({api:t,paramName:"payload.file",desc:xt()}),!1;if(b){if(!(e.file instanceof HTMLInputElement||Ue(e.file)))return Fe(e.file)&&"undefined"!=typeof uni?0!==e.file.tempFilePaths.length&&0!==e.file.tempFiles.length||(Ft({api:t,paramName:"payload.file",desc:es()}),!1):(Ft({api:t,paramName:"payload.file",desc:Vt()}),!1);if(e.file instanceof HTMLInputElement&&0===e.file.files.length)return Ft({api:t,paramName:"payload.file",desc:es()}),!1}return!0}},onProgress:{type:"Function",required:!1,validator:(e,t,s)=>($e(e)&&Ft({api:t,paramName:s,desc:Wt()}),!0)}},createLocationMessage:{to:rs,conversationType:rs,payload:{...cs,validator:(e,t,s)=>Fe(e)?ke(e.description)?Ge(e.longitude)?!!Ge(e.latitude)||(Ft({api:t,paramName:"payload.latitude",desc:qt()}),!1):(Ft({api:t,paramName:"payload.longitude",desc:qt()}),!1):(Ft({api:t,paramName:"payload.description",desc:bt()}),!1):(Ft({api:t,paramName:s,desc:Zt()}),!1)}},createMergerMessage:{to:rs,conversationType:rs,payload:{...cs,validator:(e,t,s)=>{if(Oe(e.messageList))return Ft({api:t,paramName:"payload.messageList",desc:Ht()}),!1;if(Oe(e.compatibleText))return Ft({api:t,paramName:"payload.compatibleText",desc:$t("compatibleText")}),!1;let i=!1;return e.messageList.forEach(e=>{e.status===Nt&&(i=!0)}),!i||(Ft({api:t,paramName:"payload.messageList",desc:ds("MergeFailedMessageLog")}),!1)}}},revokeMessage:[{name:"message",...cs,validator:(e,s,i)=>Oe(e)?(Ft({api:s,paramName:i,desc:ts()}),!1):e.conversationType===t.CONV_SYSTEM?(Ft({api:s,paramName:i,desc:ds("MessageCanBeRevokedDesc")}),!1):!0!==e.isRevoked||(Ft({api:s,paramName:i,desc:ds("MessageRevokedLog")}),!1)}],deleteMessage:[{name:"messageList",...as,validator:(e,t,s)=>!Oe(e)||(Ft({api:t,paramName:s,desc:Ht()}),!1)}],translateText:{sourceTextList:as,sourceLanguage:rs,targetLanguage:rs},convertVoiceToText:{message:{...cs,validator:(e,s,i)=>Oe(e)?(Ft({api:s,paramName:i,desc:ts()}),!1):e.type===t.MSG_AUDIO&&e.status===Ot||(Ft({api:s,paramName:i,desc:ds("AudioMessageRequiredLog")}),!1)}},modifyMessage:[{name:"message",...cs,validator:(e,s,i)=>Oe(e)?(Ft({api:s,paramName:i,desc:ts()}),!1):e.conversationType===t.CONV_SYSTEM?(Ft({api:s,paramName:i,desc:ds("MessageCanBeModifiedLog")}),!1):!0!==e._onlineOnlyFlag||(Ft({api:s,paramName:i,desc:ds("OnlineMessageNotSupportLog")}),!1)}],searchCloudMessages:{keywordList:{type:"Array",required:!1,validator:(e,t,s)=>!(e&&(be(e)?0===e.length?(Ft({api:t,paramName:s,desc:Ht()}),1):5<e.length&&(Ft({api:t,paramName:s,desc:os(s,5)}),1):(Ft({api:t,paramName:s,desc:Kt()}),1)))},keywordListMatchType:{type:"String",required:!1,validator:(e,t,s)=>!e||"or"===e||"and"===e||Ft({api:t,paramName:s,desc:e+" is invalid match type"})},senderUserIDList:{type:"Array",required:!1,validator:(e,t,s)=>!(e&&(be(e)?(0===e.length&&Ft({api:t,paramName:s,desc:Ht()}),5<e.length&&(Ft({api:t,paramName:s,desc:os(s,5)}),1)):(Ft({api:t,paramName:s,desc:Kt()}),1)))},messageTypeList:{type:"Array",required:!1,validator:(e,s,i)=>{if(!e)return!0;if(!be(e))return Ft({api:s,paramName:i,desc:Kt()}),!1;0===e.length&&Ft({api:s,paramName:i,desc:Ht()});const o=[t.MSG_TEXT,t.MSG_IMAGE,t.MSG_AUDIO,t.MSG_FILE,t.MSG_VIDEO,t.MSG_LOCATION,t.MSG_CUSTOM,t.MSG_MERGER];return!(0<e.filter(e=>-1===o.indexOf(e)).length&&(Ft({api:s,paramName:i,desc:(e=i,ds("ContainsUnsupportedMessageTypeLog",e))}),1))}},conversationID:{type:"String",required:!1,validator:e=>!e||wt(e)},timePosition:{type:"number",required:!1,validator:(e,t,s)=>!(e&&e<0&&(Ft({api:t,paramName:s,desc:Jt(s,0)}),1))},timePeriod:{type:"number",required:!1,validator:(e,t,s)=>!(e&&e<0&&(Ft({api:t,paramName:s,desc:Jt(s,0)}),1))},cursor:{type:"String",required:!1}},getUserProfile:{userIDList:{type:"Array",validator:(e,t,s)=>be(e)?(0===e.length&&Ft({api:t,paramName:s,desc:Ht()}),!0):(Ft({api:t,paramName:s,desc:Kt()}),!1)}},updateMyProfile:{profileCustomField:{type:"Array",validator:(e,t,s)=>!!$e(e)||!!be(e)||(Ft({api:t,paramName:s,desc:Kt()}),!1)}},setSelfStatus:{customStatus:{type:"String",validator:(e,t,s)=>!!ke(e)||(Ft({api:t,paramName:s,desc:bt()}),!1)}},getUserStatus:{userIDList:{type:"Array",validator:(e,t,s)=>be(e)?0!==e.length||(Ft({api:t,paramName:s,desc:Ht()}),!1):(Ft({api:t,paramName:s,desc:Kt()}),!1)}},subscribeUserStatus:{userIDList:{type:"Array",validator:(e,t,s)=>be(e)?0!==e.length||(Ft({api:t,paramName:s,desc:Ht()}),!1):(Ft({api:t,paramName:s,desc:Kt()}),!1)}},unsubscribeUserStatus:{userIDList:{type:"Array",validator:(e,t,s)=>!e||!!be(e)||(Ft({api:t,paramName:s,desc:Kt()}),!1)}},addFriend:{to:rs,source:{type:"String",required:!0,validator:(e,t,s)=>!!e&&(e.startsWith("AddSource_Type_")?!(8<e.replace("AddSource_Type_","").length&&(Ft({api:t,paramName:s,desc:zt("keyword",8)}),1)):(Ft({api:t,paramName:s,desc:ds("SourcePrefixLog")}),!1))},remark:{type:"String",required:!1,validator:(e,t,s)=>!(ke(e)&&96<e.length&&(Ft({api:t,paramName:s,desc:zt(s,96)}),1))}},deleteFriend:{userIDList:as},checkFriend:{userIDList:as},getFriendProfile:{userIDList:as},updateFriend:{userID:rs,remark:{type:"String",required:!1,validator:(e,t,s)=>!(ke(e)&&96<e.length&&(Ft({api:t,paramName:s,desc:zt(s,96)}),1))},friendCustomField:{type:"Array",required:!1,validator:(e,s,i)=>{if(e){if(!be(e))return Ft({api:s,paramName:i,desc:Kt()}),!1;let t=!0;return e.forEach(e=>ke(e.key)&&-1!==e.key.indexOf("Tag_SNS_Custom")?ke(e.value)?8<e.key.replace("Tag_SNS_Custom_","").length?(Ft({api:s,paramName:i,desc:zt("keyword",8)}),t=!1):void 0:(Ft({api:s,paramName:i,desc:Xt("value")}),t=!1):(Ft({api:s,paramName:i,desc:ds("FriendCustomFieldPrefixLog")}),t=!1)),t}return!0}}},acceptFriendApplication:{userID:rs},refuseFriendApplication:{userID:rs},deleteFriendApplication:{userID:rs},createFriendGroup:{name:rs},deleteFriendGroup:{name:rs},addToFriendGroup:{name:rs,userIDList:as},removeFromFriendGroup:{name:rs,userIDList:as},renameFriendGroup:{oldName:rs,newName:rs},sendMessageReadReceipt:[{name:"messageList",type:"Array",validator:(e,t,s)=>be(e)?0!==e.length||(Ft({api:t,paramName:s,desc:Ht()}),!1):(Ft({api:t,paramName:s,desc:Kt()}),!1)}],getMessageReadReceiptList:[{name:"messageList",type:"Array",validator:(e,t,s)=>be(e)?0!==e.length||(Ft({api:t,paramName:s,desc:Ht()}),!1):(Ft({api:t,paramName:s,desc:Kt()}),!1)}],createTopicInCommunity:{groupID:rs,topicName:rs},deleteTopicFromCommunity:{groupID:rs,topicIDList:{type:"Array",validator:(e,t,s)=>!e||!!be(e)||(Ft({api:t,paramName:s,desc:Kt()}),!1)}},updateTopicProfile:{groupID:rs,topicID:rs},getTopicList:{groupID:rs,topicIDList:{type:"Array",validator:(e,t,s)=>!e||!!be(e)||(Ft({api:t,paramName:s,desc:Kt()}),!1)}},followUser:[{name:"userIDList",...as}],unfollowUser:[{name:"userIDList",...as}],getMyFollowingList:[{name:"startIndex",...rs,required:!1}],getMyFollowersList:[{name:"startIndex",...rs,required:!1}],getMutualFollowersList:[{name:"startIndex",...rs,required:!1}],getUserFollowInfo:[{name:"userIDList",...as,required:!1}],checkFollowType:[{name:"userIDList",...as}],addSignalingListener:[{name:"eventName",type:"String",validator:(e,t,s)=>"string"==typeof e&&0!==e.length||(Ft({api:t,paramName:s,desc:$t(s)}),!1)},{name:"handler",type:"Function",validator:(e,t,s)=>"function"!=typeof e?(Ft({api:t,paramName:s,desc:Bt()}),!1):(""===e.name&&Ft({api:t,paramName:s,desc:ss()}),!0)}],removeSignalingListener:[{name:"eventName",type:"String",validator:(e,t,s)=>"string"==typeof e&&0!==e.length||(Ft({api:t,paramName:s,desc:$t(s)}),!1)},{name:"handler",type:"Function",validator:(e,t,s)=>"function"!=typeof e?(Ft({api:t,paramName:s,desc:Bt()}),!1):(""===e.name&&Ft({api:t,paramName:s,desc:ss()}),!0)}],invite:{userID:rs},inviteSync:[{...cs,validator:(e,t,s)=>Fe(e)?!!ke(e.userID)||(Ft({api:t,paramName:"options.userID",desc:bt()}),!1):(Ft({api:t,paramName:"options",desc:Zt()}),!1)},{name:"successCb",type:"Function",required:!1,validator:(e,t,s)=>($e(e)&&Ft({api:t,paramName:s,desc:Bt()}),!0)},{name:"errorCb",type:"Function",required:!1,validator:(e,t,s)=>($e(e)&&Ft({api:t,paramName:s,desc:Bt()}),!0)}],inviteInGroup:{groupID:rs,inviteeList:as},inviteInGroupSync:[{...cs,validator:(e,t,s)=>Fe(e)?ke(e.groupID)?!!be(e.inviteeList)||(Ft({api:t,paramName:"options.inviteeList",desc:Kt()}),!1):(Ft({api:t,paramName:"options.groupID",desc:bt()}),!1):(Ft({api:t,paramName:"options",desc:Zt()}),!1)},{name:"successCb",type:"Function",required:!1,validator:(e,t,s)=>($e(e)&&Ft({api:t,paramName:s,desc:Bt()}),!0)},{name:"errorCb",type:"Function",required:!1,validator:(e,t,s)=>($e(e)&&Ft({api:t,paramName:s,desc:Bt()}),!0)}],accept:{inviteID:rs},reject:{inviteID:rs},getSignalingInfo:[{name:"message",...cs,validator:(e,t,s)=>!Oe(e)||(Ft({api:t,paramName:s,desc:ts()}),!1)}],modifyInvitation:{inviteID:rs,data:rs}},hs={login:1,logout:1,getLoginUser:1,getServerTime:1,on:1,once:1,off:1,setLogLevel:1,registerPlugin:1,destroy:1,isReady:1,createTextMessage:1,createTextAtMessage:1,createImageMessage:1,createAudioMessage:1,createVideoMessage:1,createCustomMessage:1,createFaceMessage:1,createFileMessage:1,createLocationMessage:1,createMergerMessage:1,downloadMergerMessage:1,createForwardMessage:1,sendMessage:1,resendMessage:1,revokeMessage:1,deleteMessage:1,translateText:1,convertVoiceToText:1,modifyMessage:1,searchCloudMessages:1,sendMessageReadReceipt:1,getGroupMessageReadMemberList:1,getMessageReadReceiptList:1,setMessageExtensions:1,getMessageExtensions:1,deleteMessageExtensions:1,addMessageReaction:1,removeMessageReaction:1,getMessageReactions:1,getAllUserListOfMessageReaction:1,getMessageList:1,findMessage:1,getMessageListHopping:1,setMessageRead:1,setAllMessageRead:1,getConversationList:1,getConversationProfile:1,deleteConversation:1,setConversationDraft:1,pinConversation:1,getTotalUnreadMessageCount:1,setConversationCustomData:1,markConversation:1,createConversationGroup:1,getConversationGroupList:1,deleteConversationGroup:1,renameConversationGroup:1,addConversationsToGroup:1,deleteConversationsFromGroup:1,clearHistoryMessage:1,setMessageRemindType:1,setAllReceiveMessageOpt:1,getAllReceiveMessageOpt:1,getGroupList:1,getGroupProfile:1,createGroup:1,joinGroup:1,updateGroupProfile:1,quitGroup:1,dismissGroup:1,changeGroupOwner:1,searchGroupByID:1,getGroupApplicationList:1,handleGroupApplication:1,initGroupAttributes:1,setGroupAttributes:1,deleteGroupAttributes:1,getGroupAttributes:1,setGroupCounters:1,increaseGroupCounter:1,decreaseGroupCounter:1,getGroupCounters:1,getJoinedCommunityList:1,createTopicInCommunity:1,deleteTopicFromCommunity:1,updateTopicProfile:1,getTopicList:1,getGroupMemberProfile:1,getGroupMemberList:1,addGroupMember:1,deleteGroupMember:1,setGroupMemberNameCard:1,setGroupMemberMuteTime:1,setGroupMemberRole:1,setGroupMemberCustomField:1,getGroupOnlineMemberCount:1,markGroupMemberList:1,getMyProfile:1,getUserProfile:1,updateMyProfile:1,setSelfStatus:1,getUserStatus:1,subscribeUserStatus:1,unsubscribeUserStatus:1,getBlacklist:1,addToBlacklist:1,removeFromBlacklist:1,getFriendList:1,addFriend:1,deleteFriend:1,checkFriend:1,updateFriend:1,getFriendProfile:1,getFriendApplicationList:1,refuseFriendApplication:1,deleteFriendApplication:1,acceptFriendApplication:1,setFriendApplicationRead:1,getFriendGroupList:1,createFriendGroup:1,renameFriendGroup:1,deleteFriendGroup:1,addToFriendGroup:1,removeFromFriendGroup:1,followUser:1,unfollowUser:1,getMyFollowingList:1,getMyFollowersList:1,getMutualFollowersList:1,getUserFollowInfo:1,checkFollowType:1,callExperimentalAPI:1,addSignalingListener:1,removeSignalingListener:1,invite:1,inviteSync:1,inviteInGroup:1,inviteInGroupSync:1,cancel:1,accept:1,reject:1,getSignalingInfo:1,modifyInvitation:1},ps=1,gs=2,ms=3,fs=4,Ms=6,Is=7,Cs=8,Ts=10,ys=11,vs=12,Es=13,Ss=14,Ds=15,Rs=17,Ls=18,As=19,Os=20,Ns=21,Ps=23,Us=24,Gs=25,ks=26,ws=27,Fs=28,bs=29,$s=30,qs=31,xs=32,Vs=33,Bs=34,Ks=35,Hs=36,Ws=37,Ys=function(e){return{code:0,data:e||{}}};class zs extends Error{constructor(e){super();var{code:e,message:t,data:s}=e;this.code=e,t?this.message=t:this._getErrMsg&&(this.message=this._getErrMsg(this.code)),this.data=s||{}}}const js={NO_SDKAPPID:2e3,NO_ACCOUNT_TYPE:2001,NO_IDENTIFIER:2002,NO_USERSIG:2003,NO_TINYID:2022,NO_A2KEY:2023,USER_NOT_LOGGED_IN:2024,REPEAT_LOGIN:2025,COS_UNDETECTED:2040,COS_GET_SIG_FAIL:2041,MSG_SEND_FAIL:2100,MSG_SEND_FAIL_NOT_IN_AV:2101,MSG_INSTANCE_REQUIRED:2105,MSG_INVALID_CONV_TYPE:2106,MSG_F_IS_EMPTY:2108,MSG_ONPROGRESS_ERR:2109,MSG_REVOKE_FAIL:2110,MSG_DELETE_FAIL:2111,MSG_UNREAD_ALL_FAIL:2112,READ_RECEIPT_MSG_LIST_EMPTY:2114,MSG_SEND_GRP_WITH_TOPIC_FAIL:2115,CANNOT_DELETE_GRP_SYSTEM_NOTICE:2116,TRANSLATE_TEXT_FAIL:2117,VOICE_TO_TEXT_FAIL:2118,UNSUPPORTED_VOICE_FORMAT:2119,MSG_I_SELECT_F_FIRST:2251,MSG_I_TYPES_LIMIT:2252,MSG_I_SIZE_LIMIT:2253,MSG_A_UPLOAD_FAIL:2300,MSG_A_SIZE_LIMIT:2301,MSG_V_UPLOAD_FAIL:2350,MSG_V_SIZE_LIMIT:2351,MSG_V_TYPES_LIMIT:2352,MSG_F_UPLOAD_FAIL:2400,MSG_F_SELECT_F_FIRST:2401,MSG_F_SIZE_LIMIT:2402,MSG_F_URL_IS_EMPTY:2403,MSG_MERGER_TYPE_INVALID:2450,MSG_MERGER_KEY_INVALID:2451,MSG_MERGER_DOWNLOAD_FAIL:2452,MSG_FORWARD_TYPE_INVALID:2453,MSG_FORWARD_INVALID_ELEMENTS:2454,MSG_MODIFY_CONFLICT:2480,MSG_MODIFY_DISABLED_IN_AV:2481,CONV_NOT_FOUND:2500,USER_OR_GRP_NOT_FOUND:2501,CONV_UN_RECORDED_TYPE:2502,INVALID_CONV_ID:2503,ILLEGAL_GRP_TYPE:2600,ILLEGAL_GRP_ID:2602,CANNOT_FIND_GRP:2603,CANNOT_CHANGE_OWNER_IN_AV:2620,CANNOT_CHANGE_OWNER_TO_SELF:2621,MEMBER_NOT_IN_GRP:2623,JOIN_GRP_FAIL:2660,CANNOT_ADD_MEMBER_IN_AV:2661,CANNOT_JOIN_NON_AV_WITHOUT_LOGIN:2662,NOT_OWNER:2681,INVALID_MEMBER_ROLE:2683,CANNOT_SET_SELF_MEMBER_ROLE:2684,CANNOT_MUTE_SELF:2685,BAN_DURATION_INVALID:2686,OPERATION_NOT_SUPPORTED_IN_AV:2687,NOT_MY_FRIEND:2700,ALREADY_MY_FRIEND:2701,FRIEND_GRP_EXISTED:2710,FRIEND_GRP_NOT_EXIST:2711,FRIEND_APPLICATION_NOT_EXIST:2716,UPDATE_PROFILE_INVALID_PARAM:2721,UPDATE_PROFILE_NO_KEY:2722,CANNOT_ADD_SELF_TO_BLACKLIST:2742,NETWORK_ERROR:2800,NETWORK_TIMEOUT:2801,NO_NETWORK:2805,UNCAUGHT_ERROR:2903,INVALID_OPERATION:2905,INVALID_TRTC_CMD:2995,OVER_FREQUENCY_LIMIT:2996,NO_PROTOCOL:2997,NO_MODULE:2998,SDK_IS_NOT_READY:2999,LOGGING_IN:3e3,LOGIN_FAILED:3001,KICKED_OUT_MULT_DEVICE:3002,KICKED_OUT_MULT_ACCOUNT:3003,KICKED_OUT_USERSIG_EXPIRED:3004,LOGGED_OUT:3005,KICKED_OUT_REST_API:3006,ILLEGAL_TOPIC_ID:3021,NO_USE:3122,PROFANITY_FOUND:3123,OPTIONS_IS_EMPTY:3153,MSG_A2KEY_EXPIRED:20002,ACCOUNT_A2KEY_EXPIRED:70001,HELLO_ANSWER_KICKED_OUT:1002,OPEN_SERVICE_OVERLOAD_ERROR:60022,SIGNALING_INVALID_INVITE_ID:8010,SIGNALING_NO_PERMISSION:8011,SIGNALING_ALREADY_EXISTS:8012,INVALID_CANCEL_MESSAGE:8020,MSG_SEARCH_CURSOR_INVALID:27002,MSG_SEARCH_CURSOR_EXPIRED:27003};let Js=null;const Xs=function(e){Js=e},Zs=function(e){return Promise.resolve(Ys(e))},Qs=function(t,s=!1){if(t instanceof zs)return s&&null!==Js&&Js.emit(e.ERROR,t),Promise.reject(t);if(t instanceof Error){const t=new zs({code:js.UNCAUGHT_ERROR});return s&&null!==Js&&Js.emit(e.ERROR,t),Promise.reject(t)}if($e(t)||$e(t.code))return Promise.reject(new zs({code:js.UNCAUGHT_ERROR}));t=new zs(t);return s&&null!==Js&&Js.emit(e.ERROR,t),Promise.reject(t)};class ei{constructor(e){this._m=e,this._n=""}isLoggedIn(){return this._m.get(vs).isLoggedIn()}isOversea(){return this._m.get(vs).isOversea()}isPrivateNetWork(){const e=this._m.get(vs);return e.isPrivateNetWork()&&!e.getFileDownloadProxy()}getFileDownloadProxy(){return this._m.get(vs).getFileDownloadProxy()}getDowloadFileAuthKey(){return this._m.get(vs).getDowloadFileAuthKey()}getMyUserID(){return this._m.get(vs).getUserID()}getMyTinyID(){return this._m.get(vs).getTinyID()}getSDKAppID(){return this._m.get(vs).getSDKAppID()}isIntl(){return this._m.get(vs).isIntl()}isUsingChatCore(){return this._m.get(vs).isUsingChatCore()}isDevMode(){return this._m.get(vs).isDevMode()}get(e){return this._m.get(e)}getPlatform(){return V}getCloudConfig(e){return this._m.get(Ps).getCloudConfig(e)}emitOEvt(e,t){this._m.getOEmitInst().emit(e,t)}emitIEvt(e,t){this._m.getIEmitInst().emit(e,t)}getIEmitInst(){return this._m.getIEmitInst()}req(e){return this._m.get(Os).req(e)}canIUse(e){return this._m.get(ws).canIUse(e)}getErrMsg(e,t,s){return this._m.getErrMsg(e,t,s)}warn(e,t,s){e=this.getErrMsg(e,t,s);e&&Ce.w(e)}noUse(e){var t=js.NO_USE;return Qs({code:t,message:this.getErrMsg(t,e)})}}const ti={LOGIN:"wslogin",LOGOUT:"wslogout",HELLO:"wshello",KICK_OTHER:"KickOther",SYNC_UNREAD_MSG:"getmsg",SEND_C2C_MSG:"sendmsg",SEND_GRP_MSG:"send_group_msg",GET_USER_PROFILE:"portrait_get_all",UPDATE_MY_PROFILE:"portrait_set",GET_BL:"black_list_get",ADD_TO_BL:"black_list_add",RM_FROM_BL:"black_list_delete",GET_FD_LIST:"friend_get",GET_FD_PROFILE:"friend_get_specified",CHECK_FD:"friend_check",DEL_FD:"friend_delete",ADD_FD:"friend_add",UPDATE_FD:"friend_update",RESPOND_FD_APPLICATION:"friend_response",GET_FD_APPLICATION_LIST:"pendency_get",DEL_FD_APPLICATION:"pendency_delete",REFUSE_FD_APPLICATION:"pendency_refuse",REPORT_FD_APPLICATION:"pendency_report",GET_FD_GRP_LIST:"group_get",CREATE_FD_GRP:"group_add",DEL_FD_GRP:"group_delete",UPDATE_FD_GRP:"group_update",REVOKE_C2C_MSG:"msgwithdraw",SET_C2C_MSG_READ:"msgreaded",SET_C2C_PEER_MUTE_NOTIFICATIONS:"set_c2c_peer_mute_notifications",GET_C2C_PEER_MUTE_NOTIFICATIONS:"get_c2c_peer_mute_notifications",GET_C2C_ROAMING_MSG:"getroammsg",GET_C2C_PEER_READ_TIME:"get_peer_read_time",DEL_C2C_MSG:"delete_c2c_msg_ramble",MODIFY_C2C_MSG:"modify_c2c_msg",MODIFY_C2C_MSG_EXT:"set_key_values",GET_C2C_MSG_EXT:"get_key_values",ADD_C2C_MSG_REACTION:"reaction_add",RM_C2C_MSG_REACTION:"reaction_del",GET_C2C_MSG_REACTIONS:"reaction_multi_stat",GET_C2C_MSG_REACTION_USER_LIST:"reaction_iterate",PAGING_GET_CONV_LIST:"page_get",DEL_CONV:"batch_delete",CLEAR_HISTORY_MSG:"clear_msg",PIN_CONV:"top",DEL_GROUP_AT_TIPS:"deletemsg",SET_CONV_CUSTOM_DATA:"set_conv_custom_data",MARK_CONV:"mark_contact",CREATE_CONV_GRP:"create_contact_group",DEL_CONV_GRP:"del_contact_group",RENAME_CONV_GRP:"update_contact_group",ADD_CONV_TO_GRP:"add_conv_to_group",DEL_CONV_FROM_GRP:"del_conv_from_group",GET_CONV_GRP_LIST:"get_contact_group",SEARCH_CONV_GRP_MARK:"search_contact_group",GET_GRP_LIST:"get_joined_group_list",GET_GRP_PROFILE:"get_group_self_member_info",CREATE_GRP:"create_group",DISMISS_GRP:"destroy_group",UPDATE_GRP_PROFILE:"modify_group_base_info",APPLY_JOIN_GRP:"apply_join_group",APPLY_JOIN_GRP_NOAUTH:"apply_join_group_noauth",QUIT_GRP:"quit_group",SEARCH_GRP:"get_group_public_info",CHANGE_GRP_OWNER:"change_group_owner",HANDLE_GRP_APPLICATION:"handle_apply_join_group",HANDLE_INVITE_JOIN_GRP:"handle_invite_join_permission_group",HANDLE_GRP_INVITATION:"handle_invite_join_group",REVOKE_GRP_MSG:"group_msg_recall",SET_GRP_MSG_READ:"msg_read_report",SET_ALL_MSG_READ:"read_all_unread_msg",GET_GRP_ROAMING_MSG:"group_msg_get",GET_READ_RECEIPT:"get_group_msg_receipt",SEND_READ_RECEIPT:"group_msg_receipt",SEND_C2C_READ_RECEIPT:"c2c_msg_read_receipt",GET_READ_RECEIPT_DETAIL:"get_group_msg_receipt_detail",GET_GRP_PENDENCY:"get_pendency",DEL_GRP_SYSTEM_NOTICE:"deletemsg",AV_POLLING:"get_msg",AV_NOAUTH_POLLING:"get_msg_noauth",GET_ONLINE_MBR_NUM:"get_online_member_num",DEL_GRP_MSG:"delete_group_ramble_msg_by_seq",MODIFY_GRP_MSG:"modify_group_msg",SET_GRP_ATTR:"set_group_attr",MODIFY_GRP_ATTR:"modify_group_attr",DEL_GRP_ATTR:"delete_group_attr",CLEAR_GRP_ATTR:"clear_group_attr",GET_GRP_ATTR:"get_group_attr",MODIFY_GRP_MSG_EXT:"group_set_key_values",GET_GRP_MSG_EXT:"group_get_key_values",GET_GRP_NOTIFY:"batch_get_group_notify",UPDATE_GRP_COUNTER:"update_group_counter",GET_GRP_COUNTER:"get_group_counter",ADD_GRP_MSG_REACTION:"group_reaction_add",RM_GRP_MSG_REACTION:"group_reaction_del",GET_GRP_MSG_REACTIONS:"group_reaction_multi_stat",GET_GRP_MSG_REACTION_USER_LIST:"group_reaction_iterate",GET_GRP_MBR_LIST:"get_group_member_info",GET_AV_MBR_LIST:"get_members",GET_GRP_MBR_PROFILE:"get_specified_group_member_info",ADD_GRP_MBR:"add_group_member",DEL_GRP_MBR:"delete_group_member",BAN_AV_MBR:"ban_group_member",MODIFY_GRP_MBR_INFO:"modify_group_member_info",MARK_AV_MBR_INFO:"modify_user_info",COS_SIGN:"cos",COS_PRE_SIG:"pre_sig",SIMPLE_COS_PRE_SIG:"simple_sig",GET_IMAGE_INFO:"get_imageinfo",GET_IP:"get_final_ip",VIDEO_COVER:"video_cover",SSO_STAT:"tim_web_report_v2",PING:"alive",MSG_PUSH:"msg_push",MSG_CLOUD_SEARCH:"query",MULTI_MSG_PUSH:"multi_msg_push_ws",MSG_PUSH_ACK:"ws_msg_push_ack",STATUS_FORCE_OFFLINE:"stat_forceoffline",UPLOAD_MERGER_MSG:"save_relay_json_msg",DOWNLOAD_MERGER_MSG:"get_relay_json_msg",FETCH_CLOUD_CTRL_CONFIG:"fetch_config",PUSHED_CLOUD_CTRL_CONFIG:"push_configv2",FETCH_COMMERCIAL_CONFIG:"fetch_imsdk_purchase_bitsv2",PUSHED_COMMERCIAL_CONFIG:"push_imsdk_purchase_bitsv2",OVERLOAD_NOTIFY:"notify2",CREATE_TOPIC:"create_topic",DEL_TOPIC:"destroy_topic",UPDATE_TOPIC_PROFILE:"modify_topic",GET_TOPIC_LIST:"get_topic",SET_SELF_STATUS:"ws_set_custom_status",GET_USER_STATUS:"ws_get_user_status",SUB_USER_STATUS:"ws_status_subscribe",UNSUB_USER_STATUS:"ws_status_unsubscribe",STAT_BACKGROUND:"ws_stat_background",STAT_FOREGROUND:"ws_stat_foreground",SET_TOKEN:"ws_stat_settoken",PUSH_REPORT:"uniapp_sdk_report",GET_PROFANITY_LIST:"get_local_words",TRANSLATE_TEXT:"ws_batch_trans_text",VOICE_TO_TEXT:"ws_sentence_recognition",FOLLOW:"follow_add",UNFOLLOW:"follow_delete",GET_FOLLOW:"follow_get",GET_FOLLOW_INFO:"follow_get_info",CHECK_FOLLOW_TYPE:"follow_check",SET_ALL_RECEIVE_MSG_OPT:"ws_set_do_not_disturb",GET_ALL_RECEIVE_MSG_OPT:"ws_get_do_not_disturb"},si="networkRTT",ii="messageE2EDelay",ni="sendMessageC2C",oi="sendMessageGroup",ri="sendMessageGroupAV",ai="sendMessageRichMedia",ci="cosUpload",li="messageReceivedGroup",ui="messageReceivedGroupAVPush",di="messageReceivedGroupAVPull",_i={[si]:2,[ii]:3,[ni]:4,[oi]:5,[ri]:6,[ai]:7,[li]:8,[ui]:9,[di]:10,[ci]:11},hi={info:4,warning:5,error:6},pi={wifi:1,"2g":2,"3g":3,"4g":4,"5g":5,unknown:6,none:7,online:8},gi={login:4,plugin_search:16,plugin_translate:16,plugin_voice_to_text:16,plugin_cs:16,plugin_push:16,plugin_bot:16,plugin_emoji_reaction:16};class mi{constructor(e){this._n="SSOLogData",this.eventType=gi[e]||0,this.timestamp=0,this.networkType=8,this.code=0,this.message="",this.moreMessage="",this.extension=e,this.costTime=0,this.duplicate=!1,this.level=4,this.uiPlatform=void 0,this._sentFlag=!1,this._startts=pe()}static bindEventStatModule(e){mi.prototype._eventStatModule=e}static bindNetMonitorModule(e){mi.prototype._netMonitorModule=e}updateTimeStamp(){this.timestamp=pe()}start(e){return this._startts=e,this}end(e=!1){if(!this._sentFlag){if(this._netMonitorModule){const e=this._netMonitorModule.getNetworkType();this.setNetworkType(e)}var t=pe();0===this.costTime&&(this.costTime=t-this._startts),this.setMoreMessage(`startts:${this._startts} endts:`+t),e?(this._sentFlag=!0,this._eventStatModule&&this._eventStatModule.pushIn(this)):setTimeout(()=>{this._sentFlag=!0,this._eventStatModule&&this._eventStatModule.pushIn(this)},0)}}setError(e){if(!(e instanceof Error))return Ce.w(this._n+".setError value not instanceof Error, please check!"),this;if(this._sentFlag)return this;let t=!0;if(t=this._netMonitorModule?this._netMonitorModule.isOnline():t)e.code&&this.setCode(e.code),e.message&&this.setMoreMessage(e.message);else{const e=js.NO_NETWORK;this.setCode(e)}return this.setLevel("error"),this}setCode(e){return $e(e)||this._sentFlag||("ECONNABORTED"===e&&(this.code=103),Ge(e)?this.code=e:Ce.w(this._n+".setCode value not a number, please check!",e,typeof e)),this}setMessage(e){return $e(e)||this._sentFlag||(Ge(e)&&(this.message=e.toString()),ke(e)&&(this.message=e)),this}setCostTime(e){return this.costTime=e,this}setLevel(e){return $e(e)||this._sentFlag||(this.level=hi[e]),this}setMoreMessage(e){return Oe(this.moreMessage)?this.moreMessage=""+e:this.moreMessage+=" "+e,this}setNetworkType(e){return $e(e)?Ce.w(this._n+".setNetworkType value is undefined, please check!"):(e=pi[e.toLowerCase()],$e(e)||(this.networkType=e)),this}getStartTs(){return this._startts}setUIPlatform(e){return this.uiPlatform=e,this}setExtension(e){return this.extension=e,this}setEventType(e){return this.eventType=e,this}}class fi{constructor(e){this.type=t.MSG_TEXT,this.content={text:e.text||""}}setText(e){this.content.text=e}sendable(){return 0!==this.content.text.length}}function Mi(t,s,i,o=[]){if(t){let e=t;return s&&(t.startsWith("http://")?e=t.replace(/^http:\/\/[^/]+/,s):t.startsWith("https://")&&(e=t.replace(/^https:\/\/[^/]+/,s))),e=i&&-1===e.indexOf("authKey=")&&Ti(e,o)?-1<e.indexOf("?")?e+"&authKey="+i:e+"?authKey="+i:e}}function Ii(e,s,i=[]){if(e===t.MSG_VIDEO)Ti((s[0].content||s[0].payload).snapshotUrl,i)&&(s[0].content?(s[0].content.snapshotUrl=Ci(s[0].content.snapshotUrl),s[0].content.thumbUrl=Ci(s[0].content.thumbUrl)):(s[0].payload.snapshotUrl=Ci(s[0].payload.snapshotUrl),s[0].payload.thumbUrl=Ci(s[0].payload.thumbUrl)));else if(e===t.MSG_FILE)Ti((s[0].content||s[0].payload).fileUrl,i)&&(s[0].content?s[0].content.fileUrl=Ci(s[0].content.fileUrl):s[0].payload.fileUrl=Ci(s[0].payload.fileUrl));else if(e===t.MSG_MERGER){const{downloadKey:e="",messageList:t=[]}=s[0].content||s[0].payload;Oe(e)&&t.forEach(e=>{Ii(e.messageBody[0].type,e.messageBody)})}return s}function Ci(e){if(!e)return e;if(-1===e.indexOf("authKey="))return e;const t=e.split("?"),s=t[1].split("&");let i=0;for(let e=0;e<s.length;e++)if(-1<s[e].indexOf("authKey=")){i=e;break}return s.splice(i,1),0<s.length?t[0]+"?"+s.join("&"):t[0]}function Ti(e,t){let s=!1;if(e){const i=e.match(/:\/\/([0-9]?\.)?(.[^/:]+)/),o=i&&i[2]||"";if(o.includes("rich-dev"))return!0;for(let e=0;e<t.length;e++)if(o.endsWith(t[e])){s=!0;break}}return s}class yi{constructor(e,s,i,o){this._imageMemoryURL="",this._fileDownloadProxy=s,this._authKey=i,this._fileDNList=o,k||F?this.createImageDataASURL(e.file):this.createImageDataASURLInWeb(e.file),this._initImageInfoModel(),this.type=t.MSG_IMAGE,this._percent=0,this.content={imageFormat:e.imageFormat||Te.UNKNOWN,uuid:e.uuid,imageInfoArray:[]},this.initImageInfoArray(e.imageInfoArray),this._autoFixUrl()}_initImageInfoModel(){const t=this;this._ImageInfoModel=function(e){this.instanceID=je(9999999),this.sizeType=e.type||0,this.type=0,this.size=e.size||0,this.width=e.width||0,this.height=e.height||0,this.imageUrl=e.imageUrl||e.url||"",this.url=Mi(e.url||t._imageMemoryURL,t._fileDownloadProxy,t._authKey,t._fileDNList)},this._ImageInfoModel.prototype={setSizeType(e){this.sizeType=e},setType(e){this.type=e},setImageUrl(e){e&&(this.imageUrl=e)},getImageUrl(){return this.imageUrl}}}initImageInfoArray(e){let t=0,s=null,i;for(;t<=2;)i=$e(e)||$e(e[t])?{type:0,size:0,width:0,height:0,url:""}:e[t],(s=new this._ImageInfoModel(i)).setSizeType(t+1),s.setType(t),this.addImageInfo(s),t++;this.updateAccessSideImageInfoArray()}updateImageInfoArray(t){var s=this.content.imageInfoArray.length;let i;for(let e=0;e<s;e++)i=this.content.imageInfoArray[e],t[e].size&&(i.size=t[e].size),t[e].url&&i.setImageUrl(t[e].url),t[e].width&&(i.width=t[e].width),t[e].height&&(i.height=t[e].height)}_autoFixUrl(){var t=this.content.imageInfoArray.length;let s="",i="";const o=["http","https"];let n=null;for(let e=0;e<t;e++)this.content.imageInfoArray[e].url&&(""!==(n=this.content.imageInfoArray[e]).imageUrl&&(i=n.imageUrl.slice(0,n.imageUrl.indexOf("://")+1),s=n.imageUrl.slice(n.imageUrl.indexOf("://")+1),o.indexOf(i)<0&&(i="https:"),this.content.imageInfoArray[e].setImageUrl([i,s].join(""))))}updatePercent(e){this._percent=e,1<this._percent&&(this._percent=1)}updateImageFormat(e){this.content.imageFormat=Te[e.toUpperCase()]||Te.UNKNOWN}createImageDataASURLInWeb(e){void 0!==e&&0<e.files.length&&(this._imageMemoryURL=window.URL.createObjectURL(e.files[0]))}createImageDataASURL(e){e&&e.url&&(this._imageMemoryURL=e.url)}replaceImageInfo(e,t){this.content.imageInfoArray[t]instanceof this._ImageInfoModel||(this.content.imageInfoArray[t]=e)}addImageInfo(e){3<=this.content.imageInfoArray.length||this.content.imageInfoArray.push(e)}updateAccessSideImageInfoArray(){var e=this.content.imageInfoArray,{width:t=0,height:s=0}=e[0];0!==t&&0!==s&&(gt(e),Object.assign(e[2],pt({originWidth:t,originHeight:s,min:720})))}sendable(){return 0!==this.content.imageInfoArray.length&&""!==this.content.imageInfoArray[0].imageUrl&&0!==this.content.imageInfoArray[0].size}}class vi{constructor(e){this.type=t.MSG_FACE,this.content=e||null}sendable(){return null!==this.content}}class Ei{constructor(e,s,i,o){this.type=t.MSG_AUDIO,this._percent=0,this.content={downloadFlag:2,second:e.second,size:e.size,url:Mi(e.url,s,i,o),remoteAudioUrl:e.url||"",uuid:e.uuid}}updatePercent(e){this._percent=e,1<this._percent&&(this._percent=1)}updateAudioUrl(e){this.content.remoteAudioUrl=e}sendable(){return""!==this.content.remoteAudioUrl}}const Si={from:!0,groupID:!0,groupName:!0,to:!0};class Di{constructor(e){this.type=t.MSG_GRP_TIP,this.content={},this._initContent(e)}_initContent(t){Object.keys(t).forEach(e=>{switch(e){case"remarkInfo":break;case"groupProfile":this.content.groupProfile={},this._initGroupProfile(t[e]);break;case"operatorInfo":this.content.operatorInfo={},this._initOperatorInfo(t[e]);break;case"memberInfoList":case"msgMemberInfo":this._updateMemberList(t[e]);break;case"memberExtraInfo":case"onlineMemberInfo":break;case"memberNum":this.content[e]=t[e],this.content.memberCount=t[e];break;case"newGroupProfile":this.content.newGroupProfile={},this._initNewGroupProfile(t[e]);break;default:this.content[e]=t[e]}}),this.content.userIDList||(this.content.userIDList=[this.content.operatorID])}_initGroupProfile(t){var s=Object.keys(t);for(let e=0;e<s.length;e++){var i=s[e];Si[i]&&(this.content.groupProfile[i]=t[i])}}_initOperatorInfo(t){var s=Object.keys(t);for(let e=0;e<s.length;e++){var i=s[e];this.content.operatorInfo[i]=t[i]}}_updateMemberList(e){Oe(this.content.memberList)?this.content.memberList=e:this.content.memberList.forEach(t=>{e.forEach(e=>{t.userID===e.userID&&Object.assign(t,e)})})}_initNewGroupProfile(t){var s=Object.keys(t);for(let e=0;e<s.length;e++){var i=s[e];this.content.newGroupProfile[i]="muteAllMembers"!==i?t[i]:1===t[i]}}}const Ri={from:!0,groupID:!0,groupName:!0,to:!0,groupType:!0};class Li{constructor(e){this.type=t.MSG_GRP_SYS_NOTICE,this.content={},this._initContent(e)}_initContent(t){Object.keys(t).forEach(e=>{switch(e){case"memberInfoList":break;case"remarkInfo":this.content.handleMessage=t[e];break;case"groupProfile":this.content.groupProfile={},this._initGroupProfile(t[e]);break;default:this.content[e]=t[e]}})}_initGroupProfile(t){var s=Object.keys(t);for(let e=0;e<s.length;e++){var i=s[e];Ri[i]&&("groupName"===i?this.content.groupProfile.name=t[i]:this.content.groupProfile[i]=t[i])}}}class Ai{constructor(e,s,i,o){this.type=t.MSG_FILE,this._percent=0;var n=this._getFileInfo(e);this.content={downloadFlag:2,fileUrl:Mi(e.url||e.fileUrl,s,i,o)||"",uuid:e.uuid,fileName:n.name||"",fileSize:n.size||0}}_getFileInfo(e){if(!$e(e.fileName)&&!$e(e.fileSize))return{size:e.fileSize,name:e.fileName};const t=e.file.files[0];if(P){if(t.path&&-1!==t.path.indexOf(".")){const e=t.path.slice(t.path.lastIndexOf(".")+1).toLowerCase();t.type=e,t.name||(t.name=je(999999)+"."+e)}t.name||(t.type="",t.name=t.path.slice(t.path.lastIndexOf("/")+1).toLowerCase()),t.suffix&&(t.type=t.suffix),t.url||(t.url=t.path)}return{size:t.size,name:t.name}}updatePercent(e){this._percent=e,1<this._percent&&(this._percent=1)}updateFileUrl(e){this.content.fileUrl=e}sendable(){return""!==this.content.fileUrl&&""!==this.content.fileName&&0!==this.content.fileSize}}class Oi{constructor(e){this.type=t.MSG_CUSTOM,this.content={data:e.data||"",description:e.description||"",extension:e.extension||""}}setData(e){return this.content.data=e,this}setDescription(e){return this.content.description=e,this}setExtension(e){return this.content.extension=e,this}sendable(){return 0!==this.content.data.length||0!==this.content.description.length||0!==this.content.extension.length}}class Ni{constructor(e,s,i,o){this.type=t.MSG_VIDEO,this._percent=0,this.content={remoteVideoUrl:e.remoteVideoUrl||e.videoUrl||"",videoFormat:e.videoFormat,videoSecond:parseInt(e.videoSecond,10),videoSize:e.videoSize,videoUrl:Mi(e.videoUrl,s,i,o),videoDownloadFlag:2,videoUUID:e.videoUUID,thumbUUID:e.thumbUUID,thumbFormat:e.thumbFormat,thumbWidth:e.thumbWidth,snapshotWidth:e.thumbWidth,thumbHeight:e.thumbHeight,snapshotHeight:e.thumbHeight,thumbSize:e.thumbSize,snapshotSize:e.thumbSize,thumbDownloadFlag:2,thumbUrl:Mi(e.thumbUrl,s,i,o),snapshotUrl:Mi(e.thumbUrl,s,i,o)}}updatePercent(e){this._percent=e,1<this._percent&&(this._percent=1)}updateVideoUrl(e){e&&(this.content.remoteVideoUrl=e)}updateSnapshotInfo(e){var{snapshotUrl:e,snapshotWidth:t,snapshotHeight:s}=e;Oe(e)||(this.content.thumbUrl=this.content.snapshotUrl=e),Oe(t)||(this.content.thumbWidth=this.content.snapshotWidth=Number(t)),Oe(s)||(this.content.thumbHeight=this.content.snapshotHeight=Number(s))}sendable(){return""!==this.content.remoteVideoUrl}}class Pi{constructor(e){this.type=t.MSG_LOCATION;var{description:e,longitude:s,latitude:i}=e;this.content={description:e,longitude:s,latitude:i}}sendable(){return!0}}class Ui{constructor(e,s,i,o){var n,r;this.from=e.from,this.messageSender=e.from,this.time=e.time,this.messageSequence=e.sequence,this.clientSequence=e.clientSequence||e.sequence,this.messageRandom=e.random,this.cloudCustomData=e.cloudCustomData||"",this.clientTime=e.clientTime||void 0,e.ID?(this.ID=e.ID||"",this.nick=e.nick||"",this.avatar=e.avatar||"",e.messageBody?this.messageBody=JSON.parse(JSON.stringify(e.messageBody)):this.messageBody=[{type:e.type,payload:e.payload}],e.conversationType?e.conversationType.startsWith(t.CONV_C2C)?this.receiverUserID=e.to:e.conversationType.startsWith(t.CONV_GROUP)&&(this.receiverGroupID=e.to):e.receiverGroupID?this.receiverGroupID=e.receiverGroupID:e.receiverUserID&&(this.receiverUserID=e.receiverUserID),this.messageReceiver=e.to||e.messageReceiver):(this.nick=e.nick||"",this.avatar=e.avatar||"",this.messageBody=[],n=e.elements[0].type,r=e.elements[0].content,this._patchRichMediaPayload(n,r),this._updateRichMediaDownloadUrl(n,r,s,i,o),n===t.MSG_MERGER?this.messageBody.push({type:n,payload:new Gi(r,s,i,o).content}):this.messageBody.push({type:n,payload:r}),e.groupID&&(this.receiverGroupID=e.groupID,this.messageReceiver=e.groupID),e.to&&(this.receiverUserID=e.to,this.messageReceiver=e.to),this.ID=`${e.tinyID}-${e.clientTime}-`+e.random)}_patchRichMediaPayload(e,s){e===t.MSG_IMAGE?s.imageInfoArray.forEach(e=>{!e.imageUrl&&e.url&&(e.imageUrl=e.url,e.sizeType=e.type,1===e.type?e.type=0:3===e.type&&(e.type=1))}):e===t.MSG_VIDEO?!s.remoteVideoUrl&&s.videoUrl&&(s.remoteVideoUrl=s.videoUrl):e===t.MSG_AUDIO?!s.remoteAudioUrl&&s.url&&(s.remoteAudioUrl=s.url):e===t.MSG_FILE&&!s.fileUrl&&s.url&&(s.fileUrl=s.url,s.url=void 0)}_updateRichMediaDownloadUrl(e,s,i,o,n){(i||o)&&(e===t.MSG_IMAGE?s.imageInfoArray.forEach(e=>{e.url=Mi(e.url,i,o,n)}):e===t.MSG_VIDEO?(s.videoUrl=Mi(s.videoUrl,i,o,n),s.snapshotUrl=Mi(s.thumbUrl,i,o,n),s.snapshotHeight=s.thumbHeight,s.snapshotWidth=s.thumbWidth):e===t.MSG_AUDIO?s.url=Mi(s.url,i,o,n):e===t.MSG_FILE&&(s.fileUrl=Mi(s.fileUrl,i,o,n)))}}var Gi=class{constructor(e,s,i,o){if(this.type=t.MSG_MERGER,this.content={downloadKey:"",pbDownloadKey:"",messageList:[],title:"",abstractList:[],compatibleText:"",version:0,layersOverLimit:!1},e.downloadKey){const{downloadKey:t,pbDownloadKey:s,title:i,abstractList:o,compatibleText:n,version:r}=e;this.content.downloadKey=t,this.content.pbDownloadKey=s,this.content.title=i,this.content.abstractList=o,this.content.compatibleText=n,this.content.version=r||0}else if(Oe(e.messageList))1===e.layersOverLimit&&(this.content.layersOverLimit=!0);else{const{messageList:t,title:a,abstractList:c,compatibleText:l,version:_}=e,d=[];t.forEach(e=>{Oe(e)||(e=new Ui(e,s,i,o),d.push(e))}),this.content.messageList=d,this.content.title=a,this.content.abstractList=c,this.content.compatibleText=l,this.content.version=_||0}}sendable(){return!Oe(this.content.messageList)||!Oe(this.content.downloadKey)}};const ki={1:t.MSG_PRIORITY_HIGH,2:t.MSG_PRIORITY_NORMAL,3:t.MSG_PRIORITY_LOW,4:t.MSG_PRIORITY_LOWEST};class wi{constructor(e){this.ID="",this.conversationID=e.conversationID||null,this.conversationType=e.conversationType||t.CONV_C2C,this.conversationSubType=e.conversationSubType,this.time=e.time||Math.ceil(Date.now()/1e3),this.sequence=e.sequence||0,this.clientSequence=e.clientSequence||e.sequence||0,this.random=e.random||0===e.random?e.random:je(),this.priority=this._computePriority(e.priority),this.nick=e.nick||"",this.avatar=e.avatar||"",this.isPeerRead=!1,this.nameCard="",this.hasRiskContent=Dt(e.checkResult),this._elements=[],this.isPlaceMessage=e.isPlaceMessage||0,this.isRevoked=2===e.isPlaceMessage||8===e.msgFlagBits,this.from=e.from||null,this.to=e.to||null,this.flow="",this.isSystemMessage=e.isSystemMessage||!1,this.protocol=e.protocol||"JSON",this.isResend=!1,this.isRead=!1,this.status=e.status||Ot,this._onlineOnlyFlag=!1,this._groupAtInfoList=[],this._relayFlag=!1,this.atUserList=[],this.cloudCustomData=e.cloudCustomData||"",this.isDeleted=!1,this.isModified=!!e.messageVersion,this._isExcludedFromUnreadCount=!(!e.messageControlInfo||1!==e.messageControlInfo.excludedFromUnreadCount),this._isExcludedFromLastMessage=!(!e.messageControlInfo||1!==e.messageControlInfo.excludedFromLastMessage),this.clientTime=e.clientTime||me()||0,this.senderTinyID=e.senderTinyID||e.tinyID||"",this.readReceiptInfo=e.readReceiptInfo||{readCount:void 0,unreadCount:void 0,isPeerRead:void 0,timestamp:0},this.needReadReceipt=!0===e.needReadReceipt||1===e.needReadReceipt,this.version=e.messageVersion||0,this.isBroadcastMessage=e.isBroadcastMessage||!1,this._receiverList=e.receiverList||void 0,this.isSupportExtension=!0===e.isSupportExtension||1===e.isSupportExtension,this._cmConfigID=e.customModerationConfigurationID,this.revoker=e.revokerInfo&&e.revokerInfo.revoker||"",this.revokerInfo=e.revokerInfo||{userID:"",nick:"",avatar:""},this.revokeReason=e.revokeReason||"",this.reInitialize(e.currentUser),this.extractGroupInfo(e.groupProfile||null),this.handleGroupAtInfo(e),this.initC2CReadReceiptInfo(e)}get elements(){return this._elements}getElements(){return this._elements}extractGroupInfo(e){null!==e&&(ke(e.nick)&&(this.nick=e.nick),ke(e.avatar)&&(this.avatar=e.avatar),e=e["messageFromAccountExtraInformation"],Fe(e)&&ke(e.nameCard)&&(this.nameCard=e.nameCard))}handleGroupAtInfo(e){e.payload&&e.payload.atUserList&&e.payload.atUserList.forEach(e=>{e!==t.MSG_AT_ALL?(this._groupAtInfoList.push({groupAtAllFlag:0,groupAtUserID:e}),this.atUserList.push(e)):(this._groupAtInfoList.push({groupAtAllFlag:1}),this.atUserList.push(t.MSG_AT_ALL))}),be(e.groupAtInfo)&&e.groupAtInfo.forEach(e=>{0===e.groupAtAllFlag?this.atUserList.push(e.groupAtUserID):1===e.groupAtAllFlag&&this.atUserList.push(t.MSG_AT_ALL)})}getGroupAtInfoList(){return this._groupAtInfoList}_initProxy(){this._elements[0]&&(this.payload=this._elements[0].content,this.type=this._elements[0].type)}reInitialize(e){e&&(this.status=this.from?Ot:At,this.from||(this.from=e)),this._initFlow(e),this._initSequence(e),this._concatConversationID(e),this.generateMessageID()}isSendable(){return 0!==this._elements.length&&(!0===this._relayFlag||"function"==typeof this._elements[0].sendable&&this._elements[0].sendable())}_initTo(e){this.conversationType===t.CONV_GROUP&&(this.to=e.groupID)}_initSequence(e){0===this.clientSequence&&e&&(this.clientSequence=function(i){if(!i)return!1;if(void 0===Qe[i]){const o=new Date;let e=("3"+o.getHours()).slice(-2),t=("0"+o.getMinutes()).slice(-2),s=("0"+o.getSeconds()).slice(-2);Qe[i]=parseInt([e,t,s,"0001"].join("")),e=null,t=null,s=null,Ce.l("autoIncrementIndex start index:"+Qe[i])}return Qe[i]++}(e)),0===this.sequence&&this.conversationType===t.CONV_C2C&&(this.sequence=this.clientSequence)}generateMessageID(){this.from===t.CONV_SYSTEM&&(this.senderTinyID="144115198244471703"),this.ID=`${this.senderTinyID}-${this.clientTime}-`+this.random}_initFlow(e){""!==e&&(e===this.from?(this.flow="out",this.isRead=!0):this.flow="in")}_concatConversationID(e){var s=this["to"],i=this.conversationType;i!==t.CONV_SYSTEM?(e=i===t.CONV_C2C?e===this.from?s:this.from:this.to,this.conversationID=e?""+i+e:null):this.conversationID=t.CONV_SYSTEM}isElement(e){return e instanceof fi||e instanceof yi||e instanceof vi||e instanceof Ei||e instanceof Ai||e instanceof Ni||e instanceof Di||e instanceof Li||e instanceof Oi||e instanceof Pi||e instanceof Gi}setElement(s,i,o,n){if(this.isElement(s))return this._elements=[s],void this._initProxy();var r=e=>{if(e.type&&e.content)switch(e.type){case t.MSG_TEXT:this.setTextElement(e.content);break;case t.MSG_IMAGE:this.setImageElement(e.content,i,o,n);break;case t.MSG_AUDIO:this.setAudioElement(e.content,i,o,n);break;case t.MSG_FILE:this.setFileElement(e.content,i,o,n);break;case t.MSG_VIDEO:this.setVideoElement(e.content,i,o,n);break;case t.MSG_CUSTOM:this.setCustomElement(e.content);break;case t.MSG_LOCATION:this.setLocationElement(e.content);break;case t.MSG_GRP_TIP:this.setGroupTipElement(e.content);break;case t.MSG_GRP_SYS_NOTICE:this.setGroupSystemNoticeElement(e.content);break;case t.MSG_FACE:this.setFaceElement(e.content);break;case t.MSG_MERGER:this.setMergerElement(e.content,i,o,n)}};if(be(s))for(let e=0;e<s.length;e++)r(s[e]);else r(s);this._initProxy()}clearElement(){this._elements.length=0}setTextElement(e){e="string"==typeof e?e:e.text,e=new fi({text:e});this._elements.push(e)}setImageElement(e,t,s,i){e=new yi(e,t,s,i);this._elements.push(e)}setAudioElement(e,t,s,i){e=new Ei(e,t,s,i);this._elements.push(e)}setFileElement(e,t,s,i){e=new Ai(e,t,s,i);this._elements.push(e)}setVideoElement(e,t,s,i){e=new Ni(e,t,s,i);this._elements.push(e)}setLocationElement(e){e=new Pi(e);this._elements.push(e)}setCustomElement(e){e=new Oi(e);this._elements.push(e)}setGroupTipElement(e){let s={};var i=e.operationType;if(Oe(e.memberInfoList)?e.operatorInfo&&(s=e.operatorInfo):i!==t.GRP_TIP_MBR_JOIN&&i!==t.GRP_TIP_MBR_KICKED_OUT&&i!==t.GRP_TIP_MBR_SET_ADMIN&&i!==t.GRP_TIP_MBR_CANCELED_ADMIN||(s=e.memberInfoList[0]),!Oe(e.memberExtraInfo)){const t=e.memberExtraInfo["reason"];e.msgMemberInfo.forEach(e=>{e.reason=t})}var{nick:i,avatar:o}=s,i=(ke(i)&&(this.nick=i),ke(o)&&(this.avatar=o),new Di(e));this._elements.push(i)}setGroupSystemNoticeElement(e){e=new Li(e);this._elements.push(e)}setFaceElement(e){e=new vi(e);this._elements.push(e)}setMergerElement(e,t,s,i){e=new Gi(e,t,s,i);this._elements.push(e)}setIsRead(e){this.isRead=e}setRelayFlag(e){this._relayFlag=e}_computePriority(e){if($e(e))return t.MSG_PRIORITY_NORMAL;if(ke(e)&&-1!==Object.values(ki).indexOf(e))return e;if(Ge(e)){const t=""+e;if(-1!==Object.keys(ki).indexOf(t))return ki[t]}return t.MSG_PRIORITY_NORMAL}setNickAndAvatar(e){var{nick:e,avatar:t}=e;ke(e)&&(this.nick=e),ke(t)&&(this.avatar=t)}setNameCard(e){ke(e)&&(this.nameCard=e)}initC2CReadReceiptInfo(e){var{readReceiptSentByPeer:e,timestamp:s=0}=e;this.conversationType===t.CONV_C2C&&!0===this.needReadReceipt&&(this.readReceiptInfo.isPeerRead=1===e,this.readReceiptInfo.timestamp=s)}}function Fi(e){var t=e.lastIndexOf(".");return-1===t?e:e.slice(0,t)}function bi(e){var{androidInfo:e={},androidOPPOChannelID:t=""}=e,t=e.OPPOChannelID||t;return{...e,Sound:Fi(e.sound||""),OPPOChannelID:t,GoogleChannelID:e.FCMChannelID||""}}function $i(e){var{apnsInfo:e={},ignoreIOSBadge:t=!1,disableVoipPush:s}=e,t=!0===e.ignoreIOSBadge||!0===t?1:0;let i=void 0;return $e(s)||(i=!1===s?1:0),$e(e.disableVoipPush)||(i=!1===e.disableVoipPush?1:0),{...e,badgeMode:t,isVoipPush:i}}function qi(e){if(Fe(e))return{pushFlag:!0===e.disablePush?1:0,title:e.title||"",desc:e.description||"",ext:e.extension||"",apnsInfo:$i(e),androidInfo:bi(e)}}class xi extends ei{constructor(e){super(e),this._n="C2CModule",this._msgFromUnreadDBMap=new Map,this._noticeFromUnreadDBList=[]}onNewMessage(t){var{dataList:t,isInstantMessage:s,C2CRemainingUnreadList:i,C2CPairUnreadList:o,isSyncingEnded:n}=t;s||Ce.l(this._n+".onNewMessage C2CPairUnreadList:",o,"C2CRemainingUnreadList:",i);const{conversationOptionsList:r,messageList:a,isUnreadC2CMessage:c}=this._assembly({dataList:t,C2CRemainingUnreadList:i,C2CPairUnreadList:o,isInstantMessage:s}),l=Oe(t=a)?[]:t.filter(e=>!0===e.isModified);0<l.length&&this.emitOEvt(e.MESSAGE_MODIFIED,l),this.get(ys).onNewMessage({conversationOptionsList:r,isInstantMessage:s,isUnreadC2CMessage:c,isSyncingEnded:n});o=Oe(i=a)?[]:i.filter(e=>!1===e.isModified);s&&0<o.length&&this.emitOEvt(e.MESSAGE_RECEIVED,o),a.length=0}_assembly({dataList:o,C2CRemainingUnreadList:n,C2CPairUnreadList:r,isInstantMessage:a}){let c=null;const l=[],d=[],s={},h=this.get(ks);let _=!1;const u=this.get(ys),p=this.get(fs),e=this.get(Rs),g=this.getFileDownloadProxy(),m=this.getDowloadFileAuthKey(),f=e.getFileDNList();for(let i=0,e=o.length;i<e;i++)if(this._isC2CNotice(o[i]))this._noticeFromUnreadDBList.push(o[i].eventArray[0].c2CNotifyMsgArray[0]);else{const n=o[i],r=(n.currentUser=this.getMyUserID(),n.conversationType=t.CONV_C2C,n.isSystemMessage=!!n.isSystemMessage,($e(n.nick)||$e(n.avatar))&&(_=!0),(c=new wi(n)).setElement(n.elements,g,m,f),c.setNickAndAvatar({nick:n.nick,avatar:n.avatar}),c)["conversationID"];if(a){if(this._msgFromUnreadDBMap.get(c.ID))continue;let e=!1;if(c.from!==this.getMyUserID()){const o=u.getLatestMessageSentByPeer(r);if(o){const{nick:n,avatar:r}=o;_?c.setNickAndAvatar({nick:n,avatar:r}):n===c.nick&&r===c.avatar||(e=!0)}}else{const o=u.getLatestMessageSentByMe(r);if(o){const{nick:t,avatar:n}=o;t===c.nick&&n===c.avatar||(u.modifyMessageSentByMe({conversationID:r,latestNick:c.nick,latestAvatar:c.avatar}),p.mockOnNickAvatarModified(c.nick,c.avatar))}}let s=1===o[i].isModified;if(u.isMessageSentByCurrentInstance(c)?c.isModified=s:s=!1,0===n.msgLifeTime)c._onlineOnlyFlag=!0,u.isMessageSentByCurrentInstance(c)||d.push(c);else{if(!u.pushIntoMessageList(d,c,s))continue;e&&(u.modifyMessageSentByPeer({conversationID:r,latestNick:c.nick,latestAvatar:c.avatar}),u.updateUserProfileSpecifiedKey({conversationID:r,nick:c.nick,avatar:c.avatar}))}a&&0<c.clientTime&&h.addMessageDelay(c.clientTime)}else this._msgFromUnreadDBMap.set(c.ID,c);if(0!==n.msgLifeTime){if(!1===c._onlineOnlyFlag){const o=u.getLastMessageTime(r);if(!(Ge(o)&&c.time<o)&&a)if($e(s[r])){let e=0;"in"===c.flow&&(c._isExcludedFromUnreadCount||(e=1)),s[r]=l.push({conversationID:r,unreadCount:e,type:c.conversationType,subType:c.conversationSubType,lastMessage:c._isExcludedFromLastMessage?"":c})-1}else{const o=s[r];l[o].type=c.conversationType,l[o].subType=c.conversationSubType,l[o].lastMessage=c._isExcludedFromLastMessage?"":c,"in"===c.flow&&(c._isExcludedFromUnreadCount||l[o].unreadCount++)}}}else c._onlineOnlyFlag=!0}this._handleNoticeFromUnreadDB();let i=!1;if(be(r)&&0<r.length)for(let s=0,e=r.length;s<e;s++)if(r[s].from!==t.CONV_SYSTEM){i=!0;const o=l.find(({conversationID:e})=>e===""+t.CONV_C2C+r[s].from);o?o.unreadCount=r[s].unreadCount:l.push({conversationID:""+t.CONV_C2C+r[s].from,unreadCount:r[s].unreadCount,type:t.CONV_C2C})}if(be(n))for(let s=0,e=n.length;s<e;s++)l.find(({conversationID:e})=>e===""+t.CONV_C2C+n[s].from)||l.push({conversationID:""+t.CONV_C2C+n[s].from,type:t.CONV_C2C,lastMsgTime:n[s].lastMsgTime});return{conversationOptionsList:l,messageList:d,isUnreadC2CMessage:i}}getMessageListFromUnreadDB(){return[...this._msgFromUnreadDBMap.values()]}_isC2CNotice(e){e=e.eventArray;return!(!be(e)||10!==e[0].event)}_handleNoticeFromUnreadDB(){var e=this._noticeFromUnreadDBList.length;if(0!==e){Ce.l(this._n+"._handleNoticeFromUnreadDB count:"+e);const t=[];this._noticeFromUnreadDBList.forEach(e=>{e.hasOwnProperty("c2cMessageRevokedNotify")&&t.push(e)}),this.onMsgRevoked({dataList:t}),this._noticeFromUnreadDBList.length=0,t.length=0}}onMsgRevoked(s){const r=this.get(ys),a=[];let c;s.dataList.forEach(e=>{if(e.c2cMessageRevokedNotify){const s=e.c2cMessageRevokedNotify["revokedInfos"];$e(s)||s.forEach(e=>{var s=this.getMyUserID()===e.from?""+t.CONV_C2C+e.to:""+t.CONV_C2C+e.from,i=(c=r.revoke(s,e.sequence,e.random),e.revokerInfo&&e.revokerInfo.revoker),o=e.revokerInfo&&e.revokerInfo.reason||"";let n;c?n=c:(n={conversationID:s,sequence:e.sequence},e.tinyID&&e.clientTime&&e.random&&(n.ID=`${e.tinyID}-${e.clientTime}-`+e.random),e.time&&(n.time=e.time)),n&&(n.revoker=i,n.revokeReason=o,n.revokerInfo={userID:i,nick:"",avatar:""},a.push(n))})}}),0!==a.length&&(r.onMessageRevoked(a),Ce.l(this._n+".onMsgRevoked count:"+a.length),r.updateRevokerInfo(a).then(t=>{this.emitOEvt(e.MESSAGE_REVOKED,t)}))}onMsgReadReceipt(e){e.dataList.forEach(e=>{if(!Oe(e.c2cMessageReadReceipt)){const o=e.c2cMessageReadReceipt["to"];e.c2cMessageReadReceipt.uinPairReadArray.forEach(e=>{e=e.peerReadTime;Ce.l(`${this._n}.onMsgReadReceipt to:${o} peerReadTime:`+e);const s=""+t.CONV_C2C+o,i=this.get(ys);i.recordPeerReadTime(s,e),i.updateMsgIsPeerReadProp(s,e)})}})}onMsgReadNotice(e){e.dataList.forEach(e=>{if(!Oe(e.c2cMessageReadNotice)){const i=this.get(ys);e.c2cMessageReadNotice.uinPairReadArray.forEach(e=>{var{from:e,peerReadTime:s}=e,e=(Ce.l(this._n+`.onMsgReadNotice from:${e} lastReadTime:`+s),""+t.CONV_C2C+e);i.updateIsReadAfterReadReport({conversationID:e,lastMessageTime:s}),i.updateUnreadCount(e)})}})}onMsgModified(e){Ce.l(this._n+".onMsgModified options:",e);const s=this.get(ys);e.dataList.forEach(e=>{s.onMessageModified({...e,conversationType:t.CONV_C2C})})}onReadReceiptList(e){Ce.l(this._n+".onReadReceiptList options:",e),this.get(ys).updateReadReceiptInfo(e.dataList)}sendMessage(e,t){e=this._createC2CMessagePack(e,t);return this.req(e)}_createC2CMessagePack(e,t){let s=null,i=(t&&(t.offlinePushInfo&&(s=t.offlinePushInfo),!0===t.onlineUserOnly&&(s?s.disablePush=!0:s={disablePush:!0})),"");ke(e.cloudCustomData)&&0<e.cloudCustomData.length&&(i=e.cloudCustomData);const o=[];if(Fe(t)&&Fe(t.messageControlInfo)){const{excludedFromUnreadCount:e,excludedFromLastMessage:s,excludedFromContentModeration:i}=t.messageControlInfo;!0===e&&o.push("NoUnread"),!0===s&&o.push("NoLastMsg"),!0===i&&o.push("NoMsgCheck")}var t=this.isOnlineMessage(e,t)?0:void 0,n=JSON.parse(JSON.stringify(e.getElements())),r=this.get(Rs).getFileDNList();return{P:ti.SEND_C2C_MSG,data:{fromAccount:this.getMyUserID(),toAccount:e.to,msgBody:Ii(e.type,n,r),cloudCustomData:i,msgSeq:e.sequence,msgRandom:e.random,msgLifeTime:t,nick:e.nick,avatar:e.avatar,offlinePushInfo:qi(s),messageControlInfo:0!==t?o:void 0,clientTime:e.clientTime,needReadReceipt:!0===e.needReadReceipt?1:0,isSupportExtension:!0===e.isSupportExtension?1:0,isRelayMessage:!0===e._relayFlag?1:0,cmConfigID:e._cmConfigID}}}isOnlineMessage(e,t){return!(!t||!0!==t.onlineUserOnly)}revokeMessage(e){return this.req({P:ti.REVOKE_C2C_MSG,data:{msgInfo:{fromAccount:e.from,toAccount:e.to,msgSeq:e.sequence,msgRandom:e.random,msgTimeStamp:e.time}}})}deleteMessage(e){var{to:e,keyList:t}=e;return Ce.l(this._n+`.deleteMessage toAccount:${e} count:`+t.length),this.req({P:ti.DEL_C2C_MSG,data:{fromAccount:this.getMyUserID(),to:e,keyList:t}})}modifyRemoteMessage(e){const{from:s,to:i,version:o=0,sequence:n,random:r,time:a,payload:_,type:c,cloudCustomData:u,_elements:l}=e;let d=void 0;return(e=c)!==t.MSG_TEXT&&e!==t.MSG_CUSTOM&&e!==t.MSG_LOCATION&&e!==t.MSG_FACE||(1<l.length&&l.splice(0,1,{type:c,content:_}),d=l),this.req({P:ti.MODIFY_C2C_MSG,data:{from:s,to:i,version:o,sequence:n,random:r,time:a,elements:d,cloudCustomData:u}})}setMessageRead({conversationID:t,lastMessageTime:s}){const i=this._n+".setMessageRead",e=`convID:${t} lastMessageTime:`+s,o=(Ce.l(i+" "+e),Ge(s)||this.warn("DoNotModifyLastTime"),new mi("setMessageRead"));return o.setMessage(e),this.req({P:ti.SET_C2C_MSG_READ,data:{C2CMsgReaded:{cookie:"",C2CMsgReadedItem:[{toAccount:t.replace("C2C",""),lastMessageTime:s,receipt:1}]}}}).then(()=>{o.end(),Ce.l(i+" ok");const e=this.get(ys);return e.updateIsReadAfterReadReport({conversationID:t,lastMessageTime:s}),e.updateUnreadCount(t),Ys()}).catch(e=>(o.setError(e).end(),Ce.l(i+" failed. error:",e),Qs(e)))}getRoamingMessage(e){const c=this._n+".getRoamingMessage",{peerAccount:s,conversationID:l,count:i,lastMessageTime:o,messageKey:n}=e,d=`peerAccount:${s} count:${i||15} lastMessageTime:${o||0} messageKey:`+n,_=(Ce.l(c+" "+d),new mi("getRoamingMessage"));return this.req({P:ti.GET_C2C_ROAMING_MSG,data:{peerAccount:s,count:i||15,lastMessageTime:o||0,messageKey:n}}).then(e=>{var{complete:e,messageList:s,messageKey:i,lastMessageTime:o}=e.data;$e(s)?Ce.l(c+` ok. complete:${e} but messageList is undefined!`):Ce.l(c+` ok. complete:${e} count:`+s.length),_.setMessage(d+` complete:${e} length:`+s.length).end();const n=this.get(ys),r=1===e;r&&n.setCompleted(l);e=[],s=n.onRoamingMessage(s,l,!0,e),n.modifyMessageList(l),n.updateIsRead(l),n.updateRoamingMsgKeyAndTime(l,i,o),i=n.getPeerReadTime(l);if(Ce.l(c+` update isPeerRead property. convID:${l} peerReadTime:`+i),i)n.updateMsgIsPeerReadProp(l,i);else{const e=l.replace(t.CONV_C2C,"");this.getRemotePeerReadTime([e]).then(()=>{n.updateMsgIsPeerReadProp(l,n.getPeerReadTime(l))})}let a="";if(0<s.length)a=s[0].ID;else{const e=n.getLocalOldestMessage(l);e&&(a=e.ID)}return Ce.l(c+` nextReqID:${a} storedMsgCount:`+s.length),{nextReqID:a,storedMessageList:s,assembledMessageList:e,isPullingCompleted:r}}).catch(e=>(_.setMessage(d).setError(e).end(),Ce.w(c+" failed. error:",e),Qs(e)))}getRoamingMessagesHopping(e){const l=this._n+".getRoamingMessagesHopping",{peerAccount:s,time:i=0,count:o,direction:d}=e,_=""+t.CONV_C2C+s,u=`peerAccount:${s} count:${o} time:${i} direction:`+d,h=(Ce.l(l+" "+u),new mi("getRoamingMessagesHopping"));return this.req({P:ti.GET_C2C_ROAMING_MSG,data:{peerAccount:s,count:o+1,lastMessageTime:i,direction:d}}).then(e=>{const{complete:s,messageList:i=[],lastMessageTime:o}=e.data,n=`complete:${s} count:`+i.length,r=(Ce.l(l+" ok. "+n),h.setMessage(u+" "+n).end(),1!==s&&(1===d?i.pop():i.shift()),this.get(ys)),a=r.onRoamingMessage(i,_,!1);this._modifyMessageList(_,a);var e=this._computeResult({complete:s,lastMessageTime:o,resultList:a}),c=(r.storeHoppingMessageList(e.messageList),r.getPeerReadTime(_));if(Ce.l(l+` update isPeerRead property. convID:${_} peerReadTime:`+c),c)r.updateMsgIsPeerReadProp(_,c);else{const e=_.replace(t.CONV_C2C,"");this.getRemotePeerReadTime([e]).then(()=>{r.updateMsgIsPeerReadProp(_,r.getPeerReadTime(_))})}return Ys(e)}).catch(e=>(h.setMessage(u).setError(e).end(),Ce.w(l+" failed. error:",e),Qs(e)))}_computeResult(e){const{complete:t=0,lastMessageTime:s,resultList:i=[]}=e,o={messageList:[...i],isCompleted:!1,nextMessageTime:""};return 1===t?o.isCompleted=!0:o.nextMessageTime=s,o}_modifyMessageList(t,s){t=this.get(ys).getLocalConversation(t);if(t){var i=t.userProfile.nick,o=t.userProfile.avatar,t=this.get(fs).getNickAndAvatarByUserID(this.getMyUserID()),n=t.nick,r=t.avatar;for(let e=s.length-1;0<=e;e--){const t=s[e];"in"===t.flow&&(t.nick!==i&&t.setNickAndAvatar({nick:i}),t.avatar!==o&&t.setNickAndAvatar({avatar:o})),"out"===t.flow&&(t.nick!==n&&t.setNickAndAvatar({nick:n}),t.avatar!==r&&t.setNickAndAvatar({avatar:r}))}}}getRemotePeerReadTime(n){const r=this._n+".getRemotePeerReadTime";if(Oe(n))return Promise.resolve();const a=new mi("getRemotePeerReadTime");return Ce.l(r+" userIDList:"+n),this.req({P:ti.GET_C2C_PEER_READ_TIME,data:{userIDList:n}}).then(e=>{var s=e.data["peerReadTimeList"];Ce.l(r+" ok. peerReadTimeList:"+s);let i="";const o=this.get(ys);for(let e=0;e<n.length;e++)i+=`${n[e]}-${s[e]} `,0<s[e]&&o.recordPeerReadTime(""+t.CONV_C2C+n[e],s[e]);a.setMessage(i).end()}).catch(e=>{a.setError(e).end(),Ce.w(r+" failed. error:",e)})}sendReadReceipt(e){const s=e[0].conversationID.replace(t.CONV_C2C,""),i=new mi("sendReadReceipt"),o=(i.setMessage("peerAccount:"+s),this.getMyUserID()),n=e.filter(e=>e.from!==o&&!0===e.needReadReceipt).map(e=>{var{from:e,to:t,sequence:s,random:i,time:o,clientTime:n}=e;return{fromAccount:e,toAccount:t,sequence:s,random:i,time:o,clientTime:n}});if(0===n.length)return Qs({code:js.READ_RECEIPT_MSG_LIST_EMPTY});const r=this._n+".sendReadReceipt";return Ce.l(r+`. peerAccount:${s} length:`+n.length),this.req({P:ti.SEND_C2C_READ_RECEIPT,data:{peerAccount:s,messageInfoList:n}}).then(e=>(i.end(),Ce.l(r+" ok"),Ys())).catch(e=>(i.setError(e).end(),Ce.w(r+" failed. error:",e),Qs(e)))}getReadReceiptList(e){var s=e[0].conversationID.replace(t.CONV_C2C,"");return Ce.l(this._n+`.getReadReceiptList peerAccount:${s} msgCount:`+e.length),Zs({messageList:e})}getMessageExtensions(e,t){return Ce.l(this._n+".getMessageExtensions startSequence:"+t),this.req({P:ti.GET_C2C_MSG_EXT,data:{from:e.from,to:e.to,messageKey:this.getMessageKey(e),startSequence:t}})}modifyMsgExts(e,t,s=1){return Ce.l(this._n+".modifyMsgExts operateType:"+s),this.req({P:ti.MODIFY_C2C_MSG_EXT,data:{from:e.from,to:e.to,messageKey:this.getMessageKey(e),extensionList:t,operateType:s}})}getMessageKey(e){var{clientSequence:e,random:t,time:s}=e;return e+`_${t}_`+s}reset(){Ce.l(this._n+".reset"),this._msgFromUnreadDBMap.clear(),this._noticeFromUnreadDBList.length=0}}const Vi={A2KEY_AND_TINYID_UPDATED:"_inner1",CLOUD_CONFIG:"_inner2",PROFILE_UPDATED:"_inner3",CONV_SYNC_COMPLETED:"_inner4",C2C_UNREAD_HANDLE_COMPLETED:"_inner5"};class Bi{constructor(e){this._convM=e,this._map=new Map,this._n="MsgListHandler",this._latestMsgSentByPeerMap=new Map,this._latestMsgSentByMeMap=new Map,this._hoppingMsgMap=new Map,this.TOPIC_MSG_LIMIT=1e3,this._convM.getIEmitInst().on(Vi.CLOUD_CONFIG,this._onCloudConfig,this)}_onCloudConfig(){var e=this._convM.getCloudConfig("topic_msg_limit");$e(e)||(this.TOPIC_MSG_LIMIT=Number(e)),Ce.l(this._n+"._onCloudConfig topicMsgLimit:"+this.TOPIC_MSG_LIMIT)}onCheckTimer(e){if(e%20==0&&0<this._map.size)for(var[t,s]of this._map)t.includes(Le)&&s.size>=this.TOPIC_MSG_LIMIT&&this._convM.clearMemMsg(t,!0)}pushIn(e,t=!1){var s=e["conversationID"];let i=!0;this._map.has(s)||this._map.set(s,new Map);var o=this._getUniqueIDOfMsg(e);if(this._map.get(s).has(o)){const e=this._map.get(s).get(o);if(!t||!0===e.isModified)return i=!1}return this._map.get(s).set(o,e),this._setLatestMsgSentByPeer(s,e),this._setLatestMsgSentByMe(s,e),i}unshift(s,i){let o;if(be(s)?0<s.length&&(o=s[0].conversationID,this._unshiftMultipleMsgs(s,i)):(o=s.conversationID,this._unshiftSingleMsg(s,i)),o){const s=Array.from(this._map.get(o).values()),i=s.length;if(0!==i){for(let e=i-1;0<=e;e--)if("out"===s[e].flow){this._setLatestMsgSentByMe(o,s[e]);break}if(o.startsWith(t.CONV_C2C))for(let e=i-1;0<=e;e--)if("in"===s[e].flow){this._setLatestMsgSentByPeer(o,s[e]);break}}}}_unshiftSingleMsg(e,t){var s=e["conversationID"],i=this._getUniqueIDOfMsg(e);if(!this._map.has(s))return this._map.set(s,new Map),this._map.get(s).set(i,e),void t.push(e);const o=this._map.get(s),n=Array.from(o);o.has(i)||(n.unshift([i,e]),this._map.set(s,new Map(n)),t.push(e))}_unshiftMultipleMsgs(t,s){const i=t.length,o=[],e=t[0].conversationID,n=this._map.get(e),r=this._map.has(e)?Array.from(n):[];for(let e=0;e<i;e++){const i=this._getUniqueIDOfMsg(t[e]);n&&n.has(i)||(o.push([i,t[e]]),s.push(t[e]))}this._map.set(e,new Map(o.concat(r)))}remove(e){var t=e["conversationID"],e=this._getUniqueIDOfMsg(e);this._map.has(t)&&this._map.get(t).delete(e)}revoke(e,t,s){var i;return this._map.has(e)?(i=this._map.get(e),this._updateMsgIsRevoked(i,t,s)):this._hoppingMsgMap.has(e)?(i=this._hoppingMsgMap.get(e),this._updateMsgIsRevoked(i,t,s)):null}_updateMsgIsRevoked(e,t,s){for(var[,i]of e)if(i.sequence===t&&($e(s)||i.random===s))return i.isRevoked||(i.isRevoked=!0),i}removeByConvID(e){var t=this._map.has(e);Ce.l(this._n+`.removeByConvID convID:${e} has:`+t),t&&(this._map.delete(e),this._latestMsgSentByPeerMap.delete(e),this._latestMsgSentByMeMap.delete(e))}findMessage(e){let t=null;return t=(t=this._findMsg(e,this._map))||this._findMsg(e,this._hoppingMsgMap)}_findMsg(t,s){let i=null;for(var[,e]of s){const s=[...e.values()],o=s.length;for(let e=0;e<o;e++)if(s[e].ID===t){i=s[e];break}}return i}updateMsgIsPeerReadProp(e,t){let s=[];var i;return this._map.has(e)?(i=this._map.get(e),s=this._updateMsgIsPeerReadProp(i,t)):this._hoppingMsgMap.has(e)&&(i=this._hoppingMsgMap.get(e),s=this._updateMsgIsPeerReadProp(i,t)),Ce.l(this._n+`.updateMsgIsPeerReadProp convID:${e} peerReadTime:${t} count:`+s.length),s}_updateMsgIsPeerReadProp(e,t){const s=[];for(var[,i]of e)i.time<=t&&!i.isPeerRead&&"out"===i.flow&&(i.isPeerRead=!0,s.push(i));return s}updateMsgIsModifiedProp(e){var t=e["conversationID"];if(this._map.has(t)){const s=this._getUniqueIDOfMsg(e),i=this._map.get(t).get(s);i&&(i.isModified=!0)}}hasLocalMsgList(e){return this._map.has(e)}getLocalMsgList(e){return this.hasLocalMsgList(e)?[...this._map.get(e).values()]:[]}getLocalMaxSeq(e){if(!this.hasLocalMsgList(e))return 0;e=[...this._map.get(e).values()].map(e=>e.sequence);return Math.max(...e)}getLocalMaxTime(e){if(!this.hasLocalMsgList(e))return 0;e=[...this._map.get(e).values()].map(e=>e.time);return Math.max(...e)}hasLocalMsg(e,t){let s=!1;var i=this.getLocalMsgList(e),o=i.length;for(let e=0;e<o;e++)i[e].ID===t&&(s=!0);return s}getLocalMsg(e,t){let s=null;var i=this.getLocalMsgList(e),o=i.length;for(let e=0;e<o;e++)if(i[e].ID===t){s=i[e];break}return s}getLocalLastMsg(e){e=this.getLocalMsgList(e);return e[e.length-1]}getLocalSecondLastMsg(e){e=this.getLocalMsgList(e);return e[e.length-2]}getLocalOldestMsg(e){return this.getLocalMsgList(e)[0]}_setLatestMsgSentByPeer(e,s){e.startsWith(t.CONV_C2C)&&"in"===s.flow&&this._latestMsgSentByPeerMap.set(e,s)}_setLatestMsgSentByMe(e,t){"out"===t.flow&&this._latestMsgSentByMeMap.set(e,t)}getLatestMsgSentByPeer(e){return this._latestMsgSentByPeerMap.get(e)}getLatestMsgSentByMe(e){return this._latestMsgSentByMeMap.get(e)}modifyMsgSentByPeer(o){const{conversationID:e,latestNick:n,latestAvatar:r}=o,t=this._map.get(e);if(!Oe(t)){var a=Array.from(t.values()),o=a.length;if(0!==o){let t=null,s=0,i=!1;for(let e=o-1;0<=e;e--)"in"===a[e].flow&&((t=a[e]).nick!==n&&(t.setNickAndAvatar({nick:n}),i=!0),t.avatar!==r&&(t.setNickAndAvatar({avatar:r}),i=!0),i&&(s+=1));Ce.l(this._n+`.modifyMsgSentByPeer convID:${e} count:`+s)}}}modifyMsgSentByMe(o){const{conversationID:e,latestNick:n,latestAvatar:r}=o,t=this._map.get(e);if(!Oe(t)){var a=Array.from(t.values()),o=a.length;if(0!==o){let t=null,s=0,i=!1;for(let e=o-1;0<=e;e--)"out"===a[e].flow&&((t=a[e]).nick!==n&&(t.setNickAndAvatar({nick:n}),i=!0),t.avatar!==r&&(t.setNickAndAvatar({avatar:r}),i=!0),i&&(s+=1));Ce.l(this._n+`.modifyMsgSentByMe convID:${e} count:`+s)}}}getTopicConvIDList(s){return[...this._map.keys()].filter(e=>e.startsWith(""+t.CONV_GROUP+s))}onMsgModified(e,t){if(!this._map.has(e)&&!this._hoppingMsgMap.has(e))return{isUpdated:!1,message:null};const s=this._n+".onMsgModified",i=this._getUniqueIDOfMsg(t),o=this._getTargetMsg(e,i),n=!!o;if(Ce.l(s+` convID:${e} uniqueID:${i} has:`+n),n){const{messageVersion:e,elements:i,cloudCustomData:n,checkResult:r}=t;return Ce.l(s+` localVersion:${o.version} remoteVersion:`+e),o.version<e?(o.version=e,o._elements=JSON.parse(JSON.stringify(i)),o.payload=o._elements[0].content,o.type=o._elements[0].type,o.cloudCustomData=n,o.isModified=!0,o.hasRiskContent=Dt(r),{isUpdated:!0,message:o}):{isUpdated:!1,message:o}}return{isUpdated:!1,message:null}}_getUniqueIDOfMsg(e){var{from:e,to:t,random:s,sequence:i,time:o}=e;return e+`-${t}-${s}-${i}-`+o}_getTargetMsg(e,t){if(this._map.has(e))return this._map.get(e).get(t);let s=void 0;if(this._hoppingMsgMap.has(e)){var i=[...this._hoppingMsgMap.get(e).values()];for(let e=0;e<i.length;e++)if(this._getUniqueIDOfMsg(i[e])===t){s=i[e];break}}return s}storeHoppingMsgList(t){if(0!==t.length){const s=t[0]["conversationID"],i=t.length,o=(this._hoppingMsgMap.has(s)||this._hoppingMsgMap.set(s,new Map),this._hoppingMsgMap.get(s));for(let e=0;e<i;e++){const s=t[e];o.has(s.ID)||o.set(s.ID,s)}}}getHoppingMsg(e,t){if(this._hoppingMsgMap.has(e))return this._hoppingMsgMap.get(e).get(t)}reset(){this._map.clear(),this._latestMsgSentByPeerMap.clear(),this._latestMsgSentByMeMap.clear(),this._hoppingMsgMap.clear()}}function Ki(e){this.mixin(e)}Ki.mixin=function(e){const t=e.prototype||e;t._isReady=!1,t.ready=function(e,t=!1){if(e)return this._isReady?void(t?e.call(this):setTimeout(e,1)):(this._readyQueue=this._readyQueue||[],void this._readyQueue.push(e))},t.triggerReady=function(){this._isReady=!0,setTimeout(()=>{const e=this._readyQueue;this._readyQueue=[],e&&0<e.length&&e.forEach(function(e){e.call(this)},this)},1)},t.resetReady=function(){this._isReady=!1,this._readyQueue=[]},t.isReady=function(){return this._isReady}};const Hi=["jpg","jpeg","gif","png","bmp","image","webp"],Wi=["mp4","quicktime","mov"],Yi=1,zi=2,ji=3,Ji=255;class Xi{constructor(e){Oe(e)||(this.userID=e.userID||"",this.nick=e.nick||"",this.gender=e.gender||"",this.birthday=e.birthday||0,this.location=e.location||"",this.selfSignature=e.selfSignature||"",this.allowType=e.allowType||t.ALLOW_TYPE_ALLOW_ANY,this.language=e.language||0,this.avatar=e.avatar||"",this.messageSettings=e.messageSettings||0,this.adminForbidType=e.adminForbidType||t.FORBID_TYPE_NONE,this.level=e.level||0,this.role=e.role||0,this.lastUpdatedTime=0,this.profileCustomField=[],Oe(e.profileCustomField)||e.profileCustomField.forEach(e=>{this.profileCustomField.push({key:e.key,value:e.value})}))}validate(s){let i=!0,e="";if(Oe(s))return{valid:!1,tips:"empty options"};if(s.profileCustomField){const i=s.profileCustomField.length;let t=null;for(let e=0;e<i;e++){if(t=s.profileCustomField[e],!ke(t.key)||-1===t.key.indexOf("Tag_Profile_Custom"))return{valid:!1,tips:"The prefix of keys of the custom profile key-value pairs (which is profileCustomField) must be Tag_Profile_Custom"};if(!ke(t.value))return{valid:!1,tips:"The type of values of the custom profile key-value pairs (which is profileCustomField) must be String"}}}for(const t in s)if(Object.prototype.hasOwnProperty.call(s,t)){if("profileCustomField"===t)continue;if(Oe(s[t])&&!ke(s[t])&&!Ge(s[t])){e="key:"+t+", invalid value:"+s[t],i=!1;continue}switch(t){case"nick":ke(s[t])||(e="nick must be a string",i=!1),500<ze(s[t])&&(e=`nick name limited: must less than or equal to 500 bytes, current size: ${ze(s[t])} bytes`,i=!1);break;case"gender":Ze(Ee,s.gender)||(e="key:gender, invalid value:"+s.gender,i=!1);break;case"birthday":Ge(s.birthday)||(e="birthday must be a number",i=!1);break;case"location":ke(s.location)||(e="location must be a string",i=!1);break;case"selfSignature":ke(s.selfSignature)||(e="selfSignature must be a string",i=!1);break;case"allowType":Ze(De,s.allowType)||(e="key:allowType, invalid value:"+s.allowType,i=!1);break;case"language":Ge(s.language)||(e="language must be a number",i=!1);break;case"avatar":ke(s.avatar)||(e="avatar must be a string",i=!1);break;case"messageSettings":0!==s.messageSettings&&1!==s.messageSettings&&(e="messageSettings must be 0 or 1",i=!1);break;case"adminForbidType":Ze(Se,s.adminForbidType)||(e="key:adminForbidType, invalid value:"+s.adminForbidType,i=!1);break;case"level":Ge(s.level)||(e="level must be a number",i=!1);break;case"role":Ge(s.role)||(e="role must be a number",i=!1);break;default:e="unknown key:"+t+"  "+s[t],i=!1}}return{valid:i,tips:e}}}class Zi{constructor(e){this.MAX_LENGTH=e,this.map=new Map}set(e){if(this.map.size>=this.MAX_LENGTH){const e=this.map.entries().next().value[0];this.map.delete(e)}this.map.set(e,1)}has(e){return this.map.has(e)}delete(e){this.has(e)&&this.map.delete(e)}reset(){this.map.clear()}}const Qi=["groupID","name","avatar","type","introduction","notification","ownerID","selfInfo","createTime","infoSequence","lastInfoTime","lastMessage","nextMessageSeq","memberNum","maxMemberNum","memberList","joinOption","groupCustomField","muteAllMembers","isSupportTopic","inviteOption","_lastRevokedTime"];class en{constructor(e){this.groupID="",this.name="",this.avatar="",this.type="",this.introduction="",this.notification="",this.ownerID="",this.createTime="",this.infoSequence="",this.lastInfoTime="",this.selfInfo={messageRemindType:"",joinTime:"",nameCard:"",role:"",userID:"",memberCustomField:void 0,readedSequence:0,excludedUnreadSequenceList:void 0},this.lastMessage={lastTime:"",lastSequence:"",fromAccount:"",messageForShow:""},this.nextMessageSeq="",this.memberNum="",this.memberCount="",this.maxMemberNum="",this.maxMemberCount="",this.joinOption="",this.inviteOption="",this.groupCustomField=[],this.muteAllMembers=!1,this.isSupportTopic=!1,this._lastRevokedTime=0,this._initGroup(e)}set memberNum(e){}set maxMemberNum(e){}get memberNum(){return this.memberCount}get maxMemberNum(){return this.maxMemberCount}_initGroup(e){for(const t in e)Qi.indexOf(t)<0||("selfInfo"!==t?("memberNum"===t&&(this.memberCount=e[t]),"maxMemberNum"===t&&(this.maxMemberCount=e[t]),"isSupportTopic"!==t?this[t]=e[t]:this.isSupportTopic=1===e[t]):this.updateSelfInfo(e[t]))}updateGroup(e){e.appid=void 0,e.grossTopicNextMsgSeq=void 0,e.selfInfo&&(e.selfInfo.grossTopicReadSeq=void 0);const t=JSON.parse(JSON.stringify(e));t.lastMsgTime&&(this.lastMessage.lastTime=t.lastMsgTime),$e(t.muteAllMembers)||("On"===t.muteAllMembers?t.muteAllMembers=!0:t.muteAllMembers=!1),t.groupCustomField&&st(this.groupCustomField,t.groupCustomField),$e(t.memberNum)||(this.memberCount=t.memberNum),$e(t.maxMemberNum)||(this.maxMemberCount=t.maxMemberNum),$e(t.isSupportTopic)||(this.isSupportTopic=Ge(t.isSupportTopic)?1===t.isSupportTopic:t.isSupportTopic),We(this,t,["members","errorCode","lastMsgTime","groupCustomField","memberNum","maxMemberNum","isSupportTopic"]),be(t.members)&&0<t.members.length&&t.members.forEach(e=>{e.userID===this.selfInfo.userID&&We(this.selfInfo,e,["sequence"])})}updateSelfInfo({nameCard:e,joinTime:t,role:s,messageRemindType:i,readedSequence:o,excludedUnreadSequenceList:n}){e={nameCard:e,joinTime:t,role:s,messageRemindType:i,readedSequence:o,excludedUnreadSequenceList:n};We(this.selfInfo,{...e},[],["",null,void 0,0,NaN])}setSelfNameCard(e){this.selfInfo.nameCard=e}}const tn=function(e,t,s){return $e(e)?{lastTime:0,lastSequence:0,fromAccount:"",messageForShow:"",payload:null,type:"",isRevoked:!1,cloudCustomData:"",onlineOnlyFlag:!1,nick:"",nameCard:"",version:0,isPeerRead:!1,revoker:null}:s&&e.ID||e instanceof wi?{lastTime:e.time||0,lastSequence:e.sequence||0,fromAccount:e.from||"",messageForShow:Tt(e.type,e.payload,t),payload:e.payload||null,type:e.type||null,isRevoked:e.isRevoked||!1,cloudCustomData:e.cloudCustomData||"",onlineOnlyFlag:e._onlineOnlyFlag||!1,nick:e.nick||"",nameCard:e.nameCard||"",version:e.version||0,isPeerRead:e.isPeerRead||!1,revoker:e.revoker||null}:{...e,messageForShow:Tt(e.type,e.payload,t)}};class sn{constructor(e,t,s=!1){this.conversationID=e.conversationID||"",this.unreadCount=e.unreadCount||0,this.type=e.type||"",this.lastMessage=tn(e.lastMessage,t,s),e.lastMsgTime&&(this.lastMessage.lastTime=e.lastMsgTime),this._isInfoCompleted=!1,this.peerReadTime=e.peerReadTime||0,this.groupAtInfoList=[],this.remark="",this.isPinned=e.isPinned||!1,this.messageRemindType=e.messageRemindType,this.markList=e.markList||[],this.customData=e.customData||"",this.conversationGroupList=e.conversationGroupList||[],this.draftText=e.draftText||"",this._initProfile(e),this.subType=this.groupProfile?this.groupProfile.type:""}get toAccount(){return this.conversationID.startsWith(t.CONV_C2C)?this.conversationID.replace(t.CONV_C2C,""):this.conversationID.startsWith(t.CONV_GROUP)?this.conversationID.replace(t.CONV_GROUP,""):""}_initProfile(s){Object.keys(s).forEach(e=>{switch(e){case"userProfile":this.userProfile=s.userProfile;break;case"groupProfile":this.groupProfile=s.groupProfile}}),$e(this.userProfile)&&this.type===t.CONV_C2C?this.userProfile=new Xi({userID:s.conversationID.replace("C2C","")}):$e(this.groupProfile)&&this.type===t.CONV_GROUP&&(this.groupProfile=new en({groupID:s.conversationID.replace("GROUP","")}))}updateUnreadCount(e){var{nextUnreadCount:e,isFromGetConversations:s,isUnreadC2CMessage:i}=e;$e(e)||(it(this.subType)?this.unreadCount=0:s&&this.type===t.CONV_GROUP||s&&this.type===t.CONV_TOPIC||i&&this.type===t.CONV_C2C?this.unreadCount=e:this.unreadCount=this.unreadCount+e)}updateLastMessage(e){this.lastMessage=tn(e)}updateGroupAtInfoList(s){if(!this._isNeedMergeGroupAtInfo(s)){let[...e]=s.groupAtType;-1!==e.indexOf(t.CONV_AT_ME)&&-1!==e.indexOf(t.CONV_AT_ALL)&&(e=[t.CONV_AT_ALL_AT_ME]);s={from:s.from,groupID:s.groupID,topicID:s.topicID,messageSequence:s.sequence,atTypeArray:e,__random:s.__random,__sequence:s.__sequence};this.groupAtInfoList.push(s)}}_isNeedMergeGroupAtInfo(s){const{groupID:e,sequence:i}=s;if(!nt({groupID:e}))return!1;let o=!1;return this.groupAtInfoList.forEach(e=>{e.messageSequence===i&&(-1<e.atTypeArray.indexOf(t.CONV_AT_ME)&&-1<s.groupAtType.indexOf(t.CONV_AT_ALL)&&(e.atTypeArray=[t.CONV_AT_ALL_AT_ME]),-1<e.atTypeArray.indexOf(t.CONV_AT_ALL)&&-1<s.groupAtType.indexOf(t.CONV_AT_ME)&&(e.atTypeArray=[t.CONV_AT_ALL_AT_ME],e.__random=s.__random,e.__sequence=s.__sequence),o=!0)}),o}clearGroupAtInfoList(){this.groupAtInfoList.length=0}reduceUnreadCount(){return 1<=this.unreadCount&&(--this.unreadCount,!0)}isLastMessageRevoked({sequence:e,time:s}){return this.type===t.CONV_C2C&&e===this.lastMessage.lastSequence&&s===this.lastMessage.lastTime||this.type===t.CONV_GROUP&&e===this.lastMessage.lastSequence}setLastMessageRevoked(e){this.lastMessage.isRevoked=e}setLastMessageRevoker(e){this.lastMessage.revoker=e}setDraftText(e){this.draftText=e}}const nn={[t.MSG_REMIND_ACPT_AND_NOTE]:0,[t.MSG_REMIND_DISCARD]:1,[t.MSG_REMIND_ACPT_NOT_NOTE]:2};class on{constructor(e){this._convM=e,this._n="MsgRemindHandler"}onAllRcvMsgOptNotify(t){t=this._handleResult(t);this._convM.emitOEvt(e.ALL_RECEIVE_MESSAGE_OPT_UPDATED,t)}getC2CMsgRemindType(t){const s=this._n+".getC2CMsgRemindType";return this._convM.req({P:ti.GET_C2C_PEER_MUTE_NOTIFICATIONS,data:{toAccount:this._convM.getMyUserID(),userIDList:t}}).then(e=>{Ce.l(s+" ok. userIDList:"+t);e=e.data.muteFlagList;this._convM.onC2CMsgRemindTypeFetched(e)}).catch(e=>{Ce.e(s+" failed. error:",e)})}set(e){return e.groupID?this._setGroupMsgRemindType(e):be(e.userIDList)?this._setC2CMsgRemindType(e):void 0}_setGroupMsgRemindType(t){const s=this._n+"._setGroupMsgRemindType",{groupID:e,messageRemindType:i}=t,o=`groupID:${e} messageRemindType:`+i,n=new mi("_setGroupMsgRemindType"),r=(n.setMessage(o),this._get(Is));return r?r.modifyGroupMemberInfo({groupID:e,messageRemindType:i,userID:this._convM.getMyUserID()}).then(()=>{n.end(),Ce.l(s+" ok. "+o);var e=this.onGroupMsgRemindTypeUpdated(t);return this._convM.onTotalUnreadCountUpdate(),Ys(e)}).catch(e=>(n.setError(e).end(),Ce.e(s+" failed. error:",e),Qs(e))):Qs({code:js.NO_MODULE})}onGroupMsgRemindTypeUpdated(t){var{groupID:s,messageRemindType:i}=t;Ce.l(this._n+`.onGroupMsgRemindTypeUpdated groupID:${s} messageRemindType:`+i);const o=this._get(Is).getLocalGroupProfile(s);if(o&&(o.selfInfo.messageRemindType=i),ot(s)){const t=s,o=Ct(t),n=this._get(Ts).getLocalTopic(o,t);return n&&n.updateSelfInfo({messageRemindType:i})&&this._convM.emitOEvt(e.TOPIC_UPDATED,{groupID:o,topic:n}),{topic:n}}return this._convM.patchMsgRemindType({ID:s,isC2CConversation:!1,messageRemindType:i})&&this._emitConvUpdate(),{group:o}}_setC2CMsgRemindType(e){const r=this._n+"._setC2CMsgRemindType",{userIDList:t,messageRemindType:a}=e,c=t.slice(0,30),s=nn[a]||0,l=`userIDList:${c} messageRemindType:`+a,d=new mi("_setC2CMsgRemindType");return d.setMessage(l),this._convM.req({P:ti.SET_C2C_PEER_MUTE_NOTIFICATIONS,data:{userIDList:c,muteFlag:s}}).then(e=>{d.end();const t=e.data["errorList"],s=[],i=[],o=(be(t)&&t.forEach(e=>{s.push(e.userID),i.push({userID:e.userID,code:e.errorCode})}),c.filter(e=>-1===s.indexOf(e)));Ce.l(r+` ok. ${l} successUserIDList:${o} failureUserIDList:`+JSON.stringify(i));let n=0;return o.forEach(e=>{this._convM.patchMsgRemindType({ID:e,isC2CConversation:!0,messageRemindType:a})&&(n+=1)}),1<=n&&this._emitConvUpdate(),c.length=s.length=0,this._convM.onTotalUnreadCountUpdate(),Zs({successUserIDList:o.map(e=>({userID:e})),failureUserIDList:i})}).catch(e=>(d.setError(e).end(),Ce.e(r+" failed. error:",e),Qs(e)))}_get(e){return this._convM.get(e)}_emitConvUpdate(){this._convM.emitConvUpdate(!0,!1)}setAllRcvMsgOpt(e){const s=this._n+".setAllRcvMsgOpt",{messageRemindType:i=t.MSG_REMIND_ACPT_NOT_NOTE,isRepeated:o=!0}=e,{startTime:n=0,endTime:r=0}=this._calcStartAndEndTime(e),a=JSON.stringify(e),c=new mi("setAllRcvMsgOpt");return c.setMessage(a),Ce.l(s+" options:"+a),this._convM.req({P:ti.SET_ALL_RECEIVE_MSG_OPT,data:{messageRemindType:nn[i],startTime:n,endTime:r,isRepeated:o?1:0}}).then(e=>(c.end(),Ce.l(s+" ok."),Ys(e))).catch(e=>(c.setError(e).end(),Ce.e(s+" failed. error:",e),Qs(e)))}_calcStartAndEndTime(e){const{startHour:t=0,startMinute:s=0,startSecond:i=0,duration:o=0,isRepeated:n=!0}=e,r=new Date,a=r.getFullYear(),c=r.getMonth(),d=r.getDate(),l=Math.round(new Date(a,c,d,t,s,i).getTime()/1e3);let _=n&&86400<=o?l+86400:l+o;return{startTime:l,endTime:_}}getAllRcvMsgOpt(){const t=this._n+".getAllRcvMsgOpt",s=new mi("getAllRcvMsgOpt");return this._convM.req({P:ti.GET_ALL_RECEIVE_MSG_OPT,data:{toAccount:this._convM.getMyUserID()}}).then(e=>{e=e.data,s.setMessage(JSON.stringify(e)).end(),Ce.l(t+" ok. data:"+JSON.stringify(e)),e=this._handleResult(e);return Ys(e)}).catch(e=>(s.setError(e).end(),Ce.e(t+" failed. error:",e),Qs(e)))}_handleResult(e){var{messageRemindType:e,startTime:s,endTime:i,isRepeated:o}=e;let n=t.MSG_REMIND_ACPT_AND_NOTE;return 1===e&&(n=t.MSG_REMIND_DISCARD),{messageRemindType:n=2===e?t.MSG_REMIND_ACPT_NOT_NOTE:n,startTime:s,endTime:i,isRepeated:1===o}}reset(){Ce.l(this._n+".reset")}}class rn{constructor(e){this._convM=e,this._n="ConvGroupHandler",this._convGroupMap=new Map,this._startIndex=0,this._pagingStatus=Pt}setConvCustomData(e){const s=this._n+".setConvCustomData",{conversationIDList:i,customData:n}=e,r=(Ce.l(s+" options:",e),new mi("setConvCustomData")),o=(r.setMessage(JSON.stringify(e)),{fromAccount:this._getMyUserID(),itemList:[]}),a=[],c=[];return i.forEach(e=>{if(!this._hasLocalConv(e))return this._onConvNotFound(c,e),!0;if(!rt(e)&&!at(e))return this._onConvIDInvalid(c,e),!0;const s={operationType:2,contactItem:void 0,customMark:n};rt(e)?s.contactItem={type:1,toAccount:e.replace(t.CONV_C2C,"")}:at(e)&&(s.contactItem={type:2,groupID:e.replace(t.CONV_GROUP,"")}),o.itemList.push(s)}),c.length===i.length?Zs({successConversationIDList:a,failureConversationIDList:c}):this._convM.req({P:ti.SET_CONV_CUSTOM_DATA,data:o}).then(e=>{r.end(),Ce.l(s+" ok");const o=e.data["resultItem"];if(be(o)){let t,s,i=!1;o.forEach(e=>{t=this._concatConvID(e.contactItem),0===e.resultCode?(a.push(t),(s=this._getLocalConv(t))&&s.customData!==n&&(s.customData=n,i=!0)):c.push({conversationID:t,code:e.resultCode,message:e.resultInfo})}),!0===i&&this._emitConvUpdate()}return Ys({successConversationIDList:a,failureConversationIDList:c})}).catch(e=>(r.setError(e).end(),Ce.e(s+" failed. error:",e),Qs(e)))}markConv(e){if(!this._convM.canIUse(M.CONV_MARK))return this._convM.noUse("markConv");const s=this._n+".markConv",{conversationIDList:i,markType:n,enableMark:r}=e,a=(Ce.l(s+" options:",e),new mi("markConv"));a.setMessage(JSON.stringify(e));let o=void 0,c=void 0;e=this._getFlagBit(n);!0===r?c=[e]:o=[e];const _={fromAccount:this._getMyUserID(),itemList:[]},l=[],d=[];return i.forEach(e=>{if(!this._hasLocalConv(e))return this._onConvNotFound(d,e),!0;if(!rt(e)&&!at(e))return this._onConvIDInvalid(d,e),!0;const s={operationType:1,contactItem:void 0,clearMark:o,setMark:c};rt(e)?s.contactItem={type:1,toAccount:e.replace(t.CONV_C2C,"")}:at(e)&&(s.contactItem={type:2,groupID:e.replace(t.CONV_GROUP,"")}),_.itemList.push(s)}),d.length===i.length?Zs({successConversationIDList:l,failureConversationIDList:d}):this._convM.req({P:ti.MARK_CONV,data:_}).then(e=>{a.end(),Ce.l(s+" ok");const o=e.data["resultItem"];if(be(o)){let t,s,i=!1;o.forEach(e=>{if(t=this._concatConvID(e.contactItem),0===e.resultCode){if(l.push(t),s=this._getLocalConv(t)){const t=s.markList.indexOf(n);!0===r?-1===t&&(s.markList.push(n),i=!0):-1!==t&&(s.markList.splice(t,1),i=!0)}}else d.push({conversationID:t,code:e.resultCode,message:e.resultInfo})}),!0===i&&this._emitConvUpdate()}return Ys({successConversationIDList:l,failureConversationIDList:d})}).catch(e=>(a.setError(e).end(),Ce.e(s+" failed. error:",e),Qs(e)))}getLocalConvGroupList(){return Ce.l(this._n+".getLocalConvGroupList pagingStatus:"+this._pagingStatus),this._pagingStatus===kt?this.getRemoteConvGroupList().then(()=>Ys([...this._convGroupMap.values()])):Zs([...this._convGroupMap.values()])}searchConvGroupAndMark(e,t){const s=this._n+".searchConvGroupAndMark",i=[];return e.forEach(e=>{1===t?i.push({type:1,toAccount:e}):2===t&&i.push({type:2,groupID:e})}),Ce.l(s+` type:${t} list:`,e),this._convM.req({P:ti.SEARCH_CONV_GRP_MARK,data:{fromAccount:this._getMyUserID(),contactItem:i}}).then(e=>{var{contactItem:e,groupItem:t}=e.data;Ce.l(s+" ok. contactItem:",e,"groupItem:",t),this._fillConvGroupMap(t),this._handleContactItem(e),this._emitConvUpdate()}).catch(e=>{Ce.w(s+" failed. error:",e)})}_fillConvGroupMap(e){be(e)&&e.forEach(e=>{var{convGroupID:e,groupName:t}=e;this._convGroupMap.set(e,t)})}_handleContactItem(e){if(be(e)){let n,r;e.forEach(e=>{const t=[],{standardMark:s,customData:i,convGroupIDList:o}=e;be(o)&&o.forEach(e=>{this._convGroupMap.has(e)&&t.push(this._convGroupMap.get(e))}),r=this._concatConvID(e),(n=this._getLocalConv(r))&&(n.markList=yt(s),n.customData=i||"",n.conversationGroupList=[...t])})}}getRemoteConvGroupList(){const o=this._n+".getRemoteConvGroupList";return this._pagingStatus=Ut,this._convM.req({P:ti.GET_CONV_GRP_LIST,data:{fromAccount:this._getMyUserID(),startIndex:this._startIndex}}).then(e=>{var{completeFlag:e,contactItem:t,nextStartIndex:s=0,groupItem:i}=e.data;if(this._startIndex=s,Ce.l(o+` completeFlag:${e} nextStartIndex:${s}, groupItem:`,i,"contactItem:",t),this._fillConvGroupMap(i),this._handleContactItem(t),0===e)return this.getRemoteConvGroupList();1===e&&(this._pagingStatus=Gt,this._emitConvUpdate(),this._emitConvGroupListUpdate())}).catch(e=>{this._pagingStatus=kt,Ce.w(o+" failed. error:",e)})}createConvGroup(e){if(!this._convM.canIUse(M.CONV_GROUP))return this._convM.noUse("createConvGroup");const i=this._n+".createConvGroup",n=(Ce.l(i+" options:",e),new mi("createConvGroup")),{groupName:r,conversationIDList:s}=(n.setMessage(JSON.stringify(e)),e),o={fromAccount:this._getMyUserID(),itemList:[{groupName:r,contactItem:[]}]},a=[],c=[];return s.forEach(e=>this._hasLocalConv(e)?rt(e)||at(e)?void(rt(e)?o.itemList[0].contactItem.push({type:1,toAccount:e.replace(t.CONV_C2C,"")}):at(e)&&o.itemList[0].contactItem.push({type:2,groupID:e.replace(t.CONV_GROUP,"")})):(this._onConvIDInvalid(c,e),!0):(this._onConvNotFound(c,e),!0)),c.length===s.length?Zs({successConversationIDList:a,failureConversationIDList:c}):this._convM.req({P:ti.CREATE_CONV_GRP,data:o}).then(e=>{n.end(),Ce.l(i+" ok");const t=e.data["groupResultItem"],{groupItem:s,resultItem:o}=t[0];if(Fe(s)&&(this._convGroupMap.set(s.convGroupID,s.groupName),this._emitConvGroupListUpdate()),be(o)){let t,s,i=!1;o.forEach(e=>{t=this._concatConvID(e.contactItem),0===e.resultCode?(a.push(t),(s=this._getLocalConv(t))&&-1===s.conversationGroupList.indexOf(r)&&(s.conversationGroupList.push(r),i=!0)):c.push({conversationID:t,code:e.resultCode,message:e.resultInfo})}),!0===i&&(this._emitConvUpdate(),this._emitConvGroupListUpdate())}return Ys({successConversationIDList:a,failureConversationIDList:c})}).catch(e=>(n.setError(e).end(),Ce.e(i+" failed. error:",e),Qs(e)))}deleteConvGroup(t){if(!this._convM.canIUse(M.CONV_GROUP))return this._convM.noUse("deleteConvGroup");const i=this._n+".deleteConvGroup",o=(Ce.l(i+" groupName:"+t),new mi("deleteConvGroup"));return o.setMessage(t),this._convM.req({P:ti.DEL_CONV_GRP,data:{fromAccount:this._getMyUserID(),groupName:[t]}}).then(e=>{o.end(),Ce.l(i+" ok");const s=e.data["groupItem"];if(be(s)){let t=!1;s.forEach(e=>{this._convGroupMap.has(e.convGroupID)&&(this._convGroupMap.delete(e.convGroupID),t=!0)}),!0===t&&this._emitConvGroupListUpdate()}this._eraseFromConversationGroupList([t])}).catch(e=>(o.setError(e).end(),Ce.e(i+" failed. error:",e),Qs(e)))}renameConvGroup(e){if(!this._convM.canIUse(M.CONV_GROUP))return this._convM.noUse("renameConvGroup");const n=this._n+".renameConvGroup",r=(Ce.l(n+" options:",e),new mi("renameConvGroup")),{oldName:a,newName:c}=(r.setMessage(JSON.stringify(e)),e);return this._convM.req({P:ti.RENAME_CONV_GRP,data:{fromAccount:this._getMyUserID(),updateType:1,updateGroup:{updateGroupType:1,oldName:a,newName:c}}}).then(e=>{r.end(),Ce.l(n+" ok");e=e.data.updateGroupResult,e=e.convGroupID;this._convGroupMap.set(e,c),this._emitConvGroupListUpdate();const t=this._convM.getLocalConvList();let s,i,o=!1;t.forEach(e=>{s=e.conversationGroupList,-1!==(i=s.indexOf(a))&&(s.splice(i,1,c),o=!0)}),!0===o&&this._emitConvUpdate()}).catch(e=>(r.setError(e).end(),Ce.e(n+" failed. error:",e),Qs(e)))}addConvsToGroup(e){if(!this._convM.canIUse(M.CONV_GROUP))return this._convM.noUse("addConvsToGroup");const s=this._n+".addConvsToGroup",i=(Ce.l(s+" options:",e),new mi("addConvsToGroup")),{conversationIDList:o,groupName:n}=(i.setMessage(JSON.stringify(e)),e),r={fromAccount:this._getMyUserID(),updateType:1,updateGroup:{updateGroupType:2,groupName:n,updateItem:[]}},a=[],c=[];return o.forEach(e=>this._hasLocalConv(e)?rt(e)||at(e)?void(rt(e)?r.updateGroup.updateItem.push({operationType:1,contactItem:{type:1,toAccount:e.replace(t.CONV_C2C,"")}}):at(e)&&r.updateGroup.updateItem.push({operationType:1,contactItem:{type:2,groupID:e.replace(t.CONV_GROUP,"")}})):(this._onConvIDInvalid(c,e),!0):(this._onConvNotFound(c,e),!0)),c.length===o.length?Zs({successConversationIDList:a,failureConversationIDList:c}):this._convM.req({P:ti.ADD_CONV_TO_GRP,data:r}).then(e=>{i.end(),Ce.l(s+" ok");const o=e.data.updateGroupResult["contactResultItem"];if(be(o)){let t,s,i=!1;o.forEach(e=>{t=this._concatConvID(e.contactItem),0===e.resultCode?(s=this._getLocalConv(t))&&-1===s.conversationGroupList.indexOf(n)&&(s.conversationGroupList.push(n),a.push(t),i=!0):c.push({conversationID:t,code:e.resultCode,message:e.resultInfo})}),!0===i&&(this._emitConvUpdate(),this._emitConvInGroupUpdate(n))}return Ys({successConversationIDList:a,failureConversationIDList:c})}).catch(e=>(i.setError(e).end(),Ce.e(s+" failed. error:",e),Qs(e)))}deleteConvsFromGroup(e){var s="deleteConvsFromGroup";if(!this._convM.canIUse(M.CONV_GROUP))return this._convM.noUse(s);const i=this._n+"."+s,n=(Ce.l(i+" options:",e),new mi(s)),{conversationIDList:o,groupName:r}=(n.setMessage(JSON.stringify(e)),e),a={fromAccount:this._getMyUserID(),updateType:1,updateGroup:{updateGroupType:2,groupName:r,updateItem:[]}},c=[],l=[];return o.forEach(e=>this._hasLocalConv(e)?rt(e)||at(e)?void(rt(e)?a.updateGroup.updateItem.push({operationType:2,contactItem:{type:1,toAccount:e.replace(t.CONV_C2C,"")}}):at(e)&&a.updateGroup.updateItem.push({operationType:2,contactItem:{type:2,groupID:e.replace(t.CONV_GROUP,"")}})):(this._onConvIDInvalid(l,e),!0):(this._onConvNotFound(l,e),!0)),l.length===o.length?Zs({successConversationIDList:c,failureConversationIDList:l}):this._convM.req({P:ti.DEL_CONV_FROM_GRP,data:a}).then(e=>{n.end(),Ce.l(i+" ok");const o=e.data.updateGroupResult["contactResultItem"];if(be(o)){let t,s,i=!1;o.forEach(e=>{if(t=this._concatConvID(e.contactItem),0===e.resultCode){if(s=this._getLocalConv(t)){const e=s.conversationGroupList.indexOf(r);-1!==e&&(s.conversationGroupList.splice(e,1),c.push(t),i=!0)}}else l.push({conversationID:t,code:e.resultCode,message:e.resultInfo})}),!0===i&&(this._emitConvUpdate(),this._emitConvInGroupUpdate(r))}return Ys({successConversationIDList:c,failureConversationIDList:l})}).catch(e=>(n.setError(e).end(),Ce.e(i+" failed. error:",e),Qs(e)))}onConvMarkUpdated(e){if(!Oe(e)){let o,n,r=(Ce.l(this._n+".onConvMarkUpdated markItemList:",e),!1);e.forEach(e=>{var{recentContactItem:e,optType:t,standardMark:s,customMark:i}=e;if(o=this._concatConvID(e),n=this._getLocalConv(o))if(1===t)r=this._diffStandardMark(n,s);else if(2===t)r=this._diffCustomMark(n,i);else if(3===t){const e=this._diffStandardMark(n,s),o=this._diffCustomMark(n,i);r=e||o}}),!0===r&&this._emitConvUpdate()}}_diffStandardMark(e,t){t=yt(t);let s=!1;return!0!==function(s,i){if(s===i)return!0;if(!s||!i)return!1;if(s.length!==i.length)return!1;for(let e=0,t=s.length;e<t;e++)if(s[e]!==i[e])return!1;return!0}(e.markList,t)&&(e.markList=t,s=!0),s}_diffCustomMark(e,t){let s=!1;return e.customData!==t&&void 0!==t&&(e.customData=t,s=!0),s}onConvGroupCreated(e){Ce.l(this._n+".onConvGroupCreated resultList:",e);let n=!1,s=!1;be(e)&&(e.forEach(e=>{const{groupID:t,groupName:i}=e.msgGroupItem,o=(this._convGroupMap.get(t)!==i&&(this._convGroupMap.set(t,i),s=!0),e.msgRecentContactItem);if(be(o)){let t,s;o.forEach(e=>{t=this._concatConvID(e),(s=this._getLocalConv(t))&&-1===s.conversationGroupList.indexOf(i)&&(s.conversationGroupList.push(i),n=!0)})}}),!0===n&&this._emitConvUpdate(),!0===s&&this._emitConvGroupListUpdate())}onConvGroupDeleted(e){Ce.l(this._n+".onConvGroupDeleted groupItemList:",e);const i=[];if(be(e)){let s=!1;e.forEach(e=>{var{groupID:e,groupName:t}=e;this._convGroupMap.has(e)&&(this._convGroupMap.delete(e),s=!0,i.push(t))}),!0===s&&this._emitConvGroupListUpdate()}this._eraseFromConversationGroupList(i)}_eraseFromConversationGroupList(t){Oe(t)||(this._convM.getLocalConvList().forEach(e=>{e.conversationGroupList=e.conversationGroupList.filter(e=>!t.includes(e))}),this._emitConvUpdate())}onConvGroupNameUpdated(e){Ce.l(this._n+".onConvGroupNameUpdated options:",e);const{groupID:o,groupName:n,oldGroupName:r}=e;if(this._convGroupMap.get(o)!==n){this._convGroupMap.set(o,n),this._emitConvGroupListUpdate();const a=this._convM.getLocalConvList();let t,s,i=!1;a.forEach(e=>{t=e.conversationGroupList,-1!==(s=t.indexOf(r))&&(t.splice(s,1,n),i=!0)}),!0===i&&this._emitConvUpdate()}}onConvInGroupUpdated(e){Ce.l(this._n+".onConvInGroupUpdated options:",e);const{oldGroupName:r,recentContactUpdateGroupItem:t}=e;if(be(t)){let s,i,o,n=!1;t.forEach(e=>{var{contactOptType:e,recentContactItem:t}=e;s=this._concatConvID(t),(i=this._getLocalConv(s))&&(o=i.conversationGroupList.indexOf(r),1===e?-1===o&&(i.conversationGroupList.push(r),n=!0):2===e&&-1!==o&&(i.conversationGroupList.splice(o,1),n=!0))}),!0===n&&(this._emitConvUpdate(),this._emitConvInGroupUpdate(r))}}onConvAddedToOrDeletedFromGroup(e){Ce.l(this._n+".onConvAddedToOrDeletedFromGroup options:",e);const{msgRecentContactItem:t,msgRecentContactUpdateContactItem:o}=e,s=this._concatConvID(t),n=this._getLocalConv(s);if(n&&be(o)){let s,i=!1;o.forEach(e=>{var{groupOptType:e,recentContactGroupItem:t}=e,t=t["groupName"];s=n.conversationGroupList.indexOf(t),1===e?-1===s&&(n.conversationGroupList.push(t),i=!0):2===e&&-1!==s&&(n.conversationGroupList.splice(s,1),i=!0),!0===i&&this._emitConvInGroupUpdate(t)}),!0===i&&this._emitConvUpdate()}}onConvGroupListSynced(e){be(e)&&0!==e.length&&(Ce.l(this._n+".onConvGroupListSynced groupItem:",e),this._fillConvGroupMap(e))}getConvGroupListByID(e){if(!Oe(e)){const t=[];return e.forEach(e=>{this._convGroupMap.has(e)&&t.push(this._convGroupMap.get(e))}),t}}_onConvNotFound(e,t){e.push({conversationID:t,code:js.CONV_NOT_FOUND,message:this._convM.getErrMsg(js.CONV_NOT_FOUND)})}_onConvIDInvalid(e,t){e.push({conversationID:t,code:js.INVALID_CONV_ID,message:this._convM.getErrMsg(js.INVALID_CONV_ID)})}_getFlagBit(e){var t=e.toString(2),s=t.length;for(let e=s-1;0<=e;e--)if("1"===t[e])return s-e-1}_concatConvID(e){var{type:e,to:s,groupID:i,userID:o}=e;let n;return 1===e?$e(o)?$e(s)||(n=""+t.CONV_C2C+s):n=""+t.CONV_C2C+o:2===e&&(n=""+t.CONV_GROUP+i),n}_getMyUserID(){return this._convM.getMyUserID()}_getLocalConv(e){return this._convM.getLocalConversation(e)}_hasLocalConv(e){return this._convM.hasLocalConversation(e)}_emitConvUpdate(){this._convM.emitConvUpdate(!0,!1)}_emitConvGroupListUpdate(){this._convM.emitOEvt(e.CONVERSATION_GROUP_LIST_UPDATED,[...this._convGroupMap.values()])}_emitConvInGroupUpdate(t){const s={groupName:t,conversationList:[]},i=this._convM.getLocalConvList();s.conversationList=i.filter(e=>e.conversationGroupList.includes(t)),this._convM.emitOEvt(e.CONVERSATION_IN_GROUP_UPDATED,s)}reset(){Ce.l(this._n+".reset"),this._convGroupMap.clear(),this._startIndex=0,this._pagingStatus=Pt}}class an extends ei{constructor(e){super(e),this._n="ConvModule",Ki.mixin(this),this._msgListHandler=new Bi(this),this._msgRemindHandler=new on(this),this._convGroupHandler=new rn(this),this._sll=new Zi(100),this._pagingStatus=Pt,this._pagingTs=0,this._pagingStartIdx=0,this._pagingPinnedTs=0,this._pagingPinnedStartIdx=0,this._pagingConvIDMap=new Map,this._convIDFromUnreadDBMap=new Map,this._convMap=new Map,this._tmpGroupList=[],this._tmpGroupAtTipsList=[],this._peerReadTimeMap=new Map,this._completedMap=new Map,this._roamingMsgKeyAndTimeMap=new Map,this._remoteGroupReadSeqMap=new Map,this._convTotalUnreadCount=0,this._pagingGetCostList=[],this._convMapForDiff=new Map,this._partialUpdatedConvMap=new Map,this._everClearedMap=new Map,this._bPullOnInvite=!0,this._initListeners()}_initListeners(){const e=this.getIEmitInst();e.on(Vi.A2KEY_AND_TINYID_UPDATED,this._init,this),e.on(Vi.PROFILE_UPDATED,this._onProfileUpdated,this),e.on(Vi.CLOUD_CONFIG,this._onCloudConfig,this)}_init(){Ce.l(this._n+"._init");var t=this.get(Es).getItem("conversationMap"),s=this.isIntl(),i=this.isUsingChatCore();if(t){var o=t.length;for(let e=0;e<o;e++){var n=t[e];if(n){if(this._isNonExistentAccount(n.conversationID))continue;if(n.groupProfile&&it(n.groupProfile.type))continue}this._convMap.set(n.conversationID,new sn(t[e],s,i))}this.emitConvUpdate(!0,!1)}this.ready(()=>{0<this._tmpGroupList.length&&(this.updateConvGroupProfile(this._tmpGroupList),this._tmpGroupList.length=0)}),this.syncConvList()}_isNonExistentAccount(e){let s;return"@TLS#ERROR"===(s=e.startsWith(t.CONV_C2C)?e.replace(t.CONV_C2C,""):s)||"@TLS#NOT_FOUND"===s}onCheckTimer(e){this.isLoggedIn()&&this._msgListHandler.onCheckTimer(e)}onMessageSent(e){this._onSendOrRcvMsg({conversationOptionsList:e.conversationOptionsList,isInstantMessage:!0})}onNewMessage(e){this._onSendOrRcvMsg(e)}_onSendOrRcvMsg(e){const{conversationOptionsList:t,isInstantMessage:s=!0,isUnreadC2CMessage:i=!1,updateUnreadCount:o=!0,isSyncingEnded:n=!1}=e;this._isReady?0!==t.length?(!0===s&&this._checkNewConv(t),this._updateLocalConvList({conversationOptionsList:t,isInstantMessage:s,isUnreadC2CMessage:i,isFromGetConversations:!1,updateUnreadCount:o}),s||(this._convIDFromUnreadDBMap=new Map([...this._convIDFromUnreadDBMap,...t.map(e=>[e.conversationID,1])]),this._diffAndDeleteConv(),n&&this.emitIEvt(Vi.C2C_UNREAD_HANDLE_COMPLETED)),0<t.filter(e=>!this._isConvNeedShow(e.conversationID)).length||this.emitConvUpdate()):n&&this.emitIEvt(Vi.C2C_UNREAD_HANDLE_COMPLETED):this.ready(()=>{this._onSendOrRcvMsg(e)})}updateConvGroupProfile(e){if(!be(e)||0!==e.length)if(0!==this._convMap.size){let i=!1;e.forEach(e=>{var s=""+t.CONV_GROUP+e.groupID;if(this._convMap.has(s)){i=!0;const t=this._convMap.get(s);t.groupProfile=JSON.parse(JSON.stringify(e)),t.lastMessage.lastSequence<e.nextMessageSeq&&(t.lastMessage.lastSequence=e.nextMessageSeq-1),t.subType||(t.subType=e.type)}}),i&&this.emitConvUpdate(!0,!1)}else this._tmpGroupList=e}onMessageRevoked(e,o){if(0!==e.length){let s=null,i=!1;const n=[];e.forEach(e=>{(s=this._convMap.get(e.conversationID))&&(o&&s.reduceUnreadCount()&&(i=s.type!==t.CONV_TOPIC),s.type===t.CONV_TOPIC?n.push(e):s.isLastMessageRevoked({sequence:e.sequence,time:e.time})&&(s.setLastMessageRevoked(!0),s.setLastMessageRevoker(e.revoker),i=!0))}),this.get(Ts).onMessageRevoked(n),i&&this.emitConvUpdate(!0,!1)}}updateRevokerInfo(o){const t=new Set;for(let e=0;e<o.length;e++){const s=o[e]["revoker"];t.add(s)}const s=[...t],e=this.get(fs);return new Promise(i=>{e.getUserProfile({userIDList:s}).then(e=>{e=e.data;if(!be(e)||0===e.length)return i(o);const s={};for(const{userID:o,nick:i,avatar:t}of e)s[o]={nick:i,avatar:t};o.forEach(e=>{var t=e["revoker"];s[t]&&(e.revokerInfo.nick=s[t].nick||"",e.revokerInfo.avatar=s[t].avatar||"")}),i(o)}).catch(()=>{i(o)})})}isLastMessageRevoked(e){let s=!1;const{conversationID:i,sequence:o,time:n}=e,r=this._convMap.get(i);return r&&(s=r.type===t.CONV_TOPIC?this.get(Ts).isLastMessageRevoked({topicID:i.replace(t.CONV_GROUP,""),sequence:o}):r.isLastMessageRevoked({sequence:o,time:n})),Ce.l(this._n+".isLastMessageRevoked options:",e,"ret:"+s),s}onMessageDeleted(e){if(0!==e.length){let s=null;e.forEach(e=>{(s=this._msgListHandler.getLocalMsg(e.conversationID,e.ID))&&(s.isDeleted=!0),e!==s&&(e.isDeleted=!0)});const o=e[0].conversationID,n=this._msgListHandler.getLocalMsgList(o);let i={};for(let e=n.length-1;0<=e;e--)if(!n[e].isDeleted){i=n[e];break}const r=this._convMap.get(o);if(r){let e=!1;r.lastMessage.lastSequence===i.sequence&&r.lastMessage.lastTime===i.time||(Oe(i)&&(i=void 0),r.updateLastMessage(i),r.type!==t.CONV_TOPIC&&(e=!0),Ce.l(`${this._n}.onMessageDeleted. update convID:${o} with lastMessage:`,r.lastMessage)),o.startsWith(t.CONV_C2C)&&this.updateUnreadCount(o),e&&this.emitConvUpdate(!0,!1)}}}onMessageModified(s){var i=this._n+".onMessageModified",{conversationType:o,from:n,to:r,time:u,sequence:h,elements:a,cloudCustomData:p,messageVersion:c}=s;let l=""+o+r;r===this.getMyUserID()&&o===t.CONV_C2C&&(l=""+o+n);var{isUpdated:o,message:d}=this._msgListHandler.onMsgModified(l,s),_=(!0===o&&this.emitOEvt(e.MESSAGE_MODIFIED,[d]),this._isTopicConv(l));if(null===d?Ce.l(i+" message is null! options:",s):Ce.l(i+` isUpdated:${o} isTopicMessage:${_} from:${n} to:${r} sequence:${d.sequence} time:`+d.time),_)this.get(Ts).onMessageModified(s);else{const e=this._convMap.get(l);if(e){const t=e.lastMessage;t&&t.lastTime===u&&t.lastSequence===h&&t.version!==c&&(Ce.l(i+` convID:${l} lastMessage updated`),t.type=a[0].type,t.payload=a[0].content,t.messageForShow=Tt(t.type,t.payload,this.isIntl()),t.cloudCustomData=p,t.version=c,this.emitConvUpdate(!0,!1))}}return d}onNewGroupAtTips(e){const t=e.dataList;let s=null;t.forEach(e=>{e.groupAtTips?s=e.groupAtTips:e.elements?s={...e.elements,sync:!0}:e.groupAtType&&(s={...e,sync:!0}),s.__random=e.random,s.__sequence=e.clientSequence,this._tmpGroupAtTipsList.push(s)}),Ce.l(this._n+".onNewGroupAtTips isReady:"+this._isReady,this._tmpGroupAtTipsList),this._isReady&&this._handleGroupAtTipsList()}_handleGroupAtTipsList(){if(0!==this._tmpGroupAtTipsList.length){let r=!1;this._tmpGroupAtTipsList.forEach(e=>{const{groupID:s,from:i,topicID:o,sync:n=!1}=e;if(i!==this.getMyUserID())if($e(o)){const i=this._convMap.get(""+t.CONV_GROUP+s);i&&(i.updateGroupAtInfoList(e),r=!0)}else{const r=this._convMap.get(""+t.CONV_GROUP+o);if(r){r.updateGroupAtInfoList(e);const t=this.get(Ts),s=r["groupAtInfoList"];t.onAtInfoUpdated({topicID:o,groupAtInfoList:s})}Oe(r)&&n&&(this.updateTopicConversation([{conversationID:""+t.CONV_GROUP+o,type:t.CONV_TOPIC}]),this._convMap.get(""+t.CONV_GROUP+o).updateGroupAtInfoList(e))}}),r&&this.emitConvUpdate(!0,!1),this._tmpGroupAtTipsList.length=0}}_checkNewConv(e){let s=[],i=[];e.forEach(e=>{this._convMap.has(e.conversationID)||(e.type===t.CONV_C2C?s.push(e.conversationID.replace(t.CONV_C2C,"")):e.type===t.CONV_GROUP&&i.push(e.conversationID.replace(t.CONV_GROUP,"")))}),0<s.length&&(this._onNewC2CConv(s),s=null),0<i.length&&(this._onNewGroupConv(i),i=null)}_onNewC2CConv(e){const t=this.get(Ms);return Promise.all([t.getRemotePeerReadTime(e),this._msgRemindHandler.getC2CMsgRemindType(e),this._convGroupHandler.searchConvGroupAndMark(e,1)])}_onNewGroupConv(e){const t=this.get(Is);return t?Promise.all([t.getMsgRemindType(e),this._convGroupHandler.searchConvGroupAndMark(e,2)]):Promise.resolve()}_setStorageConvList(e=!1){var s=this.getLocalConvList().filter(e=>e.type===t.CONV_C2C||e.type===t.CONV_GROUP&&e.lastMessage.type!==t.MSG_GRP_TIP).slice(0,20).map(e=>({conversationID:e.conversationID,type:e.type,subType:e.subType,lastMessage:e.lastMessage,groupProfile:e.groupProfile,userProfile:e.userProfile}));this.get(Es).setItem("conversationMap",s,e)}emitConvUpdate(t=!0,s=!0){var i=this.getLocalConvList();if(s){const e=this.get(Is);e&&e.updateGroupLastMessage(i)}t&&(this.get(vs).isPartialUpdatedConvs()?(this._diffConvMap(this._convMapForDiff,this._convMap),0<this._partialUpdatedConvMap.size&&(this.emitOEvt(e.CONVERSATION_LIST_UPDATED),this.onTotalUnreadCountUpdate(),this._convMapForDiff.clear(),this._convMapForDiff=Ye(this._convMap,!0)),0===this._convMapForDiff.size&&(this._convMapForDiff=Ye(this._convMap,!0))):(this.emitOEvt(e.CONVERSATION_LIST_UPDATED),this.onTotalUnreadCountUpdate()))}_diffConvMap(e,t){for(var[s,i]of t)e.has(s)&&JSON.stringify(i)===e.get(s)||this._partialUpdatedConvMap.set(s,i)}getPartialUpdatedConvs(){var e=[...Ye(this._partialUpdatedConvMap,!1).values()];return this._partialUpdatedConvMap.clear(),e}getLocalConvList(){return[...this._convMap.values()].filter(e=>this._isConvNeedShow(e.conversationID))}getLocalConversation(e){return this._convMap.get(e)}hasLocalConversation(e){return this._convMap.has(e)}getLocalOldestMessage(e){return this._msgListHandler.getLocalOldestMsg(e)}syncConvList(e=!0){const i=new mi("syncConvList");return this._pagingStatus===Pt&&this._convMap.clear(),this._pagingGetConvList(e).then(e=>{var t=function(e){if(be(e)&&0!==e.length){let t=0;return e.forEach(e=>{t+=e}),(t/e.length).toFixed(0)}}(this._pagingGetCostList),s=function(e){if(be(e)&&0!==e.length){let t=0;return e.forEach(e=>{t+=e}),t.toFixed(0)}}(this._pagingGetCostList),s=(this._pagingGetCostList.length=0,this._pagingStatus=Gt,this._diffAndDeleteConv(),this.emitConvUpdate(!0,!1),this._setStorageConvList(),this._handleC2CPeerReadTime(),this.emitIEvt(Vi.CONV_SYNC_COMPLETED),`count:${this._convMap.size} sum:${s} avg:`+t);return Ce.l(this._n+".syncConvList. "+s),i.setMessage(s).end(),e}).catch(e=>(this._pagingStatus=kt,i.setMessage(this._pagingTs).setError(e).end(),Qs(e)))}_diffAndDeleteConv(){if(this._isSyncCompleted()){let s=[];this._convMap.forEach((e,t)=>{!this._pagingConvIDMap.has(t)&&this._convIDFromUnreadDBMap.has(t)&&(this._convMap.delete(t),s.push(t))}),Ce.l(this._n+"._diffAndDeleteConv list:"+s),s=null}}_pagingGetConvList(e=!0){const a=this._n+"._pagingGetConvList",c=(Ce.l(a+` incrementalPullFlag:${e} ts:${this._pagingTs} startIdx:${this._pagingStartIdx} pinnedTs:${this._pagingPinnedTs} pinnedStartIdx:`+this._pagingPinnedStartIdx),Date.now());return this._pagingStatus=Ut,this.req({P:ti.PAGING_GET_CONV_LIST,data:{fromAccount:this.getMyUserID(),timeStamp:e?this._pagingTs:0,startIndex:e?this._pagingStartIdx:0,pinnedTimeStamp:e?this._pagingPinnedTs:0,pinnedStartIndex:e?this._pagingPinnedStartIdx:0,orderType:1}}).then(e=>{var{completeFlag:e,conversations:t=[],timeStamp:s,startIndex:i,pinnedTimeStamp:o,pinnedStartIndex:n,groupItem:r}=e.data;if(this._pagingGetCostList.push(St(c,!1)),Ce.l(a+` ok. completeFlag:${e} count:${t.length} cost:`+St(c)),this._convGroupHandler.onConvGroupListSynced(r),0<t.length){const e=this._getConvOptions(t);this._pagingConvIDMap=new Map([...this._pagingConvIDMap,...e.map(e=>[e.conversationID,1])]),this._updateLocalConvList({conversationOptionsList:e,isFromGetConversations:!0,updateUnreadCount:!0}),this.isLoggedIn()&&this.emitConvUpdate()}if(!this._isReady){if(!this.isLoggedIn())return Zs();this.triggerReady()}return this._pagingTs=s,this._pagingStartIdx=i,this._pagingPinnedTs=o,this._pagingPinnedStartIdx=n,1!==e?this._pagingGetConvList():(this._handleGroupAtTipsList(),this._convGroupHandler.getRemoteConvGroupList(),Zs())}).catch(e=>{throw this.isLoggedIn()&&(this._isReady||(Ce.w(a+" failed. error:",e),this.triggerReady())),e})}_updateLocalConvList(e){var t=e["isFromGetConversations"],s=Date.now(),e=this._getTmpConvListMapping(e)["newConvList"];this._convMap=new Map(this._sortConvList([...this._convMap])),t||this._updateUserOrGroupProfile(e),Ce.l(this._n+"._updateLocalConvList cost:"+St(s))}_getTmpConvListMapping(i){const{conversationOptionsList:o,isFromGetConversations:n,isInstantMessage:r,isUnreadC2CMessage:h=!1,updateUnreadCount:p}=i,a=[],c=[],l=this.get(Is),d=this.get(Cs),g=this.isIntl(),m=this.isUsingChatCore();for(let e=0,s=o.length;e<s;e++){const i=new sn(o[e],g,m),{conversationID:_,type:u}=i;if(!this._isNonExistentAccount(_)){if(this._convMap.has(_)){const a=this._convMap.get(_);if(n){this._convMap.set(_,i),u===t.CONV_C2C?i.unreadCount=a.unreadCount:u===t.CONV_GROUP&&(i.groupProfile=JSON.parse(JSON.stringify(a.groupProfile)));continue}const c=["unreadCount","allowType","adminForbidType","payload"],l=(!1===r&&c.push("lastMessage"),"boolean"==typeof r&&c.push("isPinned"),o[e].lastMessage),d=!$e(l);d||o[e].type===t.CONV_TOPIC||this._onLastMsgNotExist(o[e]),$e(r)&&d&&null===a.lastMessage.payload&&(a.lastMessage.payload=l.payload),Oe(a.lastMessage.revoker)||(a.lastMessage.revoker=null),We(a,i,c,[null,void 0,"",0,NaN]),!0===p&&a.updateUnreadCount({nextUnreadCount:i.unreadCount,isFromGetConversations:n,isUnreadC2CMessage:h}),r&&d&&(l.payload&&(a.lastMessage.payload=l.payload),a.type===t.CONV_GROUP&&(a.lastMessage.nameCard=l.nameCard,a.lastMessage.nick=l.nick)),d&&a.lastMessage.cloudCustomData!==l.cloudCustomData&&(a.lastMessage.cloudCustomData=l.cloudCustomData||"")}else{if(u===t.CONV_GROUP&&l){const t=i.groupProfile["groupID"],o=l.getLocalGroupProfile(t);o&&(i.groupProfile=o,!0===p&&i.updateUnreadCount({nextUnreadCount:0}))}else if(u===t.CONV_C2C){const o=_.replace(t.CONV_C2C,"");d&&d.isMyFriend(o)&&(i.remark=d.getFriendRemark(o))}a.push(i),this._convMap.set(_,i)}this._convMap.get(_).type===t.CONV_TOPIC&&c.push(this._convMap.get(_))}}const _=this.get(Ts);for(let e=0,s=c.length;e<s;e++){const{conversationID:i,groupAtInfoList:o}=c[e];Oe(o)||_.onAtInfoUpdated({topicID:i.replace(t.CONV_GROUP,""),groupAtInfoList:o})}return{newConvList:a}}_onLastMsgNotExist(e){new mi("lastMsgNotExist").setMessage(JSON.stringify(e)).end()}_sortConvList(e){const t=[],s=[],i=[],o=[];return e.forEach(e=>{(!0===e[1].isPinned?Oe(e[1].lastMessage.lastTime)?s:t:Oe(e[1].lastMessage.lastTime)?o:i).push(e)}),t.sort((e,t)=>t[1].lastMessage.lastTime-e[1].lastMessage.lastTime).concat(s).concat(i.sort((e,t)=>t[1].lastMessage.lastTime-e[1].lastMessage.lastTime)).concat(o)}_sortConvListAndEmitEvent(){this._convMap=new Map(this._sortConvList([...this._convMap])),this.emitConvUpdate(!0,!1)}_updateUserOrGroupProfile(e){if(0!==e.length){const s=[],i=[],o=this.get(fs),n=this.get(Is);e.forEach(e=>{if(e.type===t.CONV_C2C)s.push(e.toAccount);else if(e.type===t.CONV_GROUP){const t=e.toAccount;n.hasLocalGroup(t)?e.groupProfile=n.getLocalGroupProfile(t):i.push(t)}}),Ce.l(`${this._n}._updateUserOrGroupProfile userIDList:${s} groupIDList:`+i),0<s.length&&o.getUserProfile({userIDList:s}).then(({data:e})=>{be(e)?e.forEach(e=>{this._doUpdateUserProfile(""+t.CONV_C2C+e.userID,e)}):this._doUpdateUserProfile(""+t.CONV_C2C+e.userID,e)}),0<i.length&&n.getGroupProfileAdvance({groupIDList:i,responseFilter:{groupBaseInfoFilter:["Type","Name","FaceUrl"]}}).then(({data:{successGroupList:e}})=>{let i=!1;e.forEach(e=>{var s=""+t.CONV_GROUP+e.groupID;if(this._convMap.has(s)){const t=this._convMap.get(s);We(t.groupProfile,e,[],[null,void 0,"",0,NaN]),!t.subType&&e.type&&(t.subType=e.type),i=!0}}),i&&this.emitConvUpdate()})}}_doUpdateUserProfile(e,t){this.hasLocalConversation(e)&&(this.getLocalConversation(e).userProfile=t,this.emitConvUpdate())}_getConvOptions(e){const i=[],s=e.filter(({type:e,userID:t})=>1===e&&!this._isNonExistentAccount(t)||2===e),o=this.getMyUserID(),n=s.map(e=>{var s;return $e(e.lastMsg)&&(e.lastMsg={elements:[]}),1===e.type?(s={userID:e.userID,nick:e.peerNick,avatar:e.peerAvatar},i.push(s),{conversationID:""+t.CONV_C2C+e.userID,type:t.CONV_C2C,lastMessage:{lastTime:e.time,lastSequence:e.sequence,fromAccount:e.lastC2CMsgFromAccount,type:e.lastMsg.elements[0]?e.lastMsg.elements[0].type:null,payload:e.lastMsg.elements[0]?this._amendLayersOverLimitProp(e.lastMsg.elements[0].content):null,cloudCustomData:e.lastMsg.cloudCustomData||"",isRevoked:8===e.lastMessageFlag,onlineOnlyFlag:!1,nick:"",nameCard:"",version:0,isPeerRead:e.lastC2CMsgFromAccount===o&&e.time<=e.c2cPeerReadTime,revoker:e.lastMsg.revokerInfo?e.lastMsg.revokerInfo.revoker:null},unreadCount:0,userProfile:new Xi(s),peerReadTime:e.c2cPeerReadTime,isPinned:1===e.isPinned,customData:e.customMark||"",markList:yt(e.standardMark),conversationGroupList:this._convGroupHandler.getConvGroupListByID(e.contactGroupId),remark:e.friendRemark||"",messageRemindType:this._transMsgRemindType(e.messageRemindType)}):{conversationID:""+t.CONV_GROUP+e.groupID,type:t.CONV_GROUP,lastMessage:{lastTime:e.time,lastSequence:e.sequence,fromAccount:e.msgGroupFromAccount,...this._patchTypeAndPayload(e),cloudCustomData:e.lastMsg.cloudCustomData||"",isRevoked:2===e.lastMessageFlag,onlineOnlyFlag:!1,nick:e.senderNick||"",nameCard:e.senderNameCard||"",revoker:e.lastMsg.revokerInfo?e.lastMsg.revokerInfo.revoker:null},groupProfile:new en({groupID:e.groupID,name:e.groupNick,avatar:e.groupImage,type:e.groupType,nextMessageSeq:e.nextMessageSeq}),unreadCount:this._computeGroupUnreadCount(e),peerReadTime:0,isPinned:1===e.isPinned,version:0,customData:e.customMark||"",markList:yt(e.standardMark),conversationGroupList:this._convGroupHandler.getConvGroupListByID(e.contactGroupId),messageRemindType:this._transMsgRemindType(e.messageRemindType)}});return 0<i.length&&this.get(fs).onConvProfileUpdated(i),n}_transMsgRemindType(e){let s="";return 0===e?s=t.MSG_REMIND_ACPT_AND_NOTE:1===e?s=t.MSG_REMIND_DISCARD:2===e?s=t.MSG_REMIND_ACPT_NOT_NOTE:3===e&&(s=t.NOT_RECEIVE_OFFLINE_PUSH_EXCEPT_AT),s}_computeGroupUnreadCount(e){var{unreadCount:e=0,noUnreadCount:t=0}=e,e=e-t;return 0<e?e:0}_patchTypeAndPayload(e){const{event:s,elements:i=[],groupTips:o={}}=e.lastMsg;if($e(s)||Oe(o))return{type:i[0]?i[0].type:null,payload:i[0]?this._amendLayersOverLimitProp(i[0].content):null};{let e=new wi(o);e.setElement({type:t.MSG_GRP_TIP,content:{...o.elements,groupProfile:o.groupProfile}});const s=JSON.parse(JSON.stringify(e.payload));return e=null,{type:t.MSG_GRP_TIP,payload:s}}}_amendLayersOverLimitProp(e){var t=e["layersOverLimit"];return 0===t?e.layersOverLimit=!1:1===t&&(e.layersOverLimit=!0),e}getLocalMessageList(e){return this._msgListHandler.getLocalMsgList(e)}deleteLocalMessage(e){e instanceof wi&&this._msgListHandler.remove(e)}onConvDeleted(e){be(e)&&(e=e.map(e=>{var{type:e,userID:s,groupID:i}=e;return 1===e?""+t.CONV_C2C+s:2===e?""+t.CONV_GROUP+i:void 0}),Ce.l(this._n+".onConvDeleted convIDList:"+e),this.deleteLocalConvList(e))}onConvPinnedStatus(e,r){if(be(e)){let n=!1;e.forEach(e=>{var{type:e,userID:s,groupID:i}=e;let o;1===e?o=this.getLocalConversation(""+t.CONV_C2C+s):2===e&&(o=this.getLocalConversation(""+t.CONV_GROUP+i)),o&&(Ce.l(`${this._n}.onConvPinnedStatus convID:${o.conversationID} localPinned:${o.isPinned} remotePinned:`+r),r?o.isPinned||(o.isPinned=!0,n=!0):o.isPinned&&(o.isPinned=!1,n=!0))}),n&&this._sortConvListAndEmitEvent()}}getMessageList({conversationID:a,nextReqMessageID:e,count:t}){const c=this._n+".getMessageList",s=this.getLocalConversation(a);let i="";if(s&&s.groupProfile&&(i=s.groupProfile.type),it(i))return Ce.l(c+` not available in ${i}. convID:`+a),Zs({messageList:[],nextReqMessageID:"",isCompleted:!0});($e(t)||15<t)&&(t=15),e||this._isMeInCommunity(a)||this.clearMemMsg(a);const l=this._computeRemainingCount({conversationID:a,nextReqMessageID:e}),o=this._completedMap.has(a);if(Ce.l(c+` convID:${a} isEverCleared:${this._isEverCleared(a)} nextReqMessageID:${e} remainingCount:${l} count:${t} isCompleted:`+o),this._needGetHistory({conversationID:a,remainingCount:l,count:t}))return this.getHistoryMessages({conversationID:a,nextReqMessageID:e,count:20}).then(e=>{var{nextReqID:e,storedMessageList:t,assembledMessageList:s,isPullingCompleted:i}=e,o=this._completedMap.has(a);let n=t;0<l&&(n=this._msgListHandler.getLocalMsgList(a).slice(0,t.length+l));const r={nextReqMessageID:void 0,messageList:void 0,isCompleted:void 0};this._isEverCleared(a)?(r.nextReqMessageID=e,r.messageList=s,r.isCompleted=i):(r.nextReqMessageID=o?"":e,r.messageList=n,r.isCompleted=o);t=r.messageList.filter(e=>e.isRevoked)||[],s=r.messageList.map(e=>e.sequence);return Ce.l(c+` ret.nextReqMessageID:${r.nextReqMessageID} ret.isCompleted:${r.isCompleted} sequenceList:`,s),be(t)&&0!==t.length?this.updateRevokerInfo(t).then(e=>(e.forEach(t=>{const s=t["revokerInfo"];r.messageList=r.messageList.map(e=>(e.ID===t.ID&&s&&(e.revokeReason=s.reason||"",e.revokerInfo={userID:s.revoker||e.revoker,nick:s.nick,avatar:s.avatar}),e))}),Ys(r))):Ys(r)});this.modifyMessageList(a);e=this._getMsgListFromMem({conversationID:a,nextReqMessageID:e,count:t});return Zs(e)}_isEverCleared(e){return this._everClearedMap.has(e)}_getMsgListFromMem({conversationID:e,nextReqMessageID:t,count:s}){const i=this._n+"._getMsgListFromMem",o=this._msgListHandler.getLocalMsgList(e),n=o.length,r=rt(e);let a=0;const c={isCompleted:!1,nextReqMessageID:"",messageList:[]};t?(a=r?o.findIndex(e=>e.ID===t):o.findIndex(e=>e.sequence+""===t))>s?(c.messageList=o.slice(a-s,a),c.nextReqMessageID=r?o[a-s].ID:o[a-s].sequence+""):(c.messageList=o.slice(0,a),c.isCompleted=!0):s<n?(a=n-s,c.messageList=o.slice(a,n),c.nextReqMessageID=r?o[a].ID:o[a].sequence+""):(c.messageList=o.slice(0,n),c.isCompleted=!0);s=c.messageList.map(e=>e.sequence);return Ce.l(i+` convID:${e} ret.nextReqMessageID:${c.nextReqMessageID} ret.isCompleted:${c.isCompleted} sequenceList:`+s),c}getMessageListHopping(e){let{conversationID:s,sequence:i,time:o,count:n,direction:r=0}=e;if(($e(n)||15<n)&&(n=15),s.startsWith(t.CONV_C2C)){const e=this.get(Ms),i=s.replace(t.CONV_C2C,"");return e.getRoamingMessagesHopping({peerAccount:i,time:o,count:n,direction:r})}if(s.startsWith(t.CONV_GROUP)){const e=this.get(Is),o=s.replace(t.CONV_GROUP,"");return e.getRoamingMessagesHopping({groupID:o,sequence:i,count:n,direction:r})}}_computeRemainingCount({conversationID:e,nextReqMessageID:t}){const s=this._msgListHandler.getLocalMsgList(e),i=s.length;if(Ce.l(this._n+`._computeRemainingCount convID:${e} nextReqMessageID:${t} length:`+i),!t)return i;let o=0;return rt(e)?o=s.findIndex(e=>e.ID===t):at(e)&&(o=-1!==t.indexOf("-")?s.findIndex(e=>e.ID===t):s.findIndex(e=>e.sequence+""===t)),o=-1===o?0:o}_needGetHistory({conversationID:e,remainingCount:t,count:s}){var i=this.getLocalConversation(e);let o="";if(i&&i.groupProfile&&(o=i.groupProfile.type),ct(e)||it(o))return!1;if(this._isEverCleared(e))return!0;i=t<=s&&!this._completedMap.has(e);return Ce.l(this._n+`._needGetHistory convID:${e} ret:`+i),i}_isTopicConv(e){e=e.replace(t.CONV_GROUP,"");return ot(e)}getHistoryMessages(o){const{conversationID:n,count:e,nextReqMessageID:r}=o;if(n===t.CONV_SYSTEM)return Zs();let a=15,c=(20<e&&(a=20),null);if(rt(n)){let e=0,s="",i=!1;o=this._roamingMsgKeyAndTimeMap.has(n);if(r)if(i=!0,o)e=this._roamingMsgKeyAndTimeMap.get(n).lastMessageTime,s=this._roamingMsgKeyAndTimeMap.get(n).messageKey;else{const t=this._msgListHandler.findMessage(r);t&&(e=t.time,Ce.l(`${this._n}.getHistoryMessages convID:${n} isRelayInfoExisted:${o} lastMessageTime:`+e))}return(c=this.get(Ms)).getRoamingMessage({conversationID:n,peerAccount:n.replace(t.CONV_C2C,""),count:a,lastMessageTime:i?e:0,messageKey:i?s:""})}if(at(n)){if(!(c=this.get(Is)))return Qs({code:js.NO_MODULE});const o=n.replace(t.CONV_GROUP,"");let e=null,s=(this._convMap.has(n)&&!ot(o)&&(e=this._convMap.get(n).lastMessage),0);return r?s=Number(r):e&&(s=e.lastSequence),c.getRoamingMessage({conversationID:n,groupID:o,count:a,sequence:s})}return Zs()}patchConvLastMessage(e,t=!1){const s=this.getLocalConversation(e);if(s){const{messageForShow:i,payload:o}=s.lastMessage;if(Oe(i)||Oe(o)||t){const i=this._msgListHandler.getLocalMsgList(e);if(0!==i.length){const o=i[i.length-1];Ce.l(this._n+`.patchConvLastMessage bForceUpdate:${t} convID:${e} payload:`,o.payload),s.updateLastMessage(o)}}}}onRoamingMessage(e=[],_,u=!0,s){var i=_.startsWith(t.CONV_C2C)?t.CONV_C2C:t.CONV_GROUP;let o=null,n=[],r=[],a=0,c=e.length,l;const d=i===t.CONV_GROUP,h=this.getFileDownloadProxy(),p=this.getDowloadFileAuthKey(),g=be(s),m=this.get(Rs).getFileDNList();let f=()=>{d?--a:++a},M=()=>d?a>=c:a<c;for(a=d?e.length-1:0,c=d?0:e.length;M();f())if(1!==e[a].isPlaceMessage)if((o=new wi(e[a])).to=e[a].to,i!==t.CONV_GROUP||$e(e[a].topicID)||(o.to=e[a].topicID),o.isSystemMessage=!!e[a].isSystemMessage,o.conversationType=i,l=4===e[a].event?{type:t.MSG_GRP_TIP,content:{...e[a].elements,groupProfile:e[a].groupProfile}}:e[a].elements,d||o.setNickAndAvatar({nick:e[a].nick,avatar:e[a].avatar}),Oe(l)){const t=new mi("emptyMessageBody");t.setMessage(`from:${o.from} to:${o.to} sequence:${o.sequence} event:`+e[a].event),t.setLevel("warning").end()}else o.setElement(l,h,p,m),o.reInitialize(this.getMyUserID()),n.push(o),g&&s.push(o);return f=M=null,u?(this._msgListHandler.unshift(n,r),n=null,r):(r=null,n)}findMessage(e){return this._msgListHandler.findMessage(e)}_isMeInCommunity(e){let s=!0;return this._isTopicConv(e)&&(e=Ct(e.replace(t.CONV_GROUP,"")),this.get(Is).hasLocalGroup(e)||(s=!1,Ce.l(this._n+`._isMeInCommunity groupID:${e} ret:`+s))),s}deleteTopicRoamingInfo(e){nt({groupID:e})&&this._msgListHandler.getTopicConvIDList(e).forEach(e=>{this.clearMemMsg(e)})}deleteGroupRoamingInfo(e){e=""+t.CONV_GROUP+e;0<this._msgListHandler.getLocalMsgList(e).length&&this.clearMemMsg(e)}setMessageRead({conversationID:e}){const s=this.getLocalConversation(e),i=this._n+".setMessageRead";if(Ce.l(i+` convID:${e} unreadCount:`+(s?s.unreadCount:0)),!s)return Zs();if(s.type!==t.CONV_GROUP&&s.type!==t.CONV_TOPIC||Oe(s.groupAtInfoList)||this.deleteGroupAtTips(e),0===s.unreadCount)return Zs();const o=this._msgListHandler.getLocalLastMsg(e);let n=s.lastMessage.lastTime;var r=this._msgListHandler.getLocalMaxTime(e),r=(n<r&&(Ce.l(`${i} update lastMessageTime from ${n} to `+r),n=r),this._msgListHandler.getLocalMaxSeq(e));let a=s.lastMessage.lastSequence;if(a<r&&(Ce.l(`${i} update lastMessageSeq from ${a} to `+r),a=r),s.type===t.CONV_TOPIC&&$e(o)){const s=this.get(Ts),i=e.replace(t.CONV_GROUP,""),o=Ct(i),n=s.getLocalTopic(o,i);n&&(a=n.nextMessageSeq-1)}let c=null;switch(s.type){case t.CONV_C2C:return(c=this.get(Ms))?c.setMessageRead({conversationID:e,lastMessageTime:n}):Qs({code:js.NO_MODULE});case t.CONV_GROUP:case t.CONV_TOPIC:return(c=this.get(Is))?c.setMessageRead({conversationID:e,lastMessageSeq:a}):Qs({code:js.NO_MODULE});case t.CONV_SYSTEM:return s.unreadCount=0,this.emitConvUpdate(!0,!1),Zs();default:return Zs()}}setAllMessageRead(s={}){const i=this._n+".setAllMessageRead";s.scope||(s.scope=t.READ_ALL_MSG),Ce.l(i+" options:",s);var e=this._createSetAllMessageReadPack(s);if(0===e.readAllC2CMessage&&0===e.groupMessageReadInfoList.length)return Zs();const o=new mi("setAllMessageRead");return this.req({P:ti.SET_ALL_MSG_READ,data:e}).then(e=>{e=e.data,e=this._handleAllMsgRead(e);return o.setMessage(`scope:${s.scope} failureGroups:`+JSON.stringify(e)).end(),Zs()}).catch(e=>(o.setError(e).end(),Ce.w(i+" failed. error:",e),Qs({code:e&&e.code?e.code:js.MSG_UNREAD_ALL_FAIL,message:e&&e.message?e.message:void 0})))}setConvCustomData(e){return this._convGroupHandler.setConvCustomData(e)}markConv(e){return this._convGroupHandler.markConv(e)}getConvGroupList(){return this._convGroupHandler.getLocalConvGroupList()}createConvGroup(e){return this._convGroupHandler.createConvGroup(e)}deleteConvGroup(e){return this._convGroupHandler.deleteConvGroup(e)}renameConvGroup(e){return this._convGroupHandler.renameConvGroup(e)}addConvsToGroup(e){return this._convGroupHandler.addConvsToGroup(e)}deleteConvsFromGroup(e){return this._convGroupHandler.deleteConvsFromGroup(e)}onConvMarkUpdated(e){this._convGroupHandler.onConvMarkUpdated(e)}onConvGroupCreated(e){this._convGroupHandler.onConvGroupCreated(e)}onConvGroupDeleted(e){this._convGroupHandler.onConvGroupDeleted(e)}onConvGroupNameUpdated(e){this._convGroupHandler.onConvGroupNameUpdated(e)}onConvInGroupUpdated(e){this._convGroupHandler.onConvInGroupUpdated(e)}onConvAddedToOrDeletedFromGroup(e){this._convGroupHandler.onConvAddedToOrDeletedFromGroup(e)}_getConvLastMessageSeq(e){var t=this._msgListHandler.getLocalLastMsg(e.conversationID);let s=e.lastMessage.lastSequence;return s=t&&s<t.sequence?t.sequence:s}_getConvLastMessageTime(e){var t=this._msgListHandler.getLocalLastMsg(e.conversationID);let s=e.lastMessage.lastTime;return s=t&&s<t.time?t.time:s}_createSetAllMessageReadPack(e){const s={readAllC2CMessage:0,groupMessageReadInfoList:[]},i=e["scope"];for(var[,o]of this._convMap)if(0<o.unreadCount)if(o.type===t.CONV_C2C&&0===s.readAllC2CMessage){if(i===t.READ_ALL_MSG)s.readAllC2CMessage=1;else if(i===t.READ_ALL_C2C_MSG){s.readAllC2CMessage=1;break}}else if(o.type===t.CONV_GROUP&&(i===t.READ_ALL_GROUP_MSG||i===t.READ_ALL_MSG)){const e=this._getConvLastMessageSeq(o);s.groupMessageReadInfoList.push({groupID:o.groupProfile.groupID,messageSequence:e})}return s}onPushedAllMessageRead(e){this._handleAllMsgRead(e)}_handleAllMsgRead(e){var{groupMessageReadInfoList:e,readAllC2CMessage:t}=e,e=this._parseGroupReadInfo(e);return 1<=this._updateAllConvUnreadCount({readAllC2CMessage:t})&&this.emitConvUpdate(!0,!1),e}_parseGroupReadInfo(s){const i=[];if(s&&s.length)for(let e=0,t=s.length;e<t;e++){var{groupID:o,sequence:n,retCode:r,lastMessageSeq:a}=s[e];$e(r)?this._remoteGroupReadSeqMap.set(o,a):(this._remoteGroupReadSeqMap.set(o,n),0!==r&&i.push(o+`-${n}-`+r))}return i}_updateAllConvUnreadCount(e){const s=e["readAllC2CMessage"];let i=0;for(var[o,n]of this._convMap)if(1<=n.unreadCount){if(1===s&&n.type===t.CONV_C2C){const e=this._getConvLastMessageTime(n);this.updateIsReadAfterReadReport({conversationID:o,lastMessageTime:e})}else if(n.type===t.CONV_GROUP){const e=o.replace(t.CONV_GROUP,"");if(this._remoteGroupReadSeqMap.has(e)){const t=this._remoteGroupReadSeqMap.get(e),s=this._getConvLastMessageSeq(n);this.updateIsReadAfterReadReport({conversationID:o,remoteReadSequence:t}),s>=t&&this._remoteGroupReadSeqMap.delete(e)}}this.updateUnreadCount(o,!1)&&(i+=1)}return i}isRemoteRead(e){const{conversationID:s,sequence:i}=e,o=s.replace(t.CONV_GROUP,"");let n=!1;if(this._remoteGroupReadSeqMap.has(o)){const e=this._remoteGroupReadSeqMap.get(o);i<=e&&(n=!0,Ce.l(`${this._n}.isRemoteRead convID:${s} msgSeq:${i} remoteReadSeq:`+e)),i>=e+10&&this._remoteGroupReadSeqMap.delete(o)}return n}updateIsReadAfterReadReport({conversationID:e,lastMessageSeq:s,lastMessageTime:i}){var o=this._msgListHandler.getLocalMsgList(e);if(0!==o.length){let t;for(let e=o.length-1;0<=e;e--)if(t=o[e],!(i&&t.time>i||s&&t.sequence>s)){if("in"===t.flow&&t.isRead)break;t.setIsRead(!0)}}}updateUnreadCount(e,s=!0){let i=!1;const o=this.getLocalConversation(e),n=this._msgListHandler.getLocalMsgList(e);if(o){var r=o.unreadCount,a=n.filter(e=>!e.isRead&&!e._onlineOnlyFlag&&!e.isDeleted).length;if(r!==a&&(o.unreadCount=a,i=!0,Ce.l(this._n+`.updateUnreadCount from ${r} to ${a}, convID:`+e),!0===s&&this.emitConvUpdate(!0,!1)),i&&o.type===t.CONV_TOPIC){const s=o["unreadCount"],i=this.get(Ts),n=e.replace(t.CONV_GROUP,"");i.onUnreadCountUpdatedFromConv(n,s)}return i}}clearGroupAtInfoList(e,s=!0){const i=this.getLocalConversation(e);if(i&&0<i.groupAtInfoList.length){if(i.clearGroupAtInfoList(),Ce.l(this._n+".clearGroupAtInfoList convID:"+e),i.type===t.CONV_TOPIC){const s=i["groupAtInfoList"],o=this.get(Ts),n=e.replace(t.CONV_GROUP,"");o.onAtInfoUpdated({topicID:n,groupAtInfoList:s})}!0===s&&this.emitConvUpdate(!0,!1)}}updateReadReceiptInfo(s){const{userID:a,groupID:d,readReceiptList:i,timestamp:c=0}=s;if(!Oe(i)){const _=[];if($e(a)){if(!$e(d)){const e=""+t.CONV_GROUP+d;i.forEach(t=>{const{tinyID:s,clientTime:i,random:o,readCount:n,unreadCount:r}=t,a=s+`-${i}-`+o,c=this._msgListHandler.getLocalMsg(e,a)||this._msgListHandler.getHoppingMsg(e,a),l={groupID:d,messageID:a,readCount:0,unreadCount:0};c&&(Ge(n)&&(c.readReceiptInfo.readCount=n,l.readCount=n),Ge(r)&&(c.readReceiptInfo.unreadCount=r,l.unreadCount=r),_.push(l))})}}else{const e=""+t.CONV_C2C+a;i.forEach(t=>{const{tinyID:s,clientTime:i,random:o}=t,n=s+`-${i}-`+o,r=this._msgListHandler.getLocalMsg(e,n)||this._msgListHandler.getHoppingMsg(e,n);if(r&&!r.readReceiptInfo.isPeerRead){r.readReceiptInfo.isPeerRead=!0,r.readReceiptInfo.timestamp=c;const e={userID:a,messageID:n,isPeerRead:!0,timestamp:c};_.push(e)}})}0<_.length&&this.emitOEvt(e.MESSAGE_READ_RECEIPT_RECEIVED,_)}}updateIsRead(e){const i=this.getLocalConversation(e),o=this.getLocalMessageList(e);if(i&&0!==o.length&&!ct(i.type)){const n=[];for(let e=0,t=o.length;e<t;e++)"in"!==o[e].flow?"out"!==o[e].flow||o[e].isRead||o[e].setIsRead(!0):n.push(o[e]);let s=0;if(i.type===t.CONV_C2C){const e=n.slice(-i.unreadCount).filter(e=>e.isRevoked).length;s=n.length-i.unreadCount-e}else s=n.length-i.unreadCount;for(let e=0;e<s&&!n[e].isRead;e++)n[e].setIsRead(!0)}}deleteGroupAtTips(e){const s=this._n+".deleteGroupAtTips";Ce.l(s);var i=this._convMap.get(e);if(!i)return Promise.resolve();const o=i.groupAtInfoList;if(0===o.length)return Promise.resolve();let n=void 0,r=(e.startsWith(t.CONV_GROUP)&&(n=e.replace(t.CONV_GROUP,"")),[...o]);if((nt({groupID:n})||ot(n))&&0===(r=o.filter(e=>!e.atTypeArray.includes(t.CONV_AT_ALL))).length)return this.clearGroupAtInfoList(e,!1),Promise.resolve();const a=this.getMyUserID();return this.req({P:ti.DEL_GROUP_AT_TIPS,data:{messageListToDelete:r.map(e=>({from:e.from,to:a,messageSeq:e.__sequence,messageRandom:e.__random,groupID:$e(e.topicID)?e.groupID:e.topicID}))}}).then(()=>(Ce.l(s+" ok. count:"+o.length),this.clearGroupAtInfoList(e,!1),Promise.resolve())).catch(e=>(Ce.e(s+" failed. error:",e),Qs(e)))}appendToMessageList(e){return this._msgListHandler.pushIn(e)}setMessageRandom(e){this._sll.set(e.random)}deleteMessageRandom(e){this._sll.delete(e.random)}pushIntoMessageList(e,t,s){return!(!this._msgListHandler.pushIn(t,s)||this._sll.has(t.random)&&!s||(e.push(t),0))}revoke(e,t,s){return this._msgListHandler.revoke(e,t,s)}getPeerReadTime(e){return this._peerReadTimeMap.get(e)}recordPeerReadTime(e,t){(!this._peerReadTimeMap.has(e)||this._peerReadTimeMap.get(e)<t)&&this._peerReadTimeMap.set(e,t)}updateMsgIsPeerReadProp(s,i){if(s.startsWith(t.CONV_C2C)&&0<i){const t=this._msgListHandler.updateMsgIsPeerReadProp(s,i);if(0<t.length&&this.emitOEvt(e.MESSAGE_READ_BY_PEER,t),this._convMap.has(s)){const e=this._convMap.get(s).lastMessage;Oe(e)||e.fromAccount===this.getMyUserID()&&e.lastTime<=i&&!e.isPeerRead&&(e.isPeerRead=!0,this.emitConvUpdate(!0,!1))}}}updateMsgIsModifiedProp(e){this._msgListHandler.updateMsgIsModifiedProp(e)}setCompleted(e){Ce.l(this._n+".setCompleted convID:"+e),this._completedMap.set(e,!0)}updateRoamingMsgKeyAndTime(e,t,s){this._roamingMsgKeyAndTimeMap.set(e,{messageKey:t,lastMessageTime:s})}getConvList(t){const s=this._n+".getConvList",e=`pagingStatus:${this._pagingStatus}, local conversation count:${this._convMap.size}, options:`+JSON.stringify(t);if(Ce.l(s+". "+e),this._pagingStatus===kt){const i=new mi("getConvList");return i.setMessage(e),this.syncConvList().then(()=>{i.end();var e=this._getConvList(t);return Ys({conversationList:e,isSyncCompleted:this._isSyncCompleted()})}).catch(e=>(i.setError(e).end(),Ce.e(s+" failed. error:",e),Qs(e)))}const i=this._getConvList(t);return Ce.l(s+". returned conversation count:"+i.length),Zs({conversationList:i,isSyncCompleted:this._isSyncCompleted()})}_getConvList(t){if($e(t))return this.getLocalConvList();if(be(t))return 0===t.length?[]:this.getLocalConvList().filter(e=>t.includes(e.conversationID));if(Fe(t)){const{type:s,markType:i,groupName:o,hasUnreadCount:n,hasGroupAtInfo:r}=t;return this.getLocalConvList().filter(e=>this._filterType(e,s)&&this._filterMarkType(e,i)&&this._filterGroupName(e,o)&&this._filterUnreadCount(e,n)&&this._filterGroupAtInfo(e,r))}return[]}_filterType(e,s){return s!==t.CONV_C2C&&s!==t.CONV_GROUP||e.type===s}_filterGroupName(e,t){return!ke(t)||(""===t?0===e.conversationGroupList.length:e.conversationGroupList.includes(t))}_filterMarkType(e,t){return!Ge(t)||(0===t?0===e.markList.length:e.markList.includes(t))}_filterUnreadCount(e,t){let s=!0;return!0===t?s=1<=e.unreadCount:!1===t&&(s=0===e.unreadCount),s}_filterGroupAtInfo(e,t){let s=!0;return!0===t?s=1<=e.groupAtInfoList.length:!1===t&&(s=0===e.groupAtInfoList.length),s}_handleC2CPeerReadTime(){for(var[e,s]of this._convMap)s.type===t.CONV_C2C&&this.recordPeerReadTime(e,s.peerReadTime)}_isPagingGetGroupListCompleted(){const e=this.get(Is);return!e||e.isPagingGetCompleted()}_getLocalGroupCount(){const e=this.get(Is);return e?e.getLocalGroupList().length:0}_hasLocalGroup(e){const s=this.get(Is);return!!s&&s.hasLocalGroup(e.replace(t.CONV_GROUP,""))}getConversationProfile(i){let o,n=!1;if(this._convMap.has(i)?o=this._convMap.get(i):(o=new sn({conversationID:i,type:rt(i)?t.CONV_C2C:t.CONV_GROUP},this.isIntl(),this.isUsingChatCore()),n=!0),o._isInfoCompleted||o.type===t.CONV_SYSTEM)return Zs({conversation:o});if(at(i)){if(!this.get(Is))return Qs({code:js.NO_MODULE});if(!this._hasLocalGroup(i))return Zs({conversation:o})}const r=this._n+".getConversationProfile",a=new mi("getConversationProfile");return Ce.l(r+`. convID:${i} remark:${o.remark} lastMessage:`,o.lastMessage),this._getUserOrGroupProfile(o).then(e=>{a.setMessage(`convID:${i} unreadCount:`+e.data.conversation.unreadCount).end();const s=this.get(Cs);if(s&&o.type===t.CONV_C2C){const n=i.replace(t.CONV_C2C,"");if(s.isMyFriend(n)){const t=s.getFriendRemark(n);o.remark!==t&&(o.remark=t,Ce.l(r+`. convID:${i} patch remark:`+o.remark))}}if(Ce.l(r+` ok. isNewConv:${n} convID:`+i),n){if(o.type===t.CONV_C2C)return this._onNewC2CConv([i.replace(t.CONV_C2C,"")]).then(()=>Zs({conversation:o}));if(o.type===t.CONV_GROUP)return this._onNewGroupConv([i.replace(t.CONV_GROUP,"")]).then(()=>Zs({conversation:o}))}return e}).catch(e=>(a.setError(e).setMessage("convID:"+i).end(),Ce.e(r+" failed. error:",e),Qs(e)))}_getUserOrGroupProfile(s){return s.type===t.CONV_C2C?this.get(fs).getUserProfile({userIDList:[s.toAccount]}).then(e=>{e=e.data;return 0===e.length?Qs({code:js.USER_OR_GRP_NOT_FOUND}):(s.userProfile=e[0],s._isInfoCompleted=!0,this._insertConvAfterTopmost(s),Zs({conversation:s}))}):this.get(Is).getGroupProfile({groupID:s.toAccount}).then(e=>(s.groupProfile=e.data.group,s._isInfoCompleted=!0,this._insertConvAfterTopmost(s),Zs({conversation:s})))}_insertConvAfterTopmost(e){if(e instanceof sn&&!this._convMap.has(e.conversationID)){const t=[...this._convMap],s=t.findIndex(e=>!1===e[1].isPinned);t.splice(s,0,[e.conversationID,e]),this._convMap=new Map(t),this._setStorageConvList(),this.emitConvUpdate(!0,!1)}}_onProfileUpdated(e){e.data.forEach(e=>{var s=e["userID"];if(s===this.getMyUserID())this._onMyProfileModified({latestNick:e.nick,latestAvatar:e.avatar});else{const i=this._convMap.get(""+t.CONV_C2C+s);i&&(i.userProfile=e)}})}_onCloudConfig(e){"0"===this.getCloudConfig("pull_on_invite")&&(this._bPullOnInvite=!1),Ce.l(this._n+"._onCloudConfig bPullOnInvite:"+this._bPullOnInvite)}disableMsgPullOnInvite(){this._bPullOnInvite=!1}_isSyncCompleted(){return this._pagingStatus===Gt}_errorLog(e,t,s,i){var o=new Error("Params validate failed."),n=""+this.getErrMsg("API_REFER")+e;throw Ce.w(`[${e}] | ${t} | ${this.getErrMsg(s,i)}, `+n),Ce.e(`[${e}] Invalid ${t}: type check failed for ${t}.`),o}_isValidConvID(e){return rt(e)||at(e)||ct(e)}deleteConversation(e){const t="deleteConversation";return ke(e)||we(e)||this._errorLog(t,"options","StringOrObjectRequiredLog"),ke(e)?(this._isValidConvID(e)||this._errorLog(t,"options","InvalidConversationID",e),Ce.l(`${this._n}.${t} convID:`+e),this.deleteConvList({conversationIDList:[e],flag:1})):(be(e.conversationIDList)||this._errorLog(t,"conversationIDList","ArrayRequiredLog"),0===e.conversationIDList.length&&this._errorLog(t,"conversationIDList","NonEmptyArrayLog"),e.conversationIDList.forEach(e=>{this._isValidConvID(e)||this._errorLog(t,"conversationIDList","InvalidConversationID",e)}),"clearHistoryMessage"in e&&"boolean"!=typeof e.clearHistoryMessage&&this._errorLog(t,"clearHistoryMessage","BooleanRequiredLog"),100<e.conversationIDList.length&&(e.conversationIDList=e.conversationIDList.slice(0,100)),this.deleteConvList(e))}deleteConvList(e){const{conversationIDList:t=[],clearHistoryMessage:s=!0,flag:i=0}=e,o=this._n+".deleteConvList",n=`convIDList:${t} clearHistoryMessage:`+s,r=(Ce.l(o+" "+n),new mi("deleteConvList"));return r.setMessage(n),Promise.all([this.rmLocalOnlyConvList(t),this.rmLocalAndRemoteConvList(t,s)]).then(e=>{r.end();e=[...e[0],...e[1]];return 0===e.length?Qs(new zs({code:js.CONV_NOT_FOUND})):(Ce.l(o+" ok"),Zs(1===i?{conversationID:e[0]}:{conversationIDList:e}))}).catch(e=>(r.setError(e).end(),Ce.e(o+" failed. error:",e),Qs(e)))}rmLocalOnlyConvList(e){return e.filter(e=>{if(!this._convMap.has(e))return!1;var s=this.getLocalConversation(e).type;return s!==t.CONV_GROUP||this._hasLocalGroup(e)?s===t.CONV_SYSTEM&&(this.get(Is).deleteGroupSystemNotice({messageList:this._msgListHandler.getLocalMsgList(e)}),this.deleteLocalConv(e),!0):(this.deleteLocalConv(e),!0)})}rmLocalAndRemoteConvList(e,s){const i={fromAccount:this.getMyUserID(),conversationList:[],clearHistoryMessage:s?1:0};return e.forEach(e=>{var s;this._convMap.has(e)&&((s=this.getLocalConversation(e).type)===t.CONV_C2C?i.conversationList.push({toAccount:e.replace(s,""),type:1}):s===t.CONV_GROUP&&this._hasLocalGroup(e)&&i.conversationList.push({toGroupID:e.replace(s,""),type:2}))}),0===i.conversationList.length?[]:this.req({P:ti.DEL_CONV,data:i}).then(e=>{const s=[];return 0<e.data.resultList.length&&e.data.resultList.map(e=>{0===e.code&&(e=1===e.type?""+t.CONV_C2C+e.to:""+t.CONV_GROUP+e.groupID,s.push(e))}),this.deleteLocalConvList(s),s})}setConvDraft(e){var{conversationID:e,draftText:t}=e,s=this._n+".setConvDraft";if(Ce.l(s+` convID:${e} draftText:`+t),!this._convMap.has(e))return Qs({code:js.CONV_NOT_FOUND});const i=this._convMap.get(e);return i.setDraftText(t),this.emitConvUpdate(),Zs({code:0,conversation:i})}clearHistoryMessage(s){const e={fromAccount:this.getMyUserID(),toAccount:void 0,type:void 0,toGroupID:void 0};if(!this._convMap.has(s))return Qs({code:js.CONV_NOT_FOUND});var i=this._convMap.get(s).type;if(i===t.CONV_C2C)e.type=1,e.toAccount=s.replace(t.CONV_C2C,"");else{if(i!==t.CONV_GROUP)return i===t.CONV_SYSTEM?(this.get(Is).deleteGroupSystemNotice({messageList:this._msgListHandler.getLocalMsgList(s)}),Zs({conversationID:s})):Qs({code:js.CONV_UN_RECORDED_TYPE});e.type=2,e.toGroupID=s.replace(t.CONV_GROUP,"")}const o=this._n+".clearHistoryMessage",n=new mi("clearHistoryMessage");return n.setMessage("convID:"+s),Ce.l(o+". convID:"+s),this.setMessageRead({conversationID:s}).then(()=>this.req({P:ti.CLEAR_HISTORY_MSG,data:e})).then(()=>{n.end(),Ce.l(o+" ok"),this.clearMemMsg(s);const e=this.getLocalConversation(s);return e&&(e.updateLastMessage(),this._sortConvListAndEmitEvent()),Zs({conversationID:s})}).catch(e=>(n.setError(e).end(),Ce.e(o+" failed. error:",e),Qs(e)))}pinConversation(e){const{conversationID:s,isPinned:i}=e,o=this.getLocalConversation(s);if(o&&o.isPinned===i)return Zs({conversationID:s});if(ct(s))return o&&(o.isPinned=i),this._sortConvListAndEmitEvent(),Zs({conversationID:s});let n=null;if(rt(s)?n={type:1,toAccount:s.replace(t.CONV_C2C,"")}:at(s)&&(n={type:2,groupID:s.replace(t.CONV_GROUP,"")}),null===n)return Qs({code:js.INVALID_CONV_ID});const r=this._n+".pinConversation",a=`convID:${s} isPinned:`+i,c=new mi("pinConversation");return c.setMessage(a),Ce.l(r+". "+a),this.req({P:ti.PIN_CONV,data:{fromAccount:this.getMyUserID(),operationType:!0===i?1:2,itemList:[n]}}).then(()=>(c.end(),Ce.l(r+" ok"),o?o.isPinned!==i&&(o.isPinned=i):this._convMap.set(s,new sn({conversationID:s,type:rt(s)?t.CONV_C2C:t.CONV_GROUP,isPinned:i},this.isIntl(),this.isUsingChatCore())),this._sortConvListAndEmitEvent(),Ys({conversationID:s}))).catch(e=>(c.setError(e).end(),Ce.e(r+" failed. error:",e),Qs(e)))}setMessageRemindType(e){return this._msgRemindHandler.set(e)}patchMsgRemindType(e){var{ID:s,isC2CConversation:i,messageRemindType:o}=e;let n=!1;const r=this.getLocalConversation(i?""+t.CONV_C2C+s:""+t.CONV_GROUP+s);return r&&r.messageRemindType!==o&&(r.messageRemindType=o,n=!0),Ce.l(this._n+".patchMsgRemindType options:",e,"ret:"+n),n}onC2CMsgRemindTypeFetched(e){if(be(e)&&0<e.length){let s=0;e.forEach(e=>{var{userID:e,muteFlag:t}=e,t=this._transMsgRemindType(t);!0===this.patchMsgRemindType({ID:e,isC2CConversation:!0,messageRemindType:t})&&(s+=1)}),Ce.l(this._n+".onC2CMsgRemindTypeFetched updateCount:"+s),1<=s&&this.emitConvUpdate(!0,!1)}}onC2CMsgRemindTypeSynced(e){const i=this._n+".onC2CMsgRemindTypeSynced";e.dataList.forEach(t=>{if(!Oe(t.muteNotificationsSync)){var{to:t,muteFlag:s}=t.muteNotificationsSync,s=this._transMsgRemindType(s);let e=0;this.patchMsgRemindType({ID:t,isC2CConversation:!0,messageRemindType:s})&&(e+=1),Ce.l(i+" updateCount:"+e),1<=e&&this.emitConvUpdate(!0,!1)}})}onGroupMsgRemindTypeUpdated(e){this._msgRemindHandler.onGroupMsgRemindTypeUpdated(e)}deleteLocalConv(e,t=!0){var s=this._convMap.has(e);if(Ce.l(this._n+`.deleteLocalConv convID:${e} has:`+s),s&&(this._convMap.delete(e),this._convMapForDiff.delete(e),this.clearMemMsg(e),this._setStorageConvList(!0),t)){const t=!this._isTopicConv(e);this.emitConvUpdate(t,!1)}}pullMsgOnInvite(i){const o=this.get(Is);if(o){var n=this._n+".pullMsgOnInvite";if(Ce.l(n+" flag:"+this._bPullOnInvite),this._bPullOnInvite){var r=this.getLocalLastMessage(i),a=this.getLocalSecondLastMessage(i);let e=1,s=1;r&&(e=r.sequence),a&&(s=a.sequence);r=o.getGroupRemoteLastSeq(i.replace(t.CONV_GROUP,""));Ce.l(n+` convID:${i} localLastSeq:${e} localSecondLastSeq:${s} remoteLastSeq:`+r),this.clearMemMsg(i),1<e-s?this._recursiveGetMsgList([],i,!1,e,s):1<r-e&&this._recursiveGetMsgList([],i,!0,r,e)}}}_recursiveGetMsgList(n,r,a,c,l,e){this.getMessageList({conversationID:r,nextReqMessageID:e}).then(e=>{const{messageList:t,isCompleted:s,nextReqMessageID:i}=e.data,o=t.filter(e=>a?e.sequence>l&&e.sequence<=c:e.sequence>l&&e.sequence<c);n.unshift(...o),!s&&0<t.length&&t[0].sequence>l&&n.length<60?this._recursiveGetMsgList(n,r,a,c,l,i):this._emitMsgReceived(r,n)})}_emitMsgReceived(t,s){if(0<s.length){const i=s.filter((t,e,s)=>e===s.findIndex(e=>e.sequence===t.sequence)),o=this.hasLocalConversation(t),n=i.map(e=>e.sequence);Ce.l(`${this._n}._emitMsgReceived convID:${t} has:${o} count:${n.length} sequenceList:`,n),this.emitOEvt(e.MESSAGE_RECEIVED,i),o?this.patchConvLastMessage(t,!0):this.getConversationProfile(t).then(()=>{this.patchConvLastMessage(t,!0)})}}deleteLocalConvList(e){let t=!1;e.forEach(e=>{this._convMap.has(e)&&(this.deleteLocalConv(e,!1),t=!0)}),Ce.l(this._n+`.deleteLocalConvList convID:${e} isConvIDExisted:`+t),t&&this.emitConvUpdate(!0,!1)}isMessageSentByCurrentInstance(e){return!(!this._msgListHandler.hasLocalMsg(e.conversationID,e.ID)&&!this._sll.has(e.random))}modifyMessageList(e){var s,i;e.startsWith(t.CONV_C2C)&&this._convMap.has(e)&&(i=this._convMap.get(e),s=Date.now(),this._msgListHandler.modifyMsgSentByPeer({conversationID:e,latestNick:i.userProfile.nick,latestAvatar:i.userProfile.avatar}),i=this.get(fs).getNickAndAvatarByUserID(this.getMyUserID()),this._msgListHandler.modifyMsgSentByMe({conversationID:e,latestNick:i.nick,latestAvatar:i.avatar}),Ce.l(this._n+`.modifyMessageList convID:${e} cost:`+St(s)))}updateUserProfileSpecifiedKey(e){Ce.l(this._n+".updateUserProfileSpecifiedKey options:",e);var{conversationID:t,nick:s,avatar:i}=e;if(this._convMap.has(t)){const e=this._convMap.get(t).userProfile;ke(s)&&e.nick!==s&&(e.nick=s),ke(i)&&e.avatar!==i&&(e.avatar=i),this.emitConvUpdate(!0,!1)}}_onMyProfileModified(t){const e=this.getLocalConvList(),s=Date.now();e.forEach(e=>{this.modifyMessageSentByMe({conversationID:e.conversationID,...t})}),Ce.l(this._n+"._onMyProfileModified. modify all messages sent by me, cost:"+St(s))}modifyMessageSentByMe(e){this._msgListHandler.modifyMsgSentByMe(e)}getLatestMessageSentByMe(e){return this._msgListHandler.getLatestMsgSentByMe(e)}modifyMessageSentByPeer(e){this._msgListHandler.modifyMsgSentByPeer(e)}getLatestMessageSentByPeer(e){return this._msgListHandler.getLatestMsgSentByPeer(e)}pushIntoNoticeResult(e,t){return!(!this._msgListHandler.pushIn(t)||this._sll.has(t.random)||(e.push(t),0))}getLocalLastMessage(e){return this._msgListHandler.getLocalLastMsg(e)}getLocalSecondLastMessage(e){return this._msgListHandler.getLocalSecondLastMsg(e)}checkAndPatchRemark(){const o=this.get(Cs);if(0!==this._convMap.size&&o){const e=[...this._convMap.values()].filter(e=>e.type===t.CONV_C2C);if(0!==e.length){let i=0;e.forEach(e=>{var s=e.conversationID.replace(t.CONV_C2C,"");if(o.isMyFriend(s)){const t=o.getFriendRemark(s);e.remark!==t&&(e.remark=t,i+=1)}}),Ce.l(`${this._n}.checkAndPatchRemark. c2cConvCount:${e.length} patchedCount:`+i),0<i&&this.emitConvUpdate(!0,!1)}}}updateTopicConversation(e){this._updateLocalConvList({conversationOptionsList:e,isFromGetConversations:!0,updateUnreadCount:!0})}sendReadReceipt(e){var s=e[0];let i=null;return s.conversationType===t.CONV_C2C?i=this._m.get(Ms):s.conversationType===t.CONV_GROUP&&(i=this._m.get(Is)),i?i.sendReadReceipt(e):Qs({code:js.NO_MODULE})}getReadReceiptList(e){var s=e[0];let i=null;return s.conversationType===t.CONV_C2C?i=this._m.get(Ms):s.conversationType===t.CONV_GROUP&&(i=this._m.get(Is)),i?i.getReadReceiptList(e):Qs({code:js.NO_MODULE})}getLastMessageTime(e){e=this.getLocalConversation(e);return e?e.lastMessage.lastTime:0}getTotalUnreadCount(){const e=this.getLocalConvList();let s=0;return e.forEach(e=>{e.type!==t.CONV_SYSTEM&&(""!==e.messageRemindType&&e.messageRemindType!==t.MSG_REMIND_ACPT_AND_NOTE||(s+=e.unreadCount))}),s}onTotalUnreadCountUpdate(){var t=this.getTotalUnreadCount();this._convTotalUnreadCount!==t&&(Ce.l(`${this._n}.onTotalUnreadCountUpdate from ${this._convTotalUnreadCount} to `+t),this._convTotalUnreadCount=t,this.emitOEvt(e.TOTAL_UNREAD_MESSAGE_COUNT_UPDATED))}_isConvNeedShow(e){e=this.getLocalConversation(e);if($e(e))return!0;var s=e.type===t.CONV_TOPIC,i=e.type===t.CONV_GROUP&&e.groupProfile.type===t.GRP_ROOM,e=e.type===t.CONV_GROUP&&e.groupProfile.type===t.GRP_LIVE;return!(s||i||e)}setAllRcvMsgOpt(e){return this._msgRemindHandler.setAllRcvMsgOpt(e)}getAllRcvMsgOpt(){return this._msgRemindHandler.getAllRcvMsgOpt()}onAllRcvMsgOptNotify(e){this._msgRemindHandler.onAllRcvMsgOptNotify(e)}clearUnreadCount(e){const t=this.getLocalConversation(e);t&&0<t.unreadCount&&(t.unreadCount=0,this.emitConvUpdate(!0,!1))}storeHoppingMessageList(e){this._msgListHandler.storeHoppingMsgList(e)}clearMemMsg(e,t=!1){Ce.l(this._n+`.clearMemMsg convID:${e} isOverLimit:`+t),this._msgListHandler.removeByConvID(e),this._completedMap.delete(e),this._roamingMsgKeyAndTimeMap.delete(e),this._everClearedMap.set(e,1)}reset(){Ce.l(this._n+".reset"),this._setStorageConvList(!0),this._pagingStatus=Pt,this._msgListHandler.reset(),this._msgRemindHandler.reset(),this._roamingMsgKeyAndTimeMap.clear(),this._sll.reset(),this._peerReadTimeMap.clear(),this._completedMap.clear(),this._convMap.clear(),this._pagingTs=0,this._pagingStartIdx=0,this._pagingPinnedTs=0,this._pagingPinnedStartIdx=0,this._remoteGroupReadSeqMap.clear(),this._convTotalUnreadCount=0,this._pagingGetCostList.length=0,this._pagingConvIDMap.clear(),this._convIDFromUnreadDBMap.clear(),this._pagingGetCostList.length=0,this._convMapForDiff.clear(),this._partialUpdatedConvMap.clear(),this._everClearedMap.clear(),this._bPullOnInvite=!0,this._convGroupHandler.reset(),this.resetReady()}}const cn=["topicID","topicName","avatar","introduction","notification","unreadCount","muteAllMembers","customData","groupAtInfoList","nextMessageSeq","selfInfo"],ln=function(e,t){return Oe(e)?{lastTime:0,lastSequence:0,fromAccount:"",payload:null,type:"",messageForShow:"",nick:"",avatar:"",version:0,cloudCustomData:"",isRevoked:!1,revoker:null}:{lastTime:e.time||0,lastSequence:e.sequence||0,fromAccount:e.from||"",payload:e.payload||null,type:e.type||"",messageForShow:Tt(e.type,e.payload,t),nick:e.nick||"",avatar:e.avatar||"",version:e.version||0,cloudCustomData:e.cloudCustomData||"",isRevoked:e.isRevoked||!1,revoker:e.revoker||null}};class un{constructor(e,t){this.topicID="",this.topicName="",this.avatar="",this.introduction="",this.notification="",this.unreadCount=0,this.muteAllMembers=!1,this.customData="",this.groupAtInfoList=[],this.nextMessageSeq=0,this.lastMessage=ln(e.lastMessage,t),this.selfInfo={muteTime:0,readedSequence:0,messageRemindType:"",excludedUnreadSequenceList:void 0},this._initTopic(e)}_initTopic(e){for(const t in e)cn.indexOf(t)<0||("selfInfo"===t?this.updateSelfInfo(e[t]):this[t]="muteAllMembers"===t?1===e[t]:e[t])}updateUnreadCount(e=0){this.unreadCount=e}updateNextMessageSeq(e){this.nextMessageSeq=e}updateLastMessage(e){this.lastMessage=ln(e)}updateGroupAtInfoList(e){this.groupAtInfoList=JSON.parse(JSON.stringify(e))}updateTopic(e){$e(e.selfInfo)||this.updateSelfInfo(e.selfInfo),$e(e.muteAllMembers)||(this.muteAllMembers=1===e.muteAllMembers),We(this,e,["groupID","lastMessageTime","selfInfo","muteAllMembers","lastMsg"])}updateSelfInfo(e){return 0===We(this.selfInfo,e,[],[""])}reduceUnreadCount(){return 1<=this.unreadCount&&(--this.unreadCount,!0)}isLastMessageRevoked({sequence:e}){return e===this.lastMessage.lastSequence}setLastMessageRevoked(e){this.lastMessage.isRevoked=e}setLastMessageRevoker(e){this.lastMessage.revoker=e}}class dn extends ei{constructor(e){super(e),this._n="TopicModule",this._topicMap=new Map,this._getTopicTimeMap=new Map,this.TOPIC_CACHE_TIME=300,this.TOPIC_LAST_ACTIVE_TIME=3600,this.getIEmitInst().on(Vi.CLOUD_CONFIG,this._onCloudConfig,this)}_onCloudConfig(){var e=this.getCloudConfig("topic_cache_time"),t=this.getCloudConfig("topic_last_active_time");$e(e)||(this.TOPIC_CACHE_TIME=Number(e)),$e(t)||(this.TOPIC_LAST_ACTIVE_TIME=Number(t))}onTopicCreated(t){var s=t["groupID"];this.resetGetTopicTime(s),this.emitOEvt(e.TOPIC_CREATED,t)}onTopicDeleted(t){const{groupID:s,topicIDList:i=[]}=t;i.forEach(e=>{this._deleteLocalTopic(s,e)}),this.emitOEvt(e.TOPIC_DELETED,t)}onTopicProfileUpdated(t){const{groupID:s,topicID:i}=t,o=this.getLocalTopic(s,i);o&&(o.updateTopic(t),this.emitOEvt(e.TOPIC_UPDATED,{groupID:s,topic:o}))}onTopicLatestMsg(e){const{topicLatestMessage:s,excludedUnreadSequenceList:i}=e||{};if(!Oe(s)){const{topicID:e}=s["groupProfile"],o=(s.conversationType=t.CONV_GROUP,s.to=e,new wi(s));o.setElement(s.elements),this.updateUnreadCountAndLastMsg(e,o,i)}}onMessageRemindTypeUpdated(t){const{groupID:s,topicID:i,messageRemindType:o}=t,n=this.getLocalTopic(s,i);if(n){const t=n.updateSelfInfo({messageRemindType:o});t&&this.emitOEvt(e.TOPIC_UPDATED,{groupID:s,topic:n}),Ce.l(this._n+`.onMessageRemindTypeUpdated topicID:${i} messageRemindType:${o} isUpdated:`+t)}}onAtInfoUpdated(t){const{topicID:s,groupAtInfoList:i}=t,o=Ct(s),n=this.getLocalTopic(o,s);n&&!$e(i)&&(n.updateGroupAtInfoList(i),this.emitOEvt(e.TOPIC_UPDATED,{groupID:o,topic:n}))}onUnreadCountUpdatedFromConv(t,s=0){const i=Ct(t),o=this.getLocalTopic(i,t);o&&o.unreadCount!==s&&(o.updateUnreadCount(s),0===s&&o.updateSelfInfo({readedSequence:o.lastMessage.lastSequence}),this.emitOEvt(e.TOPIC_UPDATED,{groupID:i,topic:o}))}onMessageSent(t){const{groupID:s,topicID:i,lastMessage:o}=t,n=this.getLocalTopic(s,i);if(n){const{sequence:t=0}=o,i=t+1;i>n.nextMessageSeq&&(n.updateNextMessageSeq(i),n.updateLastMessage(o),n.updateSelfInfo({readedSequence:t}),n.updateUnreadCount(0),this.emitOEvt(e.TOPIC_UPDATED,{groupID:s,topic:n}))}}onMessageModified(t){var{to:s,time:i,sequence:o,elements:n,cloudCustomData:r,messageVersion:a}=t,c=Ct(s),l=this.getLocalTopic(c,s);if(l){const d=l.lastMessage;Ce.d(this._n+`.onMessageModified topicID:${s} lastMessage:`,JSON.stringify(d),"options:",JSON.stringify(t)),d&&(null===d.payload||d.lastTime===i&&d.lastSequence===o&&d.version!==a)&&(d.type=n[0].type,d.payload=n[0].content,d.messageForShow=Tt(d.type,d.payload,this.isIntl()),d.cloudCustomData=r,d.version=a,d.lastSequence=o,d.lastTime=i,this.emitOEvt(e.TOPIC_UPDATED,{groupID:c,topic:l}))}}onMessageRevoked(t){if(0!==t.length){let s=null,i=null,o=!1;t.forEach(e=>{const t=e.to;if(i=Ct(t),s=this.getLocalTopic(i,t)){s.reduceUnreadCount()&&(o=!0),s.isLastMessageRevoked(e)&&(s.setLastMessageRevoked(!0),s.setLastMessageRevoker(e.revoker),o=!0);const t=s.selfInfo.excludedUnreadSequenceList||[];t.push(e.sequence),s.updateSelfInfo({excludedUnreadSequenceList:t})}}),o&&this.emitOEvt(e.TOPIC_UPDATED,{groupID:i,topic:s})}}isLastMessageRevoked(e){const{topicID:t,sequence:s}=e,i=Ct(t),o=this.getLocalTopic(i,t);let n=!1;return n=o?o.isLastMessageRevoked({sequence:s}):n}updateUnreadCountAndLastMsg(i,o,n){const r=Ct(i),a=this.getLocalTopic(r,i);if(a){let s=a.selfInfo.excludedUnreadSequenceList||[];if($e(n)||(s=n),o._isExcludedFromUnreadCount&&s.push(o.sequence),a.updateSelfInfo({excludedUnreadSequenceList:s}),Ce.l(`${this._n}.updateUnreadCountAndLastMsg seq:${o.sequence} lastSeq:`+a.lastMessage.lastSequence),o.sequence>a.lastMessage.lastSequence){a.updateLastMessage(o);const n=o.sequence+1;a.updateNextMessageSeq(n);o=this._computeUnreadCount(a);a.updateUnreadCount(o);const c=this.get(ys).getLocalConversation(""+t.CONV_GROUP+i);c&&c.updateUnreadCount({nextUnreadCount:o,isFromGetConversations:!0}),this.emitOEvt(e.TOPIC_UPDATED,{groupID:r,topic:a})}}}getJoinedCommunityList(){return this.get(Is).syncCommunityWithTopic()}createTopicInCommunity(t){const s=this._n+".createTopicInCommunity",e=t["topicID"];if(!$e(e)&&!ot(e))return Qs({code:js.ILLEGAL_TOPIC_ID});if(t.topicName&&!1===this._filterProfanity("topicName",t))return Qs({code:js.PROFANITY_FOUND});if(t.introduction&&!1===this._filterProfanity("introduction",t))return Qs({code:js.PROFANITY_FOUND});if(t.notification&&!1===this._filterProfanity("notification",t))return Qs({code:js.PROFANITY_FOUND});const i=new mi("createTopicInCommunity");return this.req({P:ti.CREATE_TOPIC,data:{...t}}).then(e=>{e=e.data.topicID;return i.setMessage("topicID:"+e).end(),Ce.l(s+" ok. topicID:"+e),this._updateTopicMap([{...t,topicID:e}]),Ys({topicID:e})}).catch(e=>(i.setError(e).end(),Ce.e(s+" failed. error:",e),Qs(e)))}deleteTopicFromCommunity(e){const s=this._n+".deleteTopicFromCommunity",{groupID:n,topicIDList:t=[]}=e,r=new mi("deleteTopicFromCommunity");return r.setMessage(`groupID:${n} topicIDList:`+t),this.req({P:ti.DEL_TOPIC,data:{groupID:n,topicIDList:t}}).then(e=>{const{resultList:t=[]}=e.data,i=[],o=[];t.forEach(e=>{var{topicID:e,errorCode:t,errorInfo:s}=e;0===t?i.push({topicID:e}):o.push({topicID:e,code:t,message:s})});e=`success count:${i.length}, fail count:`+o.length;return r.setMoreMessage(e).end(),Ce.l(s+" ok. "+e),i.forEach(e=>{this._deleteLocalTopic(n,e.topicID)}),Ys({successTopicList:i,failureTopicList:o})}).catch(e=>(r.setError(e).end(),Ce.e(s+" failed. error:",e),Qs(e)))}updateTopicProfile(e){const t=this._n+".updateTopicProfile";if(Ce.l(t+" options:",e),e.topicName&&!1===this._filterProfanity("topicName",e))return Qs({code:js.PROFANITY_FOUND});if(e.introduction&&!1===this._filterProfanity("introduction",e))return Qs({code:js.PROFANITY_FOUND});if(e.notification&&!1===this._filterProfanity("notification",e))return Qs({code:js.PROFANITY_FOUND});const s=new mi("updateTopicProfile");return s.setMessage(`groupID:${e.groupID} topicID:`+e.topicID),$e(e.muteAllMembers)||(e.muteAllMembers=!0===e.muteAllMembers?"On":"Off"),this.req({P:ti.UPDATE_TOPIC_PROFILE,data:{...e}}).then(()=>(s.end(),Ce.l(t+" ok"),this._updateTopicMap([e]),Ys({topic:this.getLocalTopic(e.groupID,e.topicID)}))).catch(e=>(s.setError(e).end(),Ce.e(t+" failed. error:",e),Qs(e)))}getTopicList(e){const i=this._n+".getTopicList",{groupID:o,topicIDList:t=[]}=e,c=0===t.length,l=new mi("getTopicList");if(l.setMessage("groupID:"+o),this._getTopicTimeMap.has(o)){const{isGetAll:e,time:s}=this._getTopicTimeMap.get(o);if((e||!e&&!c)&&Date.now()-s<1e3*this.TOPIC_CACHE_TIME){const e=this._getLocalTopicList(o,t);if(c||e.length===t.length)return l.setMoreMessage("from cache, topic count:"+e.length).end(),Ce.l(i+` groupID:${o} from cache, topic count:`+e.length),Zs({successTopicList:e,failureTopicList:[]})}}return this.req({P:ti.GET_TOPIC_LIST,data:{groupID:o,topicIDList:t}}).then(e=>{const{topicInfoList:t=[]}=e.data,n=[],r=[],a=[];t.forEach(e=>{var{topic:e,selfInfo:t,errorCode:s,errorInfo:i}=e,o=e["topicID"];0===s?(n.push({...e,selfInfo:t}),r.push(o)):a.push({topicID:o,code:s,message:i})}),this._updateTopicMap(n),this._handleTopicAtInfo(n);e=`success count:${r.length}, fail count:`+a.length;l.setMoreMessage(e).end(),Ce.l(i+` groupID:${o} from remote, `+e);let s=[];return Oe(r)||(this._getTopicTimeMap.set(o,{time:Date.now(),isGetAll:c}),s=this._getLocalTopicList(o,r)),Ys({successTopicList:s,failureTopicList:a})}).catch(e=>(l.setError(e).end(),Ce.e(i+" failed. error:",e),Qs(e)))}hasLocalTopic(e,t){return!!this._topicMap.has(e)&&this._topicMap.get(e).has(t)}getLocalTopic(e,t){let s=null;return s=this._topicMap.has(e)?this._topicMap.get(e).get(t):s}_getLocalTopicList(e,t=[]){const s=this._topicMap.get(e);let i=[];return s&&(i=[...s.values()]),0===t.length?i:i.filter(e=>t.includes(e.topicID))}_deleteLocalTopic(e,t){this._topicMap.has(e)&&this._topicMap.get(e).has(t)&&(this._topicMap.get(e).delete(t),Ce.l(this._n+`._deleteLocalTopic groupID:${e} topicID:`+t))}_updateTopicMap(e){const n=[];e.forEach(e=>{var{groupID:s,topicID:i}=e;let o=null;this._topicMap.has(s)||this._topicMap.set(s,new Map),this._topicMap.get(s).has(i)?(o=this._topicMap.get(s).get(i)).updateTopic(e):(this._getTopicLastMessage(e),o=new un(e,this.isIntl()),this._topicMap.get(s).set(i,o));e=this._computeUnreadCount(o);o.updateUnreadCount(e),n.push({conversationID:""+t.CONV_GROUP+i,type:t.CONV_TOPIC,unreadCount:e})}),0<n.length&&this.get(ys).updateTopicConversation(n)}resetGetTopicTime(e){$e(e)?[...this._getTopicTimeMap.keys()].forEach(e=>{this._getTopicTimeMap.set(e,0)}):this._getTopicTimeMap.set(e,0)}getTopicListOnReconnected(){const e=[...this._topicMap.keys()],i=[],o=this.get(ys);e.forEach(e=>{const s=[],t=this._getLocalTopicList(e);o.deleteTopicRoamingInfo(e),t.forEach(e=>{var{lastMessage:{lastTime:t=0}}=e;Date.now()-1e3*t<1e3*this.TOPIC_LAST_ACTIVE_TIME&&s.push(e.topicID)}),0<s.length&&i.push({groupID:e,topicIDList:s})}),Ce.l(this._n+".getTopicListOnReconnected. active community count:"+i.length),this._relayGetTopicList(i)}_relayGetTopicList(t){if(0!==t.length){const e=t.shift(),s=5<e.topicIDList.length?"topicIDList.length:"+e.topicIDList.length:"topicIDList:"+e.topicIDList,i=new mi("relayGetTopicList");i.setMessage(s),Ce.l(this._n+"._relayGetTopicList. "+s),this.getTopicList(e).then(()=>{i.end(),this._relayGetTopicList(t)}).catch(e=>{i.setError(e).end(),this._relayGetTopicList(t)})}}_handleTopicAtInfo(e){0!==e.length&&e.forEach(e=>{const{groupID:t,topicID:s,groupAtInfoList:i}=e,o=[];$e(i)||(i.forEach(e=>{o.push({...e,groupID:t,topicID:s})}),this.get(ys).onNewGroupAtTips({dataList:o}))})}_getTopicLastMessage(e){var t;$e(e.lastMsg)||(t={time:e.lastMsg.time,sequence:e.lastMsg.sequence,from:e.lastMsg.from,payload:e.lastMsg.elements[0]?e.lastMsg.elements[0].content:null,type:e.lastMsg.elements[0]?e.lastMsg.elements[0].type:"",nick:e.lastMsg.nick,avatar:e.lastMsg.avatar,version:e.lastMsg.messageVersion,cloudCustomData:e.lastMsg.cloudCustomData,isRevoked:2===e.lastMsg.isPlaceMessage,revoker:Oe(e.lastMsg.revokerInfo)?null:e.lastMsg.revokerInfo.revoker},e.lastMessage=t)}deleteTopicListInCommunity(s){const e=this._getLocalTopicList(s),i=this.get(ys);e.forEach(e=>{e=e.topicID;this._deleteLocalTopic(s,e),this._getTopicTimeMap.delete(s),i.deleteLocalConv(""+t.CONV_GROUP+e)})}_computeUnreadCount(s){const{excludedUnreadSequenceList:e,readedSequence:i}=s.selfInfo;let o=s.nextMessageSeq-s.selfInfo.readedSequence-1;if(be(e)){let t=0;e.forEach(e=>{e>i&&e<=s.nextMessageSeq-1&&(t+=1)}),1<=t&&(o-=t)}return o<0?0:o}_filterProfanity(e,t){const s=this.get(bs);if(!s)return!0;var{isAllowedToSend:i,modifiedText:o}=s.filterText(t[e],E);return!0===i&&(t[e]=o,!0)}getMessageExtensions(e,t){Ce.l(this._n+".getMessageExtensions startSequence:"+t);var s=Ct(e.to);return this.req({P:ti.GET_GRP_MSG_EXT,data:{groupID:s,topicID:e.to,messageSequence:e.sequence,startSequence:t}})}modifyMsgExts(e,t,s=1){Ce.l(this._n+".modifyMsgExts operateType:"+s);var i=Ct(e.to);return this.req({P:ti.MODIFY_GRP_MSG_EXT,data:{groupID:i,topicID:e.to,messageSequence:e.sequence,extensionList:t,operateType:s}})}reset(){Ce.l(this._n+".reset"),this._topicMap.clear(),this._getTopicTimeMap.clear(),this.TOPIC_CACHE_TIME=300,this.TOPIC_LAST_ACTIVE_TIME=3600}}class _n{constructor(e){this._userM=e,this._n="ProfileHandler",this.TAG="profile",this.accountProfileMap=new Map,this.expirationTime=864e5}setExpirationTime(e){this.expirationTime=e}getUserProfile(e){const t=this._n+".getUserProfile",s=e.userIDList,i=(e.fromAccount=this._userM.getMyAccount(),100<s.length&&(Ce.w(t+" "+Et(100)),s.length=100),[]),o=[];var n;for(let e=0,t=s.length;e<t;e++)n=s[e],this._userM.isMyFriend(n)&&this._contains(n)?o.push(this._getProfileFromMap(n)):i.push(n);if(0===i.length)return Zs(o);e.toAccount=i;const r=e.bFromGetMyProfile||!1,a=[],c=(e.toAccount.forEach(e=>{a.push({toAccount:e,standardSequence:0,customSequence:0})}),e.userItem=a,new mi("getUserProfile"));return c.setMessage(5<s.length?"userIDList.length:"+s.length:"userIDList:"+s),this._userM.req({P:ti.GET_USER_PROFILE,data:e}).then(e=>{c.end(),Ce.i(t+" ok");e=this._handleResponse(e).concat(o);return Ys(r?e[0]:e)}).catch(e=>(c.setError(e).end(),Ce.e(t+" failed. error:",e),Qs(e)))}getMyProfile(){var e,t=this._userM.getMyAccount(),s=this._n+".getMyProfile";return Ce.l(s+" myAccount:"+t),this._fill(),this._contains(t)?(e=this._getProfileFromMap(t),Ce.d(s+" from cache, myProfile:"+JSON.stringify(e)),Zs(e)):this.getUserProfile({fromAccount:t,userIDList:[t],bFromGetMyProfile:!0})}_handleResponse(s){var i,o=s.data["userProfileItem"];if(!be(o))return[];const n=[],r=Date.now();for(let e=0,t=o.length;e<t;e++){const{to:s,profileItem:r}=o[e];"@TLS#NOT_FOUND"!==s&&""!==s&&(i=this._update(s,this._getLatestProfileFromResponse(s,r))["latestProfile"],n.push(i))}return Ce.l(this._n+"._handleResponse cost:"+St(r)),n}_getLatestProfileFromResponse(e,s){const i={userID:e,profileCustomField:[]};if(!Oe(s))for(let e=0,t=s.length;e<t;e++)if(-1<s[e].tag.indexOf("Tag_Profile_Custom"))i.profileCustomField.push({key:s[e].tag,value:s[e].value});else switch(s[e].tag){case ye.NICK:i.nick=s[e].value;break;case ye.GENDER:i.gender=s[e].value;break;case ye.BIRTHDAY:i.birthday=s[e].value;break;case ye.LOCATION:i.location=s[e].value;break;case ye.SELFSIGNATURE:i.selfSignature=s[e].value;break;case ye.ALLOWTYPE:i.allowType=s[e].value;break;case ye.LANGUAGE:i.language=s[e].value;break;case ye.AVATAR:i.avatar=s[e].value;break;case ye.MESSAGESETTINGS:i.messageSettings=s[e].value;break;case ye.ADMINFORBIDTYPE:i.adminForbidType=s[e].value;break;case ye.LEVEL:i.level=s[e].value;break;case ye.ROLE:i.role=s[e].value;break;default:Ce.w(this._n+"._getLatestProfileFromResponse unknown tag:",s[e].tag,s[e].value)}return i}updateMyProfile(o){const n=this._n+".updateMyProfile";if(o.nick&&!1===this._userM.filterProfanity("nick",o))return Qs({code:js.PROFANITY_FOUND});if(o.selfSignature&&!1===this._userM.filterProfanity("selfSignature",o))return Qs({code:js.PROFANITY_FOUND});const r=new mi("updateMyProfile");r.setMessage(JSON.stringify(o));var t=(new Xi).validate(o);if(!t.valid)return r.setCode(js.UPDATE_PROFILE_INVALID_PARAM).setMoreMessage("info:"+t.tips).end(),Ce.e(n+" info:"+t.tips),Qs({code:js.UPDATE_PROFILE_INVALID_PARAM});const s=[];for(const e in o)Object.prototype.hasOwnProperty.call(o,e)&&("profileCustomField"===e?o.profileCustomField.forEach(e=>{s.push({tag:e.key,value:e.value})}):s.push({tag:ye[e.toUpperCase()],value:o[e]}));if(0===s.length){const e=new zs({code:js.UPDATE_PROFILE_NO_KEY});return r.setError(e).end(),Ce.e(n+" failed. error:",e),Qs(e)}const a=this._userM.getMyAccount();return this._userM.req({P:ti.UPDATE_MY_PROFILE,data:{fromAccount:a,profileItem:s}}).then(t=>{r.end(),Ce.i(n+" ok");var{isProfileUpdated:s,latestProfile:i}=this._update(a,o);return!0===s&&this._userM.emitOEvt(e.PROFILE_UPDATED,[i]),Zs(i)}).catch(e=>(r.setError(e).end(),Ce.e(n+" failed. error:",e),Qs(e)))}onProfileModified(t){var s,i=t.dataList;if(!Oe(i)){const o=i.length;Ce.d(`${this._n}.onProfileModified count:${o} dataList:`,t.dataList);const n=[];for(let e=0;e<o;e++){s=i[e].userID;const{isProfileUpdated:t,latestProfile:o}=this._update(s,this._getLatestProfileFromResponse(s,i[e].profileList));!0===t&&n.push(o)}0<n.length&&(this._userM.emitIEvt(Vi.PROFILE_UPDATED,n),this._userM.emitOEvt(e.PROFILE_UPDATED,n))}}_fill(){if(0===this.accountProfileMap.size){var s=this._getCachedProfiles(),i=Date.now();for(let e=0,t=s.length;e<t;e++)i-s[e].lastUpdatedTime<this.expirationTime&&this.accountProfileMap.set(s[e].userID,s[e]);Ce.l(this._n+"._fill from cache, size:"+this.accountProfileMap.size)}}_update(e,t){let s,i=!1;var o=Date.now();return this._contains(e)?(s=this._getProfileFromMap(e),t.profileCustomField&&!0===st(s.profileCustomField,t.profileCustomField)&&(s.lastUpdatedTime=o,i=!0),0<We(s,t,["profileCustomField"])&&(s.lastUpdatedTime=o,i=!0)):(s=new Xi(t),!this._userM.isMyFriend(e)&&e!==this._userM.getMyAccount()||(s.lastUpdatedTime=o,i=!0,this.accountProfileMap.set(e,s))),this._flush(e===this._userM.getMyAccount()),!0===i&&Ce.l(this._n+`._update account:${e} isUpdated:`+i),{isProfileUpdated:i,latestProfile:s}}_flush(e){const t=[...this.accountProfileMap.values()],s=this._userM.getStorageModule();Ce.d(this._n+`._flush length:${t.length} flushAtOnce:`+e),s.setItem(this.TAG,t,e)}_contains(e){return this.accountProfileMap.has(e)}_getProfileFromMap(e){return this.accountProfileMap.get(e)}_getCachedProfiles(){var e=this._userM.getStorageModule().getItem(this.TAG);return Oe(e)?[]:e}onConvProfileUpdated(s){var i,o,n;const r=[];for(let e=0,t=s.length;e<t;e++)o=(i=s[e]).userID,this._userM.isMyFriend(o)&&(this._contains(o)?(n=this._getProfileFromMap(o),0<We(n,i)&&r.push(o)):r.push(i.userID));0!==r.length&&(Ce.l(this._n+".onConvProfileUpdated toAccountList:"+r),this.getUserProfile({userIDList:r}))}getNickAndAvatarByUserID(e){return this._contains(e)?{nick:(e=this._getProfileFromMap(e)).nick,avatar:e.avatar}:{nick:"",avatar:""}}getUserNickAndAvatar(e){var t=[...new Set(e)];Ce.l(`${this._n}.getUserNickAndAvatar userIDList.length:${e.length} uniqueUserIDList.length:`+t.length);const s=[];if(0===e.length)return Promise.resolve(s);const i=this._createUserIDListGroup(t),o=[];return i.forEach(e=>{o.push(this.getUserProfile({userIDList:e}))}),Promise.all(o).then(e=>(e.forEach(e=>{e=e.data.map(({userID:e,nick:t,avatar:s})=>({userID:e,nick:t,avatar:s}));s.push(...e)}),s))}_createUserIDListGroup(e){const t=[];let s=0;for(;s<e.length;)t.push(e.slice(s,s+=100));return t}reset(){this._flush(!0),this.accountProfileMap.clear()}}class hn{constructor(e){Oe||(this.userID=e.userID||"",this.timeStamp=e.timeStamp||0)}}class pn{constructor(e){this._userM=e,this._n="BlacklistHandler",this._blacklistMap=new Map,this._startIndex=0}getLocalBlacklist(){return[...this._blacklistMap.keys()]}getBlacklist(){const o=this._n+".getBlacklist",t={fromAccount:this._userM.getMyAccount(),maxLimited:100,startIndex:this._startIndex},n=new mi("getBlacklist");return this._userM.req({P:ti.GET_BL,data:t}).then(t=>{var{blackListItem:t,startIndex:s}=t.data,i=Oe(t)?0:t.length;n.setMessage("count:"+i).end(),Ce.i(o+" ok"),this._startIndex=s,this._handleResponse(t,!0),this._userM.emitOEvt(e.BLACKLIST_UPDATED,[...this._blacklistMap.keys()]),0!==this._startIndex&&this.getBlacklist()}).catch(e=>(n.setError(e).end(),Ce.e(o+" failed. error:",e),Qs(e)))}addBlacklist(t){const s=new mi("addToBlacklist"),i=this._n+".addBlacklist",o=this._userM.getMyAccount();if(1!==t.userIDList.length||t.userIDList[0]!==o)return t.userIDList.includes(o)&&(t.userIDList=t.userIDList.filter(e=>e!==o)),t.fromAccount=this._userM.getMyAccount(),t.toAccount=t.userIDList,this._userM.req({P:ti.ADD_TO_BL,data:t}).then(e=>(s.setMessage(5<t.userIDList.length?"userIDList.length:"+t.userIDList.length:"userIDList:"+t.userIDList).end(),Ce.i(i+" ok"),this._handleResponse(e.resultItem,!0),Ys([...this._blacklistMap.keys()]))).catch(e=>(s.setError(e).end(),Ce.e(i+" failed. error:",e),Qs(e)));{const t=js.CANNOT_ADD_SELF_TO_BLACKLIST,o=this._userM.getErrMsg(t);s.setCode(t).setMessage(o).end();var e=new zs({code:t});return Ce.e(i+" failed. error:",e),Qs(e)}}_handleResponse(n,r){if(!Oe(n)){let s,i,o;for(let e=0,t=n.length;e<t;e++)i=n[e].to,o=n[e].resultCode,!$e(o)&&0!==o||(r?((s=this._blacklistMap.has(i)?this._blacklistMap.get(i):new hn).userID=i,Oe(n[e].addBlackTimeStamp)||(s.timeStamp=n[e].addBlackTimeStamp),this._blacklistMap.set(i,s)):this._blacklistMap.has(i)&&(s=this._blacklistMap.get(i),this._blacklistMap.delete(i)))}Ce.l(`${this._n}._handleResponse total:${this._blacklistMap.size} bAdd:`+r)}deleteBlacklist(t){const s=this._n+".deleteBlacklist",i=new mi("removeFromBlacklist");return t.fromAccount=this._userM.getMyAccount(),t.toAccount=t.userIDList,this._userM.req({P:ti.RM_FROM_BL,data:t}).then(e=>(i.setMessage(5<t.userIDList.length?"userIDList.length:"+t.userIDList.length:"userIDList:"+t.userIDList).end(),Ce.i(s+" ok"),this._handleResponse(e.data.resultItem,!1),Ys([...this._blacklistMap.keys()]))).catch(e=>(i.setError(e).end(),Ce.e(s+" failed. error:",e),Qs(e)))}onAccountDeleted(s){for(let e=0,t=s.length;e<t;e++){const i=s[e];this._blacklistMap.has(i)&&this._blacklistMap.delete(i)}const i=s.length;0<i&&(Ce.l(`${this._n}.onAccountDeleted count:${i} `+(i<30?"userIDList:"+s:"")),this._userM.emitOEvt(e.BLACKLIST_UPDATED,[...this._blacklistMap.keys()]))}onAccountAdded(s){const i=[];var o;for(let e=0,t=s.length;e<t;e++)o=s[e],this._blacklistMap.has(o)||(this._blacklistMap.set(o,new hn({userID:o})),i.push(o));0<i.length&&(Ce.l(`${this._n}.onAccountAdded count:${i.length} userIDList:`,i),this._userM.emitOEvt(e.BLACKLIST_UPDATED,[...this._blacklistMap.keys()]))}reset(){this._blacklistMap.clear(),this._startIndex=0}}const gn=function(e){const o=String(e).replace(/[=]+$/,"");let n="";if(o.length%4==1)return"";for(let e,t,s=0,i=0;t=o.charAt(i++);~t&&(e=s%4?64*e+t:t,s++%4)&&(n+=String.fromCharCode(255&e>>(-2*s&6))))t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(t);try{return decodeURIComponent(escape(n))}catch(e){return""}};class mn{constructor(e){this._userM=e,this._n="UserStatusHandler",this.MAX_QUERY_USER_COUNT=500,this.MAX_SUBSCRIBE_USER_COUNT=100,this.MAX_UNSUBSCRIBE_USER_COUNT=100,this._userM.getIEmitInst().on(Vi.CLOUD_CONFIG,this._onCloudConfig,this)}_onCloudConfig(){var e=this._userM.getCloudConfig("status_query_count"),t=this._userM.getCloudConfig("status_sub_count"),s=this._userM.getCloudConfig("status_unsub_count");Ce.l(this._n+`._onCloudConfig statusQueryCount:${e} statusSubscribeCount:${t} statusUnsubscribeCount:`+s),$e(e)||(this.MAX_QUERY_USER_COUNT=parseInt(e,10)),$e(e)||(this.MAX_SUBSCRIBE_USER_COUNT=parseInt(t,10)),$e(e)||(this.MAX_UNSUBSCRIBE_USER_COUNT=parseInt(s,10))}onUserStatusUpdated(t){const s=t["dataList"],i=this._userM.getMyUserID(),o=this._userM.get(vs),n=s.map(e=>{var{to:e,statusType:t,customStatus:s}=e,s=gn(s);return e===i&&o.setCustomStatus(s),{userID:e,statusType:t,customStatus:s}});Ce.l(this._n+".onUserStatusUpdated list:"+JSON.stringify(n)),this._userM.emitOEvt(e.USER_STATUS_UPDATED,n)}setSelfStatus(e){const t=this._n+".setSelfStatus";if(!1===this._userM.filterProfanity("customStatus",e))return Qs({code:js.PROFANITY_FOUND});const s=new mi("setSelfStatus"),i=e["customStatus"];return this._userM.req({P:ti.SET_SELF_STATUS,data:{customStatus:i}}).then(e=>(s.setMessage("customStatus:"+i).end(),Ce.l(t+" ok. customStatus:"+i),this._userM.get(vs).setCustomStatus(i),Ys({userID:this._userM.getMyUserID(),statusType:1,customStatus:i}))).catch(e=>(s.setError(e).end(),Ce.e(t+" failed. error:",e),Qs(e)))}getUserStatus(e){const n=this._n+".getUserStatus",{userIDList:r=[]}=e,t=this._userM.getMyUserID();let s=[...r],a=void 0;var i=s.indexOf(t);if(-1<i){s.splice(i,1);const e=this._userM.get(vs).getCustomStatus();a={userID:t,statusType:1,customStatus:e}}if(0===s.length)return Zs({successUserList:[a],failureUserList:[]});if(!this._userM.canIUse(M.USER_STATUS))return this._userM.noUse("getUserStatus");s.length>this.MAX_QUERY_USER_COUNT&&(Ce.w(n+" "+Et(this.MAX_QUERY_USER_COUNT)),s=r.slice(0,this.MAX_QUERY_USER_COUNT));const c=new mi("getUserStatus");return this._userM.req({P:ti.GET_USER_STATUS,data:{userIDList:s}}).then(e=>{const{successUserList:t=[],failureUserList:s=[]}=e.data,i=t.map(e=>{var{userID:e,statusType:t,customStatus:s}=e;return{userID:e,statusType:t,customStatus:gn(s)}}),o=s.map(e=>{var{userID:e,invalidUserID:t,errorCode:s,errorInfo:i}=e;return{userID:Oe(t)?e:t,code:s,message:i}});$e(a)||i.unshift(a);e=`userID count:${r.length}, success count:${i.length}, fail count:`+o.length;return c.setMessage(e).end(),Ce.l(n+` ok. ${e}.`),Ys({successUserList:i,failureUserList:o})}).catch(e=>(c.setMessage("userID count:"+r.length).setError(e).end(),Ce.e(n+" failed. error:",e),Qs(e)))}subscribeUserStatus(e){var t="subscribeUserStatus";if(!this._userM.canIUse(M.USER_STATUS))return this._userM.noUse(t);const i=this._n+"."+t,{userIDList:s=[]}=e;let o=[...s];o.length>this.MAX_SUBSCRIBE_USER_COUNT&&(Ce.w(i+" "+Et(this.MAX_SUBSCRIBE_USER_COUNT)),o=s.slice(0,this.MAX_SUBSCRIBE_USER_COUNT));const n=new mi(t),r="userID count:"+s.length;return Ce.l(i+" "+r),this._userM.req({P:ti.SUB_USER_STATUS,data:{userIDList:o}}).then(e=>{const{failureUserList:t=[]}=e.data,s=t.map(e=>{var{userID:e,invalidUserID:t,errorCode:s,errorInfo:i}=e;return{userID:Oe(t)?e:t,code:s,message:i}});return n.setMessage(r+" fail count:"+s.length).end(),Ce.l(i+` ok. fail count:${s.length}.`),Ys({failureUserList:s})}).catch(e=>(n.setMessage(r).setError(e).end(),Ce.e(i+" failed. error:",e),Qs(e)))}unsubscribeUserStatus(e){var t="unsubscribeUserStatus";if(!this._userM.canIUse(M.USER_STATUS))return this._userM.noUse(t);const i=this._n+"."+t,{userIDList:s=[]}=e||{};let o=[...s];s.length>this.MAX_UNSUBSCRIBE_USER_COUNT&&(Ce.w(i+" "+Et(this.MAX_UNSUBSCRIBE_USER_COUNT)),o=s.slice(0,this.MAX_UNSUBSCRIBE_USER_COUNT));const n=new mi(t),r="userID count:"+s.length,a=(Ce.l(i+" "+r),{userIDList:o});return 0===o.length&&(a.userIDList=void 0,a.unsubscribeAll=1),this._userM.req({P:ti.UNSUB_USER_STATUS,data:a}).then(e=>{const{failureUserList:t=[]}=e.data,s=t.map(e=>{var{userID:e,invalidUserID:t,errorCode:s,errorInfo:i}=e;return{userID:Oe(t)?e:t,code:s,message:i}});return n.setMessage(r+" fail count:"+s.length).end(),Ce.l(i+` ok. fail count:${s.length}.`),Ys({failureUserList:s})}).catch(e=>(n.setMessage(r).setError(e).end(),Ce.e(i+" failed. error:",e),Qs(e)))}reset(){this.MAX_QUERY_USER_COUNT=500,this.MAX_SUBSCRIBE_USER_COUNT=100,this.MAX_UNSUBSCRIBE_USER_COUNT=100}}class fn extends ei{constructor(e){super(e),this._n="UserModule",this._profileHandler=new _n(this),this._blacklistHandler=new pn(this),this._userStatusHandler=new mn(this),this.getIEmitInst().on(Vi.A2KEY_AND_TINYID_UPDATED,this.onContextUpdated,this)}onContextUpdated(e){this._profileHandler.getMyProfile(),this._blacklistHandler.getBlacklist()}mockOnNickAvatarModified(e,t){Ce.l(this._n+`._mockOnNickAvatarModified nick:${e} avatar:`+t),this.onProfileModified({dataList:[{pushType:1,userID:this.getMyUserID(),profileList:[{tag:ye.NICK,value:e},{tag:ye.AVATAR,value:t}]}]})}onProfileModified(e){this._profileHandler.onProfileModified(e)}onRelationChainModified(e){const t=e["dataList"];if(!Oe(t)){const s=[],i=(t.forEach(e=>{e.blackListDelAccount&&s.push(...e.blackListDelAccount)}),0<s.length&&this._blacklistHandler.onAccountDeleted(s),[]);t.forEach(e=>{e.blackListAddAccount&&i.push(...e.blackListAddAccount)}),0<i.length&&this._blacklistHandler.onAccountAdded(i)}}onConvProfileUpdated(e){this._profileHandler.onConvProfileUpdated(e)}getMyAccount(){return this.getMyUserID()}getMyNick(){return this._profileHandler.getNickAndAvatarByUserID(this.getMyUserID()).nick}getMyProfile(){return this._profileHandler.getMyProfile()}getStorageModule(){return this.get(Es)}filterProfanity(e,t){const s=this.get(bs);if(!s)return!0;var{isAllowedToSend:i,modifiedText:o}=s.filterText(t[e],v);return!0===i&&(t[e]=o,!0)}isMyFriend(e){const t=this.get(Cs);return!!t&&t.isMyFriend(e)}getUserProfile(e){return this._profileHandler.getUserProfile(e)}updateMyProfile(e){return this._profileHandler.updateMyProfile(e)}getNickAndAvatarByUserID(e){return this._profileHandler.getNickAndAvatarByUserID(e)}getUserNickAndAvatar(e){return this._profileHandler.getUserNickAndAvatar(e)}getLocalBlacklist(){var e=this._blacklistHandler.getLocalBlacklist();return Zs(e)}addBlacklist(e){return this._blacklistHandler.addBlacklist(e)}deleteBlacklist(e){return this._blacklistHandler.deleteBlacklist(e)}onUserStatusUpdated(e){this._userStatusHandler.onUserStatusUpdated(e)}setSelfStatus(e){return this._userStatusHandler.setSelfStatus(e)}getUserStatus(e){return this._userStatusHandler.getUserStatus(e)}subscribeUserStatus(e){return this._userStatusHandler.subscribeUserStatus(e)}unsubscribeUserStatus(e){return this._userStatusHandler.unsubscribeUserStatus(e)}reset(){Ce.l(this._n+".reset"),this._profileHandler.reset(),this._blacklistHandler.reset(),this._userStatusHandler.reset()}}class Mn{constructor(e,t){this._m=e,this._isLoggedIn=!1,this._SDKAppID=t.SDKAppID,this._userID=t.userID||"",this._userSig=t.userSig||"",this._version="3.4.8",this._a2Key="",this._tinyID="",this._customStatus="",this._contentType="json",this._unlimitedAVChatRoom=t.unlimitedAVChatRoom,this._scene=t.scene||"",this._oversea=t.oversea,this._instanceID=t.instanceID,this._statusInstanceID=0,this._isDevMode=t.devMode,this._isTestEnv=t.testEnv,this._proxyServer=t.proxyServer,this._fileUploadProxy=t.fileUploadProxy,this._fileDownloadProxy=t.fileDownloadProxy,this._applicationID=0,this._isPartialUpdatedConvs=t.partialUpdatedConversations,this._isUsingChatCore=!1,this._uiPlatform=0,this._authKey="",this._customLoginInfo=""}isLoggedIn(){return this._isLoggedIn}isOversea(){return this._oversea}isPrivateNetWork(){return this._proxyServer}isDevMode(){return this._isDevMode}isTestEnv(){return this._isTestEnv}isPartialUpdatedConvs(){return this._isPartialUpdatedConvs}isSingaporeSite(){return 2e7<=this._SDKAppID&&this._SDKAppID<3e7||172e7<=this._SDKAppID&&this._SDKAppID<173e7}isKoreaSite(){return 3e7<=this._SDKAppID&&this._SDKAppID<4e7||173e7<=this._SDKAppID&&this._SDKAppID<174e7}isGermanySite(){return 4e7<=this._SDKAppID&&this._SDKAppID<5e7||174e7<=this._SDKAppID&&this._SDKAppID<175e7}isIndiaSite(){return 5e7<=this._SDKAppID&&this._SDKAppID<6e7||175e7<=this._SDKAppID&&this._SDKAppID<176e7}isJapanSite(){return 6e7<=this._SDKAppID&&this._SDKAppID<7e7||176e7<=this._SDKAppID&&this._SDKAppID<177e7}isUSASite(){return 7e7<=this._SDKAppID&&this._SDKAppID<8e7||177e7<=this._SDKAppID&&this._SDKAppID<178e7}isIndonesiaSite(){return 8e7<=this._SDKAppID&&this._SDKAppID<9e7||178e7<=this._SDKAppID&&this._SDKAppID<179e7}isIntl(){return 0===(e=this._SDKAppID)||2e7<=e&&e<9e7||172e7<=e&&e<179e7;var e}isUnlimitedAVChatRoom(){return this._unlimitedAVChatRoom}isUsingChatCore(){return this._isUsingChatCore}setUsingChatCore(e){this._isUsingChatCore=e}getUIPlatform(){return this._uiPlatform}setUIPlatform(e){this._uiPlatform=e}setUserID(e){this._userID=e}getUserID(){return this._userID}setUserSig(e){this._userSig=e}getUserSig(){return this._userSig}getSDKAppID(){return this._SDKAppID}setTinyID(e){this._tinyID=e,this._isLoggedIn=!0}getTinyID(){return this._tinyID}setCustomStatus(e){this._customStatus=e}getCustomStatus(){return this._customStatus}getScene(){return oe?window.tencent_cloud_im_csig_flutter_for_web_25F_cy:this._isTUIKit()?"tuikit":this._scene}getInstanceID(){return this._instanceID}getStatusInstanceID(){return this._statusInstanceID}setStatusInstanceID(e){this._statusInstanceID=e}getVersion(){return this._version}getA2Key(){return this._a2Key}setA2Key(e){this._a2Key=e}getContentType(){return this._contentType}getProxyServer(){return this._proxyServer}getFileUploadProxy(){return this._fileUploadProxy}getFileDownloadProxy(){return this._fileDownloadProxy}setApplicationID(e){this._applicationID=e}getApplicationID(){return this._applicationID}setDowloadFileAuthKey(e){this._authKey=e}getDowloadFileAuthKey(){return this._authKey}setCustomLoginInfo(e){this._customLoginInfo=e}getCustomLoginInfo(){return this._customLoginInfo}_isTUIKit(){let s=!1,e=!1,t=!1,i=!1,o=[];k&&(o=Object.keys($));for(let e=0,t=(o=b?G?Object.keys(uni):Object.keys(window):o).length;e<t;e++)if(o[e].toLowerCase().includes("uikit")){s=!0;break}if(o=null,k&&!xe($.createGamePortal)&&xe(getApp)&&!$e(getApp())){const s=getApp().globalData;Fe(s)&&!0===s.isTUIKit&&(e=!0)}!0===this._m.get(Es).getStorageSync(`TIM_${this._SDKAppID}_isTUIKit`)&&(t=!0);let n=null;if(S&&!L&&"undefined"==typeof uni&&__wxConfig&&(n=__wxConfig.pages),R&&"undefined"==typeof uni&&__qqConfig&&(n=__qqConfig.pages),be(n)&&0<n.length){for(let e=0,t=n.length;e<t;e++)if(n[e].toLowerCase().includes("tui")){i=!0;break}n=null}return s||e||t||i}reset(){this._isLoggedIn=!1,this._userSig="",this._a2Key="",this._tinyID="",this._customStatus="",this._statusInstanceID=0}}const In={"k-vue2-pc":1,"k-vue2-h5":2,"k-vue2-h5-uni":3,"k-vue2-app-uni":4,"k-vue2-mp-uni":5,"k-vue2-pc-uni":6,"k-vue3-pc":7,"k-vue3-h5":8,"k-vue3-h5-uni":9,"k-vue3-app-uni":10,"k-vue3-mp-uni":11,"k-vue3-pc-uni":12,"k-rn":13};class Cn extends ei{constructor(e){super(e),this._n="SignModule",this._helloInterval=120,this._lastLoginTs=0,this._lastWsHelloTs=0,this._isWebUniapp=0,Ki.mixin(this)}onCheckTimer(e){this.isLoggedIn()&&e%this._helloInterval==0&&this._hello()}getPushModule(){let e=void 0;const t=this.get(Hs),s=this.get(Fs);return t.canIUseTIMPush()?e=t:s.canIUseOfflinePush()&&(e=s),e}login(e){if(this.isLoggedIn()){const e=this.getMyUserID();return(t=this.getErrMsg("RepeatLogin",e))&&Ce.w(t),Zs({actionStatus:"OK",errorCode:0,errorInfo:t,repeatLogin:!0})}if(Date.now()-this._lastLoginTs<=15e3)return this.warn("LoggingIn",e.userID),Qs({code:js.REPEAT_LOGIN});Ce.l(this._n+".login userID:"+e.userID);var t=this._checkLoginInfo(e);if(0!==t.code)return Qs(t);const s=this.get(vs),{userID:i,userSig:o}=e;return s.setUserID(i),s.setUserSig(o),this.get(Os).updateProtocolConfig(),this._login()}_login(){const f=this.get(vs);let M=f.getScene(),e=0,t=M;M&&M.startsWith("k-")&&(t=In[M],M="tuikit");const I=new mi("login");I.setMessage(""+t).setMoreMessage("identifier:"+this.getMyUserID());var s="tuikit"===M;let i=0;G?i=s?3===t||4===t||5===t||6===t?31:9===t||10===t||11===t||12===t?32:4:3:k?i=D?36:"tuikit"===M?12:11:b?i=oe?"flutter_web_uikit"===M?21:20:this._isReactUIKit()?ne?25:24:s?1===t||2===t?29:7===t||8===t?30:ne?17:14:ne?16:13:13===t&&(i=38),I.setUIPlatform(i),f.setUIPlatform(i);const o=this.getPushModule();if(o){this._isWebUniapp=o.getUniAppPlatform();const M=this._getStatusInstanceID();f.setStatusInstanceID(M),this.get(Os).updateProtocolConfig(),e=o.getDeviceBrand()}const C=this._n+"._login";return this._lastLoginTs=Date.now(),this.req({P:ti.LOGIN,data:{deviceBrand:e,isWebUniapp:this._isWebUniapp,customInfo:f.getCustomLoginInfo()}}).then(e=>{this._lastLoginTs=0;var t=Date.now();let s=null;var{a2Key:i,tinyID:o,helloInterval:d,instanceID:n,timeStamp:_,customStatus:r="",purchaseBits:u,authKey:h=""}=e.data,a=1e3*_,c=t-I.getStartTs(),c=a+parseInt(c/2)-t,t=I.getStartTs()+c;I.start(t);{t=a,a=c,he=a;const l=new Date;l.setTime(t),Ce.i(`baseTime from server:${l} offset:`+he)}if(!o)throw s=new zs({code:js.NO_TINYID}),I.setError(s).end(),s;if(!i)throw s=new zs({code:js.NO_A2KEY}),I.setError(s).end(),s;a=this.get(Ns).getSocketID(),t=gn(r),r=`socketID:${a} scene:${M} helloInterval:${d} instanceID:${n} timeStamp:${_} offset:${c} customStatus:${t} isWebUniapp:`+this._isWebUniapp;Ce.l(C+" ok. "+r);let p="",g="";if(S&&xe($.getAccountInfoSync)){const f=$.getAccountInfoSync().miniProgram;f&&(p=f.appId,g=f.envVersion)}I.setMoreMessage(r+` href:${b?window.location.href:""} mpAppId:${p} envVersion:${g} authKey:`+h).end(),f.setA2Key(i),f.setTinyID(o),f.setStatusInstanceID(n),f.setCustomStatus(t),f.setDowloadFileAuthKey(h),u&&this.get(ws).onPushedConfig({errorCode:0,expiredTime:0,purchaseBits:u}),this.get(Os).updateProtocolConfig(),this.emitIEvt(Vi.A2KEY_AND_TINYID_UPDATED),this._helloInterval=d,this.triggerReady();const m=this.getPushModule();return m&&(uni.setStorageSync("timUniAppInstanceID",n),m.init()),this._fetchCloudControlConfig(),this.get(bs).init(),e}).catch(e=>(I.setError(e).end(!0),this._m.setNotReadyReason(js.LOGIN_FAILED),Ce.e(C+" failed. error:",e),this._lastLoginTs=0,this._m.onLoginFailed(),Qs(e)))}logout(e=0){const t=this._n+".logout",s=this.isLoggedIn();return Ce.i(t+` type:${e} isLoggedIn:${s} isWebUniapp:`+this._isWebUniapp),s?(new mi("logout").setMessage("identifier:"+this.getMyUserID()).end(!0),0===e&&this._m.setNotReadyReason(js.LOGGED_OUT),this.req({P:ti.LOGOUT,data:{type:e,isWebUniapp:this._isWebUniapp}}).then(()=>(this.resetReady(),Zs({}))).catch(e=>(Ce.e(t+" error:",e),this.resetReady(),Zs({})))):Qs({code:js.USER_NOT_LOGGED_IN})}getLoginUser(){return this.isLoggedIn()?this.getMyUserID():""}_fetchCloudControlConfig(){this.get(Ps).fetchConfig()}_getStatusInstanceID(){return uni.getStorageSync("timUniAppInstanceID")||0}_hello(){this._lastWsHelloTs=Date.now(),this.req({P:ti.HELLO,data:{isWebUniapp:this._isWebUniapp}}).catch(e=>{Ce.w(this._n+"._hello error:",e)})}getLastWsHelloTs(){return this._lastWsHelloTs}_checkLoginInfo(e){let t=0;return Oe(this.get(vs).getSDKAppID())?t=js.NO_SDKAPPID:Oe(e.userID)?t=js.NO_IDENTIFIER:Oe(e.userSig)&&(t=js.NO_USERSIG),{code:t}}_isReactUIKit(){return b&&void 0!==window.tencent_cloud_im_csig_react_uikit_23F_xa}onMultipleAccountKickedOut(s){new mi("kickedOut").setMessage(`type:${t.KICKED_OUT_MULT_ACCOUNT} newInstanceInfo:`+JSON.stringify(s)).end(!0),Ce.w(`${this._n}.onMultipleAccountKickedOut userID:${this.getMyUserID()} newInstanceInfo:`,s),this.logout(1).then(()=>{this.emitOEvt(e.KICKED_OUT,{type:t.KICKED_OUT_MULT_ACCOUNT}),this._m.setNotReadyReason(js.KICKED_OUT_MULT_ACCOUNT),this._m.reset()})}onMultipleDeviceKickedOut(s){new mi("kickedOut").setMessage(`type:${t.KICKED_OUT_MULT_DEVICE} newInstanceInfo:`+JSON.stringify(s)).end(!0),Ce.w(`${this._n}.onMultipleDeviceKickedOut userID:${this.getMyUserID()} newInstanceInfo:`,s),this.logout(1).then(()=>{this.emitOEvt(e.KICKED_OUT,{type:t.KICKED_OUT_MULT_DEVICE}),this._m.setNotReadyReason(js.KICKED_OUT_MULT_DEVICE),this._m.reset()})}onUserSigExpired(){new mi("kickedOut").setMessage(t.KICKED_OUT_USERSIG_EXPIRED).end(!0),Ce.w(this._n+".onUserSigExpired userID:"+this.getMyUserID()),0!==this.get(vs).getStatusInstanceID()&&(this.emitOEvt(e.KICKED_OUT,{type:t.KICKED_OUT_USERSIG_EXPIRED}),this._m.setNotReadyReason(js.KICKED_OUT_USERSIG_EXPIRED),this._m.reset())}onRestApiKickedOut(s){new mi("kickedOut").setMessage(`type:${t.KICKED_OUT_REST_API} newInstanceInfo:`+JSON.stringify(s)).end(!0),Ce.w(`${this._n}.onRestApiKickedOut userID:${this.getMyUserID()} newInstanceInfo:`,s),0!==this.get(vs).getStatusInstanceID()&&(this.emitOEvt(e.KICKED_OUT,{type:t.KICKED_OUT_REST_API}),this._m.setNotReadyReason(js.KICKED_OUT_REST_API),this._m.reset(),this.get(Ns).onRestApiKickedOut())}reset(){Ce.l(this._n+".reset"),this.resetReady(),this._helloInterval=120,this._lastLoginTs=0,this._lastWsHelloTs=0,this._isWebUniapp=0}}function Tn(){return null}class yn{constructor(e){this._m=e,this._n="StorageModule",this._storageQueue=new Map,this._errorTolerantHandle()}_errorTolerantHandle(){k||"undefined"!=typeof window&&this._canIUseCookies()||(this.getItem=Tn,this.setItem=Tn,this.removeItem=Tn,this.clear=Tn)}onCheckTimer(e){e%20==0&&0!==this._storageQueue.size&&this._doFlush()}_doFlush(){try{for(var[e,t]of this._storageQueue)this._setStorageSync(this._getKey(e),t);this._storageQueue.clear()}catch(e){Ce.w(this._n+"._doFlush error:",e)}}_getPrefix(){const e=this._m.get(vs);return`TIM_${e.getSDKAppID()}_${e.getUserID()}_`}_getKey(e){return""+this._getPrefix()+e}getItem(e,t=!0){try{var s=t?this._getKey(e):e;return this.getStorageSync(s)}catch(e){return Ce.w(this._n+".getItem error:",e),{}}}setItem(e,t,s=!1,i=!0){if(s){const s=i?this._getKey(e):e;this._setStorageSync(s,t)}else this._storageQueue.set(e,t)}clear(){try{k?$.clearStorageSync():this._canIUseCookies()&&localStorage.clear()}catch(e){Ce.w(this._n+".clear error:",e)}}removeItem(e,t=!0){try{var s=t?this._getKey(e):e;this._removeStorageSync(s)}catch(e){Ce.w(this._n+".removeItem error:",e)}}getSize(e,t="b"){try{const s={size:0,limitSize:5242880,unit:t};if(Object.defineProperty(s,"leftSize",{enumerable:!0,get:()=>s.limitSize-s.size}),k&&(s.limitSize=1024*$.getStorageInfoSync().limitSize),e)s.size=JSON.stringify(this.getItem(e)).length+this._getKey(e).length;else if(k){const e=$.getStorageInfoSync()["keys"];e.forEach(e=>{s.size+=JSON.stringify(this.getStorageSync(e)).length+this._getKey(e).length})}else if(this._canIUseCookies())for(const e in localStorage)localStorage.hasOwnProperty(e)&&(s.size+=localStorage.getItem(e).length+e.length);return this._convertUnit(s)}catch(e){Ce.w(this._n+" error:",e)}}_convertUnit(e){const t={},s=e["unit"];t.unit=s;for(const i in e)"number"==typeof e[i]&&("kb"===s.toLowerCase()?t[i]=Math.round(e[i]/1024):"mb"===s.toLowerCase()?t[i]=Math.round(e[i]/1024/1024):t[i]=e[i]);return t}_setStorageSync(e,t){k?O?my.setStorageSync({key:e,data:t}):$.setStorageSync(e,t):this._canIUseCookies()&&localStorage.setItem(e,JSON.stringify(t))}getStorageSync(e){return k?O?my.getStorageSync({key:e}).data:$.getStorageSync(e):this._canIUseCookies()?JSON.parse(localStorage.getItem(e)):{}}_removeStorageSync(e){k?O?my.removeStorageSync({key:e}):$.removeStorageSync(e):this._canIUseCookies()&&localStorage.removeItem(e)}_canIUseCookies(){return"undefined"!=typeof window&&navigator&&navigator.cookieEnabled&&localStorage}reset(){Ce.l(this._n+".reset"),this._doFlush()}}class vn{constructor(e){this._n="SSOLogBody",this._report=[]}pushIn(e){Ce.d(this._n+".pushIn",this._report.length,e),this._report.push(e)}backfill(e){be(e)&&0!==e.length&&(Ce.d(this._n+".backfill",this._report.length,e.length),this._report.unshift(...e))}getLogsNumInMemory(){return this._report.length}isEmpty(){return 0===this._report.length}_reset(){this._report.length=0,this._report=[]}getLogsInMemory(){var e=this._report.slice();return this._reset(),e}}const En=function(e){const t=e.get(vs);return{SDKType:10,SDKAppID:t.getSDKAppID(),SDKVersion:t.getVersion(),tinyID:Number(t.getTinyID()),userID:t.getUserID(),platform:e.getPlatform(),instanceID:t.getInstanceID(),traceID:pe()}};class Sn extends ei{constructor(e){super(e),this._n="EventStatModule",this.TAG="im-ssolog-event",this._reportBody=new vn,this.MIN_THRESHOLD=20,this.MAX_THRESHOLD=100,this.WAITING_TIME=6e4,this.REPORT_LEVEL=[4,5,6],this.REPORT_SDKAPPID_BLACKLIST=[],this.REPORT_TINYID_WHITELIST=[],this._lastReportTime=Date.now();const t=this.getIEmitInst();t.on(Vi.A2KEY_AND_TINYID_UPDATED,this._onLoginSuccess,this),t.on(Vi.CLOUD_CONFIG,this._onCloudConfig,this)}reportAtOnce(){this._report()}_onLoginSuccess(){const e=this.get(Es),t=e.getItem(this.TAG,!1);!Oe(t)&&xe(t.forEach)&&(Ce.l(this._n+"._onLoginSuccess. logs count:"+t.length),t.forEach(e=>{this._reportBody.pushIn(e)}),e.removeItem(this.TAG,!1))}_onCloudConfig(){const e=this.getCloudConfig("evt_rpt_threshold"),t=this.getCloudConfig("evt_rpt_waiting"),s=this.getCloudConfig("evt_rpt_level"),i=this.getCloudConfig("evt_rpt_sdkappid_bl"),o=this.getCloudConfig("evt_rpt_tinyid_wl");$e(e)||(this.MIN_THRESHOLD=Number(e)),$e(t)||(this.WAITING_TIME=Number(t)),$e(s)||(this.REPORT_LEVEL=s.split(",").map(e=>Number(e))),$e(i)||(this.REPORT_SDKAPPID_BLACKLIST=i.split(",").map(e=>Number(e))),$e(o)||(this.REPORT_TINYID_WHITELIST=o.split(","))}pushIn(e){e instanceof mi&&(e.updateTimeStamp(),this._reportBody.pushIn(e),this._reportBody.getLogsNumInMemory()>=this.MIN_THRESHOLD&&this._report())}onCheckTimer(){Date.now()<this._lastReportTime+this.WAITING_TIME||this._reportBody.isEmpty()||this._report()}_filterLogs(e){const t=this.get(vs),s=t.getSDKAppID(),i=t.getTinyID();return Mt(this.REPORT_SDKAPPID_BLACKLIST,s)&&!It(this.REPORT_TINYID_WHITELIST,i)?[]:e.filter(e=>this.REPORT_LEVEL.includes(e.level))}_report(){if(!this._reportBody.isEmpty()){const t=this._reportBody.getLogsInMemory(),s=this._filterLogs(t);var e;0!==s.length?(e={header:En(this),event:s},this.req({P:ti.SSO_STAT,data:{...e}}).then(()=>{this._lastReportTime=Date.now()}).catch(e=>{Ce.w(this._n+"._report failed. error:",e),this._lastReportTime=Date.now(),this._reportBody.backfill(t),this._reportBody.getLogsNumInMemory()>this.MAX_THRESHOLD&&this._flushAtOnce()})):this._lastReportTime=Date.now()}}_flushAtOnce(){const t=this.get(Es),s=t.getItem(this.TAG,!1),i=this._reportBody.getLogsInMemory(),o=this._n+"._flushAtOnce";if(Oe(s))Ce.l(o+" count:"+i.length),t.setItem(this.TAG,i,!0,!1);else{let e=i.concat(s);e.length>this.MAX_THRESHOLD&&(e=e.slice(0,this.MAX_THRESHOLD)),Ce.l(o+" count:"+e.length),t.setItem(this.TAG,e,!0,!1)}}reset(){Ce.l(this._n+".reset"),this._lastReportTime=0,this._report(),this.REPORT_SDKAPPID_BLACKLIST=[],this.REPORT_TINYID_WHITELIST=[]}}const Dn="none",Rn="online";class Ln{constructor(e){this._m=e,this._networkType=Rn,this._n="NetMonitorModule",this._mpNetworkStatusCallback=null,this._webOnlineCallback=null,this._webOfflineCallback=null,this._removeListener=null,this._m.getIEmitInst().on(Vi.A2KEY_AND_TINYID_UPDATED,this._startRN,this)}_startRN(){if(F){const e=this._m.get(Ls).getPlugin("chat-network-monitor");e&&(this._removeListener=e.addEventListener(e=>{var{isConnected:e=!1,type:t}=e;this._networkType!==t&&this._onNetworkStatusChange({isConnected:e,networkType:t})}))}}start(){const t=this._n+".start";k?($.getNetworkType({success:e=>{this._networkType=e.networkType||e.subtype||"",e.networkType===Dn?Ce.w(t+" no network, please check!"):Ce.i(t+" networkType:"+e.networkType)}}),this._mpNetworkStatusCallback=this._onNetworkStatusChange.bind(this),$.onNetworkStatusChange(this._mpNetworkStatusCallback)):b&&(this._networkType=Rn,this._webOnlineCallback=this._onWebOnline.bind(this),this._webOfflineCallback=this._onWebOffline.bind(this),window.addEventListener("online",this._webOnlineCallback),window.addEventListener("offline",this._webOfflineCallback))}_onWebOnline(){this._onNetworkStatusChange({isConnected:!0,networkType:Rn})}_onWebOffline(){this._onNetworkStatusChange({isConnected:!1,networkType:Dn})}_onNetworkStatusChange(e){var{isConnected:e,networkType:t}=e,s=this._n+"._onNetworkStatusChange";let i=!1;var o=`previous:${this._networkType} current:`+t;e?(Ce.i(s+" "+o),this._networkType!==t&&(i=!0,this._networkType=t,this._m.get(Ns).reConnect(!0))):this._networkType!==t&&(i=!0,this._networkType=t,Ce.w(s+" no network, please check!"),this._m.get(Ns).offline()),i&&new mi("networkChange").setMessage(`isConnected:${e} `+o).end()}isOnline(){return this._networkType!==Dn}getNetworkType(){return this._networkType}reset(){Ce.l(this._n+".reset"),k?null!==this._mpNetworkStatusCallback&&($.offNetworkStatusChange&&$.offNetworkStatusChange(this._mpNetworkStatusCallback),this._mpNetworkStatusCallback=null):b?(null!==this._webOnlineCallback&&(window.removeEventListener("online",this._webOnlineCallback),this._webOnlineCallback=null),null!==this._onWebOffline&&(window.removeEventListener("offline",this._webOfflineCallback),this._webOfflineCallback=null)):F&&this._removeListener&&(this._removeListener(),this._removeListener=null)}}function An(e,t){return e(t={exports:{}},t.exports),t.exports}var On=An(function(e){var i=Object.prototype.hasOwnProperty,h="~";function s(){}function n(e,t,s){this.fn=e,this.context=t,this.once=s||!1}function o(e,t,s,i,o){if("function"!=typeof s)throw new TypeError("The listener must be a function");s=new n(s,i||e,o),i=h?h+t:t;return e._events[i]?e._events[i].fn?e._events[i]=[e._events[i],s]:e._events[i].push(s):(e._events[i]=s,e._eventsCount++),e}function c(e,t){0==--e._eventsCount?e._events=new s:delete e._events[t]}function t(){this._events=new s,this._eventsCount=0}Object.create&&(s.prototype=Object.create(null),(new s).__proto__||(h=!1)),t.prototype.eventNames=function(){var e,t,s=[];if(0===this._eventsCount)return s;for(t in e=this._events)i.call(e,t)&&s.push(h?t.slice(1):t);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},t.prototype.listeners=function(e){var e=h?h+e:e,t=this._events[e];if(!t)return[];if(t.fn)return[t.fn];for(var s=0,i=t.length,o=new Array(i);s<i;s++)o[s]=t[s].fn;return o},t.prototype.listenerCount=function(e){e=h?h+e:e,e=this._events[e];return e?e.fn?1:e.length:0},t.prototype.emit=function(e,t,s,i,l,d){var _=h?h+e:e;if(!this._events[_])return!1;var o,n=this._events[_],r=arguments.length;if(n.fn){switch(n.once&&this.removeListener(e,n.fn,void 0,!0),r){case 1:return n.fn.call(n.context),!0;case 2:return n.fn.call(n.context,t),!0;case 3:return n.fn.call(n.context,t,s),!0;case 4:return n.fn.call(n.context,t,s,i),!0;case 5:return n.fn.call(n.context,t,s,i,l),!0;case 6:return n.fn.call(n.context,t,s,i,l,d),!0}for(c=1,o=new Array(r-1);c<r;c++)o[c-1]=arguments[c];n.fn.apply(n.context,o)}else for(var a,u=n.length,c=0;c<u;c++)switch(n[c].once&&this.removeListener(e,n[c].fn,void 0,!0),r){case 1:n[c].fn.call(n[c].context);break;case 2:n[c].fn.call(n[c].context,t);break;case 3:n[c].fn.call(n[c].context,t,s);break;case 4:n[c].fn.call(n[c].context,t,s,i);break;default:if(!o)for(a=1,o=new Array(r-1);a<r;a++)o[a-1]=arguments[a];n[c].fn.apply(n[c].context,o)}return!0},t.prototype.on=function(e,t,s){return o(this,e,t,s,!1)},t.prototype.once=function(e,t,s){return o(this,e,t,s,!0)},t.prototype.removeListener=function(e,t,s,i){e=h?h+e:e;if(!this._events[e])return this;if(!t)return c(this,e),this;var o=this._events[e];if(o.fn)o.fn!==t||i&&!o.once||s&&o.context!==s||c(this,e);else{for(var n=0,r=[],a=o.length;n<a;n++)(o[n].fn!==t||i&&!o[n].once||s&&o[n].context!==s)&&r.push(o[n]);r.length?this._events[e]=1===r.length?r[0]:r:c(this,e)}return this},t.prototype.removeAllListeners=function(e){return e?(e=h?h+e:e,this._events[e]&&c(this,e)):(this._events=new s,this._eventsCount=0),this},t.prototype.off=t.prototype.removeListener,t.prototype.addListener=t.prototype.on,t.prefixed=h,e.exports=t.EventEmitter=t});const Nn=["rich.my-imcloud.com","imrich.qcloud.com"],Pn=9999,Un=1e4;class Gn extends ei{constructor(e){super(e),this._n="UploadModule",this.TIMUploadPlugin=null,this.timUploadPlugin=null,this.COSSDK=null,this._cosUploadMethod=null,this.expiredTimeLimit=600,this.appid=0,this.bucketName="",this.ciUrl="",this.directory="",this.downloadUrl="",this.uploadUrl="",this.region="ap-shanghai",this.cos=null,this.cosOptions={secretId:"",secretKey:"",sessionToken:"",expiredTime:0},this.uploadFileType="",this.duration=900,this.tryCount=0,this.UPLOAD_SIZE_LIMIT={A:20971520,F:104857600,I:20971520,V:104857600},this.isSimpleCos=!1,this._fileDownloadProxy="",this._authKey="",this._fileDNList=Nn;const t=this.getIEmitInst();t.on(Vi.A2KEY_AND_TINYID_UPDATED,this._init,this),t.on(Vi.CLOUD_CONFIG,this._onCloudConfig,this)}_init(){this._fileDownloadProxy=this.getFileDownloadProxy(),this._authKey=this.getDowloadFileAuthKey();const e=this.get(Ls);var t;this.TIMUploadPlugin=e.getPlugin("tim-upload-plugin"),this.TIMUploadPlugin?this._initUploaderMethod():(t=k?"cos-wx-sdk":"cos-js-sdk",this.COSSDK=e.getPlugin(t),this.COSSDK?(this._getAuthorizationKey(),this.warn("CosReplacement",t)):this.warn("PluginUndetected"))}_onCloudConfig(){const e=this._n+"._onCloudConfig",t=this.getCloudConfig("upload_size_limit"),s=this.getCloudConfig("simple_cos"),i=this.getCloudConfig("file_dn_list");if(Ce.l(e+` uploadSizeLimit:${t} simpleCos:`+s),!$e(t))try{const e=JSON.parse(t);this.UPLOAD_SIZE_LIMIT={A:e.a?1048576*parseInt(e.a):this.UPLOAD_SIZE_LIMIT.A,F:e.f?1048576*parseInt(e.f):this.UPLOAD_SIZE_LIMIT.F,I:e.i?1048576*parseInt(e.i):this.UPLOAD_SIZE_LIMIT.I,V:e.v?1048576*parseInt(e.v):this.UPLOAD_SIZE_LIMIT.V}}catch(e){}if($e(s)||(this.isSimpleCos="1"===s),!$e(i))try{JSON.parse(i).forEach(e=>{this._fileDNList.includes(e)||this._fileDNList.push(e)})}catch(e){}}_getAuthorizationKey(){const s=this._n+"._getAuthorizationKey",i=new mi("_getAuthorizationKey"),o=Math.ceil(Date.now()/1e3);this.req({P:ti.COS_SIGN,data:{duration:this.expiredTimeLimit}}).then(e=>{var e=e["data"],t=(Ce.l(s+" ok. data:",e),e.expiredTime-o);i.setMessage(`requestId:${e.requestId} requestTime:${o} expiredTime:${e.expiredTime} diff:${t}s`).end(),!k&&e.region&&(this.region=e.region),this.appid=e.appid,this.bucketName=e.bucketName,this.ciUrl=e.ciUrl,this.directory=e.directory,this.downloadUrl=e.downloadUrl,this.uploadUrl=e.uploadUrl,this.cosOptions={secretId:e.secretId,secretKey:e.secretKey,sessionToken:e.sessionToken,expiredTime:e.expiredTime},Ce.l(s+` ok. region:${this.region} bucketName:`+this.bucketName),this._initUploaderMethod()}).catch(e=>{i.setError(e).end(),Ce.w(s+" failed. error:",e)})}_getCosPreSigUrl(t){const i=this._n+"._getCosPreSigUrl",o=Math.ceil(Date.now()/1e3),n=new mi("_getCosPreSigUrl");let e={uploadMethod:t.uploadMethod,platform:this.getPlatform(),SDKAppID:this.getSDKAppID(),userID:t.userID,conversationType:t.conversationType,uploadConfig:[{fileID:1,fileType:t.fileType,fileName:t.fileName}]},s=ti.SIMPLE_COS_PRE_SIG;return this.isSimpleCos||(e={fileType:t.fileType,fileName:t.fileName,uploadMethod:t.uploadMethod,duration:t.duration},s=ti.COS_PRE_SIG),this.req({P:s,data:e}).then(e=>{this.tryCount=0;var t=e.data||{};Ce.l(`${i} ok. isSimpleCos:${this.isSimpleCos} data:`,t);let s="";if(this.isSimpleCos){const{uploadUrl:e,fileKey:i}=t.preSig[0];s=`uploadIP:${t.uploadIP} uploadUrl:${e} fileKey:${i} cost:`+St(o)}else s=`requestId:${t.requestId} expiredTime:${t.expiredTime} diff:${t.expiredTime-o}s`;return n.setMessage(s).end(),t}).catch(e=>(-1===e.code&&(e.code=js.COS_GET_SIG_FAIL),n.setError(e).end(),Ce.w(i+" failed. error:",e),this.tryCount<1?(this.tryCount++,this._getCosPreSigUrl(t)):(this.tryCount=0,Qs({code:js.COS_GET_SIG_FAIL}))))}_initUploaderMethod(){if(this.TIMUploadPlugin)return this.timUploadPlugin=new this.TIMUploadPlugin,void(this._cosUploadMethod=(e,t)=>{this.timUploadPlugin.uploadFile(e,t)});this.appid&&(this.cos=k?new this.COSSDK({ForcePathStyle:!0,getAuthorization:this._getAuthorization.bind(this)}):new this.COSSDK({getAuthorization:this._getAuthorization.bind(this)}),this._cosUploadMethod=k?(e,t)=>{this.cos.postObject(e,t)}:(e,t)=>{this.cos.uploadFiles(e,t)})}onCheckTimer(e){this.COSSDK&&(this.TIMUploadPlugin||this.isLoggedIn()&&e%60==0&&Math.ceil(Date.now()/1e3)>=this.cosOptions.expiredTime-120&&this._getAuthorizationKey())}getFileDNList(){return this._fileDNList}_getAuthorization(e,t){t({TmpSecretId:this.cosOptions.secretId,TmpSecretKey:this.cosOptions.secretKey,XCosSecurityToken:this.cosOptions.sessionToken,ExpiredTime:this.cosOptions.expiredTime})}upload(e){if(!0===e._relayFlag)return Promise.resolve();const s=this.get(ks);switch(e.type){case t.MSG_IMAGE:return s.addTotalCount(ci),this._uploadImage(e);case t.MSG_FILE:return s.addTotalCount(ci),this._uploadFile(e);case t.MSG_AUDIO:return s.addTotalCount(ci),this._uploadAudio(e);case t.MSG_VIDEO:return s.addTotalCount(ci),this._uploadVideo(e);default:return Promise.resolve()}}_uploadImage(g){const e=this.get(gs),m=g.getElements()[0],t=e.getMessageOption(g.clientSequence);return this.doUploadImage({file:t.payload.file,to:t.to,message:g,onProgress:e=>{if(m.updatePercent(e),xe(t.onProgress))try{t.onProgress(e)}catch(e){return Qs({code:js.MSG_ONPROGRESS_ERR})}}}).then(t=>{var{location:t,fileType:e,fileSize:d,width:s,height:i,smallImageUrl:o,smallImageWidth:_,smallImageHeight:u,largeImageUrl:n,largeImageWidth:h,largeImageHeight:p,imageInfoArray:r}=t,t=this.isPrivateNetWork()?t:et(t);m.updateImageFormat(e);let a,c,l={size:d,url:t,width:s,height:i};if(r&&0<r.length)for(let e=0;e<r.length;e++){const t=r[e];1===t.type?a=t:2===t.type?c=t:l={...l,...t}}else c=o&&n?(a={url:o,width:_,height:u},{url:n,width:h,height:p}):(a=pt({originUrl:t,originWidth:s,originHeight:i,min:198}),pt({originUrl:t,originWidth:s,originHeight:i,min:720}));return m.updateImageInfoArray([{...l},{...c},{...a}]),g})}_uploadFile(s){const e=this.get(gs),i=s.getElements()[0],t=e.getMessageOption(s.clientSequence);return this.doUploadFile({file:t.payload.file,to:t.to,message:s,onProgress:e=>{if(i.updatePercent(e),xe(t.onProgress))try{t.onProgress(e)}catch(e){return Qs({code:js.MSG_ONPROGRESS_ERR})}}}).then(({location:e})=>{let t=e;return this.isPrivateNetWork()||(t=Mi(t=et(e),this._fileDownloadProxy,this._authKey,this._fileDNList)),i.updateFileUrl(t),s})}_uploadAudio(t){const e=this.get(gs),s=t.getElements()[0],i=e.getMessageOption(t.clientSequence);return this.doUploadAudio({file:i.payload.file,to:i.to,message:t,onProgress:e=>{if(s.updatePercent(e),xe(i.onProgress))try{i.onProgress(e)}catch(e){return Qs({code:js.MSG_ONPROGRESS_ERR})}}}).then(({location:e})=>{e=this.isPrivateNetWork()?e:et(e);return s.updateAudioUrl(e),t})}_uploadVideo(s){const e=this.get(gs),i=s.getElements()[0],t=e.getMessageOption(s.clientSequence);return this.doUploadVideo({file:t.payload.file,to:t.to,message:s,onProgress:e=>{if(i.updatePercent(e),xe(t.onProgress))try{t.onProgress(e)}catch(e){return Qs({code:js.MSG_ONPROGRESS_ERR})}}}).then(e=>{var{location:e,snapshotInfo:t}=e,e=this.isPrivateNetWork()?e:et(e);return i.updateVideoUrl(e),Oe(t)||i.updateSnapshotInfo(t),s})}_checkSizeError(e){let t="";return"A"===e?t="audio":"I"===e?t="image":"V"===e?t="video":"F"===e&&(t="file"),Qs({code:js[`MSG_${e}_SIZE_LIMIT`],message:this.getErrMsg("UploadSizeLimit",t,this.UPLOAD_SIZE_LIMIT[e]/1048576+"MB")})}doUploadImage(s){if(!s.file||this._isEmptyFileList(s.file.files))return Qs({code:js.MSG_I_SELECT_F_FIRST});var e=this._checkImageType(s.file);if(!0!==e)return e;e=this._checkImageSize(s.file);if(!0!==e)return e;let i=null;return this._setUploadFileType(Yi),this.uploadByCOS(s).then(e=>{if(i=e,this.isPrivateNetWork())return ut(t);if(be(i.imageInfoArray)){const s=i.imageInfoArray.find(e=>3===e.type);if(s)return s}if(F)return{width:s.file.width,height:s.file.height};let t=et(e.location);return ut(t=this.COSSDK?t:Mi(t,this._fileDownloadProxy,this._authKey,this._fileDNList))}).then(e=>(i.width=e.width,i.height=e.height,Promise.resolve(i)))}_checkImageType(e){let t="";return t=k?e.url.slice(e.url.lastIndexOf(".")+1):F?e.type.split("/")[1]:e.files[0].name.slice(e.files[0].name.lastIndexOf(".")+1),0<=Hi.indexOf(t.toLowerCase())||Qs({code:js.MSG_I_TYPES_LIMIT})}_checkImageSize(e){return 0===(e=(k||F?e:e.files[0]).size)?Qs({code:js.MSG_F_IS_EMPTY}):e<this.UPLOAD_SIZE_LIMIT.I||this._checkSizeError("I")}doUploadFile(e){let t=null;return!e.file||this._isEmptyFileList(e.file.files)?(t={code:js.MSG_F_SELECT_F_FIRST},Qs(t)):e.file.files[0].size>this.UPLOAD_SIZE_LIMIT.F?this._checkSizeError("F"):0===e.file.files[0].size?(t={code:js.MSG_F_IS_EMPTY},Qs(t)):(this._setUploadFileType(Ji),this.uploadByCOS(e))}doUploadVideo(e){return e.file.videoFile.size>this.UPLOAD_SIZE_LIMIT.V?this._checkSizeError("V"):0===e.file.videoFile.size?Qs({code:js.MSG_F_IS_EMPTY}):-1===Wi.indexOf(e.file.videoFile.type)?Qs({code:js.MSG_V_TYPES_LIMIT}):(this._setUploadFileType(zi),k||F?this.handleVideoUpload({...e,file:e.file.videoFile}):b?this.handleVideoUpload(e):void 0)}handleVideoUpload(s){return new Promise((t,e)=>{this.uploadByCOS(s).then(e=>{t(e)}).catch(()=>{this.uploadByCOS(s).then(e=>{t(e)}).catch(()=>{e(new zs({code:js.MSG_V_UPLOAD_FAIL}))})})})}doUploadAudio(e){return e.file?e.file.size>this.UPLOAD_SIZE_LIMIT.A?this._checkSizeError("A"):0===e.file.size?Qs({code:js.MSG_F_IS_EMPTY}):(this._setUploadFileType(ji),this.uploadByCOS(e)):Qs({code:js.MSG_A_UPLOAD_FAIL})}uploadByCOS(t){if(!xe(this._cosUploadMethod))return this.warn("PluginUndetected"),Qs({code:js.COS_UNDETECTED});if(this.timUploadPlugin)return this._uploadWithPreSigUrl(t);const l=new mi("upload"),d=this._n+".uploadByCOS",_=Date.now(),u=this._getFile(t);return new Promise((r,a)=>{const e=k?this._createCosOptionsWXMiniApp(t):this._createCosOptionsWeb(t),c=this;this._cosUploadMethod(e,(e,t)=>{const s=Object.create(null);if(t){if(e||be(t.files)&&t.files[0].error){const e=new zs({code:js.MSG_F_UPLOAD_FAIL});return l.setError(e).end(),Ce.l(d+" failed. error:",t.files[0].error),403===t.files[0].error.statusCode&&this._getAuthorizationKey(),void a(e)}s.fileName=u.name,s.fileSize=u.size,s.fileType=u.type.slice(u.type.indexOf("/")+1).toLowerCase(),s.location=(k?t:t.files[0].data).Location;const i=Date.now()-_,o=`size:${c._formatFileSize(u.size)} time:${i}ms speed:`+c._formatSpeed(1e3*u.size/i),n=(Ce.l(d+` success. name:${u.name} `+o),r(s),this.get(ks));return n.addCost(ci,i),n.addFileSize(ci,u.size),void l.setMessage(o).end()}const i=new zs({code:js.MSG_F_UPLOAD_FAIL});l.setError(i).end(),Ce.w(d+" failed. error:",e),403===e.statusCode&&this._getAuthorizationKey(),a(i)})})}_uploadWithPreSigUrl(e){const g=this._n+"._uploadWithPreSigUrl",m=this._getFile(e);return this._createCosOptionsPreSigUrl(e).then(p=>new Promise((c,l)=>{const d=new mi("upload"),{requestSnapshotUrl:_,...u}=p,h=Date.now();this._cosUploadMethod(u,(e,t)=>{if(e||403===t.statusCode){d.setError(new zs(e)).end();const m={HttpStatusCode:Pn,CostTime:St(h,!1),error:e,url:p.url};return t.data&&t.data.uploadIP&&(m.uploadIP=t.data.uploadIP),this._uploadSSOLog(m),Ce.l(g+" failed, error:",e),void l(new zs({code:js.MSG_F_UPLOAD_FAIL}))}const s=Object.create(null);let i=t.data.location||"";this.isPrivateNetWork()||0!==i.indexOf("https://")&&0!==i.indexOf("http://")||(i=i.split("//")[1]),s.fileName=m.name,s.fileSize=m.size,s.fileType=m.type.slice(m.type.indexOf("/")+1).toLowerCase(),s.location=i;var e=St(h,!1),o=`size:${this._formatFileSize(m.size)} time:${e}ms speed:${this._formatSpeed(1e3*m.size/e)} res:`+JSON.stringify(t.data);Ce.l(g+` ok. name:${m.name} `+o),d.setMessage(o).end();const n={HttpStatusCode:t.statusCode,FileSize:m.size,CostTime:e,url:p.url},r=(t.data&&t.data.uploadIP&&(n.uploadIP=t.data.uploadIP),this._uploadSSOLog(n),this.get(ks)),a=(r.addCost(ci,e),r.addFileSize(ci,m.size),[]);if(u.thumbUrl&&u.largeUrl&&a.push(this._getSmallImageInfoByUrl(u.thumbUrl,s),this._getLargeImageInfoByUrl(u.largeUrl,s)),this.uploadFileType===Yi&&this.isSimpleCos&&!this.isPrivateNetWork()&&(a.push(this._getImageInfoArray(u.downloadUrl,s)),t.data.uploadIP&&a.push(this._getDownloadIP(u.downloadUrl.split("//")[1].split("/")[0],s))),_&&a.push(this._getSnapshotInfoByUrl(_,s)),0<a.length)return Promise.all(a).then(()=>{c(s)});c(s)})}))}_getDownloadIP(e,s){const i=this._n+"._getDownloadIP",o=Date.now();return this.req({P:ti.GET_IP,data:{domainName:e}}).then(e=>{if(e.data&&e.data.ip){Ce.l(i+` ok. downloadIP:${e.data.ip} cost:`+St(o));const t=s.location.split("/");t[0]=e.data.ip,s.location=t.join("/")}}).catch(e=>{})}_getImageInfoArray(t,s){const i=this._n+"._getImageInfoArray",o=Date.now();return this.req({P:ti.GET_IMAGE_INFO,data:{imageUrl:t}}).then(e=>{e=e.data||{};return Ce.l(i+` ok. data: ${JSON.stringify(e)} cost:`+St(o)),s.imageInfoArray=e.imageInfoArray,e}).catch(e=>{s.imageInfoArray=void 0,this._uploadSSOLog({HttpStatusCode:Un,CostTime:St(o,!1),url:t})})}_uploadSSOLog(t){if(this.isSimpleCos){const s=new mi;s.setEventType(18),t.error&&s.setError(new zs(t.error));let e=`HttpStatusCode:${t.HttpStatusCode}|CosRequestId:${t.CosRequestId||""}|FileAlreadyExist:${t.FileAlreadyExist||0}|FileSize:${t.FileSize||0}|CostTime:`+t.CostTime;t.uploadIP&&(e+="|FinalIP:"+t.uploadIP),s.setMessage("OK").setMoreMessage(t.url).setExtension(e).end()}}_getRawOrUploadProxyUrl(e){var t=this.get(vs).getFileUploadProxy();let s=e;return s=t?e.replace(/^https:\/\/[^/]+/,t):s}_getFile(e){return be(e.file.files)||Be(e.file.files)?e.file.files[0]:e.file}_formatFileSize(e){return e<1024?e+"B":e<1048576?Math.floor(e/1024)+"KB":Math.floor(e/1048576)+"MB"}_formatSpeed(e){return e<=1048576?ft(e/1024,1)+"KB/s":ft(e/1048576,1)+"MB/s"}_createCosOptionsWeb(t){const e=this._getFile(t),s=e.name,i=s.slice(s.lastIndexOf(".")),o=this._genFileName(""+je(999999)+i);return{files:[{Bucket:this.bucketName+"-"+this.appid,Region:this.region,Key:this.directory+"/"+o,Body:e}],SliceSize:1048576,onProgress:e=>{if("function"==typeof t.onProgress)try{t.onProgress(e.percent)}catch(e){Ce.w("onProgress callback error:",e)}},onFileFinish:(e,t,s)=>{}}}_createCosOptionsWXMiniApp(t){var e=this._getFile(t),s=this._genFileName(e.name),e=e.url;return{Bucket:this.bucketName+"-"+this.appid,Region:this.region,Key:this.directory+"/"+s,FilePath:e,onProgress:e=>{if(Ce.l(JSON.stringify(e)),"function"==typeof t.onProgress)try{t.onProgress(e.percent)}catch(e){Ce.w("onProgress callback error:",e)}}}}_createCosOptionsPreSigUrl(a){let c="",l="",e=0;var s=this._getFile(a);if(k||F){if(a.message.type===t.MSG_FILE){const a=s.name,t=a.slice(a.lastIndexOf("."));c=this._genFileName(""+je(999999)+t)}else c=this._genFileName(s.name);l=s.url,e=1}else{const a=s.name,t=a.slice(a.lastIndexOf("."));c=this._genFileName(""+je(999999)+t),l=s,e=0}return this._getCosPreSigUrl({fileType:this.uploadFileType,fileName:c,uploadMethod:e,duration:this.duration,userID:a.message.from,conversationType:rt(a.message.conversationID)?1:2}).then(e=>{var{uploadUrl:t,downloadUrl:s,requestSnapshotUrl:i,thumbUrl:o,largeUrl:n,fileKey:r}=this.isSimpleCos?e.preSig[0]:e,{uploadIP:e=""}=e;return{url:this._getRawOrUploadProxyUrl(t),fileType:this.uploadFileType,fileName:c,resources:l,downloadUrl:s,requestSnapshotUrl:i,thumbUrl:o,largeUrl:n,fileKey:r,uploadIP:!this.isPrivateNetWork()&&e,onProgress:e=>{if("function"==typeof a.onProgress)try{a.onProgress(e.percent)}catch(e){Ce.w("onProgress callback error:",e),Ce.e(e)}}}})}_genFileName(e){return dt()+"-"+e}_setUploadFileType(e){this.uploadFileType=e}_getSnapshotInfoByUrl(e,s){const i="_getSnapshotInfoByUrl",o=new mi(i);return this.req({P:ti.VIDEO_COVER,data:{platform:this.getPlatform(),coverName:this._genFileName(je(99999)),requestSnapshotUrl:e}}).then(e=>{e=(e.data||{}).snapshotUrl;if(Ce.l(`${this._n}.${i} ok. snapshotUrl:`+e),o.setMessage("snapshotUrl:"+e).end(),Oe(e))return{};const t=Mi(e,this._fileDownloadProxy,this._authKey,this._fileDNList);return ut(t).then(e=>{s.snapshotInfo={snapshotUrl:t,snapshotWidth:e.width,snapshotHeight:e.height}})}).catch(e=>(Ce.w(`${this._n}.${i} failed. error:`,e),o.setCode(e.errorCode).setMessage(e.errorInfo).end(),{}))}_getSmallImageInfoByUrl(t,s){return ut(Mi(t,this._fileDownloadProxy,this._authKey,this._fileDNList)).then(e=>{s.smallImageUrl=t,s.smallImageWidth=e.width,s.smallImageHeight=e.height})}_getLargeImageInfoByUrl(t,s){return ut(Mi(t,this._fileDownloadProxy,this._authKey,this._fileDNList)).then(e=>{s.largeImageUrl=t,s.largeImageWidth=e.width,s.largeImageHeight=e.height})}_isEmptyFileList(e){return!(!Be(e)||0!==e.length)}reset(){Ce.l(this._n+".reset")}}class kn{constructor(e){this._n="MergerMessageHandler",this._msgM=e}uploadMergerMessage(e,s){const i=this._n+".uploadMergerMessage",t=(Ce.d(i+" message:",e,"messageBytes:"+s),JSON.parse(JSON.stringify(e.payload)))["messageList"],o=t.length,n=this._msgM.get(Rs).getFileDNList(),r=new mi("uploadMergerMessage");return t.forEach(e=>{Ii(e.messageBody[0].type,e.messageBody,n)}),this._msgM.req({P:ti.UPLOAD_MERGER_MSG,data:{messageList:t}}).then(e=>{Ce.d(i+" ok. response:",e.data);var{pbDownloadKey:e,downloadKey:t}=e.data,e={pbDownloadKey:e,downloadKey:t,messageNumber:o};return r.setMessage(o+`-${s}-`+t).end(),e}).catch(e=>{throw Ce.w(i+" failed. error:",e),r.setError(e).end(),e})}downloadMergerMessage(o){const n=this._n+".downloadMergerMessage",t=(Ce.d(n+" message:",o),o.payload)["downloadKey"],r=this._msgM.getFileDownloadProxy(),a=this._msgM.getDowloadFileAuthKey(),c=new mi("downloadMergerMessage");return c.setMessage("downloadKey:"+t),this._msgM.req({P:ti.DOWNLOAD_MERGER_MSG,data:{downloadKey:t}}).then(e=>{Ce.d(n+" ok. response:",e.data);const t=this._msgM.get(Rs).getFileDNList();if(xe(o.clearElement)){const{downloadKey:n,pbDownloadKey:c,messageList:s,...i}=o.payload;o.clearElement(),o.setElement({type:o.type,content:{messageList:e.data.messageList,...i}},r,a,t)}else{const n=[];e.data.messageList.forEach(e=>{Oe(e)||(e=new Ui(e,r,a,t),n.push(e))}),o.payload.messageList=n,o.payload.downloadKey="",o.payload.pbDownloadKey=""}return c.end(),o}).catch(e=>{throw Ce.w(`${n} failed. key:${t} error:`,e),c.setError(e).end(),e})}createMergerMessagePack(e,s,i){return e.conversationType===t.CONV_C2C?this._createC2CMergerMessagePack(e,s,i):this._createGroupMergerMessagePack(e,s,i)}_createC2CMergerMessagePack(e,t,s){let i=null;t&&(t.offlinePushInfo&&(i=t.offlinePushInfo),!0===t.onlineUserOnly&&(i?i.disablePush=!0:i={disablePush:!0}));const o=[];if(Fe(t)&&Fe(t.messageControlInfo)){const{excludedFromUnreadCount:e,excludedFromLastMessage:s,excludedFromContentModeration:i}=t.messageControlInfo;!0===e&&o.push("NoUnread"),!0===s&&o.push("NoLastMsg"),!0===i&&o.push("NoMsgCheck")}let n="";ke(e.cloudCustomData)&&0<e.cloudCustomData.length&&(n=e.cloudCustomData);const{pbDownloadKey:r,downloadKey:a,messageNumber:d}=s,{title:_,abstractList:u,compatibleText:h}=e.payload,c=this._msgM.get(Ms),l=c&&c.isOnlineMessage(e,t)?0:void 0;return{P:ti.SEND_C2C_MSG,data:{fromAccount:this._msgM.getMyUserID(),toAccount:e.to,msgBody:[{msgType:e.type,msgContent:{pbDownloadKey:r,downloadKey:a,title:_,abstractList:u,compatibleText:h,messageNumber:d}}],cloudCustomData:n,clientTime:e.clientTime,msgSeq:e.sequence,msgRandom:e.random,msgLifeTime:l,offlinePushInfo:qi(i),messageControlInfo:0!==l?o:void 0,isSupportExtension:!0===e.isSupportExtension?1:0,isRelayMessage:!0===e._relayFlag?1:0}}}_createGroupMergerMessagePack(e,t,s){let i=null;t&&t.offlinePushInfo&&(i=t.offlinePushInfo);const o=[];if(Fe(t)&&Fe(t.messageControlInfo)){const{excludedFromUnreadCount:e,excludedFromLastMessage:s,excludedFromContentModeration:i}=t.messageControlInfo;!0===e&&o.push("NoUnread"),!0===s&&o.push("NoLastMsg"),!0===i&&o.push("NoMsgCheck")}let n="";ke(e.cloudCustomData)&&0<e.cloudCustomData.length&&(n=e.cloudCustomData);const{pbDownloadKey:r,downloadKey:a,messageNumber:d}=s,{title:_,abstractList:u,compatibleText:h}=e.payload,c=this._msgM.get(Is),l=c&&c.isOnlineMessage(e,t)?1:0;return{P:ti.SEND_GRP_MSG,data:{fromAccount:this._msgM.getMyUserID(),groupID:e.to,msgBody:[{msgType:e.type,msgContent:{pbDownloadKey:r,downloadKey:a,title:_,abstractList:u,compatibleText:h,messageNumber:d}}],random:e.random,priority:e.priority,clientSequence:e.clientSequence,groupAtInfo:void 0,cloudCustomData:n,onlineOnlyFlag:l,offlinePushInfo:qi(i),clientTime:e.clientTime,needReadReceipt:!0!==e.needReadReceipt||c.isMessageFromOrToAVChatroom(e.to)?0:1,messageControlInfo:0==l?o:void 0,isSupportExtension:!0===e.isSupportExtension?1:0,isRelayMessage:!0===e._relayFlag?1:0}}}}const wn={ERR_SVR_COMM_SENSITIVE_TEXT:80001,ERR_SVR_COMM_BODY_SIZE_LIMIT:80002,OPEN_SERVICE_OVERLOAD_ERROR:60022,ERR_SVR_MSG_PKG_PARSE_FAILED:20001,ERR_SVR_MSG_INTERNAL_AUTH_FAILED:20002,ERR_SVR_MSG_INVALID_ID:20003,ERR_SVR_MSG_PUSH_DENY:20006,ERR_SVR_MSG_IN_PEER_BLACKLIST:20007,ERR_SVR_MSG_BOTH_NOT_FRIEND:20009,ERR_SVR_MSG_NOT_PEER_FRIEND:20010,ERR_SVR_MSG_NOT_SELF_FRIEND:20011,ERR_SVR_MSG_SHUTUP_DENY:20012,ERR_SVR_GROUP_INVALID_PARAMETERS:10004,ERR_SVR_GROUP_PERMISSION_DENY:10007,ERR_SVR_GROUP_NOT_FOUND:10010,ERR_SVR_GROUP_INVALID_GROUPID:10015,ERR_SVR_GROUP_REJECT_FROM_THIRDPARTY:10016,ERR_SVR_GROUP_SHUTUP_DENY:10017,MSG_SEND_FAIL:2100,OVER_FREQUENCY_LIMIT:2996},Fn=[js.MSG_ONPROGRESS_ERR,js.MSG_I_SELECT_F_FIRST,js.MSG_I_TYPES_LIMIT,js.MSG_F_IS_EMPTY,js.MSG_I_SIZE_LIMIT,js.MSG_F_SELECT_F_FIRST,js.MSG_F_SIZE_LIMIT,js.MSG_V_SIZE_LIMIT,js.MSG_V_TYPES_LIMIT,js.MSG_A_UPLOAD_FAIL,js.MSG_A_SIZE_LIMIT,js.COS_UNDETECTED];function bn(e){let t=!1;return Object.values(wn).includes(e)&&(t=!0),t=120001<=e&&e<=13e4||10100<=e&&e<=10200?!0:t}class $n extends ei{constructor(e){super(e),this._n="MessageModule",this._messageOptionsMap=new Map,this._mergerMessageHandler=new kn(this)}createTextMessage(e){var t=this.getMyUserID();e.currentUser=t,e.senderTinyID=this.getMyTinyID();const s=new wi(e),i=ke(e.payload)?e.payload:e.payload.text,o=new fi({text:i}),n=this._getNickAndAvatarByUserID(t);return s.setElement(o),s.setNickAndAvatar(n),s.setNameCard(this._getNameCardByGroupID(s)),s}createImageMessage(e){const t=this.getMyUserID(),s=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),new wi(e));if(k){const t=e.payload["file"];if(Ue(t))return void this.warn("FileUnsupportedInMP","createImageMessage");const s=t.tempFiles[0].path||t.tempFiles[0].tempFilePath,i={url:s,name:s.slice(s.lastIndexOf("/")+1),size:t.tempFiles&&t.tempFiles[0].size||1,type:s.slice(s.lastIndexOf(".")+1).toLowerCase()};e.payload.file=i}else if(F){const t=e.payload["file"],s={url:t.uri,name:t.fileName,size:t.fileSize||1,type:t.type,width:t.width,height:t.height};e.payload.file=s}else if(b)if(Ue(e.payload.file)){const t=e.payload.file;e.payload.file={files:[t]}}else if(Fe(e.payload.file)&&"undefined"!=typeof uni){const t=e.payload.file.tempFiles[0];e.payload.file={files:[t]}}const i=new yi({imageFormat:Te.UNKNOWN,uuid:this._generateUUID(e.payload.file),file:e.payload.file}),o=this._getNickAndAvatarByUserID(t);return s.setElement(i),s.setNickAndAvatar(o),s.setNameCard(this._getNameCardByGroupID(s)),this._messageOptionsMap.set(s.clientSequence,e),s}createAudioMessage(e){const t=e.payload["file"];if(k){const s={url:t.tempFilePath,name:t.tempFilePath.slice(t.tempFilePath.lastIndexOf("/")+1),size:t.fileSize,second:parseInt(t.duration)/1e3,type:t.tempFilePath.slice(t.tempFilePath.lastIndexOf(".")+1).toLowerCase()};e.payload.file=s}if(F){const s={url:t.uri,name:t.uri.slice(t.uri.lastIndexOf("/")+1),size:t.fileSize||1,second:Math.floor(t.duration/1e3),type:t.uri.slice(t.uri.lastIndexOf(".")+1).toLowerCase()};e.payload.file=s}const s=this.getMyUserID(),i=(e.currentUser=s,e.senderTinyID=this.getMyTinyID(),new wi(e)),o=new Ei({second:Math.floor(t.duration/1e3),size:t.fileSize||t.size||1,url:t.tempFilePath,uuid:this._generateUUID(e.payload.file)}),n=this._getNickAndAvatarByUserID(s);return i.setElement(o),i.setNickAndAvatar(n),i.setNameCard(this._getNameCardByGroupID(i)),this._messageOptionsMap.set(i.clientSequence,e),i}createVideoMessage(t){const e=this.getMyUserID(),s=(t.currentUser=e,t.senderTinyID=this.getMyTinyID(),t.payload.file.thumbUrl="",t.payload.file.thumbSize=0,{});if(k){if(O)return void this.warn("VideoUnsupportedInAlipay");if(Ue(t.payload.file))return void this.warn("FileUnsupportedInMP","createVideoMessage");let e=t.payload["file"];be(e.tempFiles)&&(e=e.tempFiles[0]),s.url=e.tempFilePath,s.name=e.tempFilePath.slice(e.tempFilePath.lastIndexOf("/")+1),s.size=e.size||1,s.second=e.duration||0,s.type=e.tempFilePath.slice(e.tempFilePath.lastIndexOf(".")+1).toLowerCase()}else if(F){const e=t.payload["file"];s.url=e.uri,s.name=e.fileName,s.size=e.fileSize||1,s.second=e.duration||0,s.type=e.type.split("/")[1]}else if(b){if(Ue(t.payload.file)){const e=t.payload.file;t.payload.file.files=[e]}else if(Fe(t.payload.file)&&"undefined"!=typeof uni){const e=t.payload.file.tempFile;t.payload.file.files=[e]}const e=t.payload["file"];s.url=window.URL.createObjectURL(e.files[0]),s.name=e.files[0].name,s.size=e.files[0].size||1,s.second=e.files[0].duration||0,s.type=e.files[0].type.split("/")[1]}t.payload.file.videoFile=s;const i=new wi(t),o=new Ni({videoFormat:s.type,videoSecond:ft(s.second,0),videoSize:s.size,remoteVideoUrl:"",videoUrl:s.url,videoUUID:this._generateUUID(t.payload.file.videoFile),thumbUUID:this._generateUUID(t.payload.file.videoFile),thumbWidth:t.payload.file.width||200,thumbHeight:t.payload.file.height||200,thumbUrl:t.payload.file.thumbUrl,thumbSize:t.payload.file.thumbSize,thumbFormat:t.payload.file.thumbUrl.slice(t.payload.file.thumbUrl.lastIndexOf(".")+1).toLowerCase()}),n=this._getNickAndAvatarByUserID(e);return i.setElement(o),i.setNickAndAvatar(n),i.setNameCard(this._getNameCardByGroupID(i)),this._messageOptionsMap.set(i.clientSequence,t),i}createCustomMessage(e){var t=this.getMyUserID();e.currentUser=t,e.senderTinyID=this.getMyTinyID();const s=new wi(e),i=new Oi({data:e.payload.data,description:e.payload.description,extension:e.payload.extension}),o=this._getNickAndAvatarByUserID(t);return s.setElement(i),s.setNickAndAvatar(o),s.setNameCard(this._getNameCardByGroupID(s)),s}createFaceMessage(e){var t=this.getMyUserID();e.currentUser=t,e.senderTinyID=this.getMyTinyID();const s=new wi(e),i=new vi(e.payload),o=this._getNickAndAvatarByUserID(t);return s.setElement(i),s.setNickAndAvatar(o),s.setNameCard(this._getNameCardByGroupID(s)),s}createMergerMessage(e){var t=this.getMyUserID();e.currentUser=t,e.senderTinyID=this.getMyTinyID();const s=this._getNickAndAvatarByUserID(t),i=new wi(e),o=new Gi(e.payload);return i.setElement(o),i.setNickAndAvatar(s),i.setNameCard(this._getNameCardByGroupID(i)),i.setRelayFlag(!0),i}createForwardMessage(e){var{to:s,conversationType:i,priority:o,payload:n,needReadReceipt:r,receiverList:a}=e;if(!be(n._elements))return Qs({code:js.MSG_FORWARD_INVALID_ELEMENTS});var c=this.getMyUserID(),l=this._getNickAndAvatarByUserID(c);if(n.type===t.MSG_GRP_TIP)return Qs({code:js.MSG_FORWARD_TYPE_INVALID});const _={to:s,conversationType:i,conversationID:""+i+s,priority:o,isPlaceMessage:0,status:At,currentUser:c,senderTinyID:this.getMyTinyID(),cloudCustomData:e.cloudCustomData||n.cloudCustomData||"",needReadReceipt:r,receiverList:a,isSupportExtension:e.isSupportExtension||!1},d=new wi(_);return d.setElement(n._elements[0]),d.setNickAndAvatar(l),d.setNameCard(this._getNameCardByGroupID(n)),d.setRelayFlag(!0),d}downloadMergerMessage(e){return this._mergerMessageHandler.downloadMergerMessage(e)}createFileMessage(t){if(k){if(!S&&!R&&!P)return;let e;const s=$.getSystemInfoSync().SDKVersion;if(S&&ht(s,e="2.5.0")<0)return void this.warn("WXChooseMessageFile");if(R&&ht(s,e="1.18.0")<0)return void this.warn("QQChooseMessageFile")}if(b||P){if(Ue(t.payload.file)){const s=t.payload.file;t.payload.file={files:[s]}}else if(Fe(t.payload.file)&&"undefined"!=typeof uni){const{tempFiles:s,files:i}=t.payload.file;let e=null;be(s)?e=s[0]:be(i)&&(e=i[0]),t.payload.file={files:[e]}}}else if(S||R){const s=t.payload.file["tempFiles"],i={...s[0],url:s[0].path};t.payload.file={files:[i]}}else if(F){const s=t.payload["file"],i={...s,url:s.uri};t.payload.file={files:[i]}}const s=this.getMyUserID(),i=(t.currentUser=s,t.senderTinyID=this.getMyTinyID(),new wi(t)),e=new Ai({uuid:this._generateUUID(t.payload.file),file:t.payload.file}),o=this._getNickAndAvatarByUserID(s);return i.setElement(e),i.setNickAndAvatar(o),i.setNameCard(this._getNameCardByGroupID(i)),this._messageOptionsMap.set(i.clientSequence,t),i}createLocationMessage(e){var t=this.getMyUserID();e.currentUser=t,e.senderTinyID=this.getMyTinyID();const s=new wi(e),i=new Pi(e.payload),o=this._getNickAndAvatarByUserID(t);return s.setElement(i),s.setNickAndAvatar(o),s.setNameCard(this._getNameCardByGroupID(s)),s}_onNoModule(){return Qs({code:js.NO_MODULE})}sendMessageInstance(r,a){if(!1===this.get(bs).filterMessage(r,a))return r.hasRiskContent=!0,this._onSendMessageFailed(r,new zs({code:js.PROFANITY_FOUND}));let s=null;if(r.conversationType===t.CONV_C2C)s=this.get(Ms);else{if(r.conversationType!==t.CONV_GROUP)return Qs({code:js.MSG_INVALID_CONV_TYPE});s=this.get(Is)}if(!s)return this._onNoModule();const c=this._n+".sendMessageInstance",l=this.get(ys),d=s.isOnlineMessage(r,a);let _;return this.get(Rs).upload(r).then(()=>(this._getSendMessageSpecifiedKey(r)===ai&&this.get(ks).addSuccessCount(ci),this._guardForGroup(r).then(()=>{if(!r.isSendable())return Qs({code:js.MSG_F_URL_IS_EMPTY});this._addSendMessageTotalCount(r),_=Date.now();var e=function(t){let e="utf-8";b&&document&&(e=document.charset.toLowerCase());let s,i=0,o;if(o=t.length,"utf-8"===e||"utf8"===e)for(let e=0;e<o;e++)(s=t.codePointAt(e))<=127?i+=1:s<=2047?i+=2:s<=65535?i+=3:(i+=4,e++);else if("utf-16"===e||"utf16"===e)for(let e=0;e<o;e++)(s=t.codePointAt(e))<=65535?i+=2:(i+=4,e++);else i=t.replace(/[^\x00-\xff]/g,"aa").length;return i}(JSON.stringify(r));return r.type===t.MSG_MERGER&&11264<e?this._mergerMessageHandler.uploadMergerMessage(r,e).then(e=>{e=this._mergerMessageHandler.createMergerMessagePack(r,a,e);return this.req(e)}):(l.setMessageRandom(r),s.sendMessage(r,a))}).then(e=>{var{time:e,sequence:s,readReceiptCode:i,messageDropReason:o}=e.data;if(Ge(i)&&0!==i&&(new mi("sendMessageWithReceipt").setMessage(`from:${r.from} to:${r.to} sequence:${s} readReceiptCode:`+i).end(),Ce.w(c+` readReceiptCode:${i} message:`+this.getErrMsg(i))),o){const t=new mi("messageDropReason"),a=`from:${r.from} to:${r.to} sequence:${s} messageDropReason:`+o;t.setMessage(a).end(),Ce.w(c+" "+a)}if(this._addSendMessageSuccessCount(r,_),this._messageOptionsMap.delete(r.clientSequence),!0===r.isResend){const t=l.findMessage(r.ID);t&&(Ce.l(c+" resend ok. ID:"+t.ID),l.deleteLocalMessage(t))}r.status=Ot,r.time=e;let n=!1;if(r.conversationType===t.CONV_GROUP)r.sequence=s;else if(r.conversationType===t.CONV_C2C){const t=l.getLatestMessageSentByMe(r.conversationID);if(t){const{nick:a,avatar:e}=t;a===r.nick&&e===r.avatar||(n=!0)}}if(n&&l.modifyMessageSentByMe({conversationID:r.conversationID,latestNick:r.nick,latestAvatar:r.avatar}),!0===d)r._onlineOnlyFlag=!0;else{l.appendToMessageList(r);let e=r,s=(Fe(a)&&Fe(a.messageControlInfo)&&(!0===a.messageControlInfo.excludedFromLastMessage&&(r._isExcludedFromLastMessage=!0,e=""),!0===a.messageControlInfo.excludedFromUnreadCount&&(r._isExcludedFromUnreadCount=!0)),r.conversationType);ot(r.to)&&(s=t.CONV_TOPIC,this.get(Ts).onMessageSent({groupID:Ct(r.to),topicID:r.to,lastMessage:e})),l.onMessageSent({conversationOptionsList:[{conversationID:r.conversationID,unreadCount:0,type:s,subType:r.conversationSubType,lastMessage:e}]})}return r._relayFlag||"TIMImageElem"!==r.type||gt(r.payload.imageInfoArray),Ys({message:r})}))).catch(e=>this._onSendMessageFailed(r,e,d))}_guardForGroup(e){if(e.conversationType!==t.CONV_GROUP)return Promise.resolve();const s=this.get(Is);if(!s)return this._onNoModule();if(nt({groupID:e.to})){const t=s.getLocalGroupProfile(e.to);if(t&&t.isSupportTopic)return Qs({code:js.MSG_SEND_GRP_WITH_TOPIC_FAIL})}return s.guardForAVChatRoom(e)}_onSendMessageFailed(e,t,s=!1){var i=this._n+"._onSendMessageFailed";e.status=Nt,80001!==t.code&&80004!==t.code||(e.hasRiskContent=!0);const o=this.get(ys);o.deleteMessageRandom(e);var n=10100<=t.code&&t.code<=10200||120001<=t.code&&t.code<=13e4;s||n||!0===o.appendToMessageList(e)&&Ce.l(i+" message stored, ID:"+e.ID),this._addSendMessageFailCountOnUser(e,t);const r=new mi("sendMessage");let a=`head.seq:${t.data.headSeq} type:${e.type} from:${e.from} to:`+e.to;if(b){if("connection"in navigator){const e=navigator.connection;a+=` downlink:${e.downlink} effectiveType:${e.effectiveType} rtt:`+e.rtt}if("memory"in window.performance){const e=window.performance.memory;a+=` usedJSHeapSize:${e.usedJSHeapSize} totalJSHeapSize:${e.totalJSHeapSize} jsHeapSizeLimit:`+e.jsHeapSizeLimit}}return r.setMessage(a).setError(t).end(),Ce.e(i+` ${a} error:`,t),Qs(new zs({code:t&&t.code?t.code:js.MSG_SEND_FAIL,message:t&&t.message?t.message:void 0,data:{message:e}}))}_getSendMessageSpecifiedKey(e){if([t.MSG_IMAGE,t.MSG_AUDIO,t.MSG_VIDEO,t.MSG_FILE].includes(e.type))return ai;if(e.conversationType===t.CONV_C2C)return ni;if(e.conversationType===t.CONV_GROUP){const t=this.get(Is);if(t){var e=t.getLocalGroupProfile(e.to);if(e)return e=e.type,it(e)?ri:oi}}}_addSendMessageTotalCount(e){e=this._getSendMessageSpecifiedKey(e);e&&this.get(ks).addTotalCount(e)}_addSendMessageSuccessCount(e,t){var s=this._getSendMessageSpecifiedKey(e);if(s){const e=this.get(ks);e.addSuccessCount(s),e.addCost(s,St(t,!1))}}_addSendMessageFailCountOnUser(e,t){const{code:s=-1}=t,i=this.get(ks),o=this._getSendMessageSpecifiedKey(e);o===ai&&function(e){let t=!1;return t=Fn.includes(e)?!0:t}(s)?i.addFailedCountOfUserSide(ci):bn(s)&&o&&i.addFailedCountOfUserSide(o)}resendMessage(e,t){return e.isResend=!0,e.status=At,this.sendMessageInstance(e,t)}revokeMessage(s){let e=null;if(s.conversationType===t.CONV_C2C?e=this.get(Ms):s.conversationType===t.CONV_GROUP&&(e=this.get(Is)),!e)return this._onNoModule();const i=new mi("revokeMessage"),o=(i.setMessage(`type:${s.type} from:${s.from} to:`+s.to),this._n+".revokeMessage");return e.revokeMessage(s).then(e=>{var t=e.data.recallRetList;if(Oe(t)||0===t[0].retCode)return Ce.i(o+" ok. ID:"+s.ID),s.isRevoked=!0,i.end(),this.get(ys).onMessageRevoked([s]),Ys({message:s});{const e=new zs({code:t[0].retCode,data:{message:s}});return i.setCode(e.code).setMoreMessage(e.message).end(),Qs(e)}}).catch(e=>{i.setError(e).end();var t=new zs({code:e&&e.code?e.code:js.MSG_REVOKE_FAIL,message:e&&e.message?e.message:void 0,data:{message:s}});return Ce.w(o+" failed. error:",e),Qs(t)})}deleteMessage(e){let s=null;const i=e[0],o=i.conversationID;let n="",r=[],a=[];if(i.conversationType===t.CONV_C2C)s=this.get(Ms),n=o.replace(t.CONV_C2C,""),e.forEach(e=>{e&&e.status===Ot&&e.conversationID===o&&(e._onlineOnlyFlag||r.push(`${e.sequence}_${e.random}_`+e.time),a.push(e))});else if(i.conversationType===t.CONV_GROUP)s=this.get(Is),n=o.replace(t.CONV_GROUP,""),e.forEach(e=>{e&&e.status===Ot&&e.conversationID===o&&(e._onlineOnlyFlag||r.push(""+e.sequence),a.push(e))});else if(i.conversationType===t.CONV_SYSTEM)return Qs({code:js.CANNOT_DELETE_GRP_SYSTEM_NOTICE});if(!s)return this._onNoModule();if(0===r.length)return this._onMessageDeleted(a);30<r.length&&(r=r.slice(0,30),a=a.slice(0,30));const c=new mi("deleteMessage"),l=(c.setMessage(`to:${n} count:`+r.length),this._n+".deleteMessage");return s.deleteMessage({to:n,keyList:r}).then(e=>(c.end(),Ce.i(l+" ok"),this._onMessageDeleted(a))).catch(e=>{c.setError(e).end(),Ce.w(l+" failed. error:",e);e=new zs({code:e&&e.code?e.code:js.MSG_DELETE_FAIL,message:e&&e.message?e.message:void 0});return Qs(e)})}_onMessageDeleted(e){return this.get(ys).onMessageDeleted(e),Zs({messageList:e})}translateText(e){const o=this._n+".translateText",{sourceTextList:t,sourceLanguage:s,targetLanguage:i}=e,n=new mi("translateText");return n.setMessage(`sourceLanguage:${s} targetLanguage:`+i),this.req({P:ti.TRANSLATE_TEXT,data:{sourceTextList:t,source:s||"auto",target:i,from:this.getMyTinyID(),SDKAppID:this.getSDKAppID()}}).then(e=>{var{error:e,requestID:t,translatedTextList:s}=e.data,i=e["code"];if(0===i)return n.end(),Ce.i(o+" ok. requestID:"+t),Ys({translatedTextList:s});throw{...e,requestID:t}}).catch(e=>(n.setCode(e.code).setMoreMessage(e.requestID).end(),Ce.w(o+" failed. error:",e),Qs({code:js.TRANSLATE_TEXT_FAIL})))}convertVoiceToText(e){var{message:e,language:t}=e;let s=e.payload.url;e.from===this.getMyUserID()&&"out"===e.flow&&(s=e.payload.remoteAudioUrl);const i=/\.(wav|pcm|ogg-opus|speex|silk|mp3|m4a|aac|amr)/;if(!i.test(s))return Qs({code:js.UNSUPPORTED_VOICE_FORMAT});e=i.exec(s)[1]||"mp3";let o="16k_zh-PY";t?"zh (cmn-Hans-CN)"===t?o="16k_zh":"en-US"===t?o="16k_en":"yue-Hant-HK"===t?o="16k_yue":"ja-JP"===t&&(o="16k_ja"):o="16k_zh-PY";const n=`serviceType:${o} url:`+s,r=this._n+".convertVoiceToText",a=(Ce.i(r+" "+n),new mi("convertVoiceToText"));return a.setMessage(n),this.req({P:ti.VOICE_TO_TEXT,data:{url:s,language:o,SDKAppID:this.getSDKAppID(),format:e}}).then(e=>{var{error:e,requestID:t,result:s}=e.data,i=e["code"];if(0===i)return a.end(),Ce.i(r+" ok. requestID:"+t),Ys({result:s});throw{...e,requestID:t}}).catch(e=>(a.setCode(e.code).setMoreMessage(e.requestID||"").end(),Ce.w(r+" failed. error:",e),Qs({code:js.VOICE_TO_TEXT_FAIL})))}modifyRemoteMessage(s){if(!1===this.get(bs).filterMessage(s))return s.hasRiskContent=!0,Qs({code:js.PROFANITY_FOUND,data:{message:s}});let e=null;var{conversationType:i,to:o}=s;if(i===t.CONV_C2C)e=this.get(Ms);else if(i===t.CONV_GROUP){if(!(e=this.get(Is)))return this._onNoModule();if(e.isMessageFromOrToAVChatroom(o))return Qs({code:js.MSG_MODIFY_DISABLED_IN_AV,data:{message:s}})}const n=new mi("modifyMessage"),r=(n.setMessage("to:"+o),this._n+".modifyRemoteMessage");return e.modifyRemoteMessage(s).then(e=>{n.end(),Ce.i(r+" ok");e=this._onModifyRemoteMessageResp(s,e.data);return Ys({message:e})}).catch(e=>{var t;return n.setCode(e.code).setMoreMessage(e.message).end(),Ce.w(r+" failed. error:",e),20027===e.code?(t=this._onModifyRemoteMessageResp(s,e.data),Qs({code:js.MSG_MODIFY_CONFLICT,data:{message:t}})):Qs({code:e.code,message:e.message,data:{message:s}})})}_generateSearchdata(e){const{conversationID:s,timePosition:i,timePeriod:o,...n}=e;return $e(s)||(rt(s)&&(n.account=s.replace(t.CONV_C2C,"")),at(s)&&(n.groupID=s.replace(t.CONV_GROUP,""))),Ge(o)&&0<o&&(Ge(i)&&0<i?n.startTime=i-o:n.startTime=me()-o),n.startTime&&n.startTime<0&&(n.startTime=void 0),Ge(i)&&0<i&&(n.endTime=i),n}searchCloudMessages(o){const e="searchCloudMessages",n=this._n+"."+e;if(!o)return Qs({code:js.OPTIONS_IS_EMPTY,message:this.getErrMsg(js.OPTIONS_IS_EMPTY,e)});var{keywordList:t,keywordListMatchType:s,conversationID:i,cursor:r}=o,a=be(o.senderUserIDList)&&0<o.senderUserIDList.length,d=be(o.messageTypeList)&&0<o.messageTypeList.length;if(!t&&!a&&!d)throw Ce.e(`[${e}] Missing required params: "keywordList".`),new Error("Params validate failed.");const _=Date.now(),c=new mi(e),l=`keywordList:${t} keywordListMatchType:${s} convID:${i} cursor:`+r;return Ce.l(n+" "+l),this.req({P:ti.MSG_CLOUD_SEARCH,data:this._generateSearchdata(o)}).then(t=>{var{code:s,message:i}=t.data;if(0!==s){let e=s;60020===s&&(e="SearchCloudMessagesUnavailable");const t=this.getErrMsg(e)||i,n=new zs({code:s,message:t});return c.setMessage(l).setError(n).end(),Qs(n)}this.get(ws).isSearchCloudMessagesEnabled();var{cursor:i,totalCount:s,searchResult:t}=t.data,e=`totalCount:${s} cost:`+St(_),e=(Ce.l(n+` ok. cursor:${i} `+e),c.setMessage(l+" "+e).end(),this._handleSearchResults(t,!o.conversationID));return Ys({searchResultList:e,cursor:i,totalCount:s})}).catch(e=>(c.setMessage(l).setError(e).end(),Qs(e)))}_handleSearchResults(e,a){const c=this.get(ys);return be(e)&&0!==e.length?e.map(({groupID:e,userID:s,messageCount:i,messageList:o=[]})=>{const n=e?""+t.CONV_GROUP+e:""+t.CONV_C2C+s,r={conversationID:n,messageCount:i,messageList:[]};if(a&&1<i)return r;s=o.filter(e=>!!e);if(0<s.length){const t=c.onRoamingMessage(s,n,!1);e&&t.reverse(),r.messageList=t,r.messageCount=t.length}return r}):[]}_onModifyRemoteMessageResp(e,t){Ce.d(this._n+"._onModifyRemoteMessageResp options:",t);var{conversationType:e,from:s,to:i,random:o,sequence:n,time:r}=e,{elements:t,messageVersion:a,cloudCustomData:c=""}=t;return this.get(ys).onMessageModified({conversationType:e,from:s,to:i,time:r,random:o,sequence:n,elements:t,cloudCustomData:c,messageVersion:a})}_generateUUID(e){const t=this.get(vs);let s=`${t.getSDKAppID()}-${t.getUserID()}-`+function(){let t="";for(let e=32;0<e;--e)t+=Je[Math.floor(Math.random()*Xe)];return t}();const i=e.name||e.value||e.url||e.tempFilePath,o=i&&i.slice(i.lastIndexOf(".")+1);return s=o?s+"."+o:s}getMessageOption(e){return this._messageOptionsMap.get(e)}_getNickAndAvatarByUserID(e){return this.get(fs).getNickAndAvatarByUserID(e)}_getNameCardByGroupID(e){if(e.conversationType===t.CONV_GROUP){const t=this.get(Is);if(t)return t.getMyNameCardByGroupID(e.to)}return""}reset(){Ce.l(this._n+".reset"),this._messageOptionsMap.clear()}}class qn extends ei{constructor(e){super(e),this._n="MsgExtModule",this.msgExtMap=new Map,this.globalSeqMap=new Map,this.getMsgExtsMap=new Map}onMsgExtNotify(t){const{messageInfo:s,operateType:i,operateResultList:o,tinyID:_,globalSequence:n}=t.dataList,{clientTime:u,random:h}=s,r=_+`-${u}-`+h,a=[],c=[];Ce.l(`${this._n}.onMsgExtNotify messageID:${r} operateType:${i} globalSequence:`+n),this._updateGlobalSeq(r,n);let l=!1,d=!1;o.forEach(e=>{const{extensions:t=[],clearSequence:s}=e;1===i?(l=!0,t.forEach(e=>{a.push({key:e.key,value:e.value})}),this._updateLocalExt(r,t)):2===i?(d=!0,t.forEach(e=>{c.push(e.key)}),this._updateLocalExt(r,t)):3===i&&(d=!0,this._hasLocalExt(r)&&this._getLocalExt(r).forEach((e,t)=>{e.seq<=s&&!Oe(e.value)&&c.push(t)}),this._clearLocalExt(r,s))}),l&&this.emitOEvt(e.MESSAGE_EXTENSIONS_UPDATED,{messageID:r,extensions:a}),d&&this.emitOEvt(e.MESSAGE_EXTENSIONS_DELETED,{messageID:r,keyList:c})}setMessageExtensions(e,t){var s="setMessageExtensions";if(!this.canIUse(M.MSG_EXT))return this.noUse(s);const i=this._n+"."+s,{ID:o,conversationID:n,sequence:r,time:d}=e;let a=[...t];20<t.length&&(a=t.slice(0,20),Ce.w(i+". the length of extensions cannot exceed 20."));const c=`convID:${n} messageID:${o} sequence:${r} time:${d} count:`+a.length,l=new mi(s);return l.setMessage(c),Ce.l(i+" "+c),this._modifyMsgExts(e,a).then(e=>{var{resultList:e,successCount:t,failureCount:s}=e,t=`successCount:${t} failCount:`+s;return l.setMoreMessage(t).end(),Ce.l(i+" ok. "+t),Ys({extensions:e})}).catch(e=>(l.setError(e).end(),Ce.e(i+" failed. error:",e),Qs(e)))}getMessageExtensions(e){var t="getMessageExtensions";if(!this.canIUse(M.MSG_EXT))return this.noUse(t);const s=this._n+"."+t,{ID:i,conversationID:o,sequence:n,time:r}=e,a=`convID:${o} messageID:${i} sequence:${n} time:`+r,c=new mi(t);c.setMessage(a),Ce.l(s+" "+a);let l=void 0;return this.getMsgExtsMap.has(i)&&(l=this._getGlobalSeq(i)),this._getMsgExts(e,l).then(e=>(c.end(),Ce.l(s+" ok. extCount:"+e.length),$e(l)&&0<e.length&&this.getMsgExtsMap.set(i,1),Ys({extensions:e}))).catch(e=>(c.setError(e).end(),Ce.e(s+" failed. error:",e),Qs(e)))}deleteMessageExtensions(e,t){var s="deleteMessageExtensions";if(!this.canIUse(M.MSG_EXT))return this.noUse(s);const o=this._n+"."+s,i=[];let n=3;Oe(t)||(n=2,t.forEach(e=>{i.push({key:e,value:"",seq:0})}));const{ID:r,conversationID:a,sequence:d,time:_}=e,c=`convID:${a} messageID:${r} sequence:${d} time:${_} operateType:`+n,l=new mi(s);return l.setMessage(c),Ce.l(o+" "+c),this._modifyMsgExts(e,i,n).then(e=>{var{resultList:e,successCount:t,failureCount:s}=e;let i="";return 2===n&&(i=`success count:${t} fail count:`+s),l.setMoreMessage(""+i).end(),Ce.l(o+" ok. "+i),Ys({extensions:e})}).catch(e=>(l.setError(e).end(),Ce.e(o+" failed. error:",e),Qs(e)))}_modifyMsgExts(i,e,s=1){var o=ot(i.to)?t.CONV_TOPIC:i.conversationType;let n=void 0,r=(3!==s&&(n=this._getReqExts(i,e)),null);switch(o){case t.CONV_C2C:r=this.get(Ms);break;case t.CONV_GROUP:r=this.get(Is);break;case t.CONV_TOPIC:r=this.get(Ts);break;default:return Qs({code:js.NO_MODULE})}return r.modifyMsgExts(i,n,s).then(e=>{let{extensions:t,seq:s}=e.data;const o=[];let n=0,r=0,a=[];return(t=Oe(t)?[]:t).forEach(e=>{var{errorCode:e,extension:t}=e,{key:t,value:s,seq:i}=t;o.push({code:e,key:t,value:s}),0===e?n++:r++,a.push({key:t,value:s,seq:i})}),this._updateGlobalSeq(i.ID,s),0<a.length&&(this._updateLocalExt(i.ID,a),a=null),{resultList:o,successCount:n,failureCount:r}}).catch(e=>Qs(e))}_getReqExts(e,t){const i=[];if(this._hasLocalExt(e.ID)){const o=this._getLocalExt(e.ID);return t.forEach(e=>{var{key:e,value:t}=e;let s=0;o.has(e)&&(s=o.get(e).seq),i.push({key:e,value:t,seq:s})}),i}return t.forEach(e=>{var{key:e,value:t}=e;i.push({key:e,value:t,seq:0})}),i}_getMsgExts(n,e){const r=this._n+"._getMsgExts",{ID:a,to:s}=n;let i=null;switch(ot(s)?t.CONV_TOPIC:n.conversationType){case t.CONV_C2C:i=this.get(Ms);break;case t.CONV_GROUP:i=this.get(Is);break;case t.CONV_TOPIC:i=this.get(Ts);break;default:return Qs({code:js.NO_MODULE})}return i.getMessageExtensions(n,e).then(e=>{let{extensions:t,completeFlag:s,globalSequence:i,clearSequence:o}=e.data;if(t=Oe(t)?[]:t,Ce.l(r+` ok. completeFlag:${s} globalSequence:${i} clearSequence:${o} count:`+t.length),this._updateLocalExt(a,t),this._clearLocalExt(a,o),this._updateGlobalSeq(a,i),1===s)return this._getLocalExtList(a);{const e=t.slice(-1)[0].seq+1;return this._getMsgExts(n,e)}}).catch(e=>Qs(e))}_hasLocalExt(e){return this.msgExtMap.has(e)}_getLocalExt(e){return this.msgExtMap.get(e)}_updateLocalExt(e,t){this._hasLocalExt(e)||this.msgExtMap.set(e,new Map);const i=this._getLocalExt(e);t.forEach(e=>{var{key:e,value:t="",seq:s}=e;i.set(e,{value:t,seq:s})})}_clearLocalExt(e,s){if(!(s<=0)&&this._hasLocalExt(e)){const i=this._getLocalExt(e);i.forEach((e,t)=>{e.seq<=s&&i.delete(t)})}}_getLocalExtList(e){const s=[];return this._hasLocalExt(e)&&this._getLocalExt(e).forEach((e,t)=>{e=e.value;Oe(e)||s.push({key:t,value:e})}),s}_getGlobalSeq(e){return this.globalSeqMap.get(e)}_updateGlobalSeq(e,t){this.globalSeqMap.set(e,t)}reset(){Ce.l(this._n+".reset"),this.msgExtMap.clear(),this.globalSeqMap.clear(),this.getMsgExtsMap.clear()}}class xn extends ei{constructor(e){super(e),this._n="MsgReactionModule",this._reactedByMyselfMap=new Map,this._reactionInfoMap=new Map}onReactionNotifyList(t){const{dataList:s=[]}=t||{};s.forEach(t=>{const{C2CMessageInfo:s={},groupMessageInfo:i={},reactionList:o=[]}=t,{tinyID:n,clientTime:r,random:a}={...s,...i},c=n+`-${r}-`+a,l=[];o.forEach(e=>{$e(e.userIDList)&&(e.userIDList=[],e.count=0),l.push(...e.userIDList)}),Ce.l(this._n+`.onReactionNotifyList messageID:${c} reactionList:`+o.length),this._handleReactionSummary([{messageID:c,reactionList:o}],l).then(t=>{this.emitOEvt(e.MESSAGE_REACTIONS_UPDATED,{...t[0]})})})}onReactionNotify(t){var{C2CMessageInfo:t={},groupMessageInfo:s={},reactionID:i,operateType:o}=t.dataList||{},{tinyID:t,clientTime:s,random:n}={...t,...s},s=t+`-${s}-`+n,n=(Ce.l(this._n+`.onReactionNotify messageID:${s} reactionID:${i} operateType:`+o),1===o?this._addReactedByMyselfMap(s,i):this._removeReactedByMyselfMap(s,i),s+"-"+i);if(this._reactionInfoMap.has(n)){const t=this._reactionInfoMap.get(n);t.reactedByMyself=1===o,this.emitOEvt(e.MESSAGE_REACTIONS_UPDATED,{messageID:s,reactionList:[t]})}}addMessageReaction(t,s){var e="addMessageReaction";if(!this.canIUse(M.MSG_REACTION))return this.noUse(e);const i=this._n+"."+e,{ID:o,conversationID:n}=t,r=`convID:${n} messageID:${o} reactionID:`+s,a=new mi(e);a.setMessage(r),Ce.l(i+" "+r);e=this._createReactionOperationPack(t,s,1);return this._addReactedByMyselfMap(t.ID,s),this.req(e).then(()=>(a.end(),Ce.l(i+" ok."),Ys())).catch(e=>(this._removeReactedByMyselfMap(t.ID,s),a.setError(e).end(),Ce.e(i+" failed. error:",e),Qs(e)))}removeMessageReaction(e,t){var s="removeMessageReaction";if(!this.canIUse(M.MSG_REACTION))return this.noUse(s);const i=this._n+"."+s,{ID:o,conversationID:n}=e,r=`convID:${n} messageID:${o} reactionID:`+t,a=new mi(s);a.setMessage(r),Ce.l(i+" "+r);s=this._createReactionOperationPack(e,t,2);return this._removeReactedByMyselfMap(e.ID,t),this.req(s).then(()=>(a.end(),Ce.l(i+" ok."),Ys())).catch(e=>(a.setError(e).end(),Ce.e(i+" failed. error:",e),Qs(e)))}getMessageReactions(e){var t="getMessageReactions";if(!this.canIUse(M.MSG_REACTION))return this.noUse(t);const s=this._n+"."+t,{messageList:i,maxUserCountPerReaction:o}=e,n=i[0]["conversationID"],r=`convID:${n} maxUserCountPerReaction:${o} msgCount:`+i.length,a=new mi(t),c=(a.setMessage(r),Ce.l(s+" "+r),new Map),l=this._createReactionSummaryPack({...e,messageIDMap:c});return this.req(l).then(e=>{const{resultList:t=[]}=e.data,n=[],r=[];return t.forEach(e=>{const{messageKey:t,messageSequence:s,reactionList:i=[]}=e,o=$e(t)?c.get(s):c.get(t);n.push({messageID:o,reactionList:i}),i.forEach(e=>{r.push(...e.userIDList)})}),this._handleReactionSummary(n,r)}).then(e=>(a.end(),Ce.l(s+" ok."),c.clear(),Ys({resultList:e}))).catch(e=>(a.setError(e).end(),Ce.e(s+" failed. error:",e),Qs(e)))}getAllUserListOfMessageReaction(e){var t="getAllUserListOfMessageReaction";if(!this.canIUse(M.MSG_REACTION))return this.noUse(t);const s=this._n+"."+t,{message:i,reactionID:o,nextSeq:n,count:r}=e,{ID:d,conversationID:_}=i,a=`convID:${_} messageID:${d} reactionID:${o} nextSeq:${n} count:`+r,c=new mi(t),l=(c.setMessage(a),Ce.l(s+" "+a),{userList:[],nextSeq:0,isCompleted:!1}),u=this._createReactionUserListPack(e);return this.req(u).then(e=>{var{userIDList:e=[],nextSeq:t=0}=e.data;return l.nextSeq=t,l.isCompleted=0===t,this.get(fs).getUserNickAndAvatar(e)}).then(e=>(l.userList=e,c.end(),Ce.l(s+" ok."),Ys(l))).catch(e=>(c.setError(e).end(),Ce.e(s+" failed. error:",e),Qs(e)))}_createReactionOperationPack(s,e,i){let o=void 0;const n={reactionID:e,userIDList:[this.getMyUserID()]};if(s.conversationType===t.CONV_C2C){const t=this.get(Ms);o=1===i?ti.ADD_C2C_MSG_REACTION:ti.RM_C2C_MSG_REACTION,n.from=s.from,n.to=s.to,n.messageKey=t.getMessageKey(s)}if(s.conversationType===t.CONV_GROUP){let e=void 0,t=s.to;ot(s.to)&&(e=s.to,t=Ct(e)),o=1===i?ti.ADD_GRP_MSG_REACTION:ti.RM_GRP_MSG_REACTION,n.groupID=t,n.topicID=e,n.messageSequence=s.sequence}return{P:o,data:n}}_createReactionSummaryPack(s){const{messageList:i,maxUserCountPerReaction:o=10,messageIDMap:n}=s,r=i[0];let a=void 0,c=void 0;if(r.conversationType===t.CONV_C2C){const s=this.get(Ms),t=i.map(e=>{var t=s.getMessageKey(e);return n.set(t,e.ID),t});a=ti.GET_C2C_MSG_REACTIONS,c={from:r.from,to:r.to,messageKeyList:t,count:o}}if(r.conversationType===t.CONV_GROUP){let e=void 0,t=r.to;ot(r.to)&&(e=r.to,t=Ct(e));s=i.map(e=>(n.set(e.sequence,e.ID),e.sequence));a=ti.GET_GRP_MSG_REACTIONS,c={groupID:t,topicID:e,messageSequenceList:s,count:o}}return{P:a,data:c}}_createReactionUserListPack(e){var{message:s,reactionID:e,nextSeq:i=0,count:o=100}=e;let n=void 0;const r={reactionID:e,nextSeq:i,count:100<o?100:o};if(s.conversationType===t.CONV_C2C){const e=this.get(Ms);n=ti.GET_C2C_MSG_REACTION_USER_LIST,r.from=s.from,r.to=s.to,r.messageKey=e.getMessageKey(s)}if(s.conversationType===t.CONV_GROUP){let e=void 0,t=s.to;ot(s.to)&&(e=s.to,t=Ct(e)),n=ti.GET_GRP_MSG_REACTION_USER_LIST,r.groupID=t,r.topicID=e,r.messageSequence=s.sequence}return{P:n,data:r}}_handleReactionSummary(t,e){return this.get(fs).getUserNickAndAvatar(e).then(c=>{const e=[];return t.forEach(r=>{const a=[];r.reactionList.forEach(e=>{const{reactionID:t,count:s,userIDList:i,reactedByMyself:o}=e,n=[];i.forEach(t=>{c.forEach(e=>{t===e.userID&&n.push(e)})});e={reactionID:t,totalUserCount:s,partialUserList:n,reactedByMyself:this._computeReactedByMyself({reactedByMyself:o,messageID:r.messageID,reactionID:t})};if(a.push(e),$e(o)&&!this._reactedByMyselfMap.has(r.messageID)){const c=r.messageID+"-"+t;this._reactionInfoMap.set(c,e)}}),e.push({messageID:r.messageID,reactionList:a})}),e})}_addReactedByMyselfMap(e,t){this._reactedByMyselfMap.has(e)||this._reactedByMyselfMap.set(e,[]);const s=this._reactedByMyselfMap.get(e);-1===s.indexOf(t)&&s.push(t)}_removeReactedByMyselfMap(e,t){if(this._reactedByMyselfMap.has(e)){const s=this._reactedByMyselfMap.get(e),i=s.indexOf(t);-1<i&&s.splice(i,1)}}_computeReactedByMyself({reactedByMyself:e,messageID:t,reactionID:s}){return $e(e)?!!this._reactedByMyselfMap.has(t)&&this._reactedByMyselfMap.get(t).includes(s):1===e}reset(){Ce.l(this._n+".reset"),this._reactedByMyselfMap.clear(),this._reactionInfoMap.clear()}}class Vn extends ei{constructor(e){super(e),this._n="ComboMsgModule"}sendMessage(e){const r=this._createMsg(e);if(null===r)return Qs({code:js.MSG_SEND_FAIL});this._addSendMessageTotalCount(r);const a=Date.now();return this.get(ys).setMessageRandom(r),this._sendComboMessage(r,e).then(e=>{var{time:e,sequence:s,readReceiptCode:i}=e.data;Ge(i)&&0!==i&&(new mi("sendMessageWithReceipt").setMessage(`from:${r.from} to:${r.to} sequence:${s} readReceiptCode:`+i).end(),Ce.w(this._n+`.sendMessage readReceiptCode:${i} message:`+this.getErrMsg(i))),this._addSendMessageSuccessCount(r,a);const o=this.get(ys);r.status=Ot,r.time=e,r.conversationType===t.CONV_GROUP&&(r.sequence=s),o.appendToMessageList(r);let n=r;return!0===r._isExcludedFromLastMessage&&(n=""),o.onMessageSent({conversationOptionsList:[{conversationID:r.conversationID,unreadCount:0,type:r.conversationType,subType:r.conversationSubType,lastMessage:n}]}),Ys({message:r})}).catch(e=>this._onSendMessageFailed(r,e))}_sendComboMessage(e,s){const i=this._m.get(Os);let o="";return e.conversationType===t.CONV_C2C&&(o=f.NAME.OPEN_IM+"."+ti.SEND_C2C_MSG),e.conversationType===t.CONV_GROUP&&(o=f.NAME.GRP+"."+ti.SEND_GRP_MSG),i.sendComboMessage({servcmd:o,data:s})}_createMsg(s){var i=this._n+"._createMsg";let o=null;try{const a=this.getMyUserID(),c={};if(c.senderTinyID=this.getMyTinyID(),c.currentUser=a,c.from=s.From_Account||a,s.GroupId?(c.conversationID=""+t.CONV_GROUP+s.GroupId,c.conversationType=t.CONV_GROUP,c.to=s.GroupId):s.To_Account&&(c.conversationID=""+t.CONV_C2C+s.To_Account,c.conversationType=t.CONV_C2C,c.to=s.To_Account),c.time=s.MsgTimeStamp||0,c.random=s.Random||s.MsgRandom||0,c.priority=s.MsgPriority,ke(s.CloudCustomData)&&0<s.CloudCustomData.length&&(c.cloudCustomData=s.CloudCustomData),be(s.SendMsgControl)&&(c.messageControlInfo={},s.SendMsgControl.includes("NoUnread")&&(c.messageControlInfo.excludedFromUnreadCount=1),s.SendMsgControl.includes("NoLastMsg")&&(c.messageControlInfo.excludedFromLastMessage=1)),c.conversationType===t.CONV_GROUP&&be(s.To_Account)&&0<s.To_Account.length){let e=s.To_Account;50<s.To_Account.length&&(e=s.To_Account.slice(0,50),Ce.w(i+" To_Account must be less than or equal to 50.")),c.receiverList=[...e],s.To_Account=[...e]}1!==s.IsNeedReadReceipt&&1!==s.NeedReadReceipt||(c.needReadReceipt=!0),1===s.SupportMessageExtension&&(c.isSupportExtension=!0),(o=new wi(c)).status=At,s.MsgClientTime=o.clientTime,o.conversationType===t.CONV_C2C&&(s.MsgSeq=o.sequence);var n,r=s.MsgBody.length;for(let e=0;e<r;e++)"TIMTextElem"===(n=s.MsgBody[e]).MsgType?o.setTextElement(n.MsgContent.Text):"TIMCustomElem"===n.MsgType?o.setCustomElement({data:n.MsgContent.Data||"",description:n.MsgContent.Desc||"",extension:n.MsgContent.Ext||""}):"TIMFaceElem"===n.MsgType&&o.setFaceElement({index:n.MsgContent.Index,data:n.MsgContent.Data});var e=o.getElements();o.payload=e[0].content,o.type=e[0].type}catch(e){o=null,Ce.e(i+" failed. error:",e)}return o}_onSendMessageFailed(e,t){e.status=Nt,this.get(ys).deleteMessageRandom(e),this._addSendMessageFailCountOnUser(e,t);const s=new mi("sendMessage"),i=`head.seq:${t.data.headSeq}  type:${e.type} from:${e.from} to:`+e.to;return s.setMessage(i).setError(t).end(),Ce.e(this._n+`._onSendMessageFailed ${i} error:`,t),Qs(new zs({code:t&&t.code?t.code:js.MSG_SEND_FAIL,message:t&&t.message?t.message:void 0,data:{message:e}}))}_getSendMessageSpecifiedKey(e){if(e.conversationType===t.CONV_C2C)return ni;if(e.conversationType===t.CONV_GROUP){const t=this.get(Is).getLocalGroupProfile(e.to);if(t)return e=t.type,it(e)?ri:oi}}_addSendMessageTotalCount(e){e=this._getSendMessageSpecifiedKey(e);e&&this.get(ks).addTotalCount(e)}_addSendMessageSuccessCount(e,t){var s=this._getSendMessageSpecifiedKey(e);if(s){const e=this.get(ks);e.addSuccessCount(s),e.addCost(s,St(t,!1))}}_addSendMessageFailCountOnUser(e,t){const{code:s=-1}=t,i=this.get(ks),o=this._getSendMessageSpecifiedKey(e);bn(s)&&o&&i.addFailedCountOfUserSide(o)}}class Bn extends ei{constructor(e){super(e),this._n="PluginModule",this.plugins={}}registerPlugin(t){let s="0";Object.keys(t).forEach(e=>{this.plugins[e]=t[e],"tim-upload-plugin"===e&&"function"==typeof t[e].getVersion&&(s=t[e].getVersion())}),new mi("registerPlugin").setMessage(""+Object.keys(t)).setMoreMessage("version:"+s).end()}getPlugin(e){return this.plugins[e]}reset(){}}class Kn extends ei{constructor(e){super(e),this._n="SyncUnreadMsgModule",this._cookie="",this._onlineSyncFlag=!1,this.getIEmitInst().on(Vi.A2KEY_AND_TINYID_UPDATED,this._init,this)}_init(){this._startSync({cookie:this._cookie,syncFlag:0,isOnlineSync:0})}_startSync(e){const{cookie:t,syncFlag:s,isOnlineSync:i}=e,o=this._n+"._startSync",n=(Ce.l(o+" options:",e),new mi("syncUnread"));n.setMessage(JSON.stringify(e)),this.req({P:ti.SYNC_UNREAD_MSG,data:{cookie:t,syncFlag:s,isOnlineSync:i}}).then(e=>{var{cookie:t,syncFlag:s}=e.data,i=`$cookie:${t} syncFlag:`+s;Ce.l(o+" ok. "+i),this._cookie=t,n.setMoreMessage(i).end(),Oe(t)||(0===s||1===s?(this._dispatch({...e.data,isSyncingEnded:!1}),this._startSync({cookie:t,syncFlag:s,isOnlineSync:0})):2===s&&this._dispatch({...e.data,isSyncingEnded:!0}))}).catch(e=>{n.setError(e).end(),Ce.e(o+" failed. error:",e)})}_dispatch(e){e.eventArray&&this.get(Os).onMessage({head:{},body:{eventArray:e.eventArray,isInstantMessage:this._onlineSyncFlag,isSyncingEnded:e.isSyncingEnded}}),this.get(Ms).onNewMessage({dataList:e.messageList,isInstantMessage:!!e.isSyncingEnded&&this._onlineSyncFlag,C2CRemainingUnreadList:e.C2CRemainingUnreadList,C2CPairUnreadList:e.C2CPairUnreadList,isSyncingEnded:e.isSyncingEnded})}syncOnNeed(){Ce.l(this._n+".syncOnNeed cookie:"+this._cookie),this._onlineSyncFlag=!0,this._startSync({cookie:this._cookie,syncFlag:0,isOnlineSync:1})}syncOnReconnected(){Ce.l(this._n+".syncOnReconnected cookie:"+this._cookie),this._onlineSyncFlag=!0,this._startSync({cookie:this._cookie,syncFlag:0,isOnlineSync:0})}reset(){Ce.l(this._n+".reset"),this._onlineSyncFlag=!1,this._cookie=""}}const Hn={req:{toAccount:"To_Account",fromAccount:"From_Account",to:"To_Account",from:"From_Account",groupID:"GroupId",groupAtUserID:"GroupAt_Account",extension:"Ext",data:"Data",description:"Desc",elements:"MsgBody",sizeType:"Type",downloadFlag:"Download_Flag",thumbUUID:"ThumbUUID",videoUUID:"VideoUUID",remoteAudioUrl:"Url",remoteVideoUrl:"VideoUrl",videoUrl:"",imageUrl:"URL",fileUrl:"Url",uuid:"UUID",priority:"MsgPriority",receiverUserID:"To_Account",receiverGroupID:"GroupId",messageSender:"SenderId",messageReceiver:"ReceiverId",nick:"From_AccountNick",avatar:"From_AccountHeadurl",messageNumber:"MsgNum",pbDownloadKey:"PbMsgKey",downloadKey:"JsonMsgKey",applicationType:"PendencyType",userIDList:"To_Account",groupNameList:"GroupName",userID:"To_Account",groupAttributeList:"GroupAttr",mainSequence:"AttrMainSeq",avChatRoomKey:"BytesKey",attributeControl:"AttrControl",sequence:"seq",messageControlInfo:"SendMsgControl",updateSequence:"UpdateSeq",clientTime:"MsgClientTime",sequenceList:"MsgSeqList",topicID:"TopicId",customData:"CustomString",isSupportTopic:"SupportTopic",isWebUniapp:"is_web_uniapp",isSupportExtension:"SupportMessageExtension",messageSequence:"MsgSeq",messageKey:"MsgKey",startSequence:"startSeq",simplifiedMessage:"DownsizeFlag",isRelayMessage:"IsRelayMsg",reactionID:"Reaction",messageSequenceList:"MsgSeqList",messageKeyList:"MsgKeyList",cmConfigID:"CustomModerationConfigID"},res:{MsgPriority:"priority",ThumbUUID:"thumbUUID",VideoUUID:"videoUUID",Download_Flag:"downloadFlag",GroupId:"groupID",Member_Account:"userID",MsgList:"messageList",SyncFlag:"syncFlag",To_Account:"to",From_Account:"from",MsgSeq:"sequence",MsgRandom:"random",MsgTime:"time",MsgTimeStamp:"time",MsgContent:"content",MsgBody:"elements",From_AccountNick:"nick",From_AccountHeadurl:"avatar",GroupWithdrawInfoArray:"revokedInfos",GroupReadInfoArray:"groupMessageReadNotice",LastReadMsgSeq:"lastMessageSeq",WithdrawC2cMsgNotify:"c2cMessageRevokedNotify",C2cWithdrawInfoArray:"revokedInfos",C2cReadedReceipt:"c2cMessageReadReceipt",ReadC2cMsgNotify:"c2cMessageReadNotice",LastReadTime:"peerReadTime",MsgRand:"random",MsgType:"type",MsgShow:"messageShow",NextMsgSeq:"nextMessageSeq",FaceUrl:"avatar",ProfileDataMod:"profileModify",Profile_Account:"userID",ValueBytes:"value",ValueNum:"value",NoticeSeq:"noticeSequence",NotifySeq:"notifySequence",MsgFrom_AccountExtraInfo:"messageFromAccountExtraInformation",Operator_Account:"operatorID",OpType:"operationType",ReportType:"operationType",UserId:"userID",User_Account:"userID",List_Account:"userIDList",MsgOperatorMemberExtraInfo:"operatorInfo",MsgMemberExtraInfo:"memberInfoList",ImageUrl:"avatar",NickName:"nick",MsgGroupNewInfo:"newGroupProfile",MsgAppDefinedData:"groupCustomField",Owner_Account:"ownerID",GroupFaceUrl:"avatar",GroupIntroduction:"introduction",GroupNotification:"notification",GroupApplyJoinOption:"joinOption",MsgKey:"messageKey",GroupInfo:"groupProfile",ShutupTime:"muteTime",Desc:"description",Ext:"extension",GroupAt_Account:"groupAtUserID",MsgNum:"messageNumber",PbMsgKey:"pbDownloadKey",JsonMsgKey:"downloadKey",MsgModifiedFlag:"isModified",PendencyItem:"applicationItem",PendencyType:"applicationType",AddTime:"time",AddSource:"source",AddWording:"wording",ProfileImImage:"avatar",PendencyAdd:"friendApplicationAdded",FrienPencydDel_Account:"friendApplicationDeletedUserIDList",Peer_Account:"userID",GroupAttr:"groupAttributeList",GroupAttrAry:"groupAttributeList",AttrMainSeq:"mainSequence",seq:"sequence",GroupAttrOption:"groupAttributeOption",BytesChangedKeys:"changedKeyList",GroupAttrInfo:"groupAttributeList",GroupAttrSeq:"mainSequence",PushChangedAttrValFlag:"isWithChangedAttributeInfo",SubKeySeq:"sequence",Val:"value",MsgGroupFromCardName:"senderNameCard",MsgGroupFromNickName:"senderNick",C2cNick:"peerNick",C2cImage:"peerAvatar",SendMsgControl:"messageControlInfo",NoLastMsg:"excludedFromLastMessage",NoUnread:"excludedFromUnreadCount",UpdateSeq:"updateSequence",MuteNotifications:"muteFlag",MsgClientTime:"clientTime",TinyId:"tinyID",GroupMsgReceiptList:"readReceiptList",ReadNum:"readCount",UnreadNum:"unreadCount",TopicId:"topicID",MillionGroupFlag:"communityType",SupportTopic:"isSupportTopic",MsgTopicNewInfo:"newTopicInfo",ShutupAll:"muteAllMembers",CustomString:"customData",TopicFaceUrl:"avatar",TopicIntroduction:"introduction",TopicNotification:"notification",TopicIdArray:"topicIDList",MsgVersion:"messageVersion",C2cMsgModNotifys:"c2cMessageModified",GroupMsgModNotifys:"groupMessageModified",ApplyJoinOption:"joinOption",MsgFlag:"messageRemindType",AtInfoList:"groupAtInfoList",AtFlagList:"groupAtType",AtMsgSeq:"sequence",BanDuration:"duration",BanDescription:"reason",NotVisible:"invisible",BytesTag:"tag",BytesValue:"value",RptBytesValue:"value",LatestSeq:"globalSequence",ClearSeq:"clearSequence",SupportMessageExtension:"isSupportExtension",ExtensionList:"extensions",GroupCounter:"counterList",Revoker_Account:"revoker",MsgExtensionNotify:"messageExtensionNotify",ExtensionC2cMsgInfo:"messageInfo",ExtensionGroupMsgInfo:"messageInfo",MsgOptType:"operateType",SetKVInfo:"operateResultList",DeleteKVInfo:"operateResultList",ClearKVInfo:"operateResultList",MsgKeyValue:"extensions",ClearMsgSeq:"clearSequence",MsgLastSeq:"globalSequence",InviteJoinOption:"inviteOption",MemberList_Account:"inviteeList",MsgMemberExtraInfoList:"inviteeInfoList",E:"event",GInf:"groupProfile",MCT:"clientTime",MR:"random",MP:"priority",MTS:"time",GId:"groupID",MS:"sequence",CCD:"cloudCustomData",F_Account:"from",F_Hd:"avatar",F_NN:"nick",GN:"groupName",GT:"groupType",IsSys:"isSystemMessage",OpInf:"operatorInfo",Img:"avatar",NN:"nick",OnlineInf:"onlineMemberInfo",ET:"expireTime",Num:"onlineMemberNum",Opt:"operationType",O_Account:"operatorID",RT:"operationType",UDF:"userDefinedField",L_Account:"userIDList",IsPlaceMsg:"isPlaceMessage",MsgCheckResult:"checkResult",Results:"resultList",Reaction:"reactionID",Reaction_Account:"userIDList",MsgReactionNotifyList:"messageReactionNotifyList",MsgReactionNotify:"messageReactionNotify",MsgReactionSummary:"reactionList",C2CMsgInfo:"C2CMessageInfo",GroupMsgInfo:"groupMessageInfo",int32_err_code:"errorCode",str_err_msg:"errorMsg",MsgDropReason:"messageDropReason",ReactedByMe:"reactedByMyself",Level:"messageRemindType",PeerReadTime:"timestamp",NoUnreadSeqList:"excludedUnreadSequenceList",NewMsg:"topicLatestMessage"},ignoreKeyWord:["C2C","ID","USP"]};function Wn(e,t){if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected the input to be `string | string[]`");return t=Object.assign({pascalCase:!1},t),0===(e=Array.isArray(e)?e.map(e=>e.trim()).filter(e=>e.length).join("-"):e.trim()).length?"":1===e.length?t.pascalCase?e.toUpperCase():e.toLowerCase():(e=e=(e=e!==e.toLowerCase()?Yn(e):e).replace(/^[_.\- ]+/,"").toLowerCase().replace(/[_.\- ]+(\w|$)/g,(e,t)=>t.toUpperCase()).replace(/\d+(\w|$)/g,e=>e.toUpperCase()),t.pascalCase?e.charAt(0).toUpperCase()+e.slice(1):e)}const Yn=t=>{let s=!1,i=!1,o=!1;for(let e=0;e<t.length;e++){const n=t[e];s&&/[a-zA-Z]/.test(n)&&n.toUpperCase()===n?(t=t.slice(0,e)+"-"+t.slice(e),s=!1,o=i,i=!0,e++):i&&o&&/[a-zA-Z]/.test(n)&&n.toLowerCase()===n?(t=t.slice(0,e-1)+"-"+t.slice(e-1),o=i,i=!1,s=!0):(s=n.toLowerCase()===n&&n.toUpperCase()!==n,o=i,i=n.toUpperCase()===n&&n.toLowerCase()!==n)}return t};function zn(e,t){let i=0;return function s(e,o){return 100<++i?(i--,e):be(e)?(t=e.map(e=>we(e)?s(e,o):e),i--,t):we(e)?(t=lt(t=function(s){const i=Object.create(null);return Object.keys(s).forEach(e=>{var t=(t=>{if(!He(t))return!1;if(t!==Wn(t))for(let e=0;e<Hn.ignoreKeyWord.length&&!t.includes(Hn.ignoreKeyWord[e]);e++);var e,s;if($e(o[t]))return s=t,"OPPOChannelID"===s?s:s[0].toUpperCase()+Wn(s).slice(1);else return o[t]})((s[e],e));t&&(i[t]=s[e])}),i}(e),(e,t)=>be(e)||we(e)?s(e,o):e),i--,t):void 0;var t}(e,t)}function jn(e,o){return be(e)?e.map(e=>we(e)?jn(e,o):e):we(e)?lt(function(s){const i={};return Object.keys(s).forEach(e=>{var t;i[s[e],t=e,$e(o[t])?Wn(t):o[t]]=s[e]}),i}(e),e=>be(e)||we(e)?jn(e,o):e):void 0}const Jn=String.fromCharCode,Xn=function(e){let t=0|e.charCodeAt(0);if(55296<=t)if(t<56320){e=0|e.charCodeAt(1);if(56320<=e&&e<=57343){if(65535<(t=(t<<10)+e-56613888|0))return Jn(240|t>>>18,128|t>>>12&63,128|t>>>6&63,128|63&t)}else t=65533}else t<=57343&&(t=65533);return t<=2047?Jn(192|t>>>6,128|63&t):Jn(224|t>>>12,128|t>>>6&63,128|63&t)},Zn=function(e){const t=void 0===e?"":(""+e).replace(/[\x80-\uD7ff\uDC00-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]?/g,Xn),s=0|t.length,i=new Uint8Array(s);let o=0;for(;o<s;o=o+1|0)i[o]=0|t.charCodeAt(o);return i};class Qn{constructor(e){var t=(this._handler=e).getURL();if(this._socket=null,this._workerSocket=null,this._id=je(),this._handler.getIsWorkerEnabled()){const e=URL.createObjectURL(new Blob([';let _socket = null;onmessage = function(event) {  if (event.data.cmd === "start") {    const url = event.data.url;    _socket = new WebSocket(url);    _socket.binaryType = "arraybuffer";    _socket.onopen = function() {      postMessage({ callback: "onOpen", extensions: _socket.extensions });    };    _socket.onclose = function(e) {      postMessage({ callback: "onOpen", e: { code: e.code, reason: e.reason } });    };    _socket.onmessage = function(e) {      postMessage({ callback: "onMessage", data: e.data });    };    _socket.onerror = function(e) {      postMessage({ callback: "onError", e: { isTrusted: "true" } });    };  } else if (event.data.cmd === "sendMessage") {    if (_socket !== null) {      _socket.send(event.data.data);    }  } else if (event.data.cmd === "stop") {    if (_socket !== null) {      _socket.close(event.data.code);      _socket = null;    }  }};'],{type:"application/javascript; charset=utf-8"})),o=(this._workerSocket=new Worker(e),this);this._workerSocket.onmessage=function(e){var{callback:t,e:s,extensions:i}=e.data;"onOpen"===t?o._onOpen(i):"onClose"===t?o._onClose(s):"onError"===t?o._onError(s):"onMessage"===t&&o._onMessage(e.data)},this._workerSocket.postMessage({cmd:"start",id:this._id,url:t})}else k?O?($.connectSocket({url:t,header:{"content-type":"application/json"}}),$.onSocketClose(this._onClose.bind(this)),$.onSocketOpen(this._onOpen.bind(this)),$.onSocketMessage(this._onMessage.bind(this)),$.onSocketError(this._onError.bind(this))):(this._socket=$.connectSocket({url:t,header:{"content-type":"application/json"},complete:()=>{}}),this._socket.onClose(this._onClose.bind(this)),this._socket.onOpen(this._onOpen.bind(this)),this._socket.onMessage(this._onMessage.bind(this)),this._socket.onError(this._onError.bind(this))):(this._socket=new WebSocket(t),this._socket.binaryType="arraybuffer",this._socket.onopen=this._onOpen.bind(this,this._socket.extensions),this._socket.onmessage=this._onMessage.bind(this),this._socket.onclose=this._onClose.bind(this),this._socket.onerror=this._onError.bind(this));this._canIUseBinaryFrame=e.canIUseBinaryFrame()}getID(){return this._id}_onOpen(e){this._handler.onOpen({id:this._id,res:JSON.stringify(e)})}_onClose(e){this._handler.onClose({id:this._id,e:e})}_onMessage(e){e=this._canIUseBinaryFrame?this._isAppCompressedData(e.data)?this._handler.inflate(e.data):function(e){var o=new Uint8Array(e);let n="",r=0;for(var a=o.length;r<a;){let t=o[r],s=0,i=0;if(t<=127?(s=0,i=255&t):t<=223?(s=1,i=31&t):t<=239?(s=2,i=15&t):t<=244&&(s=3,i=7&t),0<a-r-s){let e=0;for(;e<s;)t=o[r+e+1],i=i<<6|63&t,e+=1}else i=65533,s=a-r;n+=String.fromCodePoint(i),r+=s+1}return n}(e.data):e.data;this._handler.onMessage({data:e})}_isAppCompressedData(e){e=new Uint8Array(e);return 67===e[0]&&79===e[1]&&77===e[2]&&80===e[3]}_onError(e){this._handler.onError({id:this._id,e:e})}setIsWorkerEnabled(e){this._isWorkerEnabled=!0}close(e){if(this._workerSocket&&(this._workerSocket.postMessage({cmd:"stop",code:e}),this._workerSocket.terminate(),this._workerSocket=null),O)return $.offSocketClose(),$.offSocketMessage(),$.offSocketOpen(),$.offSocketError(),void $.closeSocket();this._socket&&(k?(this._socket.onClose(()=>{}),this._socket.onOpen(()=>{}),this._socket.onMessage(()=>{}),this._socket.onError(()=>{})):(this._socket.onopen=null,this._socket.onmessage=null,this._socket.onclose=null,this._socket.onerror=null),A?this._socket.close({code:e}):this._socket.close(e),this._socket=null)}send(e){this._workerSocket?this._workerSocket.postMessage({cmd:"sendMessage",data:this._canIUseBinaryFrame?Zn(e.data).buffer:e.data}):O?$.sendSocketMessage({data:e.data,fail:()=>{e.fail&&e.requestID&&e.fail(e.requestID)}}):this._socket&&(k?this._socket.send({data:this._canIUseBinaryFrame?Zn(e.data).buffer:e.data,fail:()=>{e.fail&&e.requestID&&e.fail(e.requestID)}}):this._socket.send(this._canIUseBinaryFrame?Zn(e.data):e.data))}}const eo=4e3,to=4001,so="connected",io="connecting",no="disconnected";class oo{constructor(e){this._chM=e,this._n="SocketHandler",this._promiseMap=new Map,this._readyState=no,this._simpleRequestMap=new Map,this.MAX_SIZE=100,this._startSequence=je(),this._startTs=0,this._reConnectFlag=!1,this._nextPingTs=0,this._reConnectCount=0,this.MAX_RECONNECT_COUNT=3,this._socketID=-1,this._random=0,this._socket=null,this._url="",this._onOpenTs=0,this._canIUseBinaryFrame=!0,this._isWorkerEnabled=!0,this._currentSite=c,this._setWebsocketHost(),this._initConnection()}_setWebsocketHost(){const e=this._chM.get(vs);this._currentSite=c,this._chM.isOversea()&&(this._currentSite=l),e.isSingaporeSite()?this._currentSite=u:e.isKoreaSite()?this._currentSite=d:e.isGermanySite()?this._currentSite=_:e.isIndiaSite()?this._currentSite=h:e.isJapanSite()?this._currentSite=p:e.isUSASite()?this._currentSite=g:e.isIndonesiaSite()&&(this._currentSite=m),f.HOST.setCurrent(this._currentSite)}_initConnection(){var e=this._chM.get(vs).getSDKAppID()+"";$e(f.HOST.CURRENT.BACKUP)?this._url=f.HOST.CURRENT.DEFAULT:""===this._url?this._url=f.HOST.CURRENT.DEFAULT0.replace("*",e):-1<this._url.indexOf(e)?this._url=f.HOST.CURRENT.DEFAULT:this._url===f.HOST.CURRENT.DEFAULT?this._url=f.HOST.CURRENT.BACKUP:this._url===f.HOST.CURRENT.BACKUP?this._url=this._canIUseAnyCast()?f.HOST.CURRENT.ANYCAST:f.HOST.CURRENT.DEFAULT:this._url===f.HOST.CURRENT.ANYCAST&&(f.HOST.CURRENT.ANYCAST="",this._url=f.HOST.CURRENT.DEFAULT);const t=this._chM.get(vs),s=t.getProxyServer();Oe(s)||(this._url=s),t.isTestEnv()&&(this._url=n.TEST[this._currentSite].DEFAULT),this._connect(),this._nextPingTs=0}_canIUseAnyCast(){return b&&f.HOST.CURRENT.ANYCAST}onCheckTimer(e){e%1==0&&(this._checkPromiseMap(),this._checkNativeAppWS())}_checkPromiseMap(){0!==this._promiseMap.size&&this._promiseMap.forEach((e,t)=>{const{reject:s,timestamp:i,headSeq:o}=e;let n=15e3;-1!==t.indexOf(ti.LOGIN)?n=9e4:-1!==t.indexOf(ti.PING)&&(n=3e3),Date.now()-i>=n&&(Ce.l(this._n+"._checkPromiseMap request timeout, delete requestID:"+t),this._promiseMap.delete(t),s(new zs({code:js.NETWORK_TIMEOUT,data:{headSeq:o}})),this._chM.onRequestTimeout())})}_checkNativeAppWS(){P&&!this.isConnected()&&this._reConnect()}onOpen(e){var t,s;this._readyState!==no&&(this._onOpenTs=Date.now(),{id:e,res:t}=e,this._socketID=e,s=St(this._startTs,!1),e=`socketID:${e} res:`+t,Ce.l(this._n+`._onOpen cost:${s} ms. `+e),new mi("wsOnOpen").setMessage(s).setCostTime(s).setMoreMessage(e).end(),this._readyState=so,this._reConnectCount=0,this._resend(),!0===this._reConnectFlag&&(this._chM.onReconnected(),this._reConnectFlag=!1),this._chM.onOpen())}onClose(e){const t=new mi("wsOnClose"),{id:s,e:i}=e,o=`sourceSocketID:${s} currentSocketID:${this._socketID} code:${i.code} reason:`+i.reason;let n=0;0!==this._onOpenTs&&(n=Date.now()-this._onOpenTs),t.setMessage(n).setCostTime(n).setMoreMessage(o).setCode(i.code).end(!0),Ce.l(this._n+`._onClose ${o} onlineTime:`+n),s===this._socketID&&(this._readyState=no,n<1e3?this._chM.onReconnectFailed():this._chM.onClose())}onError(e){var{id:e,e:t}=e,s=`sourceSocketID:${e} currentSocketID:`+this._socketID;new mi("wsOnError").setMessage(t.errMsg||JSON.stringify(t,["message","code"])).setMoreMessage(s).setLevel("error").end(!0),Ce.w(this._n+"._onError",t,s),e===this._socketID&&(this._readyState=no,this._chM.onError())}onMessage(t){let s;try{s=JSON.parse(t.data)}catch(e){new mi("jsonParseError").setMessage(t.data).end()}if(s&&s.head){const i=this._getRequestIDFromHead(s.head);let e=s.body;if(!this._chM.get($s).isTRTCCommand(i)){const t=mt(s.head);e=jn(s.body,this._getResKeyMap(t))}if(Ce.d(`${this._n}.onMessage ret:${JSON.stringify(e)} requestID:${i} has:`+this._promiseMap.has(i)),this._setNextPingTs(),this._promiseMap.has(i)){const{resolve:t,reject:s,timestamp:o,headSeq:n}=this._promiseMap.get(i);return this._promiseMap.delete(i),this._calcRTT(o),void(e.errorCode&&0!==e.errorCode?(this._chM.onErrorCodeNotZero(e),s(new zs({code:e.errorCode,message:e.errorInfo||"",data:i.includes(ti.MODIFY_C2C_MSG)||i.includes(ti.MODIFY_GRP_MSG)?{elements:e.elements,messageVersion:e.messageVersion,cloudCustomData:e.cloudCustomData,headSeq:n}:{headSeq:n}}))):t(Ys(e)))}this._chM.onMessage({head:s.head,body:e})}}_calcRTT(e){e=Date.now()-e;this._chM.get(ks).addRTT(e)}_connect(){this._readyState!==io&&this._readyState!==so&&(this._startTs=Date.now(),this._onOpenTs=0,this._readyState=io,this._socket=new Qn(this),this._socketID=this._socket.getID(),Ce.l(`${this._n}._connect isWorkerEnabled:${this.getIsWorkerEnabled()} socketID:${this._socketID} url:`+this.getURL()),new mi("wsConnect").setMessage(`socketID:${this._socketID} url:`+this.getURL()).end())}getURL(){this._chM.isDevMode()&&(this._canIUseBinaryFrame=!1);var e=_t();(O||S&&"windows"===e||P)&&(this._canIUseBinaryFrame=!1);let t=-1;"ios"===e?t=Y||-1:"android"===e&&(t=j||-1);const s=this._chM.get(vs),i=this._chM.getPlatform();let o=`sdkappid=${s.getSDKAppID()}&instanceid=${s.getInstanceID()}&random=${this._getRandom()}&platform=${i}&host=${e}&version=${t}&sdkversion=3.4.8`;return D&&(o+="&isminigame=1"),this._chM.canIUseInflate()&&(o+="&compress=gzip"),this._canIUseBinaryFrame?this._url+"/binfo?"+o:this._url+"/info?"+o}_closeConnection(e){Ce.l(this._n+"._closeConnection socketID:"+this._socketID),this._socket&&(this._socket.close(e),this._socketID=-1,this._socket=null,this._readyState=no)}_resend(){if(Ce.l(this._n+"._resend reConnectFlag:"+this._reConnectFlag,`promiseMap.size:${this._promiseMap.size} simpleRequestMap.size:`+this._simpleRequestMap.size),0<this._promiseMap.size&&this._promiseMap.forEach((e,t)=>{var{uplinkData:e,resolve:s,reject:i}=e;-1!==t.indexOf(ti.AV_POLLING)?this._promiseMap.delete(t):(this._promiseMap.set(t,{resolve:s,reject:i,timestamp:Date.now(),uplinkData:e}),this._execute(t,e))}),0<this._simpleRequestMap.size){for(var[e,t]of this._simpleRequestMap)this._execute(e,t);this._simpleRequestMap.clear()}}send(s){s.head.seq=this._getSequence(),s.head.reqtime=Math.floor(Date.now()/1e3),s.head.cs=this._calcCheckSum(s.head.servcmd,s.body);const{keyMap:e,...i}=s,o=this._getRequestIDFromHead(s.head),n=JSON.stringify(i);return new Promise((e,t)=>{this._promiseMap.set(o,{resolve:e,reject:t,timestamp:Date.now(),uplinkData:n,headSeq:s.head.seq}),Ce.d(`${this._n}.send uplinkData:${JSON.stringify(i)} requestID:${o} readyState:`+this._readyState),this._readyState!==so?this._reConnect():(this._execute(o,n),this._chM.get(ks).addRequestCount())})}simplySend(e){e.head.seq=this._getSequence(),e.head.reqtime=Math.floor(Date.now()/1e3);const{keyMap:t,...s}=e,i=this._getRequestIDFromHead(e.head),o=JSON.stringify(s);this._readyState!==so?(this._simpleRequestMap.size<this.MAX_SIZE?this._simpleRequestMap.set(i,o):Ce.l(this._n+".simplySend. simpleRequestMap is full, drop request!"),this._reConnect()):this._execute(i,o)}_execute(e,t){this._socket.send({data:t,fail:k?this._onSendFail.bind(this):void 0,requestID:e})}_onSendFail(e){Ce.l(this._n+"._onSendFail requestID:"+e),this._chM.onSendFail()}_getSequence(){var e;if(this._startSequence<2415919103)return e=this._startSequence,this._startSequence+=1,2415919103===this._startSequence&&(this._startSequence=je()),e}_getRequestIDFromHead(e){var{servcmd:e,seq:t}=e;return e+t}_getResKeyMap(e){e=this._chM.getKeyMap(e);return{...Hn.res,...e.res}}_reConnect(){this._readyState!==so&&this._readyState!==io&&this.forcedReconnect()}forcedReconnect(){var e=this._n+".forcedReconnect";Ce.l(e+` count:${this._reConnectCount} readyState:`+this._readyState),this._reConnectFlag=!0,this._resetRandom(),this._reConnectCount<this.MAX_RECONNECT_COUNT?(this._reConnectCount+=1,this._closeConnection(to),this._initConnection()):(this._reConnectCount=0,this._chM.get(Ds).isOnline()?(Ce.w(e+" disconnected from wsserver but network is ok, continue..."),this._closeConnection(to),this._initConnection()):this._chM.onReconnectFailed())}getReconnectFlag(){return this._reConnectFlag}_setNextPingTs(){this._nextPingTs=P?Date.now()+5e3:Date.now()+1e4}getNextPingTs(){return this._nextPingTs}isConnected(){return this._readyState===so}canIUseBinaryFrame(){return this._canIUseBinaryFrame}getSocketID(){return this._socketID}inflate(e){if(this._chM.canIUseInflate())return this._chM.get(Ws).inflate(e)}setIsWorkerEnabled(e){Ce.l(this._n+".setIsWorkerEnabled flag:"+e),this._isWorkerEnabled=e}getIsWorkerEnabled(){return this._isWorkerEnabled&&ie}_getRandom(){return 0===this._random&&(this._random=Math.random()),this._random}_resetRandom(){this._random=0}_calcCheckSum(e,t){if(-1!==e.indexOf(ti.PING)||-1!==e.indexOf(ti.LOGIN)||-1!==e.indexOf(ti.LOGOUT)||-1!==e.indexOf(ti.AV_POLLING)||-1!==e.indexOf(ti.AV_NOAUTH_POLLING))return 0;var s=Zn(JSON.stringify(t));let i=4294967295;for(let e=0,t=s.length;e<t;e++){i^=s[e];for(let e=0;e<8;e++)1==(1&i)?i=i>>>1^3988292384:i>>>=1}return(4294967295^i)>>>0}close(){Ce.l(this._n+".close"),this._closeConnection(eo),this._promiseMap.clear(),this._startSequence=je(),this._readyState=no,this._simpleRequestMap.clear(),this._reConnectFlag=!1,this._reConnectCount=0,this._onOpenTs=0,this._url="",this._random=0,this._canIUseBinaryFrame=!0,this._isWorkerEnabled=!0}}const ro=function(n,r,a){return new Promise((t,e)=>{var s="application/x-www-form-urlencoded;charset=UTF-8";if(k)$.request({url:r,data:a,method:n,timeout:3e3,header:{"content-type":s},success:e=>{e&&e.data&&e.data.NetCheckInfo&&Ce.l("getconninfo ok in miniapp. ret:",e.data),t()},fail:()=>{e(new zs({code:js.NETWORK_ERROR}))}});else{const i=new XMLHttpRequest,o=setTimeout(()=>{i.abort(),e(new zs({code:js.NETWORK_TIMEOUT}))},3e3);i.onreadystatechange=function(){4===i.readyState&&(clearTimeout(o),200===i.status||304===i.status?(i.responseText&&-1<i.responseText.indexOf("NetCheckInfo")&&Ce.l("getconninfo ok in web. ret:",JSON.parse(i.responseText)),t()):e(new zs({code:js.NETWORK_ERROR})))},i.open(n,r,!0),i.setRequestHeader("Content-type",s),a?i.send(a):i.send()}})};class ao extends ei{constructor(e){super(e),this._n="ChannelModule",this._socketHandler=new oo(this),this._probing=!1,this._isAppShowing=!0,this._previousState=t.NET_STATE_CONNECTED,this._timerForNotLoggedIn=-1,this._timerForNotLoggedIn=setInterval(this.onCheckTimer.bind(this),1e3),this._fatalErrorFlag=!1,this._disconnectedTS=0,this._lastDiagnoseTS=0}onCheckTimer(e){this._socketHandler&&(this.isLoggedIn()?(0<this._timerForNotLoggedIn&&(clearInterval(this._timerForNotLoggedIn),this._timerForNotLoggedIn=-1),this._socketHandler.onCheckTimer(e)):this._socketHandler.onCheckTimer(1),this._checkNextPing())}onErrorCodeNotZero(e){this.get(Os).onErrorCodeNotZero(e)}onMessage(e){this.get(Os).onMessage(e)}send(e){return this._socketHandler?this._previousState!==t.NET_STATE_CONNECTED&&e.head.servcmd.includes(ti.SSO_STAT)?(this.reConnect(),this.isPrivateNetWork()?Promise.resolve():this._sendLogViaHTTP(e)):this._socketHandler.send(e):Promise.reject()}_sendLogViaHTTP(e){var t=`${f.HOST.CURRENT.STAT}/v4/imopenstat/tim_web_report_v2?sdkappid=${e.head.sdkappid}&reqtime=`+Date.now(),e=JSON.stringify(e.body);return ro("POST",t,e)}simplySend(e){return this._socketHandler?this._socketHandler.simplySend(e):Promise.reject()}onOpen(){this._ping()}onClose(){this._socketHandler&&this._socketHandler.getReconnectFlag()&&this._emitNetStateChangeEvent(t.NET_STATE_DISCONNECTED),this.reConnect()}onError(){k&&!P&&this.warn("DomainNameInMP"),this._emitNetStateChangeEvent(t.NET_STATE_DISCONNECTED)}getKeyMap(e){return this.get(Os).getKeyMap(e)}onRequestTimeout(){3e4<=Date.now()-this._lastDiagnoseTS&&this.diagnose()}onSendFail(){this._emitNetStateChangeEvent(t.NET_STATE_DISCONNECTED)}onReconnected(){Ce.l(this._n+".onReconnected cost:"+St(this._disconnectedTS,!0,!0)),this._m.restartTimer(),this.get(Os).onReconnected(St(this._disconnectedTS,!1,!1)),this._disconnectedTS=0,this._emitNetStateChangeEvent(t.NET_STATE_CONNECTED)}onReconnectFailed(){Ce.l(this._n+".onReconnectFailed"),this._emitNetStateChangeEvent(t.NET_STATE_DISCONNECTED)}setIsWorkerEnabled(e){this._socketHandler&&this._socketHandler.setIsWorkerEnabled(!1)}offline(){this._emitNetStateChangeEvent(t.NET_STATE_DISCONNECTED)}reConnect(e=!1){let s=!1;this._socketHandler&&(s=this._socketHandler.getReconnectFlag());var i=`forcedFlag:${e} fatalErrorFlag:${this._fatalErrorFlag} previousState:${this._previousState} reconnectFlag:`+s;if(Ce.l(this._n+".reConnect "+i),!this._fatalErrorFlag&&this._socketHandler){if(!0===e)this._socketHandler.forcedReconnect();else{if(this._previousState===t.NET_STATE_CONNECTING&&s)return;this._socketHandler.forcedReconnect()}this._emitNetStateChangeEvent(t.NET_STATE_CONNECTING)}}_emitNetStateChangeEvent(s){this._previousState!==s&&(Ce.l(`${this._n}._emitNetStateChangeEvent from ${this._previousState} to `+s),s===t.NET_STATE_DISCONNECTED&&0===this._disconnectedTS&&(this._disconnectedTS=Date.now(),this.diagnose()),this._previousState=s,this.emitOEvt(e.NET_STATE_CHANGE,{state:s}))}_ping(){var e;!0!==this._probing&&(this._probing=!0,e=this.get(Os).getProtocolData({P:ti.PING}),this.send(e).then(()=>{this._probing=!1}).catch(e=>{this._probing=!1;var s=this.get(Ds).isOnline();if(Ce.w(this._n+`._ping failed. bOnline:${s} error:`,e),e&&60002===e.code)return new mi("error").setMessage(`code:${e.code} message:`+e.message).end(),this._fatalErrorFlag=!0,void this._emitNetStateChangeEvent(t.NET_STATE_DISCONNECTED);s?this.reConnect():this._emitNetStateChangeEvent(t.NET_STATE_DISCONNECTED)}))}_checkNextPing(){this._socketHandler&&this._socketHandler.isConnected()&&Date.now()>=this._socketHandler.getNextPingTs()&&this._ping()}dealloc(){this._socketHandler&&(this._socketHandler.close(),this._socketHandler=null),-1<this._timerForNotLoggedIn&&clearInterval(this._timerForNotLoggedIn)}onRestApiKickedOut(){this._socketHandler&&(this._socketHandler.close(),this.reConnect(!0))}canIUseInflate(){return this._m.canIUseInflate()}getSocketID(){if(this._socketHandler)return this._socketHandler.getSocketID()}diagnose(){this.isPrivateNetWork()||(this._lastDiagnoseTS=Date.now(),this._diagnoseBySSO(),this._diagnoseByCDN())}_diagnoseBySSO(){const e=this._socketHandler.getURL(),t=e.split("/")[2];var s;t.startsWith("ws")&&(s=`https://${t}/v3/netcheck/getconninfo?${e.slice(e.indexOf("info?")+5)}&reqtime=`+Date.now(),ro("GET",s).catch(e=>{Ce.w(this._n+"._diagnoseBySSO failed. error:",e)}))}_diagnoseByCDN(){const e=this._socketHandler.getURL(),t=`https://boce-cdn.my-imcloud.com/v3/netcheck/getconninfo?${e.slice(e.indexOf("info?")+5)}&reqtime=`+Date.now();ro("GET",t).catch(e=>{Ce.w(this._n+"._diagnoseByCDN failed. error:",e)})}reset(){Ce.l(this._n+".reset"),this._previousState=t.NET_STATE_CONNECTED,this._probing=!1,this._fatalErrorFlag=!1,this._timerForNotLoggedIn=setInterval(this.onCheckTimer.bind(this),1e3),this._disconnectedTS=0,this._lastDiagnoseTS=0}}class co{constructor(e){this._n="PHandler",this._sessionM=e,this._map=new Map,this._fillMap()}_fillMap(){this._map.clear();var i=this._sessionM.genCommonHead(),e=this._sessionM.genCosSpecifiedHead(),t=this._sessionM.genSSOReportHead();this._map.set(ti.LOGIN,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ti.LOGIN},body:{state:"Online",isWebUniapp:0,deviceBrand:0,customInfo:""},keyMap:{req:{deviceBrand:"InstType"},res:{InstId:"instanceID",HelloInterval:"helloInterval",RichMsgAuthKey:"authKey"}}}),this._map.set(ti.LOGOUT,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ti.LOGOUT},body:{type:0,isWebUniapp:0},keyMap:{req:{type:"wslogout_type"}}}),this._map.set(ti.HELLO,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ti.HELLO},body:{isWebUniapp:0},keyMap:{res:{NewInstInfo:"newInstanceInfo"}}}),this._map.set(ti.KICK_OTHER,{head:{...i,servcmd:f.NAME.STAT_SERVICE+"."+ti.KICK_OTHER},body:{}}),this._map.set(ti.COS_SIGN,{head:{...e,servcmd:f.NAME.IM_COS_SIGN+"."+ti.COS_SIGN},body:{cmd:"open_im_cos_svc",subCmd:"get_cos_token",duration:300,version:2},keyMap:{req:{userSig:"usersig",subCmd:"sub_cmd",cmd:"cmd",duration:"duration",version:"version"},res:{expired_time:"expiredTime",bucket_name:"bucketName",session_token:"sessionToken",tmp_secret_id:"secretId",tmp_secret_key:"secretKey"}}}),this._map.set(ti.COS_PRE_SIG,{head:{...e,servcmd:f.NAME.CUSTOM_UPLOAD+"."+ti.COS_PRE_SIG},body:{fileType:void 0,fileName:void 0,uploadMethod:0,duration:900},keyMap:{req:{userSig:"usersig",fileType:"file_type",fileName:"file_name",uploadMethod:"upload_method"},res:{expired_time:"expiredTime",request_id:"requestId",head_url:"headUrl",upload_url:"uploadUrl",download_url:"downloadUrl",ci_url:"ciUrl",snapshot_url:"requestSnapshotUrl"}}}),this._map.set(ti.SIMPLE_COS_PRE_SIG,{head:{...e,servcmd:f.NAME.CUSTOM_UPLOAD+"."+ti.SIMPLE_COS_PRE_SIG},body:{uploadMethod:0,platform:2,SDKAppID:0,userID:"",conversationType:1,uploadConfig:[{fileID:1,fileType:1,fileName:""}]},keyMap:{req:{platform:"uint32_platform",SDKAppID:"uint32_sdkappid",userID:"str_user_id",uploadMethod:"uint32_upload_method",conversationType:"uint32_scene",uploadConfig:"rpt_upload_object",fileID:"uint32_file_id",fileType:"uint32_file_type",fileName:"str_file_name"},res:{str_final_ip:"uploadIP",rpt_pre_sig:"preSig",uint32_file_id:"fileID",uint32_exist_flag:"existFlag",str_download_url:"downloadUrl",str_upload_url:"uploadUrl",str_snapshot_url:"requestSnapshotUrl",str_file_key:"fileKey"}}}),this._map.set(ti.GET_IMAGE_INFO,{head:{...e,servcmd:f.NAME.CUSTOM_UPLOAD+"."+ti.GET_IMAGE_INFO},body:{imageUrl:""},keyMap:{req:{imageUrl:"str_image_url"},res:{rpt_msg_image_info:"imageInfoArray",uint32_image_type:"type",str_url:"url",uint32_width:"width",uint32_height:"height",str_image_format:"imageFormat"}}}),this._map.set(ti.GET_IP,{head:{...e,servcmd:f.NAME.CUSTOM_UPLOAD+"."+ti.GET_IP},body:{domainName:""},keyMap:{req:{domainName:"str_domain"},res:{str_final_ip:"ip"}}}),this._map.set(ti.VIDEO_COVER,{head:{...e,servcmd:f.NAME.CUSTOM_UPLOAD+"."+ti.VIDEO_COVER},body:{version:1,platform:void 0,coverName:void 0,requestSnapshotUrl:void 0},keyMap:{req:{version:"version",platform:"platform",coverName:"cover_name",requestSnapshotUrl:"snapshot_url"},res:{error_code:"errorCode",error_msg:"errorInfo",download_url:"snapshotUrl"}}}),this._map.set(ti.FETCH_COMMERCIAL_CONFIG,{head:{...i,servcmd:f.NAME.IM_CONFIG_MANAGER+"."+ti.FETCH_COMMERCIAL_CONFIG},body:{SDKAppID:0},keyMap:{req:{SDKAppID:"uint32_sdkappid"},res:{int32_error_code:"errorCode",str_error_message:"errorMessage",str_purchase_bits:"purchaseBits",uint32_expired_time:"expiredTime"}}}),this._map.set(ti.PUSHED_COMMERCIAL_CONFIG,{head:{...i,servcmd:f.NAME.IM_CONFIG_MANAGER+"."+ti.PUSHED_COMMERCIAL_CONFIG},body:{},keyMap:{res:{int32_error_code:"errorCode",str_error_message:"errorMessage",str_purchase_bits:"purchaseBits",uint32_expired_time:"expiredTime"}}}),this._map.set(ti.FETCH_CLOUD_CTRL_CONFIG,{head:{...i,servcmd:f.NAME.IM_CONFIG_MANAGER+"."+ti.FETCH_CLOUD_CTRL_CONFIG},body:{SDKAppID:0,version:0},keyMap:{req:{SDKAppID:"uint32_sdkappid",version:"uint64_version"},res:{int32_error_code:"errorCode",str_error_message:"errorMessage",str_json_config:"cloudControlConfig",uint32_expired_time:"expiredTime",uint32_sdkappid:"SDKAppID",uint64_version:"version"}}}),this._map.set(ti.PUSHED_CLOUD_CTRL_CONFIG,{head:{...i,servcmd:f.NAME.IM_CONFIG_MANAGER+"."+ti.PUSHED_CLOUD_CTRL_CONFIG},body:{},keyMap:{res:{int32_error_code:"errorCode",str_error_message:"errorMessage",str_json_config:"cloudControlConfig",uint32_expired_time:"expiredTime",uint32_sdkappid:"SDKAppID",uint64_version:"version"}}}),this._map.set(ti.OVERLOAD_NOTIFY,{head:{...i,servcmd:f.NAME.OVERLOAD_PUSH+"."+ti.OVERLOAD_NOTIFY},body:{},keyMap:{res:{OverLoadServCmd:"overloadCommand",DelaySecs:"waitingTime"}}}),this._map.set(ti.SYNC_UNREAD_MSG,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ti.SYNC_UNREAD_MSG},body:{cookie:"",syncFlag:0,needAbstract:1,isOnlineSync:0,needSignaling:1,needCachedMsg:1},keyMap:{req:{fromAccount:"From_Account",toAccount:"To_Account",from:"From_Account",to:"To_Account",time:"MsgTimeStamp",sequence:"MsgSeq",random:"MsgRandom",elements:"MsgBody"},res:{MsgList:"messageList",SyncFlag:"syncFlag",To_Account:"to",From_Account:"from",ClientSeq:"clientSequence",MsgSeq:"sequence",NoticeSeq:"noticeSequence",NotifySeq:"notifySequence",MsgRandom:"random",MsgTimeStamp:"time",MsgContent:"content",ToGroupId:"to",MsgKey:"messageKey",GroupTips:"groupTips",MsgBody:"elements",MsgType:"type",C2CRemainingUnreadCount:"C2CRemainingUnreadList",C2CPairUnreadCount:"C2CPairUnreadList"}}}),this._map.set(ti.GET_PROFANITY_LIST,{head:{...i,servcmd:f.NAME.IM_MSG_AUDIT_MGR+"."+ti.GET_PROFANITY_LIST},body:{version:0,deviceID:"",startIndex:void 0},keyMap:{req:{version:"uint64_version",deviceID:"str_device_id",startIndex:"uint64_start_index"},res:{msg_cmd_error_code:"errorInfo",str_err_msg:"errorMessage",uint32_code:"errorCode",msg_scene_ctl_config:"filterConfig",uint64_c2c_custom_msg_flag:"c2c_custom_message",uint64_c2c_text_msg_flag:"c2c_text_message",uint64_group_custom_msg_flag:"group_custom_message",uint64_group_text_msg_flag:"group_text_message",uint64_group_info_flag:"group_profile",uint64_group_member_info_flag:"group_member_profile",uint64_relation_chain_flag:"sns",uint64_user_info_flag:"user_profile",rpt_msg_dirty_word:"lexicon",str_dirty_word:"profanity",str_replaced_content:"replacement",uint64_filter_type:"filterType",uint64_id:"id",uint64_word_type:"profanityType",uint64_complete_flag:"completeFlag",uint64_next_start_index:"nextStartIndex",uint64_version:"version",uint64_expired_time:"expiredTime"}}}),this._map.set(ti.SEND_C2C_MSG,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ti.SEND_C2C_MSG},body:{fromAccount:"",toAccount:"",msgSeq:0,msgRandom:0,msgBody:[],cloudCustomData:void 0,nick:"",avatar:"",msgLifeTime:void 0,offlinePushInfo:{pushFlag:0,title:"",desc:"",ext:"",apnsInfo:{sound:"",badgeMode:0,isVoipPush:void 0,image:""},androidInfo:{sound:"",XiaoMiChannelID:"",OPPOChannelID:"",GoogleChannelID:"",VIVOClassification:1,VIVOCategory:"",HuaWeiCategory:"",HuaWeiImage:"",HonorImage:"",GoogleImage:""}},messageControlInfo:void 0,clientTime:void 0,needReadReceipt:0,isSupportExtension:0,isRelayMessage:0,cmConfigID:void 0},keyMap:{req:{fromAccount:"From_Account",toAccount:"To_Account",msgTimeStamp:"MsgTimeStamp",msgSeq:"MsgSeq",msgRandom:"MsgRandom",msgBody:"MsgBody",count:"MaxCnt",lastMessageTime:"LastMsgTime",messageKey:"MsgKey",peerAccount:"Peer_Account",data:"Data",description:"Desc",extension:"Ext",type:"MsgType",content:"MsgContent",sizeType:"Type",uuid:"UUID",url:"",imageUrl:"URL",fileUrl:"Url",remoteAudioUrl:"Url",remoteVideoUrl:"VideoUrl",thumbUUID:"ThumbUUID",videoUUID:"VideoUUID",videoUrl:"",downloadFlag:"Download_Flag",nick:"From_AccountNick",avatar:"From_AccountHeadurl",from:"From_Account",time:"MsgTimeStamp",messageRandom:"MsgRandom",messageSequence:"MsgSeq",elements:"MsgBody",clientSequence:"ClientSeq",payload:"MsgContent",messageList:"MsgList",messageNumber:"MsgNum",abstractList:"AbstractList",messageBody:"MsgBody",needReadReceipt:"IsNeedReadReceipt",GoogleChannelID:"GoogleChannelID",XiaoMiChannelID:"XiaoMiChannelID"}}}),this._map.set(ti.SEND_GRP_MSG,{head:{...i,servcmd:f.NAME.GRP+"."+ti.SEND_GRP_MSG},body:{fromAccount:"",groupID:"",random:0,clientSequence:0,priority:"",msgBody:[],cloudCustomData:void 0,onlineOnlyFlag:0,offlinePushInfo:{pushFlag:0,title:"",desc:"",ext:"",apnsInfo:{sound:"",badgeMode:0,isVoipPush:void 0,image:""},androidInfo:{sound:"",XiaoMiChannelID:"",OPPOChannelID:"",GoogleChannelID:"",VIVOClassification:1,VIVOCategory:"",HuaWeiCategory:"",HuaWeiImage:"",HonorImage:"",GoogleImage:""}},groupAtInfo:[],messageControlInfo:void 0,clientTime:void 0,needReadReceipt:0,topicID:void 0,receiverList:void 0,isSupportExtension:0,isRelayMessage:0,cmConfigID:void 0},keyMap:{req:{to:"GroupId",extension:"Ext",data:"Data",description:"Desc",random:"Random",sequence:"ReqMsgSeq",count:"ReqMsgNumber",type:"MsgType",priority:"MsgPriority",content:"MsgContent",elements:"MsgBody",sizeType:"Type",uuid:"UUID",url:"",imageUrl:"URL",fileUrl:"Url",remoteAudioUrl:"Url",remoteVideoUrl:"VideoUrl",thumbUUID:"ThumbUUID",videoUUID:"VideoUUID",videoUrl:"",downloadFlag:"Download_Flag",clientSequence:"ClientSeq",from:"From_Account",time:"MsgTimeStamp",messageRandom:"MsgRandom",messageSequence:"MsgSeq",payload:"MsgContent",messageList:"MsgList",messageNumber:"MsgNum",abstractList:"AbstractList",messageBody:"MsgBody",needReadReceipt:"NeedReadReceipt",receiverList:"To_Account",GoogleChannelID:"GoogleChannelID",XiaoMiChannelID:"XiaoMiChannelID"},res:{MsgTime:"time",MsgSeq:"sequence"}}}),this._map.set(ti.REVOKE_C2C_MSG,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ti.REVOKE_C2C_MSG},body:{msgInfo:{fromAccount:"",toAccount:"",msgTimeStamp:0,msgSeq:0,msgRandom:0}},keyMap:{req:{msgInfo:"MsgInfo",msgTimeStamp:"MsgTimeStamp",msgSeq:"MsgSeq",msgRandom:"MsgRandom"}}}),this._map.set(ti.REVOKE_GRP_MSG,{head:{...i,servcmd:f.NAME.GRP+"."+ti.REVOKE_GRP_MSG},body:{groupID:"",msgSeqList:void 0,topicID:""},keyMap:{req:{msgSeqList:"MsgSeqList",msgSeq:"MsgSeq"}}}),this._map.set(ti.GET_C2C_ROAMING_MSG,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ti.GET_C2C_ROAMING_MSG},body:{peerAccount:"",count:15,lastMessageTime:0,messageKey:"",withRecalledMessage:1,direction:0},keyMap:{req:{messageKey:"MsgKey",peerAccount:"Peer_Account",count:"MaxCnt",lastMessageTime:"LastMsgTime",withRecalledMessage:"WithRecalledMsg",direction:"GetDirection"},res:{LastMsgTime:"lastMessageTime",IsNeedReadReceipt:"needReadReceipt",IsPeerRead:"readReceiptSentByPeer"}}}),this._map.set(ti.MODIFY_C2C_MSG,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ti.MODIFY_C2C_MSG},body:{from:"",to:"",sequence:0,random:0,time:0,version:0,elements:void 0,cloudCustomData:void 0},keyMap:{req:{sequence:"MsgSeq",random:"MsgRandom",time:"MsgTime",version:"MsgVersion",type:"MsgType",content:"MsgContent"}}}),this._map.set(ti.GET_GRP_ROAMING_MSG,{head:{...i,servcmd:f.NAME.GRP+"."+ti.GET_GRP_ROAMING_MSG},body:{withRecalledMsg:1,groupID:"",count:15,sequence:"",topicID:void 0},keyMap:{req:{sequence:"ReqMsgSeq",count:"ReqMsgNumber",withRecalledMessage:"WithRecalledMsg"},res:{Random:"random",MsgTime:"time",MsgSeq:"sequence",ReqMsgSeq:"sequence",RspMsgList:"messageList",IsSystemMsg:"isSystemMessage",ToGroupId:"to",EnumFrom_AccountType:"fromAccountType",EnumTo_AccountType:"toAccountType",GroupCode:"groupCode",MsgPriority:"priority",MsgBody:"elements",MsgType:"type",MsgContent:"content",IsFinished:"complete",Download_Flag:"downloadFlag",ClientSeq:"clientSequence",ThumbUUID:"thumbUUID",VideoUUID:"videoUUID",ToTopicId:"topicID",InvisibleMsgSeq:"invisibleSequenceList",NextReqMsgSeq:"nextSequence"}}}),this._map.set(ti.SET_C2C_MSG_READ,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ti.SET_C2C_MSG_READ},body:{C2CMsgReaded:void 0},keyMap:{req:{lastMessageTime:"LastedMsgTime"}}}),this._map.set(ti.SET_C2C_PEER_MUTE_NOTIFICATIONS,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ti.SET_C2C_PEER_MUTE_NOTIFICATIONS},body:{userIDList:void 0,muteFlag:0},keyMap:{req:{userIDList:"Peer_Account",muteFlag:"Mute_Notifications"}}}),this._map.set(ti.GET_C2C_PEER_MUTE_NOTIFICATIONS,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ti.GET_C2C_PEER_MUTE_NOTIFICATIONS},body:{toAccount:void 0,userIDList:void 0},keyMap:{req:{userIDList:"Peer_Account"},res:{MuteNotificationsList:"muteFlagList"}}}),this._map.set(ti.SET_GRP_MSG_READ,{head:{...i,servcmd:f.NAME.GRP+"."+ti.SET_GRP_MSG_READ},body:{groupID:void 0,messageReadSeq:void 0,topicID:void 0},keyMap:{req:{messageReadSeq:"MsgReadedSeq"}}}),this._map.set(ti.SET_ALL_MSG_READ,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ti.SET_ALL_MSG_READ},body:{readAllC2CMessage:0,groupMessageReadInfoList:[]},keyMap:{req:{readAllC2CMessage:"C2CReadAllMsg",groupMessageReadInfoList:"GroupReadInfo",messageSequence:"MsgSeq"},res:{C2CReadAllMsg:"readAllC2CMessage",GroupReadInfoArray:"groupMessageReadInfoList"}}}),this._map.set(ti.DEL_C2C_MSG,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ti.DEL_C2C_MSG},body:{fromAccount:"",to:"",keyList:void 0},keyMap:{req:{keyList:"MsgKeyList"}}}),this._map.set(ti.DEL_GRP_MSG,{head:{...i,servcmd:f.NAME.GRP+"."+ti.DEL_GRP_MSG},body:{groupID:"",deleter:"",keyList:void 0,topicID:void 0},keyMap:{req:{deleter:"Deleter_Account",keyList:"Seqs"}}}),this._map.set(ti.TRANSLATE_TEXT,{head:{...i,servcmd:f.NAME.IM_OPEN_TRANSLATE+"."+ti.TRANSLATE_TEXT},body:{sourceTextList:void 0,SDKAppID:0,from:0,source:"",target:""},keyMap:{req:{sourceTextList:"SourceText",SDKAppID:"SdkAppId",from:"FromAccount"},res:{TargetText:"translatedTextList",RequestId:"requestID",CmdErrorCode:"error",ErrorCode:"code",ErrorInfo:"message"}}}),this._map.set(ti.VOICE_TO_TEXT,{head:{...i,servcmd:f.NAME.IM_OPEN_SPEECH+"."+ti.VOICE_TO_TEXT},body:{url:"",SDKAppID:0,format:"",sourceType:0,language:""},keyMap:{req:{url:"BytesUrl",SDKAppID:"Uint32Sdkappid",format:"BytesVoiceFormat",sourceType:"Uint64SourceType",language:"BytesEngServiceType"},res:{BytesRequestid:"requestID",BytesResult:"result",CmdErrorCode:"error",ErrorCode:"code",ErrorInfo:"message"}}}),this._map.set(ti.MODIFY_GRP_MSG,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ti.MODIFY_GRP_MSG},body:{groupID:"",topicID:void 0,sequence:0,version:0,elements:void 0,cloudCustomData:void 0},keyMap:{req:{sequence:"MsgSeq",version:"MsgVersion",type:"MsgType",content:"MsgContent"}}}),this._map.set(ti.GET_READ_RECEIPT,{head:{...i,servcmd:f.NAME.GRP+"."+ti.GET_READ_RECEIPT},body:{groupID:"",sequenceList:void 0},keyMap:{req:{sequence:"MsgSeq"}}}),this._map.set(ti.SEND_C2C_READ_RECEIPT,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ti.SEND_C2C_READ_RECEIPT},body:{peerAccount:"",messageInfoList:void 0},keyMap:{req:{peerAccount:"Peer_Account",messageInfoList:"C2CMsgInfo",fromAccount:"From_Account",toAccount:"To_Account",sequence:"MsgSeq",random:"MsgRandom",time:"MsgTime",clientTime:"MsgClientTime"}}}),this._map.set(ti.SEND_READ_RECEIPT,{head:{...i,servcmd:f.NAME.GRP+"."+ti.SEND_READ_RECEIPT},body:{groupID:"",sequenceList:void 0},keyMap:{req:{sequenceList:"MsgSeqList",sequence:"MsgSeq"}}}),this._map.set(ti.GET_READ_RECEIPT_DETAIL,{head:{...i,servcmd:f.NAME.GRP+"."+ti.GET_READ_RECEIPT_DETAIL},body:{groupID:"",sequence:void 0,flag:0,cursor:0,count:0},keyMap:{req:{sequence:"MsgSeq",count:"Num"},res:{ReadList:"readUserIDList",Read_Account:"userID",UnreadList:"unreadUserIDList",Unread_Account:"userID",IsFinish:"isCompleted"}}}),this._map.set(ti.MODIFY_C2C_MSG_EXT,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ti.MODIFY_C2C_MSG_EXT},body:{from:void 0,to:void 0,messageKey:void 0,operateType:void 0,extensionList:void 0}}),this._map.set(ti.GET_C2C_MSG_EXT,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ti.GET_C2C_MSG_EXT},body:{from:void 0,to:void 0,messageKey:void 0,startSequence:void 0}}),this._map.set(ti.MODIFY_GRP_MSG_EXT,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ti.MODIFY_GRP_MSG_EXT},body:{groupID:void 0,topicID:void 0,messageSequence:void 0,operateType:void 0,extensionList:void 0}}),this._map.set(ti.GET_GRP_MSG_EXT,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ti.GET_GRP_MSG_EXT},body:{groupID:void 0,topicID:void 0,messageSequence:void 0,startSequence:void 0}}),this._map.set(ti.MSG_CLOUD_SEARCH,{head:{...i,servcmd:f.NAME.MSG_SEARCH+"."+ti.MSG_CLOUD_SEARCH},body:{keywordList:void 0,keywordListMatchType:"or",account:void 0,groupID:void 0,count:100,cursor:void 0,messageTypeList:void 0,senderUserIDList:void 0,startTime:void 0,endTime:void 0},keyMap:{req:{keywordListMatchType:"MatchType",account:"PeerAccount",groupID:"GroupID",messageTypeList:"MsgTypeList",senderUserIDList:"SendUserIDList"},res:{GroupID:"groupID",UserID:"userID",Count:"messageCount",LastMsgTime:"lastMessageTime",ConversationMsgs:"searchResult",IsNeedReadReceipt:"needReadReceipt",IsPeerRead:"readReceiptSentByPeer",MsgSeq:"sequence",ReqMsgSeq:"sequence",IsSystemMsg:"isSystemMessage",ToGroupId:"to",EnumFrom_AccountType:"fromAccountType",EnumTo_AccountType:"toAccountType",GroupCode:"groupCode",MsgContent:"content",ClientSeq:"clientSequence",ToTopicId:"topicID",InvisibleMsgSeq:"invisibleSequenceList",ErrorCode:"code",ErrorInfo:"message"}}}),this._map.set(ti.ADD_C2C_MSG_REACTION,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ti.ADD_C2C_MSG_REACTION},body:{from:void 0,to:void 0,reactionID:void 0,messageKey:void 0,userIDList:void 0},keyMap:{req:{userIDList:"Add_Account"}}}),this._map.set(ti.RM_C2C_MSG_REACTION,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ti.RM_C2C_MSG_REACTION},body:{from:void 0,to:void 0,reactionID:void 0,messageKey:void 0,userIDList:void 0},keyMap:{req:{userIDList:"Del_Account"}}}),this._map.set(ti.GET_C2C_MSG_REACTIONS,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ti.GET_C2C_MSG_REACTIONS},body:{from:void 0,to:void 0,messageKeyList:void 0,count:void 0}}),this._map.set(ti.GET_C2C_MSG_REACTION_USER_LIST,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ti.GET_C2C_MSG_REACTION_USER_LIST},body:{from:void 0,to:void 0,reactionID:void 0,messageKey:void 0,count:void 0}}),this._map.set(ti.ADD_GRP_MSG_REACTION,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ti.ADD_GRP_MSG_REACTION},body:{groupID:void 0,topicID:void 0,reactionID:void 0,messageSequence:void 0,userIDList:void 0},keyMap:{req:{userIDList:"Add_Account"}}}),this._map.set(ti.RM_GRP_MSG_REACTION,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ti.RM_GRP_MSG_REACTION},body:{groupID:void 0,topicID:void 0,reactionID:void 0,messageSequence:void 0,userIDList:void 0},keyMap:{req:{userIDList:"Del_Account"}}}),this._map.set(ti.GET_GRP_MSG_REACTIONS,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ti.GET_GRP_MSG_REACTIONS},body:{groupID:void 0,topicID:void 0,messageSequenceList:void 0,count:void 0},keyMap:{res:{MsgSeq:"messageSequence"}}}),this._map.set(ti.GET_GRP_MSG_REACTION_USER_LIST,{head:{...i,servcmd:f.NAME.OPEN_IM_MSG_EXT+"."+ti.GET_GRP_MSG_REACTION_USER_LIST},body:{groupID:void 0,topicID:void 0,reactionID:void 0,messageSequence:void 0,nextSeq:void 0,count:void 0}}),this._map.set(ti.GET_C2C_PEER_READ_TIME,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ti.GET_C2C_PEER_READ_TIME},body:{userIDList:void 0},keyMap:{req:{userIDList:"To_Account"},res:{ReadTime:"peerReadTimeList"}}}),this._map.set(ti.PAGING_GET_CONV_LIST,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ti.PAGING_GET_CONV_LIST},body:{fromAccount:void 0,timeStamp:void 0,startIndex:void 0,pinnedTimeStamp:void 0,pinnedStartIndex:void 0,orderType:void 0,messageAssistFlag:15,assistFlag:31},keyMap:{req:{messageAssistFlag:"MsgAssistFlags",assistFlag:"AssistFlags",pinnedTimeStamp:"TopTimeStamp",pinnedStartIndex:"TopStartIndex"},res:{SessionItem:"conversations",ToAccount:"groupID",To_Account:"userID",UnreadMsgCount:"unreadCount",MsgGroupReadedSeq:"messageReadSeq",C2cPeerReadTime:"c2cPeerReadTime",LastMsgFlags:"lastMessageFlag",TopFlags:"isPinned",TopTimeStamp:"pinnedTimeStamp",TopStartIndex:"pinnedStartIndex",GroupId:"convGroupID",C2cRemark:"friendRemark",MsgRecvOption:"messageRemindType",GroupIgnoredUnreadSeqCount:"noUnreadCount",GroupNextMsgSeq:"nextMessageSeq"}}}),this._map.set(ti.DEL_CONV,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ti.DEL_CONV},body:{fromAccount:"",conversationList:void 0,clearHistoryMessage:void 0},keyMap:{req:{toGroupID:"ToGroupid",clearHistoryMessage:"ClearRamble",conversationList:"ContactItem"},res:{ResultItem:"resultList",ToGroupid:"groupID",ResultCode:"code",ResultInfo:"info"}}}),this._map.set(ti.CLEAR_HISTORY_MSG,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ti.CLEAR_HISTORY_MSG},body:{fromAccount:"",toAccount:void 0,type:1,toGroupID:void 0},keyMap:{req:{toGroupID:"ToGroupid"}}}),this._map.set(ti.PIN_CONV,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ti.PIN_CONV},body:{fromAccount:"",operationType:1,itemList:void 0},keyMap:{req:{itemList:"RecentContactItem"}}}),this._map.set(ti.DEL_GROUP_AT_TIPS,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ti.DEL_GROUP_AT_TIPS},body:{messageListToDelete:void 0},keyMap:{req:{messageListToDelete:"DelMsgList",messageSeq:"MsgSeq",messageRandom:"MsgRandom"}}}),this._map.set(ti.SET_CONV_CUSTOM_DATA,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ti.MARK_CONV},body:{fromAccount:"",itemList:void 0},keyMap:{req:{itemList:"MarkItem",operationType:"OptType",groupID:"ToGroupId"},res:{ToGroupId:"groupID",OptType:"operationType"}}}),this._map.set(ti.MARK_CONV,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ti.MARK_CONV},body:{fromAccount:"",itemList:void 0},keyMap:{req:{itemList:"MarkItem",operationType:"OptType",groupID:"ToGroupId"},res:{ToGroupId:"groupID",OptType:"operationType"}}}),this._map.set(ti.CREATE_CONV_GRP,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ti.CREATE_CONV_GRP},body:{fromAccount:"",itemList:void 0},keyMap:{req:{itemList:"GroupContactItem",groupID:"ToGroupId"},res:{GroupId:"convGroupID",ToGroupId:"groupID",OptType:"operationType"}}}),this._map.set(ti.DEL_CONV_GRP,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ti.DEL_CONV_GRP},body:{fromAccount:"",groupName:void 0},keyMap:{res:{GroupId:"convGroupID"}}}),this._map.set(ti.RENAME_CONV_GRP,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ti.RENAME_CONV_GRP},body:{fromAccount:"",updateType:void 0,updateGroup:void 0},keyMap:{req:{oldName:"OldGroupName",newName:"NewGroupName",groupID:"ToGroupId",operationType:"ContactOptType",groupName:"OldGroupName",updateItem:"ContactUpdateItem"},res:{ContactOptType:"operationType",ToGroupId:"groupID",GroupId:"convGroupID"}}}),this._map.set(ti.ADD_CONV_TO_GRP,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ti.RENAME_CONV_GRP},body:{fromAccount:"",updateType:void 0,updateGroup:{groupName:void 0,updateGroupType:void 0,updateItem:void 0}}}),this._map.set(ti.DEL_CONV_FROM_GRP,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ti.RENAME_CONV_GRP},body:{fromAccount:"",updateType:void 0,updateGroup:void 0}}),this._map.set(ti.GET_CONV_GRP_LIST,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ti.GET_CONV_GRP_LIST},body:{fromAccount:"",startIndex:void 0},keyMap:{res:{GroupId:"convGroupID",ToGroupId:"groupID",OptType:"operationType",CustomMark:"customData",ContactGroupId:"convGroupIDList"}}}),this._map.set(ti.SEARCH_CONV_GRP_MARK,{head:{...i,servcmd:f.NAME.RECENT_CONTACT+"."+ti.SEARCH_CONV_GRP_MARK},body:{fromAccount:"",contactItem:void 0},keyMap:{req:{groupID:"ToGroupId"},res:{GroupId:"convGroupID",ToGroupId:"groupID",OptType:"operationType",CustomMark:"customData",ContactGroupId:"convGroupIDList",ContactResultItem:"contactItem"}}}),this._map.set(ti.GET_USER_PROFILE,{head:{...i,servcmd:f.NAME.PROFILE+"."+ti.GET_USER_PROFILE},body:{fromAccount:"",userItem:[]},keyMap:{req:{toAccount:"To_Account",standardSequence:"StandardSequence",customSequence:"CustomSequence"}}}),this._map.set(ti.UPDATE_MY_PROFILE,{head:{...i,servcmd:f.NAME.PROFILE+"."+ti.UPDATE_MY_PROFILE},body:{fromAccount:"",profileItem:[{tag:ye.NICK,value:""},{tag:ye.GENDER,value:""},{tag:ye.ALLOWTYPE,value:""},{tag:ye.AVATAR,value:""}]},keyMap:{req:{toAccount:"To_Account",standardSequence:"StandardSequence",customSequence:"CustomSequence"}}}),this._map.set(ti.GET_BL,{head:{...i,servcmd:f.NAME.FD+"."+ti.GET_BL},body:{fromAccount:"",startIndex:0,maxLimited:30}}),this._map.set(ti.ADD_TO_BL,{head:{...i,servcmd:f.NAME.FD+"."+ti.ADD_TO_BL},body:{fromAccount:"",toAccount:[]}}),this._map.set(ti.RM_FROM_BL,{head:{...i,servcmd:f.NAME.FD+"."+ti.RM_FROM_BL},body:{fromAccount:"",toAccount:[]}}),this._map.set(ti.SET_SELF_STATUS,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ti.SET_SELF_STATUS},body:{customStatus:""}}),this._map.set(ti.GET_USER_STATUS,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ti.GET_USER_STATUS},body:{userIDList:void 0},keyMap:{res:{UserStatusList:"successUserList",ErrorList:"failureUserList",To_Account:"userID",Invalid_Account:"invalidUserID",Status:"statusType"}}}),this._map.set(ti.SUB_USER_STATUS,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ti.SUB_USER_STATUS},body:{userIDList:void 0},keyMap:{res:{ErrorList:"failureUserList",To_Account:"userID",Invalid_Account:"invalidUserID"}}}),this._map.set(ti.UNSUB_USER_STATUS,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ti.UNSUB_USER_STATUS},body:{userIDList:void 0,unsubscribeAll:void 0},keyMap:{res:{ErrorList:"failureUserList",To_Account:"userID",Invalid_Account:"invalidUserID"}}}),this._map.set(ti.GET_FD_LIST,{head:{...i,servcmd:f.NAME.FD+"."+ti.GET_FD_LIST},body:{fromAccount:"",startIndex:0,standardSequence:0,customSequence:0},keyMap:{res:{FriendNum:"friendCount",UserDataItem:"resultList",ValueItem:"tagValueList"}}}),this._map.set(ti.ADD_FD,{head:{...i,servcmd:f.NAME.FD+"."+ti.ADD_FD},body:{fromAccount:"",addFriendItem:[],type:""},keyMap:{req:{source:"AddSource",wording:"AddWording",type:"AddType"},res:{ResultItem:"resultList"}}}),this._map.set(ti.UPDATE_FD,{head:{...i,servcmd:f.NAME.FD+"."+ti.UPDATE_FD},body:{fromAccount:"",updateItem:void 0},keyMap:{req:{snsItem:"SnsItem"},res:{ResultItem:"resultList"}}}),this._map.set(ti.DEL_FD,{head:{...i,servcmd:f.NAME.FD+"."+ti.DEL_FD},body:{fromAccount:"",userIDList:[],type:""},keyMap:{req:{type:"DeleteType"},res:{ResultItem:"resultList"}}}),this._map.set(ti.GET_FD_PROFILE,{head:{...i,servcmd:f.NAME.FD+"."+ti.GET_FD_PROFILE},body:{fromAccount:"",userIDList:void 0},keyMap:{res:{InfoItem:"resultList",SnsProfileItem:"tagValueList"}}}),this._map.set(ti.CHECK_FD,{head:{...i,servcmd:f.NAME.FD+"."+ti.CHECK_FD},body:{fromAccount:"",userIDList:[],type:""},keyMap:{req:{type:"CheckType"},res:{InfoItem:"resultList"}}}),this._map.set(ti.GET_FD_APPLICATION_LIST,{head:{...i,servcmd:f.NAME.FD+"."+ti.GET_FD_APPLICATION_LIST},body:{fromAccount:"",applicationType:"",startTime:0,maxLimited:0,lastSequence:0},keyMap:{res:{PendencyItem:"resultList",AddSource:"source",AddTime:"time",AddWording:"wording",Image:"avatar",UnreadPendencyCount:"unreadCount",To_Account:"userID",PendencyType:"type"}}}),this._map.set(ti.RESPOND_FD_APPLICATION,{head:{...i,servcmd:f.NAME.FD+"."+ti.RESPOND_FD_APPLICATION},body:{fromAccount:"",responseFriendItem:[]},keyMap:{req:{tag:"TagName",action:"ResponseAction"},res:{ResultItem:"resultList"}}}),this._map.set(ti.DEL_FD_APPLICATION,{head:{...i,servcmd:f.NAME.FD+"."+ti.DEL_FD_APPLICATION},body:{fromAccount:"",type:"",userIDList:void 0},keyMap:{req:{type:"PendencyType",userIDList:"To_Account"},res:{ResultItem:"resultList"}}}),this._map.set(ti.REPORT_FD_APPLICATION,{head:{...i,servcmd:f.NAME.FD+"."+ti.REPORT_FD_APPLICATION},body:{fromAccount:"",latestTimeStamp:""},keyMap:{req:{latestTimeStamp:"LatestPendencyTimeStamp"}}}),this._map.set(ti.CREATE_FD_GRP,{head:{...i,servcmd:f.NAME.FD+"."+ti.CREATE_FD_GRP},body:{fromAccount:"",groupName:void 0,userIDList:void 0},keyMap:{req:{groupName:"GroupName",userIDList:"To_Account"},res:{ResultItem:"resultList"}}}),this._map.set(ti.DEL_FD_GRP,{head:{...i,servcmd:f.NAME.FD+"."+ti.DEL_FD_GRP},body:{fromAccount:"",nameList:void 0},keyMap:{req:{nameList:"GroupName"}}}),this._map.set(ti.GET_FD_GRP_LIST,{head:{...i,servcmd:f.NAME.FD+"."+ti.GET_FD_GRP_LIST},body:{fromAccount:"",lastSequence:0,needFriend:"Need_Friend_Type_Yes"},keyMap:{res:{ResultItem:"resultList",GroupName:"name",FriendNumber:"friendCount",To_Account:"userIDList"}}}),this._map.set(ti.UPDATE_FD_GRP,{head:{...i,servcmd:f.NAME.FD+"."+ti.UPDATE_FD_GRP},body:{fromAccount:"",oldName:"",newName:void 0,updateGroupItem:void 0},keyMap:{req:{oldName:"GroupOldName",newName:"GroupNewName"},res:{UpdateType:"type",ResultItem:"resultList"}}}),this._map.set(ti.GET_GRP_LIST,{head:{...i,servcmd:f.NAME.GRP+"."+ti.GET_GRP_LIST},body:{memberAccount:"",limit:void 0,offset:void 0,groupType:void 0,responseFilter:{groupBaseInfoFilter:void 0,selfInfoFilter:void 0},isSupportTopic:0,needAppDefineData:1},keyMap:{req:{memberAccount:"Member_Account"},res:{GroupIdList:"groups",MsgSeq:"readedSequence",LastRecallTime:"_lastRevokedTime",AppDefinedData:"groupCustomField"}}}),this._map.set(ti.GET_GRP_PROFILE,{head:{...i,servcmd:f.NAME.GRP+"."+ti.GET_GRP_PROFILE},body:{groupIDList:void 0,responseFilter:{groupBaseInfoFilter:void 0,groupCustomFieldFilter:void 0,memberInfoFilter:void 0,memberCustomFieldFilter:void 0}},keyMap:{req:{groupIDList:"GroupIdList",groupCustomField:"AppDefinedData",memberCustomField:"AppMemberDefinedData",groupCustomFieldFilter:"AppDefinedDataFilter_Group",memberCustomFieldFilter:"AppDefinedDataFilter_GroupMember"},res:{GroupIdList:"groups",AppDefinedData:"groupCustomField",AppMemberDefinedData:"memberCustomField",AppDefinedDataFilter_Group:"groupCustomFieldFilter",AppDefinedDataFilter_GroupMember:"memberCustomFieldFilter",InfoSeq:"infoSequence",MemberList:"members",GroupInfo:"groups",ShutUpUntil:"muteUntil",ShutUpAllMember:"muteAllMembers"}}}),this._map.set(ti.CREATE_GRP,{head:{...i,servcmd:f.NAME.GRP+"."+ti.CREATE_GRP},body:{type:void 0,name:void 0,groupID:void 0,ownerID:void 0,introduction:void 0,notification:void 0,maxMemberNum:void 0,joinOption:void 0,memberList:void 0,groupCustomField:void 0,memberCustomField:void 0,webPushFlag:1,avatar:"",isSupportTopic:void 0,inviteOption:void 0},keyMap:{req:{ownerID:"Owner_Account",userID:"Member_Account",avatar:"FaceUrl",maxMemberNum:"MaxMemberCount",joinOption:"ApplyJoinOption",groupCustomField:"AppDefinedData",memberCustomField:"AppMemberDefinedData",inviteOption:"InviteJoinOption"},res:{HugeGroupFlag:"avChatRoomFlag",OverJoinedGroupLimit_Account:"overLimitUserIDList"}}}),this._map.set(ti.DISMISS_GRP,{head:{...i,servcmd:f.NAME.GRP+"."+ti.DISMISS_GRP},body:{groupID:void 0}}),this._map.set(ti.UPDATE_GRP_PROFILE,{head:{...i,servcmd:f.NAME.GRP+"."+ti.UPDATE_GRP_PROFILE},body:{groupID:void 0,name:void 0,introduction:void 0,notification:void 0,avatar:void 0,joinOption:void 0,groupCustomField:void 0,muteAllMembers:void 0,inviteOption:void 0},keyMap:{req:{groupCustomField:"AppDefinedData",muteAllMembers:"ShutUpAllMember",joinOption:"ApplyJoinOption",avatar:"FaceUrl",inviteOption:"InviteJoinOption"},res:{AppDefinedData:"groupCustomField",ShutUpAllMember:"muteAllMembers"}}}),this._map.set(ti.APPLY_JOIN_GRP,{head:{...i,servcmd:f.NAME.GRP+"."+ti.APPLY_JOIN_GRP},body:{groupID:void 0,applyMessage:void 0,userDefinedField:void 0,webPushFlag:1,historyMessageFlag:void 0},keyMap:{req:{applyMessage:"ApplyMsg",historyMessageFlag:"HugeGroupHistoryMsgFlag"},res:{HugeGroupFlag:"avChatRoomFlag",AVChatRoomKey:"avChatRoomKey",RspMsgList:"messageList",ToGroupId:"to"}}}),this._map.set(ti.APPLY_JOIN_GRP_NOAUTH,function(){const{a2:e,tinyid:t,...s}=i;return{head:{...s,servcmd:f.NAME.BIG_GRP_NO_AUTH+"."+ti.APPLY_JOIN_GRP},body:{groupID:void 0,applyMessage:void 0,userDefinedField:void 0,webPushFlag:1},keyMap:{req:{applyMessage:"ApplyMsg"},res:{HugeGroupFlag:"avChatRoomFlag"}}}}()),this._map.set(ti.QUIT_GRP,{head:{...i,servcmd:f.NAME.GRP+"."+ti.QUIT_GRP},body:{groupID:void 0}}),this._map.set(ti.SEARCH_GRP,{head:{...i,servcmd:f.NAME.GRP+"."+ti.SEARCH_GRP},body:{groupIDList:void 0,responseFilter:{groupBasePublicInfoFilter:["Type","Name","Introduction","Notification","FaceUrl","CreateTime","Owner_Account","LastInfoTime","LastMsgTime","NextMsgSeq","MemberNum","MaxMemberNum","ApplyJoinOption","InviteJoinOption"]}}}),this._map.set(ti.CHANGE_GRP_OWNER,{head:{...i,servcmd:f.NAME.GRP+"."+ti.CHANGE_GRP_OWNER},body:{groupID:void 0,newOwnerID:void 0},keyMap:{req:{newOwnerID:"NewOwner_Account"}}}),this._map.set(ti.HANDLE_GRP_APPLICATION,{head:{...i,servcmd:f.NAME.GRP+"."+ti.HANDLE_GRP_APPLICATION},body:{groupID:void 0,applicant:void 0,handleAction:void 0,handleMessage:void 0,authentication:void 0,messageKey:void 0,userDefinedField:void 0},keyMap:{req:{applicant:"Applicant_Account",handleAction:"HandleMsg",handleMessage:"ApprovalMsg",messageKey:"MsgKey"}}}),this._map.set(ti.HANDLE_INVITE_JOIN_GRP,{head:{...i,servcmd:f.NAME.GRP+"."+ti.HANDLE_INVITE_JOIN_GRP},body:{groupID:void 0,applicant:void 0,invitee:void 0,handleAction:void 0,handleMessage:void 0,authentication:void 0,userDefinedField:void 0},keyMap:{req:{applicant:"Applicant_Account",invitee:"Invited_Account",handleAction:"HandleMsg",handleMessage:"ApprovalMsg"}}}),this._map.set(ti.HANDLE_GRP_INVITATION,{head:{...i,servcmd:f.NAME.GRP+"."+ti.HANDLE_GRP_INVITATION},body:{groupID:void 0,inviter:void 0,handleAction:void 0,handleMessage:void 0,authentication:void 0,messageKey:void 0,userDefinedField:void 0},keyMap:{req:{inviter:"Inviter_Account",handleAction:"HandleMsg",handleMessage:"ApprovalMsg",messageKey:"MsgKey"}}}),this._map.set(ti.GET_GRP_PENDENCY,{head:{...i,servcmd:f.NAME.GRP+"."+ti.GET_GRP_PENDENCY},body:{startTime:void 0,limit:void 0,handleAccount:void 0},keyMap:{req:{handleAccount:"Handle_Account"},res:{To_Account:"userID",ApplyInviteMsg:"note"}}}),this._map.set(ti.DEL_GRP_SYSTEM_NOTICE,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ti.DEL_GRP_SYSTEM_NOTICE},body:{messageListToDelete:void 0},keyMap:{req:{messageListToDelete:"DelMsgList",messageSeq:"MsgSeq",messageRandom:"MsgRandom"}}}),this._map.set(ti.AV_POLLING,{head:{...i,servcmd:f.NAME.BIG_GRP_POLLING+"."+ti.AV_POLLING},body:{USP:1,startSeq:1,startBroadcastSeq:void 0,holdTime:90,key:void 0,simplifiedMessage:void 0},keyMap:{req:{USP:"USP"},res:{ToGroupId:"groupID",RspBroadcastMsgList:"broadcastMessageList",IsSystemMsg:"isSystemMessage"}}}),this._map.set(ti.AV_NOAUTH_POLLING,function(){const{a2:e,tinyid:t,...s}=i;return{head:{...s,servcmd:f.NAME.BIG_GRP_POLLING_NO_AUTH+"."+ti.AV_POLLING},body:{USP:1,startSeq:1,holdTime:90,key:void 0,simplifiedMessage:void 0},keyMap:{req:{USP:"USP"},res:{ToGroupId:"groupID",RspBroadcastMsgList:"broadcastMessageList",IsSystemMsg:"isSystemMessage"}}}}()),this._map.set(ti.GET_ONLINE_MBR_NUM,{head:{...i,servcmd:f.NAME.GRP+"."+ti.GET_ONLINE_MBR_NUM},body:{groupID:void 0},keyMap:{res:{OnlineMemberNum:"memberCount"}}}),this._map.set(ti.SET_GRP_ATTR,{head:{...i,servcmd:f.NAME.GRP+"."+ti.SET_GRP_ATTR},body:{groupID:void 0,groupAttributeList:void 0,mainSequence:void 0,avChatRoomKey:void 0,attributeControl:["RaceConflict"]},keyMap:{req:{key:"key",value:"value"}}}),this._map.set(ti.MODIFY_GRP_ATTR,{head:{...i,servcmd:f.NAME.GRP+"."+ti.MODIFY_GRP_ATTR},body:{groupID:void 0,groupAttributeList:void 0,mainSequence:void 0,avChatRoomKey:void 0,attributeControl:["RaceConflict"]},keyMap:{req:{key:"key",value:"value"}}}),this._map.set(ti.DEL_GRP_ATTR,{head:{...i,servcmd:f.NAME.GRP+"."+ti.DEL_GRP_ATTR},body:{groupID:void 0,groupAttributeList:void 0,mainSequence:void 0,avChatRoomKey:void 0,attributeControl:["RaceConflict"]},keyMap:{req:{key:"key"}}}),this._map.set(ti.CLEAR_GRP_ATTR,{head:{...i,servcmd:f.NAME.GRP+"."+ti.CLEAR_GRP_ATTR},body:{groupID:void 0,mainSequence:void 0,avChatRoomKey:void 0,attributeControl:["RaceConflict"]}}),this._map.set(ti.GET_GRP_ATTR,{head:{...i,servcmd:f.NAME.GRP_ATTR+"."+ti.GET_GRP_ATTR},body:{groupID:void 0,avChatRoomKey:void 0,groupType:1},keyMap:{req:{avChatRoomKey:"Key",groupType:"GroupType"}}}),this._map.set(ti.GET_GRP_NOTIFY,{head:{...i,servcmd:f.NAME.GRP+"."+ti.GET_GRP_NOTIFY},body:{notifyReqList:[]},keyMap:{req:{notifyReqList:"NotifyReqList"},res:{NextMsgTime:"nextRevokedTime",NotifyMsgList:"notifyList",NotifyRspList:"notifyRspList"}}}),this._map.set(ti.UPDATE_GRP_COUNTER,{head:{...i,servcmd:f.NAME.GRP+"."+ti.UPDATE_GRP_COUNTER},body:{groupID:void 0,counterList:void 0,avChatRoomKey:void 0,mode:void 0},keyMap:{req:{counterList:"GroupCounter"}}}),this._map.set(ti.GET_GRP_COUNTER,{head:{...i,servcmd:f.NAME.GRP+"."+ti.GET_GRP_COUNTER},body:{groupID:void 0,keyList:[],avChatRoomKey:void 0},keyMap:{req:{keyList:"GroupCounterKeys"}}}),this._map.set(ti.CREATE_TOPIC,{head:{...i,servcmd:f.NAME.GRP_COMMUNITY+"."+ti.CREATE_TOPIC},body:{groupID:void 0,topicName:void 0,avatar:void 0,customData:void 0,topicID:void 0,notification:void 0,introduction:void 0},keyMap:{req:{avatar:"FaceUrl"}}}),this._map.set(ti.DEL_TOPIC,{head:{...i,servcmd:f.NAME.GRP_COMMUNITY+"."+ti.DEL_TOPIC},body:{groupID:void 0,topicIDList:void 0},keyMap:{req:{topicIDList:"TopicIdList"},res:{DestroyResultItem:"resultList"}}}),this._map.set(ti.UPDATE_TOPIC_PROFILE,{head:{...i,servcmd:f.NAME.GRP_COMMUNITY+"."+ti.UPDATE_TOPIC_PROFILE},body:{groupID:void 0,topicID:void 0,avatar:void 0,customData:void 0,notification:void 0,introduction:void 0,muteAllMembers:void 0,topicName:void 0},keyMap:{req:{avatar:"FaceUrl",muteAllMembers:"ShutUpAllMember"}}}),this._map.set(ti.GET_TOPIC_LIST,{head:{...i,servcmd:f.NAME.GRP_COMMUNITY+"."+ti.GET_TOPIC_LIST},body:{groupID:void 0,topicIDList:void 0,MemberInfoFilter:["NoUnreadSeqList"]},keyMap:{req:{topicIDList:"TopicIdList"},res:{TopicAndSelfInfo:"topicInfoList",TopicInfo:"topic",GroupID:"groupID",ShutUpTime:"muteTime",ShutUpAllFlag:"muteAllMembers",LastMsgTime:"lastMessageTime",MsgSeq:"readedSequence",LastMsgSeq:"sequence"}}}),this._map.set(ti.GET_GRP_MBR_LIST,{head:{...i,servcmd:f.NAME.GRP+"."+ti.GET_GRP_MBR_LIST},body:{groupID:void 0,limit:0,offset:void 0,next:void 0,memberRoleFilter:void 0,memberInfoFilter:void 0,memberCustomFieldFilter:void 0},keyMap:{req:{memberCustomFieldFilter:"AppDefinedDataFilter_GroupMember"},res:{AppMemberDefinedData:"memberCustomField",AppDefinedDataFilter_GroupMember:"memberCustomFieldFilter",MemberList:"members",ShutUpUntil:"muteUntil"}}}),this._map.set(ti.GET_AV_MBR_LIST,{head:{...i,servcmd:f.NAME.GRP_AV+"."+ti.GET_AV_MBR_LIST},body:{groupID:void 0,offset:void 0,filter:void 0},keyMap:{req:{offset:"Timestamp",filter:"Mark"},res:{NextTimestamp:"offset"}}}),this._map.set(ti.GET_GRP_MBR_PROFILE,{head:{...i,servcmd:f.NAME.GRP+"."+ti.GET_GRP_MBR_PROFILE},body:{groupID:void 0,userIDList:void 0,memberInfoFilter:void 0,memberCustomFieldFilter:void 0},keyMap:{req:{userIDList:"Member_List_Account",memberCustomFieldFilter:"AppDefinedDataFilter_GroupMember"},res:{MemberList:"members",ShutUpUntil:"muteUntil",AppDefinedDataFilter_GroupMember:"memberCustomFieldFilter",AppMemberDefinedData:"memberCustomField"}}}),this._map.set(ti.ADD_GRP_MBR,{head:{...i,servcmd:f.NAME.GRP+"."+ti.ADD_GRP_MBR},body:{groupID:void 0,silence:void 0,userIDList:void 0},keyMap:{req:{userID:"Member_Account",userIDList:"MemberList"},res:{MemberList:"members"}}}),this._map.set(ti.DEL_GRP_MBR,{head:{...i,servcmd:f.NAME.GRP+"."+ti.DEL_GRP_MBR},body:{groupID:void 0,userIDList:void 0,reason:void 0},keyMap:{req:{userIDList:"MemberToDel_Account"}}}),this._map.set(ti.BAN_AV_MBR,{head:{...i,servcmd:f.NAME.GRP+"."+ti.BAN_AV_MBR},body:{groupID:void 0,userIDList:void 0,duration:void 0,reason:""},keyMap:{req:{userIDList:"Members_Account",duration:"Duration",reason:"Description"}}}),this._map.set(ti.MODIFY_GRP_MBR_INFO,{head:{...i,servcmd:f.NAME.GRP+"."+ti.MODIFY_GRP_MBR_INFO},body:{groupID:void 0,topicID:void 0,userID:void 0,messageRemindType:void 0,nameCard:void 0,role:void 0,memberCustomField:void 0,muteTime:void 0},keyMap:{req:{userID:"Member_Account",memberCustomField:"AppMemberDefinedData",muteTime:"ShutUpTime",messageRemindType:"MsgFlag"}}}),this._map.set(ti.MARK_AV_MBR_INFO,{head:{...i,servcmd:f.NAME.GRP_AV+"."+ti.MARK_AV_MBR_INFO},body:{groupID:void 0,operationType:1,memberList:[]},keyMap:{req:{operationType:"CommandType",memberList:"MemberList",markType:"Marks",userID:"Member_Account"},res:{CommandType:"operationType",Marks:"markType",Member_Account:"userID"}}}),this._map.set(ti.SSO_STAT,{head:{...t,servcmd:f.NAME.IM_OPEN_STAT+"."+ti.SSO_STAT},body:{header:{},event:[],quality:[]},keyMap:{req:{SDKType:"sdk_type",SDKVersion:"sdk_version",deviceType:"device_type",platform:"platform",instanceID:"instance_id",traceID:"trace_id",SDKAppID:"sdk_app_id",userID:"user_id",tinyID:"tiny_id",extension:"extension",timestamp:"timestamp",networkType:"network_type",eventType:"event_type",code:"error_code",message:"error_message",moreMessage:"more_message",duplicate:"duplicate",costTime:"cost_time",level:"level",qualityType:"quality_type",reportIndex:"report_index",wholePeriod:"whole_period",totalCount:"total_count",rttCount:"success_count_business",successRateOfRequest:"percent_business",countLessThan1Second:"success_count_business",percentOfCountLessThan1Second:"percent_business",countLessThan3Second:"success_count_platform",percentOfCountLessThan3Second:"percent_platform",successCountOfBusiness:"success_count_business",successRateOfBusiness:"percent_business",successCountOfPlatform:"success_count_platform",successRateOfPlatform:"percent_platform",successCountOfMessageReceived:"success_count_business",successRateOfMessageReceived:"percent_business",avgRTT:"average_value",avgDelay:"average_value",avgValue:"average_value",uiPlatform:"ui_platform"}}}),this._map.set(ti.PING,{head:{...i,servcmd:f.NAME.HEARTBEAT+"."+ti.PING},body:{}}),this._map.set(ti.MSG_PUSH,{head:{...i,servcmd:f.NAME.IM_OPEN_PUSH+"."+ti.MSG_PUSH},body:{},keyMap:{res:{C2cMsgArray:"C2CMessageArray",GroupMsgArray:"groupMessageArray",GroupTips:"groupTips",C2cNotifyMsgArray:"C2CNotifyMessageArray",C2cMsgInfo:"C2CReadReceiptArray",ClientSeq:"clientSequence",MsgPriority:"priority",NoticeSeq:"noticeSequence",MsgContent:"content",MsgType:"type",MsgBody:"elements",ToGroupId:"to",Desc:"description",Ext:"extension",IsSyncMsg:"isSyncMessage",Flag:"needSync",NeedAck:"needAck",PendencyAdd_Account:"userID",ProfileImNick:"nick",PendencyType:"applicationType",C2CReadAllMsg:"readAllC2CMessage",IsNeedReadReceipt:"needReadReceipt",Status:"statusType"}}}),this._map.set(ti.MULTI_MSG_PUSH,{head:{...i,servcmd:f.NAME.IM_OPEN_PUSH+"."+ti.MULTI_MSG_PUSH},body:{},keyMap:{res:{GroupMsgArray:"groupMessageArray",GroupTips:"groupTips",ClientSeq:"clientSequence",MsgPriority:"priority",NoticeSeq:"noticeSequence",MsgContent:"content",MsgType:"type",MsgBody:"elements",ToGroupId:"to",Desc:"description",Ext:"extension",IsSyncMsg:"isSyncMessage",Flag:"needSync",NeedAck:"needAck",PendencyType:"applicationType"}}}),this._map.set(ti.MSG_PUSH_ACK,{head:{...i,servcmd:f.NAME.OPEN_IM+"."+ti.MSG_PUSH_ACK},body:{sessionData:void 0},keyMap:{req:{sessionData:"SessionData"}}}),this._map.set(ti.STATUS_FORCE_OFFLINE,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ti.STATUS_FORCE_OFFLINE},body:{},keyMap:{res:{C2cNotifyMsgArray:"C2CNotifyMessageArray",NoticeSeq:"noticeSequence",KickoutMsgNotify:"kickoutMsgNotify",NewInstInfo:"newInstanceInfo"}}}),this._map.set(ti.DOWNLOAD_MERGER_MSG,{head:{...i,servcmd:f.NAME.IM_LONG_MSG+"."+ti.DOWNLOAD_MERGER_MSG},body:{downloadKey:""},keyMap:{res:{Data:"data",Desc:"description",Ext:"extension",Download_Flag:"downloadFlag",ThumbUUID:"thumbUUID",VideoUUID:"videoUUID"}}}),this._map.set(ti.UPLOAD_MERGER_MSG,{head:{...i,servcmd:f.NAME.IM_LONG_MSG+"."+ti.UPLOAD_MERGER_MSG},body:{messageList:[]},keyMap:{req:{fromAccount:"From_Account",toAccount:"To_Account",msgTimeStamp:"MsgTimeStamp",msgSeq:"MsgSeq",msgRandom:"MsgRandom",msgBody:"MsgBody",type:"MsgType",content:"MsgContent",data:"Data",description:"Desc",extension:"Ext",sizeType:"Type",uuid:"UUID",url:"",imageUrl:"URL",fileUrl:"Url",remoteAudioUrl:"Url",remoteVideoUrl:"VideoUrl",thumbUUID:"ThumbUUID",videoUUID:"VideoUUID",videoUrl:"",downloadFlag:"Download_Flag",from:"From_Account",time:"MsgTimeStamp",messageRandom:"MsgRandom",messageSequence:"MsgSeq",elements:"MsgBody",clientSequence:"ClientSeq",payload:"MsgContent",messageList:"MsgList",messageNumber:"MsgNum",abstractList:"AbstractList",messageBody:"MsgBody"}}}),this._map.set(ti.FOLLOW,{head:{...i,servcmd:f.NAME.FOLLOW+"."+ti.FOLLOW},body:{fromAccount:"",userIDList:[]},keyMap:{req:{userIDList:"FollowItem"},res:{ResultItem:"resultList",To_Account:"userID"}}}),this._map.set(ti.UNFOLLOW,{head:{...i,servcmd:f.NAME.FOLLOW+"."+ti.UNFOLLOW},body:{fromAccount:"",userIDList:[]},keyMap:{req:{userIDList:"To_Account"},res:{ResultItem:"resultList",To_Account:"userID"}}}),this._map.set(ti.GET_FOLLOW_INFO,{head:{...i,servcmd:f.NAME.FOLLOW+"."+ti.GET_FOLLOW_INFO},body:{fromAccount:"",userIDList:[]},keyMap:{req:{userIDList:"To_Account"},res:{FollowInfo:"followInfoList",To_Account:"userID",FollowerCount:"followersCount",FollowingCount:"followingCount",MutualFollowingCount:"mutualFollowersCount"}}}),this._map.set(ti.GET_FOLLOW,{head:{...i,servcmd:f.NAME.FOLLOW+"."+ti.GET_FOLLOW},body:{fromAccount:"",type:1,nextCursor:"",count:500},keyMap:{req:{type:"FollowType",nextCursor:"StartCursor",count:"WantNum"},res:{FollowItem:"resultList",To_Account:"userID",ProfileItem:"profileList"}}}),this._map.set(ti.CHECK_FOLLOW_TYPE,{head:{...i,servcmd:f.NAME.FOLLOW+"."+ti.CHECK_FOLLOW_TYPE},body:{fromAccount:"",userIDList:[]},keyMap:{req:{userIDList:"To_Account"},res:{ResultItem:"resultList",To_Account:"userID"}}}),this._map.set(ti.SET_TOKEN,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ti.SET_TOKEN},body:{tokenID:"",pushMsg:0,sdkAppID:0,businessID:"",deviceBrand:"",deviceToken:"",isTpns:0,isWebUniapp:0,notificationStatus:0,deviceModel:"",systemVersion:"",pushVersion:""},keyMap:{req:{tokenID:"TokenID",pushMsg:"PushMsg",sdkAppID:"EnterVersion",businessID:"BusiID",deviceBrand:"InstType",deviceToken:"VarToken",isTpns:"IsTpns",notificationStatus:"NotificationStatus",deviceModel:"DeviceModel",systemVersion:"SystemVersion",pushVersion:"PushPluginVersion"}}}),this._map.set(ti.STAT_FOREGROUND,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ti.STAT_FOREGROUND},body:{isWebUniapp:0}}),this._map.set(ti.STAT_BACKGROUND,{head:{...i,servcmd:f.NAME.IM_OPEN_STATUS+"."+ti.STAT_BACKGROUND},body:{C2CUnread:0,GroupUnread:0,isWebUniapp:0},keyMap:{req:{c2cUnreadCount:"C2cUnread",groupUnreadCount:"GrpUnread"}}}),this._map.set(ti.PUSH_REPORT,{head:{...i,servcmd:f.NAME.OFFLINE_PUSH_REPORT+"."+ti.PUSH_REPORT},body:{eventList:[]},keyMap:{req:{eventList:"UinappPushEvents",type:"EventType",time:"EventTime",pushId:"ClickExt"}}}),this._map.set(ti.SET_ALL_RECEIVE_MSG_OPT,{head:{...i,servcmd:f.NAME.IM_MSG_LOGIC+"."+ti.SET_ALL_RECEIVE_MSG_OPT},body:{startTime:0,endTime:0,isRepeated:0,messageRemindType:0},keyMap:{req:{messageRemindType:"Level"}}}),this._map.set(ti.GET_ALL_RECEIVE_MSG_OPT,{head:{...i,servcmd:f.NAME.IM_MSG_LOGIC+"."+ti.GET_ALL_RECEIVE_MSG_OPT},body:{toAccount:void 0}})}has(e){return this._map.has(e)}get(e){return this._map.get(e)}update(){this._fillMap()}getKeyMap(e){return this.has(e)?this.get(e).keyMap||{}:(Ce.w(this._n+".getKeyMap unknown P:"+e),{})}getProtocolData(e){const{P:t,data:s}=e,i=this.get(t);let o=null;if(s){const e=this._simpleDeepCopy(i),t=this._updateService(s,e),n=t.body,r=Object.create(null);for(const i in n)if(Object.prototype.hasOwnProperty.call(n,i)){if(r[i]=n[i],void 0===s[i])continue;r[i]=s[i]}t.body=r,o=this._getUplinkData(t)}else o=this._getUplinkData(i);return o}_getUplinkData(e){const t=this._dataCleaner(e),s=mt(t.head),i=zn(t.body,this._getReqKeyMap(s));return t.body=i,t}_updateService(i,o){var n=mt(o.head);if(this._isFromGroupRequest(o)){let{type:e,groupID:t,groupIDList:s=[]}=i;$e(t)&&(t=s[0]||""),nt({type:e,groupID:t})&&(o.head.servcmd=f.NAME.GRP_COMMUNITY+"."+n)}return o}_isFromGroupRequest(e){return e.head.servcmd.includes(f.NAME.GRP)||e.head.servcmd.includes(f.NAME.GRP_ATTR)}_getReqKeyMap(e){e=this.getKeyMap(e);return{...Hn.req,...e.req}}_dataCleaner(e){const t=Array.isArray(e)?[]:Object.create(null);for(const s in e)Object.prototype.hasOwnProperty.call(e,s)&&He(s)&&null!==e[s]&&void 0!==e[s]&&("object"!=typeof e[s]?t[s]=e[s]:t[s]=this._dataCleaner.bind(this)(e[s]));return t}_simpleDeepCopy(s){const i=Object.keys(s),o={};var n;for(let e=0,t=i.length;e<t;e++)n=i[e],be(s[n])?o[n]=Array.from(s[n]):we(s[n])?o[n]=this._simpleDeepCopy(s[n]):o[n]=s[n];return o}}const lo=[ti.MSG_PUSH_ACK];class uo{constructor(e){this._sessionM=e,this._n="MsgDispatcher",this._eventHandlerMap=new Map,this._eventHandlerMap.set("C2CMessageArray",this._onC2CMsgArray.bind(this)),this._eventHandlerMap.set("groupMessageArray",this._onGroupMsgArray.bind(this)),this._eventHandlerMap.set("groupTips",this._onGroupTips.bind(this)),this._eventHandlerMap.set("C2CNotifyMessageArray",this._onC2CNotifyMsgArray.bind(this)),this._eventHandlerMap.set("C2CReadReceiptArray",this._onC2CReadReceiptArray.bind(this)),this._eventHandlerMap.set("profileModify",this._onProfileModified.bind(this)),this._eventHandlerMap.set("friendListMod",this._onRelationChainModified.bind(this)),this._eventHandlerMap.set("recentContactMod",this._onRecentContact.bind(this)),this._eventHandlerMap.set("readAllC2CMessage",this._onAllMsgRead.bind(this)),this._eventHandlerMap.set("c2cMessageModified",this._onC2CMsgModified.bind(this)),this._eventHandlerMap.set("groupMessageModified",this._onGroupMsgModified.bind(this)),this._eventHandlerMap.set("userStatusList",this._onUserStatusList.bind(this)),this._eventHandlerMap.set("messageExtensionNotify",this._onMsgExtNotify.bind(this)),this._eventHandlerMap.set("messageReactionNotifyList",this._onMsgReactionNotifyList.bind(this)),this._eventHandlerMap.set("messageReactionNotify",this._onMsgReactionNotify.bind(this)),this._eventHandlerMap.set("followChangeList",this._onFollowNotify.bind(this)),this._keys=[...this._eventHandlerMap.keys()]}_onC2CMsgArray(e){const t=this._sessionM.get(Ms);e.dataList.forEach(e=>{var t;1===e.isSyncMessage&&(t=e.from,e.from=e.to,e.to=t)}),1===e.needSync&&this._sessionM.get(As).syncOnNeed(),t.onNewMessage({dataList:e.dataList,isInstantMessage:!0})}_onC2CMsgModified(e){this._sessionM.get(Ms).onMsgModified(e)}_onGroupMsgArray(e){const t=this._sessionM.get(Is);t&&t.onNewMessage({event:e.event,dataList:e.dataList,isInstantMessage:!0})}_onGroupMsgModified(e){const t=this._sessionM.get(Is);t&&t.onMsgModified(e)}_onGroupTips(e){const t=this._sessionM.get(Is);if(t){var{event:s,dataList:i,isInstantMessage:o=!0,isSyncingEnded:n}=e;switch(s){case 4:case 6:t.onNewGroupTips({event:s,dataList:i});break;case 5:for(let e=0;e<i.length;e++)if(be(i[e].elements.revokedInfos))t.onMsgRevoked({dataList:i});else if(be(i[e].elements.groupMessageReadNotice))t.onMsgReadNotice({dataList:i});else{if(!be(i[e].elements.readReceiptList)){t.onNewGroupSystemNotice({dataList:i,isInstantMessage:o,isSyncingEnded:n});break}t.onReadReceiptList({dataList:i})}break;case 12:this._sessionM.get(ys).onNewGroupAtTips({dataList:i});break;default:Ce.l(this._n+`._onGroupTips unknown event:${s} dataList:`,i)}}}_onC2CNotifyMsgArray(e){const t=e["dataList"];if(be(t)){const s=this._sessionM.get(Ms);t.forEach(e=>{if(Fe(e))if(e.hasOwnProperty("kickoutMsgNotify")){const{kickoutMsgNotify:{kickType:t,newInstanceInfo:s={}}}=e;1===t?this._sessionM.onMultipleAccountKickedOut(s):2===t?this._sessionM.onMultipleDeviceKickedOut(s):3===t&&this._sessionM.onRestApiKickedOut(s)}else e.hasOwnProperty("c2cMessageRevokedNotify")?s&&s.onMsgRevoked({dataList:t}):e.hasOwnProperty("c2cMessageReadReceipt")?s&&s.onMsgReadReceipt({dataList:t}):e.hasOwnProperty("c2cMessageReadNotice")?s&&s.onMsgReadNotice({dataList:t}):e.hasOwnProperty("muteNotificationsSync")&&this._sessionM.get(ys).onC2CMsgRemindTypeSynced({dataList:t})})}}_onC2CReadReceiptArray(e){this._sessionM.get(Ms).onReadReceiptList(e)}_onProfileModified(e){this._sessionM.get(fs).onProfileModified({dataList:e.dataList});const t=this._sessionM.get(Cs);t&&t.onFriendProfileModified({dataList:e.dataList})}_onRelationChainModified(e){this._sessionM.get(fs).onRelationChainModified({dataList:e.dataList});const t=this._sessionM.get(Cs);t&&t.onRelationChainModified({dataList:e.dataList})}_onRecentContact(e){const t=e["dataList"];if(be(t)){const n=this._sessionM.get(ys);n&&t.forEach(e=>{const t=e["pushType"];if(1===t){const t=e["recentContactDeleteItem"];n.onConvDeleted(t.recentContactList)}else if(2===t){const t=e["recentContactTopItem"];n.onConvPinnedStatus(t.recentContactList,!0)}else if(3===t){const t=e["recentContactTopItem"];n.onConvPinnedStatus(t.recentContactList,!1)}else if(4===t){const t=e["recentContactMarkContact"];n.onConvMarkUpdated(t.recentContactMarkContactItem)}else if(5===t){const t=e["recentContactCreateContactGroup"];n.onConvGroupCreated(t.msgContactGroupContactItem)}else if(6===t){const t=e["recentContactDelContactGroup"];n.onConvGroupDeleted(t.msgGroupItem)}else if(7===t){const t=e["recentContactUpdateContactGroup"],{updateType:s,msgUpdateGroup:i,msgUpdateContact:o}=t;if(1===s){const e=i["updateGroupType"];1===e?n.onConvGroupNameUpdated(i):2===e&&n.onConvInGroupUpdated(i)}else 2===s&&n.onConvAddedToOrDeletedFromGroup(o)}})}}_onAllMsgRead(e){const t=e["dataList"],s=this._sessionM.get(ys);s&&s.onPushedAllMessageRead(t)}_onUserStatusList(e){this._sessionM.get(fs).onUserStatusUpdated(e)}_onMsgExtNotify(e){this._sessionM.get(ms).onMsgExtNotify(e)}_onMsgReactionNotifyList(e){this._sessionM.get(Bs).onReactionNotifyList(e)}_onMsgReactionNotify(e){this._sessionM.get(Bs).onReactionNotify(e)}_onFollowNotify(e){this._sessionM.get(Ks).onFollowNotify(e)}_onTopicLatestMsg(e){this._sessionM.get(Ts).onTopicLatestMsg(e)}onMessage(s){var e=s["body"];if(this._filterMsgFromIMOpenPush(s)){var{eventArray:i,isInstantMessage:o,isSyncingEnded:n,needSync:r}=e;if(be(i)){var a,c,l;for(let e=0,t=i.length;e<t;e++)if(100!==(l=(a=i[e]).event))if(24!==l)if(26!==l){const s=Object.keys(a).find(e=>-1!==this._keys.indexOf(e));s?(c=14===l?{readAllC2CMessage:a[s],groupMessageReadInfoList:a.groupMessageReadNotice||[]}:16===l?{userID:a.userID,timestamp:a.timestamp,readReceiptList:a[s]}:a[s],this._eventHandlerMap.get(s)({event:l,dataList:c,isInstantMessage:o,isSyncingEnded:n,needSync:r})):Ce.l(this._n+".onMessage unknown eventItem:",a)}else this._onTopicLatestMsg(a);else this._onAllRcvMsgOptNotify(a);else this._onRoomCustomData(a.content)}}}_onRoomCustomData(e){this._sessionM.get($s).onRoomCustomDataReceived(e),Ce.l(this._n+"._onRoomCustomData data:"+e)}_onAllRcvMsgOptNotify(e){this._sessionM.get(ys).onAllRcvMsgOptNotify(e)}_filterMsgFromIMOpenPush(e){const{head:t,body:s}=e,i=t["servcmd"];let o=!1;if(!(o=$e(i)?o:i.includes(f.NAME.IM_CONFIG_MANAGER)||i.includes(f.NAME.OVERLOAD_PUSH)||i.includes(f.NAME.STAT_SERVICE)))return!0;if(i.includes(ti.PUSHED_CLOUD_CTRL_CONFIG))this._sessionM.get(Ps).onPushedConfig(s);else if(i.includes(ti.PUSHED_COMMERCIAL_CONFIG))this._sessionM.get(ws).onPushedConfig(s);else if(i.includes(ti.OVERLOAD_NOTIFY))this._sessionM.onPushedServerOverload(s);else if(i.includes(ti.KICK_OTHER)){const e=Date.now(),t=(this._sessionM.reLoginOnKickOther(),new mi("kickOther")),s=this._sessionM.get(ps).getLastWsHelloTs(),i=e-s;t.setMessage(`last wshello time:${s} diff:${i}ms`).end()}return!1}}const _o=[{cmd:ti.GET_GRP_PROFILE,interval:1,count:8},{cmd:ti.UPDATE_GRP_PROFILE,interval:1,count:8},{cmd:ti.GET_AV_MBR_LIST,interval:3,count:1},{cmd:ti.GET_GRP_PENDENCY,interval:1,count:15},{cmd:ti.GET_TOPIC_LIST,interval:1,count:10},{cmd:ti.SET_GRP_ATTR,interval:5,count:10},{cmd:ti.MODIFY_GRP_ATTR,interval:5,count:10},{cmd:ti.DEL_GRP_ATTR,interval:5,count:10},{cmd:ti.CLEAR_GRP_ATTR,interval:5,count:10},{cmd:ti.GET_GRP_ATTR,interval:5,count:20},{cmd:ti.UPDATE_GRP_COUNTER,interval:5,count:20},{cmd:ti.GET_GRP_COUNTER,interval:5,count:20},{cmd:ti.SET_ALL_MSG_READ,interval:1,count:1},{cmd:ti.GET_USER_STATUS,interval:5,count:20},{cmd:ti.SUB_USER_STATUS,interval:5,count:20},{cmd:ti.UNSUB_USER_STATUS,interval:5,count:20},{cmd:ti.MSG_CLOUD_SEARCH,interval:1,count:2},{cmd:ti.CHECK_FOLLOW_TYPE,interval:5,count:20},{cmd:ti.GET_GRP_ROAMING_MSG,interval:1,count:20},{cmd:ti.GET_C2C_ROAMING_MSG,interval:1,count:20}],ho=new Map,po=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];for(let e=0,t=po.length;e<t;e++)ho.set(e,po[e]);function go(s){let i,o,n=s,r="";for(let e=0,t=(n=s.length%8!=0?"0".repeat(8-s.length%8)+s:n).length;e<t;e+=8)i=parseInt(n.slice(e,e+4),2),o=parseInt(n.slice(e+4,e+8),2),r+=ho.get(i)+ho.get(o);return r}class mo extends ei{constructor(e){super(e),this._n="SessionModule",this._platform=this.getPlatform(),this._pHandler=new co(this),this._msgDispatcher=new uo(this),this._cmdFreqLimitMap=new Map,this._cmdReqInfoMap=new Map,this._serverOverloadInfoMap=new Map,this._incrementalPullContactFlag=!0,this._init(),this.getIEmitInst().on(Vi.CLOUD_CONFIG,this._onCloudConfig,this)}_init(){this._updateCmdFreqLimitMap(_o)}_onCloudConfig(){var e=this.getCloudConfig("cmd_frequency_limit");$e(e)||(e=JSON.parse(e),this._updateCmdFreqLimitMap(e))}_updateCmdFreqLimitMap(e){e.forEach(e=>{this._cmdFreqLimitMap.set(e.cmd,{interval:e.interval,count:e.count})})}updateProtocolConfig(){this._pHandler.update()}req(e){Ce.d(this._n+".req options:",e);var t=e["P"];if(!this._pHandler.has(t))return Ce.w(this._n+".req unknown P:"+t),Qs({code:js.NO_PROTOCOL});var e=this.getProtocolData(e),s=e.head["servcmd"];let i;if(this._isFreqOverLimit(s))return i=js.OVER_FREQUENCY_LIMIT,Qs({code:i,message:this.getErrMsg(i,this._getCmd(s))});if(this._isServerOverload(s))return i=js.OPEN_SERVICE_OVERLOAD_ERROR,Qs({code:i,message:this.getErrMsg(i,this._getCmd(s))});const o=this.get(Ns);return lo.includes(t)?o.simplySend(e):o.send(e)}getKeyMap(e){return this._pHandler.getKeyMap(e)}genCommonHead(){const e=this.get(vs);return{ver:"v4",platform:this._platform,websdkappid:a,websdkversion:r,a2:e.getA2Key()||void 0,tinyid:e.getTinyID()||void 0,status_instid:e.getStatusInstanceID(),sdkappid:e.getSDKAppID(),contenttype:e.getContentType(),reqtime:0,identifier:e.getA2Key()?void 0:e.getUserID(),usersig:e.getA2Key()?void 0:e.getUserSig(),sdkability:12775283,sdkability_ext:go(""),cappid:e.getApplicationID(),cs:0}}genCosSpecifiedHead(){const e=this.get(vs);return{ver:"v4",platform:this._platform,websdkappid:a,websdkversion:r,sdkappid:e.getSDKAppID(),contenttype:e.getContentType(),reqtime:0,identifier:e.getUserID(),usersig:e.getUserSig(),status_instid:e.getStatusInstanceID(),sdkability:12775283,sdkability_ext:go(""),cappid:e.getApplicationID(),cs:0}}genSSOReportHead(){const e=this.get(vs);return{ver:"v4",platform:this._platform,websdkappid:a,websdkversion:r,sdkappid:e.getSDKAppID(),contenttype:"",reqtime:0,identifier:"",usersig:"",status_instid:e.getStatusInstanceID(),sdkability:12775283,sdkability_ext:go(""),cappid:e.getApplicationID(),cs:0}}getProtocolData(e){return this._pHandler.getProtocolData(e)}trans(e){var{servcmd:e,data:t}=e,e={head:{...this.genCommonHead(),servcmd:e},body:t};return this.get(Ns).send(e)}sendComboMessage(e){var{servcmd:e,data:t}=e,e={head:{...this.genCommonHead(),servcmd:e},body:t};return this.get(Ns).send(e)}onErrorCodeNotZero(e){const t=e["errorCode"];if(t===js.HELLO_ANSWER_KICKED_OUT){const{kickType:t,newInstanceInfo:s={}}=e;1===t?this.onMultipleAccountKickedOut(s):2===t?this.onMultipleDeviceKickedOut(s):3===t&&this.onRestApiKickedOut(s)}t!==js.MSG_A2KEY_EXPIRED&&t!==js.ACCOUNT_A2KEY_EXPIRED||(this._onUserSigExpired(),this.get(Ns).reConnect())}onMessage(e){var t=e["body"],{needAck:t=0,sessionData:s}=t;1===t&&this._sendACK(s),this._msgDispatcher.onMessage(e)}onReconnected(e){this._incrementalPullContactFlag=e<=300,this._reLoginOnReconnected()}reLoginOnKickOther(){Ce.l(this._n+".reLoginOnKickOther"),this._reLogin()}_reLoginOnReconnected(){Ce.l(this._n+"._reLoginOnReconnected"),this._reLogin()}_reLogin(){const _=this._n+"._reLogin";if(this.isLoggedIn()){let e=0;const s=this.get(ps).getPushModule(),u=(s&&(e=s.getUniAppPlatform()),new mi("reLogin"));this.req({P:ti.LOGIN,data:{isWebUniapp:e,customInfo:this.get(vs).getCustomLoginInfo()}}).then(e=>{const{instanceID:s,customStatus:i}=e.data,o=this.get(vs),n=gn(i),r=(o.setStatusInstanceID(s),this.get(Ns)),a=`socketID:${r.getSocketID()} instanceID:${s} customStatus:`+n,c=(u.setMessage(a).end(!0),Ce.l(_+" ok. "+a),o.getCustomStatus()!==n&&this.get(fs).onUserStatusUpdated({dataList:[{to:this.getMyUserID(),statusType:t.USER_STATUS_ONLINE,customStatus:i}]}),r.diagnose(),this.get(ys).syncConvList(this._incrementalPullContactFlag).then(()=>{Ce.l(_+", sync conv list ok."),this.get(Gs).start()}),this.get(Is)),l=(c&&c.updateLocalMainSequenceOnReconnected(),this.get(Ts)),d=(l.resetGetTopicTime(),l.getTopicListOnReconnected(),this.get(Ks));d&&d.clearCacheOnReconnected()})}}onMultipleAccountKickedOut(e){this.get(ps).onMultipleAccountKickedOut(e)}onMultipleDeviceKickedOut(e){this.get(ps).onMultipleDeviceKickedOut(e)}_onUserSigExpired(){this.get(ps).onUserSigExpired()}onRestApiKickedOut(e){this.get(ps).onRestApiKickedOut(e)}_sendACK(e){this.req({P:ti.MSG_PUSH_ACK,data:{sessionData:e}})}_isFreqOverLimit(e){e=e.split(".")[1];if(!this._cmdFreqLimitMap.has(e))return!1;if(!this._cmdReqInfoMap.has(e))return this._cmdReqInfoMap.set(e,{startTime:Date.now(),requestCount:1}),!1;var{count:t,interval:s}=this._cmdFreqLimitMap.get(e),{startTime:i,requestCount:o}=this._cmdReqInfoMap.get(e);if(Date.now()-i>1e3*s)return this._cmdReqInfoMap.set(e,{startTime:Date.now(),requestCount:1}),!1;this._cmdReqInfoMap.set(e,{startTime:i,requestCount:o+=1});let n=t<o?!0:!1;return n}_isServerOverload(e){if(!this._serverOverloadInfoMap.has(e))return!1;var{overloadTime:t,waitingTime:s}=this._serverOverloadInfoMap.get(e);let i=!1;return i=Date.now()-t<=1e3*s||(this._serverOverloadInfoMap.delete(e),!1)}_getCmd(e){let t="";if(!e.includes("."))return t;var s=e.split(".")[1];for(const i in ti)if(ti[i]===s){t=i;break}return t}onPushedServerOverload(e){var{overloadCommand:e,waitingTime:t}=e;this._serverOverloadInfoMap.set(e,{overloadTime:Date.now(),waitingTime:t}),Ce.w(this._n+`.onPushedServerOverload waitingTime:${t}s cmd:`+this._getCmd(e))}reset(){Ce.l(this._n+".reset"),this._updateCmdFreqLimitMap(_o),this._cmdReqInfoMap.clear(),this._serverOverloadInfoMap.clear(),this._incrementalPullContactFlag=!0}}class fo extends ei{constructor(e){super(e),this._n="CloudControlModule",this._cloudConfig=new Map,this._expiredTime=0,this._version=0,this._isFetching=!1}getCloudConfig(e){return $e(e)?this._cloudConfig:this._cloudConfig.has(e)?this._cloudConfig.get(e):void 0}getServerConfig(e){const t={code:0,data:""};return!$e(e)&&this._cloudConfig.has(e)&&(t.data=this._cloudConfig.get(e)),Promise.resolve(t)}_canFetch(){return this.isLoggedIn()&&!this._isFetching&&Date.now()>=this._expiredTime}fetchConfig(){const i=this._n+".fetchConfig",e=this._canFetch();if(Ce.l(i+" canFetch:"+e),e){const o=new mi("fetchCloudCtrlConfig"),t=this.get(vs).getSDKAppID();this._isFetching=!0,this.req({P:ti.FETCH_CLOUD_CTRL_CONFIG,data:{SDKAppID:t,version:this._version}}).then(e=>{this._isFetching=!1;var{version:t,cloudControlConfig:s}=e.data;o.setMessage(`version:${this._version} newVersion:${t} config:`+s).end(),Ce.l(i+" ok"),this._parse(e.data)}).catch(e=>{this._isFetching=!1,o.setError(e).end(),Ce.l(i+" failed. error:",e),this._setExpiredTime(12e4)})}}onPushedConfig(e){Ce.l(this._n+".onPushedConfig config:",e),new mi("pushedCloudCtrlConfig").setMessage(`newVersion:${e.version} config:`+e.cloudControlConfig).end(),this._parse(e)}onCheckTimer(e){this._canFetch()&&this.fetchConfig()}_parse(e){var s=this._n+"._parse",{errorCode:t,errorMessage:i,cloudControlConfig:o,version:n,expiredTime:r}=e;if(0===t){if(this._version!==n){let t=null;try{t=JSON.parse(o)}catch(e){this.isPrivateNetWork()||Ce.e(s+" failed. config:",o)}t&&(this._cloudConfig.clear(),Object.keys(t).forEach(e=>{this._cloudConfig.set(e,t[e])}),this._version=n,this.emitIEvt(Vi.CLOUD_CONFIG))}this._setExpiredTime(1e3*r)}else $e(t)?(Ce.l(s+" failed. Invalid message format:",e),this._setExpiredTime(36e5)):(Ce.e(s+` errorCode:${t} errorMessage:`+i),this._setExpiredTime(12e4))}_setExpiredTime(e){this._expiredTime=Date.now()+e}reset(){Ce.l(this._n+".reset"),this._cloudConfig.clear(),this._expiredTime=0,this._version=0,this._isFetching=!1}}class Mo extends ei{constructor(e){super(e),this._n="RecoverMsgModule",this.PULL_LIMIT_COUNT=15}start(){this._recoverGroupChat(),this._recoverC2CChat()}_recoverGroupChat(){const e=this._getLocalConvList().filter(e=>e.type===t.CONV_GROUP&&e.groupProfile.type!==t.GRP_AVCHATROOM),o=this.get(ys);let n,r,a,c,l;const d=[];e.forEach(e=>{const{conversationID:s,lastMessage:i}=e;r=s.replace(t.CONV_GROUP,""),n=o.getLocalLastMessage(s),i&&0!==i.lastSequence&&n?(c=i.lastSequence,a=n.sequence,l=c-a,0<a&&1<=l&&l<300?this._recoverGroupMsg({groupID:r,localLastMessageSequence:a,remoteLastMessageSequence:c}):d.push(r)):d.push(r)}),this._getGroupNotice(d)}_recoverC2CChat(){const e=this._getLocalConvList().filter(e=>e.type===t.CONV_C2C),s=this.get(ys);let i,o,n,r;const a=[Promise.resolve()];e.forEach(e=>{var{conversationID:e,lastMessage:t}=e;i=s.getLocalLastMessage(e),t&&0!==t.lastTime&&i&&(n=t.lastTime,o=i.time,r=n-o,0<o&&1<=r&&r<=600&&a.push(this._recoverC2CMsg({conversationID:e,localLastMessageTime:o,remoteLastMessageTime:n})))}),Promise.all(a).then(()=>{Ce.l(this._n+"._recoverC2CChat all done"),this.get(As).syncOnReconnected()})}_getLocalConvList(){return this.get(ys).getLocalConvList()}_recoverGroupMsg(e){const c=this._n+"._recoverGroupMsg",{groupID:l,localLastMessageSequence:d,remoteLastMessageSequence:_}=(Ce.l(c+" options:",e),e),u=JSON.stringify(e),h=new mi("_recoverGroupMsg");h.setMessage(u),this._getGroupRoamingMsg({groupID:l,sequence:d}).then(o=>{const{complete:e,messageList:n}=o.data;if(!$e(n)){const o=n[0].sequence,s=n.map(e=>e.sequence),r=u+` complete:${e} sequenceList:`+s,a=(Ce.l(c+" "+r),o!==d&&o<_&&2!==e&&this._recoverGroupMsg({groupID:l,localLastMessageSequence:o,remoteLastMessageSequence:_}),h.setMessage(r).end(),this.get(Is));1<n.length&&n.sort((e,t)=>e.sequence-t.sequence);let i=!1;for(let e=0,s=n.length;e<s;e++)if(n[e].from===t.CONV_SYSTEM){i=!0;break}if(i)for(let e=0,s=n.length;e<s;e++){const o=n[e];o.from!==t.CONV_SYSTEM?a.onNewMessage({dataList:[o],isInstantMessage:!1,updateUnreadCount:!1}):a.onNewGroupTips({event:o.event,dataList:[o]})}else a.onNewMessage({dataList:n,isInstantMessage:!1,updateUnreadCount:!1})}}).catch(e=>{h.setError(e).end(),Ce.w(c+" failed. error:",e)})}_getGroupNotice(s){var e=s.length;if(Ce.l(this._n+"._getGroupNotice length:"+e),0!==e){const i=this.get(Is);if(e<=10)i.getNotice(s);else{let t=Math.floor(e/10);5<=t&&(t=5);for(let e=0;e<=t;e++)i.getNotice(s.slice(10*e,10*(e+1)))}}}_getGroupRoamingMsg(e){var{groupID:e,sequence:t}=e;return this.req({P:ti.GET_GRP_ROAMING_MSG,data:{groupID:e,count:this.PULL_LIMIT_COUNT,sequence:t+this.PULL_LIMIT_COUNT-1}})}_recoverC2CMsg(e){const n=this._n+"._recoverC2CMsg",{conversationID:r,localLastMessageTime:t,remoteLastMessageTime:a}=(Ce.l(n+" options:",e),e),c=JSON.stringify(e),l=new mi("_recoverC2CMsg");return l.setMessage(c),this._getC2CRoamingMsg({conversationID:r,time:t}).then(e=>{const{complete:t,messageList:s}=e.data;if(!$e(s)){const e=s.length;this.get(Ms).onNewMessage({dataList:s,isInstantMessage:!0});var i=s[e-1].time,o=s.map(e=>e.random),o=c+` complete:${t} randomList:`+o;if(Ce.l(n+" "+o),l.setMessage(o).end(),i<a&&1!==t)return this._recoverC2CMsg({conversationID:r,localLastMessageTime:i,remoteLastMessageTime:a})}}).catch(e=>{l.setError(e).end(),Ce.w(n+" failed. error:",e)})}_getC2CRoamingMsg(e){const{conversationID:s,time:i}=e;return this.req({P:ti.GET_C2C_ROAMING_MSG,data:{peerAccount:s.replace(t.CONV_C2C,""),count:this.PULL_LIMIT_COUNT+1,lastMessageTime:i,direction:1}})}reset(){Ce.l(this._n+".reset")}}class Io{constructor(){this._n="AvgE2EDelay",this._e2eDelayArray=[]}addMessageDelay(e){e=me()-e;0<=e&&this._e2eDelayArray.push(e)}_calcAvg(e,t){if(0===t)return 0;let s=0;return e.forEach(e=>{s+=e}),ft(s/t,1)}_calcCountWithLimit(e){const{e2eDelayArray:t,min:s,max:i}=e;return t.filter(e=>s<=e&&e<i).length}_calcPercent(e,t){let s=ft(e/t*100,2);return s=100<s?100:s}_checkE2EDelayException(e,t){var s=e.filter(e=>t<e);if(0<s.length){const t=s.length,i=Math.min(...s),o=Math.max(...s),n=this._calcAvg(s,t),r=ft(t/e.length*100,2);50<r&&new mi("messageE2EDelayException").setMessage(`count:${t} min:${i} max:${o} avg:${n} percent:`+r).setLevel("warning").end()}}getStatResult(){var e=this._e2eDelayArray.length;if(0===e)return null;const t=[...this._e2eDelayArray],s=this._calcCountWithLimit({e2eDelayArray:t,min:0,max:1}),i=this._calcCountWithLimit({e2eDelayArray:t,min:1,max:3}),o=this._calcPercent(s,e),n=this._calcPercent(i,e),r=this._calcAvg(t,e);return this._checkE2EDelayException(t,3),t.length=0,this.reset(),{totalCount:e,countLessThan1Second:s,percentOfCountLessThan1Second:o,countLessThan3Second:i,percentOfCountLessThan3Second:n,avgDelay:r}}reset(){this._e2eDelayArray.length=0}}class Co{constructor(){this._n="AvgRTT",this._requestCount=0,this._rttArray=[]}addRequestCount(){this._requestCount+=1}addRTT(e){this._rttArray.push(e)}_calcTotalCount(){return this._requestCount}_calcRTTCount(e){return e.length}_calcSuccessRateOfRequest(e,t){if(0===t)return 0;let s=ft(e/t*100,2);return s=100<s?100:s}_calcAvg(e,t){if(0===t)return 0;let s=0;return e.forEach(e=>{s+=e}),parseInt(s/t)}_calcMax(){return Math.max(...this._rttArray)}_calcMin(){return Math.min(...this._rttArray)}getStatResult(){var e=this._calcTotalCount(),t=[...this._rttArray];if(0===e)return null;var s=this._calcRTTCount(t),i=this._calcSuccessRateOfRequest(s,e),t=this._calcAvg(t,s);return Ce.l(`${this._n}.getStatResult max:${this._calcMax()} min:${this._calcMin()} avg:`+t),this.reset(),{totalCount:e,rttCount:s,successRateOfRequest:i,avgRTT:t}}reset(){this._requestCount=0,this._rttArray.length=0}}class To{constructor(){this._map=new Map}initMap(e){e.forEach(e=>{this._map.set(e,{totalCount:0,successCount:0,failedCountOfUserSide:0,costArray:[],fileSizeArray:[]})})}addTotalCount(e){return!($e(e)||!this._map.has(e)||(this._map.get(e).totalCount+=1,0))}addSuccessCount(e){return!($e(e)||!this._map.has(e)||(this._map.get(e).successCount+=1,0))}addFailedCountOfUserSide(e){return!($e(e)||!this._map.has(e)||(this._map.get(e).failedCountOfUserSide+=1,0))}addCost(e,t){return!($e(e)||!this._map.has(e)||(this._map.get(e).costArray.push(t),0))}addFileSize(e,t){return!($e(e)||!this._map.has(e)||(this._map.get(e).fileSizeArray.push(t),0))}_calcSuccessRateOfBusiness(e){if($e(e)||!this._map.has(e))return-1;e=this._map.get(e);let t=ft(e.successCount/e.totalCount*100,2);return t=100<t?100:t}_calcSuccessRateOfPlatform(e){if($e(e)||!this._map.has(e))return-1;var t=this._map.get(e);let s=this._calcSuccessCountOfPlatform(e)/t.totalCount*100;return s=100<(s=ft(s,2))?100:s}_calcTotalCount(e){return $e(e)||!this._map.has(e)?-1:this._map.get(e).totalCount}_calcSuccessCountOfBusiness(e){return $e(e)||!this._map.has(e)?-1:this._map.get(e).successCount}_calcSuccessCountOfPlatform(e){if($e(e)||!this._map.has(e))return-1;e=this._map.get(e);return e.successCount+e.failedCountOfUserSide}_calcAvg(e){return $e(e)||!this._map.has(e)?-1:e===ci?this._calcAvgSpeed(e):this._calcAvgCost(e)}_calcAvgCost(e){var t=this._map.get(e).costArray.length;if(0===t)return 0;let s=0;return this._map.get(e).costArray.forEach(e=>{s+=e}),parseInt(s/t)}_calcAvgSpeed(e){let t=0,s=0;return this._map.get(e).costArray.forEach(e=>{t+=e}),this._map.get(e).fileSizeArray.forEach(e=>{s+=e}),parseInt(1e3*s/t)}getStatResult(e){var t=this._calcTotalCount(e);if(0===t)return null;var s=this._calcSuccessCountOfBusiness(e),i=this._calcSuccessRateOfBusiness(e),o=this._calcSuccessCountOfPlatform(e),n=this._calcSuccessRateOfPlatform(e),r=this._calcAvg(e);return this.reset(e),{totalCount:t,successCountOfBusiness:s,successRateOfBusiness:i,successCountOfPlatform:o,successRateOfPlatform:n,avgValue:r}}reset(e){$e(e)?this._map.clear():this._map.set(e,{totalCount:0,successCount:0,failedCountOfUserSide:0,costArray:[],fileSizeArray:[]})}}class yo{constructor(){this._lastMap=new Map,this._currentMap=new Map}initMap(e){e.forEach(e=>{this._lastMap.set(e,new Map),this._currentMap.set(e,new Map)})}addMessageSequence(e){const{key:s,message:i}=e;if($e(s)||!this._lastMap.has(s)||!this._currentMap.has(s))return!1;const{conversationID:o,sequence:n}=i,r=o.replace(t.CONV_GROUP,"");if(0===this._lastMap.get(s).size)this._addCurrentMap(e);else if(this._lastMap.get(s).has(r)){const t=this._lastMap.get(s).get(r),i=t.length-1;n>t[0]&&n<t[i]?(t.push(n),t.sort(),this._lastMap.get(s).set(r,t)):this._addCurrentMap(e)}else this._addCurrentMap(e);return!0}_addCurrentMap(e){const{key:s,message:i}=e,{conversationID:o,sequence:n}=i,r=o.replace(t.CONV_GROUP,"");this._currentMap.get(s).has(r)||this._currentMap.get(s).set(r,[]),this._currentMap.get(s).get(r).push(n)}_copyData(t){if(!$e(t)){this._lastMap.set(t,new Map);let e=this._lastMap.get(t);for(var[s,i]of this._currentMap.get(t))e.set(s,i);e=null,this._currentMap.set(t,new Map)}}getStatResult(e){if($e(this._currentMap.get(e))||$e(this._lastMap.get(e)))return null;if(0===this._lastMap.get(e).size)return this._copyData(e),null;let i=0,o=0;if(this._lastMap.get(e).forEach((e,t)=>{var e=[...e.values()],s=e.length;i+=e[s-1]-e[0]+1,o+=s}),0===i)return null;let t=ft(o/i*100,2);return 100<t&&(t=100),this._copyData(e),{totalCount:i,successCountOfMessageReceived:o,successRateOfMessageReceived:t}}reset(){this._currentMap.clear(),this._lastMap.clear()}}class vo extends ei{constructor(e){super(e),this._n="QualityStatModule",this.TAG="im-ssolog-quality-stat",this.reportIndex=0,this.wholePeriod=!1,this._qualityItems=[si,ii,ni,oi,ri,ai,ci,li,ui,di],this._messageSentItems=[ni,oi,ri,ai,ci],this._messageReceivedItems=[li,ui,di],this.REPORT_INTERVAL=120,this.REPORT_SDKAPPID_BLACKLIST=[],this.REPORT_TINYID_WHITELIST=[],this._statInfoArr=[],this._avgRTT=new Co,this._avgE2EDelay=new Io,this._rateMessageSent=new To,this._rateMessageReceived=new yo;const t=this.getIEmitInst();t.on(Vi.A2KEY_AND_TINYID_UPDATED,this._onLoginSuccess,this),t.on(Vi.CLOUD_CONFIG,this._onCloudConfig,this)}_onLoginSuccess(){this._rateMessageSent.initMap(this._messageSentItems),this._rateMessageReceived.initMap(this._messageReceivedItems);const e=this.get(Es),t=e.getItem(this.TAG,!1);!Oe(t)&&xe(t.forEach)&&(Ce.l(this._n+"._onLoginSuccess. logs count:"+t.length),t.forEach(e=>{this._statInfoArr.push(e)}),e.removeItem(this.TAG,!1))}_onCloudConfig(){const e=this.getCloudConfig("q_rpt_interval"),t=this.getCloudConfig("q_rpt_sdkappid_bl"),s=this.getCloudConfig("q_rpt_tinyid_wl");$e(e)||(this.REPORT_INTERVAL=Number(e)),$e(t)||(this.REPORT_SDKAPPID_BLACKLIST=t.split(",").map(e=>Number(e))),$e(s)||(this.REPORT_TINYID_WHITELIST=s.split(","))}onCheckTimer(e){this.isLoggedIn()&&e%this.REPORT_INTERVAL==0&&(this.wholePeriod=!0,this._report())}addRequestCount(){this._avgRTT.addRequestCount()}addRTT(e){this._avgRTT.addRTT(e)}addMessageDelay(e){this._avgE2EDelay.addMessageDelay(e)}addTotalCount(e){this._rateMessageSent.addTotalCount(e)||Ce.w(this._n+".addTotalCount invalid key:",e)}addSuccessCount(e){this._rateMessageSent.addSuccessCount(e)||Ce.w(this._n+".addSuccessCount invalid key:",e)}addFailedCountOfUserSide(e){this._rateMessageSent.addFailedCountOfUserSide(e)||Ce.w(this._n+".addFailedCountOfUserSide invalid key:",e)}addCost(e,t){this._rateMessageSent.addCost(e,t)||Ce.w(this._n+".addCost invalid key or cost:",e,t)}addFileSize(e,t){this._rateMessageSent.addFileSize(e,t)||Ce.w(this._n+".addFileSize invalid key or size:",e,t)}addMessageSequence(e){this._rateMessageReceived.addMessageSequence(e)||Ce.w(this._n+".addMessageSequence invalid key:",e.key)}_getQualityItem(e){let t={},s=pi[this.get(Ds).getNetworkType()];$e(s)&&(s=8);var i={qualityType:_i[e],timestamp:pe(),networkType:s,extension:""};switch(e){case si:t=this._avgRTT.getStatResult();break;case ii:t=this._avgE2EDelay.getStatResult();break;case ni:case oi:case ri:case ai:case ci:t=this._rateMessageSent.getStatResult(e);break;case li:case ui:case di:t=this._rateMessageReceived.getStatResult(e)}return null===t?null:{...i,...t}}_report(e){let t=[],s=null;$e(e)?this._qualityItems.forEach(e=>{null!==(s=this._getQualityItem(e))&&(s.reportIndex=this.reportIndex,s.wholePeriod=this.wholePeriod,t.push(s))}):null!==(s=this._getQualityItem(e))&&(s.reportIndex=this.reportIndex,s.wholePeriod=this.wholePeriod,t.push(s)),Ce.d(this._n+"._report",t),0<this._statInfoArr.length&&(t=t.concat(this._statInfoArr),this._statInfoArr=[]);const i=this.get(vs),o=i.getSDKAppID(),n=i.getTinyID();0<(t=Mt(this.REPORT_SDKAPPID_BLACKLIST,o)&&!It(this.REPORT_TINYID_WHITELIST,n)?[]:t).length&&this._doReport(t)}_doReport(t){var e={header:En(this),quality:t};this.req({P:ti.SSO_STAT,data:{...e}}).then(()=>{this.reportIndex++,this.wholePeriod=!1}).catch(e=>{Ce.w(this._n+"._doReport failed. error:",e),this._statInfoArr=this._statInfoArr.concat(t),this._flushAtOnce()})}_flushAtOnce(){const t=this.get(Es),s=t.getItem(this.TAG,!1),i=this._statInfoArr,o=this._n+"._flushAtOnce";if(Oe(s))Ce.l(o+" count:"+i.length),t.setItem(this.TAG,i,!0,!1);else{let e=i.concat(s);10<e.length&&(e=e.slice(0,10)),Ce.l(o+" count:"+e.length),t.setItem(this.TAG,e,!0,!1)}this._statInfoArr=[]}reset(){Ce.l(this._n+".reset"),this._report(),this.reportIndex=0,this.wholePeriod=!1,this.REPORT_SDKAPPID_BLACKLIST=[],this.REPORT_TINYID_WHITELIST=[],this._avgRTT.reset(),this._avgE2EDelay.reset(),this._rateMessageSent.reset(),this._rateMessageReceived.reset()}}class Eo extends ei{constructor(e){super(e),this._n="WorkerTimerModule",this._isWorkerEnabled=!0,this._workerTimer=null,this._timerID=-1,this._init(),this.getIEmitInst().on(Vi.CLOUD_CONFIG,this._onCloudConfig,this)}isWorkerEnabled(){return this._isWorkerEnabled&&ie}startWorkerTimer(){Ce.l(this._n+".startWorkerTimer"),this._workerTimer&&this._workerTimer.postMessage("start")}stopWorkerTimer(){Ce.l(this._n+".stopWorkerTimer"),this._workerTimer&&this._workerTimer.postMessage("stop")}_init(){if(ie){var e=URL.createObjectURL(new Blob(['let interval = -1;onmessage = function(event) {  if (event.data === "start") {    if (interval > 0) {      clearInterval(interval);    }    interval = setInterval(() => {      postMessage("");    }, 1000);    postMessage(interval);  } else if (event.data === "stop") {    clearInterval(interval);    interval = -1;  }};'],{type:"application/javascript; charset=utf-8"}));this._workerTimer=new Worker(e);const t=this;this._workerTimer.onmessage=function(e){e.data?(t._timerID=e.data,Ce.l(t._n+"._init seed:"+t._timerID)):t._m.onCheckTimer()}}}_onCloudConfig(){var e=this.getCloudConfig("enable_worker");Ce.l(this._n+"._onCloudConfig enableWorker:"+e),$e(e)||"1"===e?!this._isWorkerEnabled&&ie&&(this._isWorkerEnabled=!0,this.startWorkerTimer(),this._m.onWorkerTimerEnabled()):this._isWorkerEnabled&&ie&&(this._isWorkerEnabled=!1,this.stopWorkerTimer(),this._m.onWorkerTimerDisabled())}terminate(){Ce.l(this._n+".terminate"),this._workerTimer&&(this._workerTimer.terminate(),this._workerTimer=null,this._timerID=-1)}getTimerID(){return this._timerID}reset(){Ce.l(this._n+".reset")}}class So{constructor(e){this._commercialConfigM=e,this._n="PurchasedFeatureHandler",this._isSCMReported=!1,this._featureMap=new Map}isValidPurchaseBits(e){return e&&"string"==typeof e&&1<=e.length&&e.length<=64&&/[01]{1,64}/.test(e)}parsePurchaseBits(s){if(this.isValidPurchaseBits(s)){this._featureMap.clear();var o;for(let e=s.length-1,t=0;0<=e;e--,t++)o=(t<32?new i(0,Math.pow(2,t)):new i(Math.pow(2,t-32),0)).toString(),"1"===s[e]?this._featureMap.set(o,!0):this._featureMap.set(o,!1)}else Ce.w(this._n+".parsePurchaseBits invalid purchasebits:"+s)}hasPurchasedFeature(e){return!!this._featureMap.get(e)}isFeatureEnabled(e){const s=parseInt(e).toString(2);let o=void 0,n=!0;for(let e=s.length-1,t=0;0<=e;e--,t++)if("1"===s.charAt(e)&&(o=(t<32?new i(0,Math.pow(2,t)):new i(Math.pow(2,t-32),0)).toString(),!this._featureMap.get(o))){n=!1;break}return Ce.l(`${this._n}.isFeatureEnabled decimalNumber:${e} key:${o} ret:`+n),Zs({enabled:n})}isFeatureEnabledForStat(e){const s=parseInt(e).toString(2);let o=void 0;for(let e=s.length-1,t=0;0<=e;e--,t++)if("1"===s.charAt(e)){if(o=(t<32?new i(0,Math.pow(2,t)):new i(Math.pow(2,t-32),0)).toString(),!this._featureMap.get(o))break;{let e="",t=0;if(o===M.PLUGIN_TRANSLATE?(e="plugin_translate",t=16):o===M.PLUGIN_VOICE_TO_TEXT?(e="plugin_voice_to_text",t=17):o===M.PLUGIN_CS?(e="plugin_cs",t=14):o===M.PLUGIN_PUSH?(e="plugin_push",t=13):o===M.PLUGIN_BOT?(e="plugin_bot",t=15):o===M.MSG_REACTION&&(e="plugin_emoji_reaction",t=18),""!==e){const o=this._commercialConfigM.get(vs).getUIPlatform();new mi(e).setCode(t).setUIPlatform(o).end(),Ce.l(`${this._n}.isFeatureEnabledForStat ${e} code:${t} uiPlatform:`+o)}}}}isSearchCloudMessagesEnabled(){var e;this._isSCMReported||(e=this._commercialConfigM.get(vs).getUIPlatform(),new mi("plugin_search").setCode(6).setUIPlatform(e).end(),this._isSCMReported=!0)}clear(){this._featureMap.clear(),this._isSCMReported=!1}}class Do{constructor(e){this._m=e,this._n="CommercialConfigModule",this._expiredTime=0,this._isFetching=!1,this._purchasedFeatureHandler=new So(this)}_canFetch(){return this.get(vs).isLoggedIn()?!this._isFetching&&Date.now()>=this._expiredTime:(this._expiredTime=Date.now()+2e3,!1)}onCheckTimer(e){this._canFetch()&&this.fetchConfig()}fetchConfig(){const e=this._canFetch(),t=this._n+".fetchConfig";if(Ce.l(t+" canFetch:"+e),e){const s=new mi("fetchCommercialConfig"),i=this.get(vs).getSDKAppID(),o=this.get(Os);this._isFetching=!0,o.req({P:ti.FETCH_COMMERCIAL_CONFIG,data:{SDKAppID:i}}).then(e=>{s.setMessage("purchaseBits:"+e.data.purchaseBits).end(),Ce.l(t+" ok."),this._parseConfig(e.data),this._isFetching=!1}).catch(e=>{s.setError(e).end(),this._isFetching=!1})}}onPushedConfig(e){var t=this._n+".onPushedConfig data:"+JSON.stringify(e);Ce.l(t),new mi("pushedCommercialConfig").setMessage("purchaseBits:"+e.purchaseBits).end(),this._parseConfig(e)}_parseConfig(e){var t=this._n+"._parseConfig",{errorCode:s,errorMessage:i,purchaseBits:o,expiredTime:n}=e;0===s?(this._purchasedFeatureHandler.parsePurchaseBits(o),this._expiredTime=Date.now()+1e3*n):$e(s)?(Ce.l(t+" failed. Invalid message format:",e),this._setExpiredTimeOnResponseError(36e5)):(Ce.e(t+` errorCode:${s} errorMessage:`+i),this._setExpiredTimeOnResponseError(12e4))}_setExpiredTimeOnResponseError(e){this._expiredTime=Date.now()+e}canIUse(e){return this._purchasedFeatureHandler.hasPurchasedFeature(e)}isFeatureEnabled(e){return this._purchasedFeatureHandler.isFeatureEnabled(e)}isFeatureEnabledForStat(e){this._purchasedFeatureHandler.isFeatureEnabledForStat(e)}isSearchCloudMessagesEnabled(){this._purchasedFeatureHandler.isSearchCloudMessagesEnabled()}get(e){return this._m.get(e)}reset(){Ce.l(this._n+".reset"),this._expiredTime=0,this._isFetching=!1,this._purchasedFeatureHandler.clear()}}class Ro extends ei{constructor(e){super(e),this._m=e,this._n="OfflinePushModule",this._offlinePushPlugin=void 0,this._androidPushConfig={huaweiPushBussinessId:"",xiaomiPushBussinessId:"",xiaomiPushAppId:"",xiaomiPushAppKey:"",meizuPushBussinessId:"",meizuPushAppId:"",meizuPushAppKey:"",vivoPushBussinessId:"",fcmPushBussinessId:"",oppoPushBussinessId:"",oppoPushAppKey:"",oppoPushAppSecret:"",honorPushBussinessId:""},this._deviceToken="",this._businessID=0,this._iosBusinessID=0,this._c2cUnreadCount=0,this._groupUnreadCount=0,this._isWebUniapp=0}registerPlugin(e){var t,s,i,o,n,r,a,c,l,d,_,u,h;P?(this._offlinePushPlugin=e["tim-offline-push-plugin"],{huaweiBusinessID:t,xiaomiBusinessID:s,xiaomiAppID:i,xiaomiAppKey:o,meizuBusinessID:n,meizuAppID:r,meizuAppKey:a,vivoBusinessID:c,oppoBusinessID:l,oppoAppKey:d,oppoAppSecret:_,honorBusinessID:u,iosBusinessID:h}=e.offlinePushConfig||{},this._androidPushConfig.huaweiPushBussinessId=t,this._androidPushConfig.xiaomiPushBussinessId=s,this._androidPushConfig.xiaomiPushAppId=i,this._androidPushConfig.xiaomiPushAppKey=o,this._androidPushConfig.meizuPushBussinessId=n,this._androidPushConfig.meizuPushAppId=r,this._androidPushConfig.meizuPushAppKey=a,this._androidPushConfig.vivoPushBussinessId=c,this._androidPushConfig.oppoPushBussinessId=l,this._androidPushConfig.oppoPushAppKey=d,this._androidPushConfig.oppoPushAppSecret=_,this._androidPushConfig.honorPushBussinessId=u,new mi("registerPlugin").setMessage("tim-offline-push-plugin").setMoreMessage("isExist:"+!$e(this._offlinePushPlugin)).end(!0),Ce.l(this._n+".registerPlugin ok. offlinePushConfig:"+JSON.stringify(e.offlinePushConfig)),this._iosBusinessID=h,this._setAppShowListener()):this.warn("OfflinePushInUniapp")}init(){this._isWebUniapp=this.getUniAppPlatform(),this._getDeviceToken()}_getDeviceToken(){const a=this._n+"._getDeviceToken";if(xe(this._offlinePushPlugin.getDeviceToken)){let r=`androidPushConfig:${JSON.stringify(this._androidPushConfig)}, iosBusinessID:`+this._iosBusinessID;Ce.l(a+" start. "+r),new mi("_getDeviceToken").setMessage(r).end(!0),this._offlinePushPlugin.getDeviceToken(this._androidPushConfig,e=>{const t=new mi("getDeviceTokenRes"),{code:s,msg:i}=e;if(0===s){const{deviceToken:s,deviceBrand:i,deviceType:o,bussinessId:n}=e.data;this._deviceToken=s,this._businessID=n||this._iosBusinessID,r=`deviceToken:${s}, deviceBrand:${i||o}, businessID:`+this._businessID,Ce.l(a+" ok. "+r),t.setMessage(r).end(!0),this._setToken()}else t.setMessage(`code:${s}, msg:`+i).end(!0),Ce.e(a+" failed. error:",e)})}else Ce.e(a+" getDeviceToken is not a function")}canIUseOfflinePush(){return P&&!$e(this._offlinePushPlugin)}_setAppShowListener(){const t=this._n+"._setAppShowListener";$e(this._offlinePushPlugin)?Ce.e(t+" offlinePushPlugin is undefined"):xe(this._offlinePushPlugin.setAppShowListener)?(new mi("_setAppShowListener").end(!0),Ce.l(t+" start"),this._offlinePushPlugin.setAppShowListener(e=>{e=(e||{}).appShow;new mi("setAppShowListenerRes").setMessage("appShow:"+e).end(!0),Ce.l(t+" ok. appShow:"+e),this._m.isReady()&&(0===e?(this._getConvUnreadCount(),this._onBackground()):1===e&&this._onForeground())})):Ce.e(t+" setAppShowListener is not a function")}getDeviceBrand(){var e;if(!$e(this._offlinePushPlugin)&&xe(this._offlinePushPlugin.getDeviceType))return e=(this._offlinePushPlugin.getDeviceType()||{})["deviceType"],Ce.l(this._n+".getDeviceBrand ok. deviceType:"+e),e}_setToken(){const t=this._n+"._setToken",e=this.get(vs);let s,i=1,n="",r="";Oe(this._deviceToken)&&(i=0);var a=this.getUniAppPlatform(),c=this.getDeviceBrand();a===o.IOS||a===o.IPAD||a===o.MAC?r=this._deviceToken:a===o.ANDROID&&(n=this._deviceToken);const l=new mi("offlinePushSetToken");return s=`deviceToken:${r||n}, businessID:${this._businessID}, deviceBrand:${c}, isWebUniapp:${this._isWebUniapp}, pushMsg:${i}, platform:`+a,l.setMessage(s),Ce.l(t+" "+s),this.req({P:ti.SET_TOKEN,data:{tokenID:n,pushMsg:i,sdkAppID:e.getSDKAppID(),businessID:parseInt(this._businessID),deviceBrand:c,deviceToken:r,isWebUniapp:this._isWebUniapp}}).then(e=>(l.end(),Ce.l(t+" ok"),e)).catch(e=>(l.setError(e).end(),Ce.e(t+" failed. error:",e),Qs(e)))}_getConvUnreadCount(){this._c2cUnreadCount=0,this._groupUnreadCount=0,this.get(ys).getLocalConvList().forEach(e=>{e.type===t.CONV_C2C&&(this._c2cUnreadCount+=e.unreadCount),e.type===t.CONV_GROUP&&(this._groupUnreadCount+=e.unreadCount)})}_onBackground(){const t=this._n+"._onBackground",s=new mi("_onBackground");this.req({P:ti.STAT_BACKGROUND,data:{c2cUnreadCount:this._c2cUnreadCount,groupUnreadCount:this._groupUnreadCount,isWebUniapp:this._isWebUniapp}}).then(e=>(s.setMessage(`c2cUnreadCount: ${this._c2cUnreadCount}, groupUnreadCount: `+this._groupUnreadCount).end(),Ce.l(t+" ok"),e)).catch(e=>{s.setError(e).end(),Ce.e(t+" failed. error:",e)})}_onForeground(){const t=this._n+"._onForeground",s=new mi("_onForeground");this.req({P:ti.STAT_FOREGROUND,data:{isWebUniapp:this._isWebUniapp}}).then(e=>(s.end(),Ce.l(t+" ok"),e)).catch(e=>{s.setError(e).end(),Ce.e(t+" failed. error:",e)})}getUniAppPlatform(){var e=uni.getSystemInfoSync().platform,t=this.getDeviceBrand();return"ios"===e?o.IOS:"android"===e?o.ANDROID:1002===t?o.IPAD:1001===t?o.MAC:void 0}reset(){this._deviceToken="",this._businessID=0,this._c2cUnreadCount=0,this._groupUnreadCount=0,this._isWebUniapp=0,Ce.l(this._n+".reset")}}class Lo extends ei{constructor(e){super(e),this._m=e,this._n="TIMPushModule",this._pluginName="TIMPush",this._pushPlugin=void 0,this._androidPushConfig={},this._deviceToken="",this._businessID=0,this._iOSBusinessID=0,this._c2cUnreadCount=0,this._groupUnreadCount=0,this._isWebUniapp=0,this._deviceInfo={notificationStatus:0,deviceModel:"",systemVersion:"",pushVersion:"1.0.1",packageName:""}}registerPlugin(e){var t,s,i;P?(t=this._n+".registerPlugin",{androidConfig:s,iOSConfig:i}=(this._pushPlugin=e["tim-push"],this._getDeviceInfo(),e.pushConfig||{}),we(s)&&(this._androidPushConfig=s[this._deviceInfo.packageName]),s=(i||{}).iOSBusinessID,this._iOSBusinessID=s,i=!$e(this._pushPlugin),new mi("registerPlugin").setMessage(this._pluginName).setMoreMessage("isExisted:"+i).end(!0),Ce.l(t+" ok. pushConfig:"+JSON.stringify(e.pushConfig)),i?(this._setAppShowListener(),this._setPushEventReportListener()):Ce.e(t+` ${this._pluginName} is undefined`)):this.warn("TIMPushInUniapp")}init(){this._isWebUniapp=this.getUniAppPlatform(),this._reportEventCacheList(),this._getDeviceToken(),this.get(ws).isFeatureEnabledForStat(Math.pow(2,41))}_reportEventCacheList(){const r=this._n+"._reportEventCacheList";xe(this._pushPlugin.getPushEventCacheList)?(new mi("_reportEventCacheList").end(!0),this._pushPlugin.getPushEventCacheList(e=>{const{code:t,data:{eventList:s}}=e,i=new mi("getPushEventCacheListRes");if(i.setCode(t),0!==t)i.setMessage("res:"+JSON.stringify(e)).end(!0),Ce.e(r+" failed. error:"+JSON.stringify(e));else{var o=s.length<10?"eventList:"+JSON.stringify(s):"eventList.length:"+s.length;Ce.l(r+" ok. "+o),i.setMessage(o).end(!0);const n={...e.data,eventList:[]};for(;0<s.length;)n.eventList=s.splice(0,40),this._pushReport(n)}})):Ce.e(this._pluginName+".getPushEventCacheList is not a function")}_getDeviceToken(){const a=this._n+"._getDeviceToken";if(xe(this._pushPlugin.getDeviceToken)){let r=`androidPushConfig:${JSON.stringify(this._androidPushConfig)} iOSBusinessID:`+this._iOSBusinessID;Ce.l(a+" start. "+r),new mi("_getDeviceToken").setMessage(r).end(!0),this._pushPlugin.getDeviceToken(this._androidPushConfig,e=>{const{code:t,msg:s}=e,i=new mi("getDeviceTokenRes");if(i.setCode(t),0===t){const{deviceToken:t,deviceBrand:s,deviceType:o,bussinessId:n}=e.data;return this._deviceToken=t,this._businessID=n||this._iOSBusinessID,r=`deviceToken:${t} deviceBrand:${s||o} businessID:`+this._businessID,Ce.l(a+" ok. "+r),i.setMessage(r).end(!0),void this._setToken()}i.setMessage(s).end(!0),Ce.e(a+" failed. error:"+JSON.stringify(e))})}else Ce.e(this._pluginName+".getDeviceToken is not a function")}_getDeviceInfo(){var e=this._n+"._getDeviceInfo";if(xe(this._pushPlugin.getDeviceInfo)){const t=this._pushPlugin.getDeviceInfo(),{code:s,data:i}=t,o=new mi("_getDeviceInfo");if(o.setCode(s),0===s){this._deviceInfo={...this._deviceInfo,...i},this._deviceInfo.pushVersion||(this._deviceInfo.pushVersion="1.0.1");const t="deviceInfo:"+JSON.stringify(this._deviceInfo);return Ce.l(e+" ok. "+t),void o.setMessage(t).end(!0)}o.setMessage("deviceInfoRes:"+JSON.stringify(t)).end(!0),Ce.e(e+" failed. error:"+JSON.stringify(t))}else Ce.e(this._pluginName+".getDeviceInfo is not a function")}canIUseTIMPush(){return P&&!$e(this._pushPlugin)}_setAppShowListener(){const t=this._n+"._setAppShowListener";xe(this._pushPlugin.setAppShowListener)?(new mi("_setAppShowListener").end(!0),Ce.l(t+" start"),this._pushPlugin.setAppShowListener(e=>{e=(e||{}).appShow;new mi("setAppShowListenerRes").setMessage("appShow:"+e).end(!0),Ce.l(t+" ok. appShow:"+e),this._m.isReady()&&(0===e?(this._getConvUnreadCount(),this._onBackground()):1===e&&this._onForeground())})):Ce.e(this._pluginName+".setAppShowListener is not a function")}_setPushEventReportListener(){const n=this._n+"._setPushEventReportListener";xe(this._pushPlugin.setPushEventReportListener)?(new mi("_setPushEventReportListener").end(!0),this._pushPlugin.setPushEventReportListener(e=>{const{code:t,data:s}=e,i=s["eventList"],o=new mi("setPushEventReportListenerRes");if(o.setCode(t),0===t){const e="eventList:"+JSON.stringify(i);return Ce.l(n+" ok. "+e),o.setMessage(e).end(!0),void(this._m.isReady()&&be(i)&&0<i.length&&this._pushReport(s))}o.setMessage("res:"+JSON.stringify(e)).end(!0),Ce.e(n+" failed. error:"+JSON.stringify(e))})):Ce.e(this._pluginName+".setPushEventReportListener is not a function")}getDeviceBrand(){var e;if(!$e(this._pushPlugin)&&xe(this._pushPlugin.getDeviceType))return e=(this._pushPlugin.getDeviceType()||{})["deviceType"],Ce.l(this._n+".getDeviceBrand ok. deviceType:"+e),e}_setToken(){const t=this._n+"._setToken",e=this.get(vs);let s,i=1,n="",r="";Oe(this._deviceToken)&&(i=0);var a=this.getUniAppPlatform(),c=this.getDeviceBrand();a===o.IOS||a===o.IPAD||a===o.MAC?r=this._deviceToken:a===o.ANDROID&&(n=this._deviceToken);const l={tokenID:n,pushMsg:i,sdkAppID:e.getSDKAppID(),businessID:parseInt(this._businessID),deviceBrand:c,deviceToken:r,isWebUniapp:this._isWebUniapp,...this._deviceInfo},d=new mi("_setToken");s="data:"+JSON.stringify(l),d.setMessage(s),Ce.l(t+" "+s),this.req({P:ti.SET_TOKEN,data:l}).then(()=>{d.end(),Ce.w(t+" ok")}).catch(e=>{d.setError(e).end(),Ce.e(t+" failed. error:",e),Qs(e)})}_getConvUnreadCount(){this._c2cUnreadCount=0,this._groupUnreadCount=0,this.get(ys).getLocalConvList().forEach(e=>{e.type===t.CONV_C2C&&(this._c2cUnreadCount+=e.unreadCount),e.type===t.CONV_GROUP&&(this._groupUnreadCount+=e.unreadCount)})}_onBackground(){const t=this._n+"._onBackground",s=new mi("_onBackground");this.req({P:ti.STAT_BACKGROUND,data:{c2cUnreadCount:this._c2cUnreadCount,groupUnreadCount:this._groupUnreadCount,isWebUniapp:this._isWebUniapp}}).then(()=>{s.setMessage(`c2cUnreadCount:${this._c2cUnreadCount} groupUnreadCount:`+this._groupUnreadCount).end(),Ce.l(t+" ok")}).catch(e=>{s.setError(e).end(),Ce.e(t+" failed. error:",e)})}_onForeground(){const t=this._n+"._onForeground",s=new mi("_onForeground");this.req({P:ti.STAT_FOREGROUND,data:{isWebUniapp:this._isWebUniapp}}).then(()=>{s.end(),Ce.l(t+" ok")}).catch(e=>{s.setError(e).end(),Ce.e(t+" failed. error:",e)})}_pushReport(e){const t=this._n+"._pushReport",s=new mi("_pushReport");this.req({P:ti.PUSH_REPORT,data:{eventList:e.eventList}}).then(()=>{s.end(),this._notifyReportSuccess(e)}).catch(e=>{s.setError(e).end(),Ce.e(t+" failed. error:",e)})}_notifyReportSuccess(e){!$e(this._pushPlugin)&&xe(this._pushPlugin.notifyReportSuccess)&&(this._pushPlugin.notifyReportSuccess(e),Ce.l(this._n+"._notifyReportSuccess ok"))}getUniAppPlatform(){var e=uni.getSystemInfoSync().platform,t=this.getDeviceBrand();return"ios"===e?o.IOS:"android"===e?o.ANDROID:1002===t?o.IPAD:1001===t?o.MAC:void 0}reset(){this._deviceToken="",this._businessID=0,this._c2cUnreadCount=0,this._groupUnreadCount=0,this._isWebUniapp=0,Ce.l(this._n+".reset")}}class Ao extends ei{constructor(e){super(e),this._n="ProfanityFilterModule",this._plugin=null,this._filterConfigMap=new Map,this._startIndex=0,this._version=0,this._canIUseLexicon=!1,this._isFetching=!1,this._expiredTime=0}init(){const e=this.get(Ls).getPlugin("tim-profanity-filter-plugin");e&&(this._plugin=new e({logger:Ce,isArray:be,isMap:Ne,isDevMode:this.isDevMode()}),this._getLexicon())}onCheckTimer(){this._plugin&&this._canIUseLexicon&&this.isLoggedIn()&&!this._isFetching&&Date.now()>=this._expiredTime&&this._getLexicon()}filterMessage(e,s){let i=!0;if(!this._plugin||!this._canIUseLexicon)return i;if(s&&s.messageControlInfo&&!0===s.messageControlInfo.excludedFromContentModeration)return i;const{type:o,conversationType:n}=e;if(o!==t.MSG_TEXT&&o!==t.MSG_CUSTOM)return i;const r=this._n+".filterMessage";let a;if(Ce.l(""+r),o===t.MSG_TEXT){if(n===t.CONV_C2C?a=I:n===t.CONV_GROUP&&(a=T),!this._isConfigOn(a))return i;const{type:s,modifiedText:o}=this._plugin.filter(e.payload.text);1===s?i=!1:2===s&&(e.payload.text=o)}else if(o===t.MSG_CUSTOM){if(n===t.CONV_C2C?a=C:n===t.CONV_GROUP&&(a=y),!this._isConfigOn(a))return i;const s=this._plugin.filter(e.payload.data),o=this._plugin.filter(e.payload.description),r=this._plugin.filter(e.payload.extension);1===s.type||1===o.type||1===r.type?i=!1:(2===s.type&&(e.payload.data=s.modifiedText),2===o.type&&(e.payload.description=o.modifiedText),2===r.type&&(e.payload.extension=r.modifiedText))}return Ce.l(r+" done. isAllowedToSend:"+i),i}filterText(e,t){const s=this._n+".filterText",i={isAllowedToSend:!0,modifiedText:e};if(!this._plugin||!this._canIUseLexicon)return i;if(!this._isConfigOn(t))return i;Ce.l(s);var{type:t,modifiedText:e}=this._plugin.filter(e);return 1===t?i.isAllowedToSend=!1:2===t&&(i.modifiedText=e),Ce.l(s+" done. ret:",i),i}_getLexicon(){const d=new mi("profanityFilter"),_=this._n+"._getLexicon";this._isFetching=!0,this.req({P:ti.GET_PROFANITY_LIST,data:{startIndex:this._startIndex,version:this._version}}).then(e=>{var{errorInfo:e,filterConfig:t,lexicon:s,strToken:i,completeFlag:o,nextStartIndex:n,version:r,expiredTime:a}=e.data,{errorCode:c,errorMessage:l}=e;return 0!==c?(this._isFetching=!1,Ce.w(_+" failed. error:",e),void d.setCode(c).setMessage(l).end()):(this._onFilterConfig(t),this._getToken(i),1===o?(Ce.l(_+` done. version:${r} expiredTime:`+a),this._version=r,this._canIUseLexicon=!0,this._isFetching=!1,this._expiredTime=Date.now()+1e3*a,void this._plugin.onLexiconCompleted(s)):(this._startIndex=n,this._plugin.onLexiconSliced(s),void this._getLexicon()))}).catch(e=>{d.setError(e).end(),this._isFetching=!1,Ce.l(_+" failed. error:",e)})}_onFilterConfig(t){Oe(t)||(this._filterConfigMap.clear(),Object.keys(t).forEach(e=>{this._filterConfigMap.set(e,t[e])}),Ce.l(`${this._n}._onFilterConfig. keys:${Array.from(this._filterConfigMap.keys())} values:`+Array.from(this._filterConfigMap.values())))}_isConfigOn(e){return 1===this._filterConfigMap.get(e)}_getToken(s){if(ke(s)){var i=s.length;let t="";if(i%2==0)for(let e=0;e<=i-1;e+=2)t=(t+=s[e+1])+s[e];else{for(let e=0;e<i-1;e+=2)t=(t+=s[e+1])+s[e];t+=s[i-1]}this._plugin.onToken(t)}}reset(){Ce.l(this._n+".reset"),this._plugin&&(this._plugin.reset(),this._plugin=null),this._filterConfigMap.clear(),this._startIndex=0,this._version=0,this._canIUseLexicon=!1,this._isFetching=!1,this._expiredTime=0}}class Oo{constructor(e){this._m=e,this._n="TransCmdModule",this._TRTCCommandList=["tui_room_svr.*","callkit_records_svr.*","room_engine_srv.*","room_engine_http_srv.*","room_engine_mic.*","live_engine_srv.*","live_engine_http_srv.*","live_engine_pk.*","trtc_ai_service.*"],this._TRTCCommandMap=new Map,this._setTRTCCommandMap(),this._m.getIEmitInst().on(Vi.CLOUD_CONFIG,this._onCloudConfig,this)}_onCloudConfig(){let e=this._m.get(Ps).getCloudConfig("rtc_cmd");$e(e)||((e=JSON.parse(e)).forEach(e=>{this._TRTCCommandList.includes(e)||this._TRTCCommandList.push(e)}),this._setTRTCCommandMap())}_setTRTCCommandMap(){var s;for(let e=0,t=this._TRTCCommandList.length;e<t;e++)s=this._TRTCCommandList[e].split(".")[0],this._TRTCCommandMap.set(s,1)}onRoomCustomDataReceived(t){this._m.getOEmitInst().emit(e.ROOM_CUSTOM_DATA_RECEIVED,t)}sendTRTCCustomData(e){var{serviceCommand:e,data:t}=e;let s=f.NAME.TUIROOM_SVR+".*";return $e(e)||(s=e),this._isValidServiceCommand(s)?this._trans({servcmd:s,data:t}):Qs({code:js.INVALID_TRTC_CMD})}_trans(e){Ce.d(this._n+"._trans. options:"+JSON.stringify(e));var{servcmd:e,data:t}=e;return this._m.get(Os).trans({servcmd:e,data:ke(t)?JSON.parse(t):t})}_isValidServiceCommand(e){if(e.endsWith(".*"))return this._TRTCCommandList.includes(e);e=e.split(".")[0];return this._TRTCCommandMap.has(e)}isTRTCCommand(e){e=e.split(".")[0];return this._TRTCCommandMap.has(e)}reset(){Ce.l(this._n+".reset")}}class No{constructor(e){this._m=e,this._n="ErrMsgModule",this.TIM_ERROR_ASSISTANCE="tim_error_assistance",this.STORAGE_EXPIRES_TIME=6048e5,this._map=new Map,this._init()}_init(){var t=this._getStorageModule().getItem(this.TIM_ERROR_ASSISTANCE,!1);if(t){let e;try{e=JSON.parse(t)}catch(e){this._getStorageModule().removeItem(this.TIM_ERROR_ASSISTANCE,!1),Ce.w(this._n+"._init error:",e)}e&&(this._needToUpdate(e)?this._fetch():this._fillMap(e.message))}else this._fetch()}_needToUpdate(e){var{localSavedTime:e,localSavedVersion:t}=e,e=e&&(new Date).getTime()-e>=this.STORAGE_EXPIRES_TIME,t=!t||"3.4.8"!==t;return Ce.l(this._n+`._needToUpdate isTimeout:${e} isDifferentVersion:`+t),e||t}_fetch(){if(!this._m.get(vs).isPrivateNetWork()){const e="https://web.sdk.qcloud.com/im/download/error-message/v3/0.0.6/tim-error-message.txt",t="application/x-www-form-urlencoded;charset=UTF-8",s=this._n+"._fetch ok in",i=this;if(k)$.request({url:e,method:"GET",timeout:3e3,header:{"content-type":t},dataType:"text",success:e=>{i._fillAndSave(e.data),Ce.l(s+" mini program")},fail:()=>{}});else{const o=new XMLHttpRequest,n=setTimeout(()=>{o.abort()},3e3);o.onreadystatechange=function(){4===o.readyState&&(clearTimeout(n),200!==o.status&&304!==o.status||(Ce.l(s+" browser"),i._fillAndSave(o.responseText)))},o.open("GET",e,!0),o.setRequestHeader("Content-type",t),o.send()}}}_fillAndSave(e){this._fillMap(e),this._getStorageModule().setItem(this.TIM_ERROR_ASSISTANCE,JSON.stringify({message:e,localSavedTime:(new Date).getTime(),localSavedVersion:"3.4.8"}),!0,!1)}_getStorageModule(){return this._m.get(Es)}_fillMap(e){this._map.clear();const t=e.split(";\n"),s=t.length;let i,o,n;var r=new RegExp(/'/g);for(let e=0;e<s;e++)if(i=t[e].indexOf(":"),o=t[e].slice(0,i),n=t[e].slice(i+1,t[e].length),!o.startsWith("//")){if($e(n))continue;this._map.set(o,n.replace(r,""))}}get(e){var{isIntl:e,key:t,replacement1:s,replacement2:i}=e;let o=e?t+"_en":t+"_cn",n=(!this._map.has(o)&&this._map.has(t)&&(o=t),"");return this._map.has(o)&&(n=this._map.get(o),$e(s)||(n=n.replace("$replacement1",s)),$e(i)||(n=n.replace("$replacement2",i))),n}reset(){Ce.l(this._n+".reset")}}var Po=An(function(e,t){var s="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;t.assign=function(e){for(var t,s,i=Array.prototype.slice.call(arguments,1);i.length;){var o=i.shift();if(o){if("object"!=typeof o)throw new TypeError(o+"must be non-object");for(var n in o)t=o,s=n,Object.prototype.hasOwnProperty.call(t,s)&&(e[n]=o[n])}}return e},t.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var i={arraySet:function(e,t,s,i,o){if(t.subarray&&e.subarray)e.set(t.subarray(s,s+i),o);else for(var n=0;n<i;n++)e[o+n]=t[s+n]},flattenChunks:function(e){for(var t,s,i,o=0,n=0,r=e.length;n<r;n++)o+=e[n].length;for(i=new Uint8Array(o),n=t=0,r=e.length;n<r;n++)s=e[n],i.set(s,t),t+=s.length;return i}},o={arraySet:function(e,t,s,i,o){for(var n=0;n<i;n++)e[o+n]=t[s+n]},flattenChunks:function(e){return[].concat.apply([],e)}};t.setTyped=function(e){e?(t.Buf8=Uint8Array,t.Buf16=Uint16Array,t.Buf32=Int32Array,t.assign(t,i)):(t.Buf8=Array,t.Buf16=Array,t.Buf32=Array,t.assign(t,o))},t.setTyped(s)}),Uo=(Po.assign,Po.shrinkBuf,Po.setTyped,Po.Buf8,Po.Buf16,Po.Buf32,function(e,t,s,i){for(var o=65535&e|0,n=e>>>16&65535|0,r=0;0!==s;){for(s-=r=2e3<s?2e3:s;n=n+(o=o+t[i++]|0)|0,--r;);o%=65521,n%=65521}return o|n<<16|0}),Go=function(){for(var e=[],t=0;t<256;t++){for(var s=t,i=0;i<8;i++)s=1&s?3988292384^s>>>1:s>>>1;e[t]=s}return e}(),ko=function(e,t,s,i){var o=Go,n=i+s;e^=-1;for(var r=i;r<n;r++)e=e>>>8^o[255&(e^t[r])];return-1^e},wo=function(e,d){var _,t,s,u,i,h,o=e.state,n=e.next_in,p=e.input,g=n+(e.avail_in-5),r=e.next_out,a=e.output,m=r-(d-e.avail_out),f=r+(e.avail_out-257),M=o.dmax,I=o.wsize,C=o.whave,T=o.wnext,v=o.window,c=o.hold,l=o.bits,y=o.lencode,S=o.distcode,E=(1<<o.lenbits)-1,D=(1<<o.distbits)-1;e:do{for(l<15&&(c+=p[n++]<<l,l+=8,c+=p[n++]<<l,l+=8),_=y[c&E];;){if(c>>>=t=_>>>24,l-=t,0==(t=_>>>16&255))a[r++]=65535&_;else{if(!(16&t)){if(0==(64&t)){_=y[(65535&_)+(c&(1<<t)-1)];continue}if(32&t){o.mode=12;break e}e.msg="invalid literal/length code",o.mode=30;break e}for(s=65535&_,(t&=15)&&(l<t&&(c+=p[n++]<<l,l+=8),s+=c&(1<<t)-1,c>>>=t,l-=t),l<15&&(c+=p[n++]<<l,l+=8,c+=p[n++]<<l,l+=8),_=S[c&D];;){if(c>>>=t=_>>>24,l-=t,!(16&(t=_>>>16&255))){if(0==(64&t)){_=S[(65535&_)+(c&(1<<t)-1)];continue}e.msg="invalid distance code",o.mode=30;break e}if(u=65535&_,l<(t&=15)&&(c+=p[n++]<<l,(l+=8)<t&&(c+=p[n++]<<l,l+=8)),(u+=c&(1<<t)-1)>M){e.msg="invalid distance too far back",o.mode=30;break e}if(c>>>=t,l-=t,u>(t=r-m)){if((t=u-t)>C&&o.sane){e.msg="invalid distance too far back",o.mode=30;break e}if(h=v,(i=0)===T){if(i+=I-t,t<s){for(s-=t;a[r++]=v[i++],--t;);i=r-u,h=a}}else if(T<t){if(i+=I+T-t,(t-=T)<s){for(s-=t;a[r++]=v[i++],--t;);if(i=0,T<s){for(s-=t=T;a[r++]=v[i++],--t;);i=r-u,h=a}}}else if(i+=T-t,t<s){for(s-=t;a[r++]=v[i++],--t;);i=r-u,h=a}for(;2<s;)a[r++]=h[i++],a[r++]=h[i++],a[r++]=h[i++],s-=3;s&&(a[r++]=h[i++],1<s&&(a[r++]=h[i++]))}else{for(i=r-u;a[r++]=a[i++],a[r++]=a[i++],a[r++]=a[i++],2<(s-=3););s&&(a[r++]=a[i++],1<s&&(a[r++]=a[i++]))}break}}break}}while(n<g&&r<f);n-=s=l>>3,c&=(1<<(l-=s<<3))-1,e.next_in=n,e.next_out=r,e.avail_in=n<g?g-n+5:5-(n-g),e.avail_out=r<f?f-r+257:257-(r-f),o.hold=c,o.bits=l},Fo=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],bo=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],$o=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],qo=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64],xo=function(d,_,u,h,p,g,e,m){for(var t,f,M,I,C,T,v,y,S,E=m.bits,s=0,i=0,o=0,n=0,r=0,a=0,c=0,D=0,O=0,l=0,R=null,L=0,A=new Po.Buf16(16),N=new Po.Buf16(16),P=null,U=0,s=0;s<=15;s++)A[s]=0;for(i=0;i<h;i++)A[_[u+i]]++;for(r=E,n=15;1<=n&&0===A[n];n--);if(n<r&&(r=n),0===n)return p[g++]=20971520,p[g++]=20971520,m.bits=1,0;for(o=1;o<n&&0===A[o];o++);for(r<o&&(r=o),s=D=1;s<=15;s++)if((D=(D<<1)-A[s])<0)return-1;if(0<D&&(0===d||1!==n))return-1;for(N[1]=0,s=1;s<15;s++)N[s+1]=N[s]+A[s];for(i=0;i<h;i++)0!==_[u+i]&&(e[N[_[u+i]]++]=i);if(T=0===d?(R=P=e,19):1===d?(R=Fo,L-=257,P=bo,U-=257,256):(R=$o,P=qo,-1),s=o,C=g,c=i=l=0,M=-1,I=(O=1<<(a=r))-1,1===d&&852<O||2===d&&592<O)return 1;for(;;){for(S=e[i]<T?(y=0,e[i]):e[i]>T?(y=P[U+e[i]],R[L+e[i]]):(y=96,0),t=1<<(v=s-c),o=f=1<<a;p[C+(l>>c)+(f-=t)]=v<<24|y<<16|S|0,0!==f;);for(t=1<<s-1;l&t;)t>>=1;if(0!==t?l=(l&t-1)+t:l=0,i++,0==--A[s]){if(s===n)break;s=_[u+e[i]]}if(r<s&&(l&I)!==M){for(C+=o,D=1<<(a=s-(c=0===c?r:c));a+c<n&&!((D-=A[a+c])<=0);)a++,D<<=1;if(O+=1<<a,1===d&&852<O||2===d&&592<O)return 1;p[M=l&I]=r<<24|a<<16|C-g|0}}return 0!==l&&(p[C+l]=s-c<<24|64<<16|0),m.bits=r,0};function Vo(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function Bo(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Po.Buf16(320),this.work=new Po.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function Ko(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=1,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Po.Buf32(852),t.distcode=t.distdyn=new Po.Buf32(592),t.sane=1,t.back=-1,0):-2}function Ho(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,Ko(e)):-2}function Wo(e,t){var s,i;return e&&e.state?(i=e.state,t<0?(s=0,t=-t):(s=1+(t>>4),t<48&&(t&=15)),t&&(t<8||15<t)?-2:(null!==i.window&&i.wbits!==t&&(i.window=null),i.wrap=s,i.wbits=t,Ho(e))):-2}function Yo(e,t){var s;return e?(s=new Bo,(e.state=s).window=null,0!==(s=Wo(e,t))&&(e.state=null),s):-2}var zo,jo,Jo=!0;function Xo(e){if(Jo){var t;for(zo=new Po.Buf32(512),jo=new Po.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(xo(1,e.lens,0,288,zo,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;xo(2,e.lens,0,32,jo,0,e.work,{bits:5}),Jo=!1}e.lencode=zo,e.lenbits=9,e.distcode=jo,e.distbits=5}function Zo(e,t,s,i){var o,e=e.state;return null===e.window&&(e.wsize=1<<e.wbits,e.wnext=0,e.whave=0,e.window=new Po.Buf8(e.wsize)),i>=e.wsize?(Po.arraySet(e.window,t,s-e.wsize,e.wsize,0),e.wnext=0,e.whave=e.wsize):((o=e.wsize-e.wnext)>i&&(o=i),Po.arraySet(e.window,t,s-i,o,e.wnext),(i-=o)?(Po.arraySet(e.window,t,s-i,i,0),e.wnext=i,e.whave=e.wsize):(e.wnext+=o,e.wnext===e.wsize&&(e.wnext=0),e.whave<e.wsize&&(e.whave+=o))),0}var Qo={inflateReset:Ho,inflateReset2:Wo,inflateResetKeep:Ko,inflateInit:function(e){return Yo(e,15)},inflateInit2:Yo,inflate:function(e,d){var t,s,_,i,u,o,h,n,r,p,g,a,m,f,c,M,I,C,T,v,l,y,S,E,D=0,O=new Po.Buf8(4),R=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return-2;12===(t=e.state).mode&&(t.mode=13),u=e.next_out,_=e.output,h=e.avail_out,i=e.next_in,s=e.input,o=e.avail_in,n=t.hold,r=t.bits,p=o,g=h,y=0;e:for(;;)switch(t.mode){case 1:if(0===t.wrap){t.mode=13;break}for(;r<16;){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}if(2&t.wrap&&35615===n){O[t.check=0]=255&n,O[1]=n>>>8&255,t.check=ko(t.check,O,2,0),r=n=0,t.mode=2;break}if(t.flags=0,t.head&&(t.head.done=!1),!(1&t.wrap)||(((255&n)<<8)+(n>>8))%31){e.msg="incorrect header check",t.mode=30;break}if(8!=(15&n)){e.msg="unknown compression method",t.mode=30;break}if(r-=4,l=8+(15&(n>>>=4)),0===t.wbits)t.wbits=l;else if(l>t.wbits){e.msg="invalid window size",t.mode=30;break}t.dmax=1<<l,e.adler=t.check=1,t.mode=512&n?10:12,r=n=0;break;case 2:for(;r<16;){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}if(t.flags=n,8!=(255&t.flags)){e.msg="unknown compression method",t.mode=30;break}if(57344&t.flags){e.msg="unknown header flags set",t.mode=30;break}t.head&&(t.head.text=n>>8&1),512&t.flags&&(O[0]=255&n,O[1]=n>>>8&255,t.check=ko(t.check,O,2,0)),r=n=0,t.mode=3;case 3:for(;r<32;){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}t.head&&(t.head.time=n),512&t.flags&&(O[0]=255&n,O[1]=n>>>8&255,O[2]=n>>>16&255,O[3]=n>>>24&255,t.check=ko(t.check,O,4,0)),r=n=0,t.mode=4;case 4:for(;r<16;){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}t.head&&(t.head.xflags=255&n,t.head.os=n>>8),512&t.flags&&(O[0]=255&n,O[1]=n>>>8&255,t.check=ko(t.check,O,2,0)),r=n=0,t.mode=5;case 5:if(1024&t.flags){for(;r<16;){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}t.length=n,t.head&&(t.head.extra_len=n),512&t.flags&&(O[0]=255&n,O[1]=n>>>8&255,t.check=ko(t.check,O,2,0)),r=n=0}else t.head&&(t.head.extra=null);t.mode=6;case 6:if(1024&t.flags&&((a=(a=t.length)>o?o:a)&&(t.head&&(l=t.head.extra_len-t.length,t.head.extra||(t.head.extra=new Array(t.head.extra_len)),Po.arraySet(t.head.extra,s,i,a,l)),512&t.flags&&(t.check=ko(t.check,s,a,i)),o-=a,i+=a,t.length-=a),t.length))break e;t.length=0,t.mode=7;case 7:if(2048&t.flags){if(0===o)break e;for(a=0;l=s[i+a++],t.head&&l&&t.length<65536&&(t.head.name+=String.fromCharCode(l)),l&&a<o;);if(512&t.flags&&(t.check=ko(t.check,s,a,i)),o-=a,i+=a,l)break e}else t.head&&(t.head.name=null);t.length=0,t.mode=8;case 8:if(4096&t.flags){if(0===o)break e;for(a=0;l=s[i+a++],t.head&&l&&t.length<65536&&(t.head.comment+=String.fromCharCode(l)),l&&a<o;);if(512&t.flags&&(t.check=ko(t.check,s,a,i)),o-=a,i+=a,l)break e}else t.head&&(t.head.comment=null);t.mode=9;case 9:if(512&t.flags){for(;r<16;){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}if(n!==(65535&t.check)){e.msg="header crc mismatch",t.mode=30;break}r=n=0}t.head&&(t.head.hcrc=t.flags>>9&1,t.head.done=!0),e.adler=t.check=0,t.mode=12;break;case 10:for(;r<32;){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}e.adler=t.check=Vo(n),r=n=0,t.mode=11;case 11:if(0===t.havedict)return e.next_out=u,e.avail_out=h,e.next_in=i,e.avail_in=o,t.hold=n,t.bits=r,2;e.adler=t.check=1,t.mode=12;case 12:if(5===d||6===d)break e;case 13:if(t.last){n>>>=7&r,r-=7&r,t.mode=27;break}for(;r<3;){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}switch(t.last=1&n,--r,3&(n>>>=1)){case 0:t.mode=14;break;case 1:if(Xo(t),t.mode=20,6!==d)break;n>>>=2,r-=2;break e;case 2:t.mode=17;break;case 3:e.msg="invalid block type",t.mode=30}n>>>=2,r-=2;break;case 14:for(n>>>=7&r,r-=7&r;r<32;){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}if((65535&n)!=(n>>>16^65535)){e.msg="invalid stored block lengths",t.mode=30;break}if(t.length=65535&n,r=n=0,t.mode=15,6===d)break e;case 15:t.mode=16;case 16:if(a=t.length){if(0===(a=h<(a=o<a?o:a)?h:a))break e;Po.arraySet(_,s,i,a,u),o-=a,i+=a,h-=a,u+=a,t.length-=a;break}t.mode=12;break;case 17:for(;r<14;){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}if(t.nlen=257+(31&n),n>>>=5,r-=5,t.ndist=1+(31&n),n>>>=5,r-=5,t.ncode=4+(15&n),n>>>=4,r-=4,286<t.nlen||30<t.ndist){e.msg="too many length or distance symbols",t.mode=30;break}t.have=0,t.mode=18;case 18:for(;t.have<t.ncode;){for(;r<3;){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}t.lens[R[t.have++]]=7&n,n>>>=3,r-=3}for(;t.have<19;)t.lens[R[t.have++]]=0;if(t.lencode=t.lendyn,t.lenbits=7,S={bits:t.lenbits},y=xo(0,t.lens,0,19,t.lencode,0,t.work,S),t.lenbits=S.bits,y){e.msg="invalid code lengths set",t.mode=30;break}t.have=0,t.mode=19;case 19:for(;t.have<t.nlen+t.ndist;){for(;M=(D=t.lencode[n&(1<<t.lenbits)-1])>>>16&255,I=65535&D,!((c=D>>>24)<=r);){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}if(I<16)n>>>=c,r-=c,t.lens[t.have++]=I;else{if(16===I){for(E=c+2;r<E;){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}if(n>>>=c,r-=c,0===t.have){e.msg="invalid bit length repeat",t.mode=30;break}l=t.lens[t.have-1],a=3+(3&n),n>>>=2,r-=2}else if(17===I){for(E=c+3;r<E;){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}l=0,a=3+(7&(n>>>=c)),n>>>=3,r=r-c-3}else{for(E=c+7;r<E;){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}l=0,a=11+(127&(n>>>=c)),n>>>=7,r=r-c-7}if(t.have+a>t.nlen+t.ndist){e.msg="invalid bit length repeat",t.mode=30;break}for(;a--;)t.lens[t.have++]=l}}if(30===t.mode)break;if(0===t.lens[256]){e.msg="invalid code -- missing end-of-block",t.mode=30;break}if(t.lenbits=9,S={bits:t.lenbits},y=xo(1,t.lens,0,t.nlen,t.lencode,0,t.work,S),t.lenbits=S.bits,y){e.msg="invalid literal/lengths set",t.mode=30;break}if(t.distbits=6,t.distcode=t.distdyn,S={bits:t.distbits},y=xo(2,t.lens,t.nlen,t.ndist,t.distcode,0,t.work,S),t.distbits=S.bits,y){e.msg="invalid distances set",t.mode=30;break}if(t.mode=20,6===d)break e;case 20:t.mode=21;case 21:if(6<=o&&258<=h){e.next_out=u,e.avail_out=h,e.next_in=i,e.avail_in=o,t.hold=n,t.bits=r,wo(e,g),u=e.next_out,_=e.output,h=e.avail_out,i=e.next_in,s=e.input,o=e.avail_in,n=t.hold,r=t.bits,12===t.mode&&(t.back=-1);break}for(t.back=0;M=(D=t.lencode[n&(1<<t.lenbits)-1])>>>16&255,I=65535&D,!((c=D>>>24)<=r);){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}if(M&&0==(240&M)){for(C=c,T=M,v=I;M=(D=t.lencode[v+((n&(1<<C+T)-1)>>C)])>>>16&255,I=65535&D,!(C+(c=D>>>24)<=r);){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}n>>>=C,r-=C,t.back+=C}if(n>>>=c,r-=c,t.back+=c,t.length=I,0===M){t.mode=26;break}if(32&M){t.back=-1,t.mode=12;break}if(64&M){e.msg="invalid literal/length code",t.mode=30;break}t.extra=15&M,t.mode=22;case 22:if(t.extra){for(E=t.extra;r<E;){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}t.length+=n&(1<<t.extra)-1,n>>>=t.extra,r-=t.extra,t.back+=t.extra}t.was=t.length,t.mode=23;case 23:for(;M=(D=t.distcode[n&(1<<t.distbits)-1])>>>16&255,I=65535&D,!((c=D>>>24)<=r);){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}if(0==(240&M)){for(C=c,T=M,v=I;M=(D=t.distcode[v+((n&(1<<C+T)-1)>>C)])>>>16&255,I=65535&D,!(C+(c=D>>>24)<=r);){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}n>>>=C,r-=C,t.back+=C}if(n>>>=c,r-=c,t.back+=c,64&M){e.msg="invalid distance code",t.mode=30;break}t.offset=I,t.extra=15&M,t.mode=24;case 24:if(t.extra){for(E=t.extra;r<E;){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}t.offset+=n&(1<<t.extra)-1,n>>>=t.extra,r-=t.extra,t.back+=t.extra}if(t.offset>t.dmax){e.msg="invalid distance too far back",t.mode=30;break}t.mode=25;case 25:if(0===h)break e;if(t.offset>(a=g-h)){if((a=t.offset-a)>t.whave&&t.sane){e.msg="invalid distance too far back",t.mode=30;break}m=a>t.wnext?(a-=t.wnext,t.wsize-a):t.wnext-a,a>t.length&&(a=t.length),f=t.window}else f=_,m=u-t.offset,a=t.length;for(h-=a=h<a?h:a,t.length-=a;_[u++]=f[m++],--a;);0===t.length&&(t.mode=21);break;case 26:if(0===h)break e;_[u++]=t.length,h--,t.mode=21;break;case 27:if(t.wrap){for(;r<32;){if(0===o)break e;o--,n|=s[i++]<<r,r+=8}if(g-=h,e.total_out+=g,t.total+=g,g&&(e.adler=t.check=(t.flags?ko:Uo)(t.check,_,g,u-g)),g=h,(t.flags?n:Vo(n))!==t.check){e.msg="incorrect data check",t.mode=30;break}r=n=0}t.mode=28;case 28:if(t.wrap&&t.flags){for(;r<32;){if(0===o)break e;o--,n+=s[i++]<<r,r+=8}if(n!==(4294967295&t.total)){e.msg="incorrect length check",t.mode=30;break}r=n=0}t.mode=29;case 29:y=1;break e;case 30:y=-3;break e;case 31:return-4;default:return-2}return e.next_out=u,e.avail_out=h,e.next_in=i,e.avail_in=o,t.hold=n,t.bits=r,(t.wsize||g!==e.avail_out&&t.mode<30&&(t.mode<27||4!==d))&&Zo(e,e.output,e.next_out,g-e.avail_out),p-=e.avail_in,g-=e.avail_out,e.total_in+=p,e.total_out+=g,t.total+=g,t.wrap&&g&&(e.adler=t.check=(t.flags?ko:Uo)(t.check,_,g,e.next_out-g)),e.data_type=t.bits+(t.last?64:0)+(12===t.mode?128:0)+(20===t.mode||15===t.mode?256:0),y=(0==p&&0===g||4===d)&&0===y?-5:y},inflateEnd:function(e){if(!e||!e.state)return-2;var t=e.state;return t.window&&(t.window=null),e.state=null,0},inflateGetHeader:function(e,t){var s;return!e||!e.state||0==(2&(s=e.state).wrap)?-2:((s.head=t).done=!1,0)},inflateSetDictionary:function(e,t){var s,i=t.length;return!e||!e.state||0!==(s=e.state).wrap&&11!==s.mode?-2:11===s.mode&&Uo(1,t,i,0)!==s.check?-3:Zo(e,t,i,i)?(s.mode=31,-4):(s.havedict=1,0)},inflateInfo:"pako inflate (from Nodeca project)"},er=!0,tr=!0;try{String.fromCharCode.apply(null,[0])}catch(e){er=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){tr=!1}for(var sr=new Po.Buf8(256),ir=0;ir<256;ir++)sr[ir]=252<=ir?6:248<=ir?5:240<=ir?4:224<=ir?3:192<=ir?2:1;function nr(e,t){if(t<65534&&(e.subarray&&tr||!e.subarray&&er))return String.fromCharCode.apply(null,Po.shrinkBuf(e,t));for(var s="",i=0;i<t;i++)s+=String.fromCharCode(e[i]);return s}sr[254]=sr[254]=1;var or=function(e){for(var t,s,i,o,n=e.length,r=0,a=0;a<n;a++)55296==(64512&(s=e.charCodeAt(a)))&&a+1<n&&56320==(64512&(i=e.charCodeAt(a+1)))&&(s=65536+(s-55296<<10)+(i-56320),a++),r+=s<128?1:s<2048?2:s<65536?3:4;for(t=new Po.Buf8(r),a=o=0;o<r;a++)55296==(64512&(s=e.charCodeAt(a)))&&a+1<n&&56320==(64512&(i=e.charCodeAt(a+1)))&&(s=65536+(s-55296<<10)+(i-56320),a++),s<128?t[o++]=s:(s<2048?t[o++]=192|s>>>6:(s<65536?t[o++]=224|s>>>12:(t[o++]=240|s>>>18,t[o++]=128|s>>>12&63),t[o++]=128|s>>>6&63),t[o++]=128|63&s);return t},rr=function(e){for(var t=new Po.Buf8(e.length),s=0,i=t.length;s<i;s++)t[s]=e.charCodeAt(s);return t},ar=function(e,t){for(var s,i,o=t||e.length,n=new Array(2*o),r=0,a=0;a<o;)if((s=e[a++])<128)n[r++]=s;else if(4<(i=sr[s]))n[r++]=65533,a+=i-1;else{for(s&=2===i?31:3===i?15:7;1<i&&a<o;)s=s<<6|63&e[a++],i--;1<i?n[r++]=65533:s<65536?n[r++]=s:(s-=65536,n[r++]=55296|s>>10&1023,n[r++]=56320|1023&s)}return nr(n,r)},cr=function(e,t){for(var s=(t=(t=t||e.length)>e.length?e.length:t)-1;0<=s&&128==(192&e[s]);)s--;return!(s<0||0===s)&&s+sr[e[s]]>t?s:t},lr={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8},ur={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},dr=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0},_r=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1},hr=Object.prototype.toString;function pr(e){if(!(this instanceof pr))return new pr(e);this.options=Po.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options,e=(t.raw&&0<=t.windowBits&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(0<=t.windowBits&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),15<t.windowBits&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new dr,this.strm.avail_out=0,Qo.inflateInit2(this.strm,t.windowBits));if(e!==lr.Z_OK)throw new Error(ur[e]);if(this.header=new _r,Qo.inflateGetHeader(this.strm,this.header),t.dictionary&&("string"==typeof t.dictionary?t.dictionary=or(t.dictionary):"[object ArrayBuffer]"===hr.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(e=Qo.inflateSetDictionary(this.strm,t.dictionary))!==lr.Z_OK))throw new Error(ur[e])}function gr(e,t){t=new pr(t);if(t.push(e,!0),t.err)throw t.msg||ur[t.err];return t.result}pr.prototype.push=function(e,t){var s,i,o,n,r,a=this.strm,c=this.options.chunkSize,d=this.options.dictionary,l=!1;if(this.ended)return!1;i=t===~~t?t:!0===t?lr.Z_FINISH:lr.Z_NO_FLUSH,"string"==typeof e?a.input=rr(e):"[object ArrayBuffer]"===hr.call(e)?a.input=new Uint8Array(e):a.input=e,a.next_in=0,a.avail_in=a.input.length;do{if(0===a.avail_out&&(a.output=new Po.Buf8(c),a.next_out=0,a.avail_out=c),(s=(s=Qo.inflate(a,lr.Z_NO_FLUSH))===lr.Z_NEED_DICT&&d?Qo.inflateSetDictionary(this.strm,d):s)===lr.Z_BUF_ERROR&&!0===l&&(s=lr.Z_OK,l=!1),s!==lr.Z_STREAM_END&&s!==lr.Z_OK)return this.onEnd(s),!(this.ended=!0)}while(a.next_out&&(0!==a.avail_out&&s!==lr.Z_STREAM_END&&(0!==a.avail_in||i!==lr.Z_FINISH&&i!==lr.Z_SYNC_FLUSH)||("string"===this.options.to?(o=cr(a.output,a.next_out),n=a.next_out-o,r=ar(a.output,o),a.next_out=n,a.avail_out=c-n,n&&Po.arraySet(a.output,a.output,o,n,0),this.onData(r)):this.onData(Po.shrinkBuf(a.output,a.next_out)))),0===a.avail_in&&0===a.avail_out&&(l=!0),(0<a.avail_in||0===a.avail_out)&&s!==lr.Z_STREAM_END);return(i=s===lr.Z_STREAM_END?lr.Z_FINISH:i)===lr.Z_FINISH?(s=Qo.inflateEnd(this.strm),this.onEnd(s),this.ended=!0,s===lr.Z_OK):i!==lr.Z_SYNC_FLUSH||(this.onEnd(lr.Z_OK),!(a.avail_out=0))},pr.prototype.onData=function(e){this.chunks.push(e)},pr.prototype.onEnd=function(e){e===lr.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=Po.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var mr={Inflate:pr,inflate:gr,inflateRaw:function(e,t){return(t=t||{}).raw=!0,gr(e,t)},ungzip:gr},fr={},Mr=((0,Po.assign)(fr,mr,lr),fr);class Ir{constructor(e){this._m=e,this._n="InflateModule",this._bLogForInflateOK=!1,this._bLogForInflateError=!1}inflate(e){var e=new Uint8Array(e).slice(4),t=Date.now();let s;try{s=Mr.inflate(e,{to:"string"}),this._bLogForInflateOK||(this._bLogForInflateOK=!0,new mi("inflateOK").end())}catch(e){return this._bLogForInflateError?void 0:(this._bLogForInflateError=!0,void new mi("inflateError").setMessage(e).end())}var e=e.length+4,i=s.length;return Ce.d(`inflate ok. zipped:${e} unzipped:${i} compression ratio:${Math.round(100*(i-e)/i)}% cost:`+(Date.now()-t)),s}reset(){Ce.l(this._n+".reset"),this._bLogForInflateOK=!1,this._bLogForInflateError=!1}}class Cr{constructor(s){const e=new mi("sdkConstruct");if(this._n="ModuleManager",this._isReady=!1,this._reason=js.USER_NOT_LOGGED_IN,this._startLoginTs=0,this._map=new Map,this._optionalModuleMap=new Map,this._iEmitter=null,this._oEmitter=null,this._checkCount=0,this._checkTimer=-1,this._map.set(vs,new Mn(this,s)),this._map.set(Ws,new Ir(this)),this._map.set(Ds,new Ln(this)),this._map.set(ws,new Do(this)),this._map.set(Ps,new fo(this)),this._map.set(Us,new Eo(this)),this._map.set(ks,new vo(this)),this._map.set(Ns,new ao(this)),this._map.set(Os,new mo(this)),this._map.set(ps,new Cn(this)),this._map.set(gs,new $n(this)),this._map.set(ms,new qn(this)),this._map.set(Bs,new xn(this)),this._map.set(qs,new Vn(this)),this._map.set(fs,new fn(this)),this._map.set(Ms,new xi(this)),this._map.set(ys,new an(this)),this._map.set(Ts,new dn(this)),this._map.set(Es,new yn(this)),this._map.set(xs,new No(this)),this._map.set(Ss,new Sn(this)),this._map.set(Rs,new Gn(this)),this._map.set(Ls,new Bn(this)),this._map.set(As,new Kn(this)),this._map.set(Gs,new Mo(this)),this._map.set(Fs,new Ro(this)),this._map.set(Hs,new Lo(this)),this._map.set(bs,new Ao(this)),this._map.set($s,new Oo(this)),this._eventThrottleMap=new Map,this._eventThrottling=s.eventThrottling,this._map.get(vs).isPartialUpdatedConvs()&&(this._eventThrottling=!1),Fe(s.modules)){let t;Object.keys(s.modules).forEach(e=>{t=s.modules[e],"group-module"===e?this._map.set(Is,new t(this)):"relationship-module"===e?this._map.set(Cs,new t(this)):"signaling-module"===e?this._map.set(Vs,new t(this)):"follow-module"===e&&this._map.set(Ks,new t(this)),this._optionalModuleMap.set(e,1)}),this._map.get(vs).setUsingChatCore(!0)}else this._map.has(Is)||this._map.get(vs).setUsingChatCore(!0);var{instanceID:t,SDKAppID:i}=s,t=`instanceID:${t} SDKAppID:${i} isIntl:${this._map.get(vs).isIntl()} isUsingChatCore:${this._map.get(vs).isUsingChatCore()} host:${_t()} isIOSWebView:${re} platform:${V} canIUseInflate:${this.canIUseInflate()} workerAvailable:${ie} eventThrottling:${this._eventThrottling} UserAgent:`+q;mi.bindEventStatModule(this._map.get(Ss)),mi.bindNetMonitorModule(this._map.get(Ds)),e.setMessage(t+" "+function(){let t="";if(k)try{var{model:e,version:s,system:i,platform:o,SDKVersion:n}=$.getSystemInfoSync();t=`model:${e} version:${s} system:${i} platform:${o} SDKVersion:`+n}catch(e){t=""}return t}()).end(),Ce.i("SDK "+t),zs.prototype._getErrMsg=this.getErrMsg.bind(this),this._readyList=void 0,this._ssoLogForReady=null,this._initReadyList()}_startTimer(){const e=this._map.get(Us),t=e.isWorkerEnabled();Ce.l(this._n+`.startTimer isWorkerEnabled:${t} seed:`+this._checkTimer),t?e.startWorkerTimer():this._startMainThreadTimer()}_startMainThreadTimer(){this._checkTimer<0&&(this._checkTimer=setInterval(this.onCheckTimer.bind(this),1e3)),Ce.l(this._n+"._startMainThreadTimer seed:"+this._checkTimer)}stopTimer(){const e=this._map.get(Us),t=e.isWorkerEnabled();Ce.l(this._n+`.stopTimer isWorkerEnabled:${t} seed:`+this._checkTimer),t?e.stopWorkerTimer():this._stopMainThreadTimer()}_stopMainThreadTimer(){Ce.l(this._n+"._stopMainThreadTimer"),0<this._checkTimer&&(clearInterval(this._checkTimer),this._checkTimer=-1,this._checkCount=0)}_stopMainThreadSocket(){Ce.l(this._n+"._stopMainThreadSocket");const e=this._map.get(Ns);e.setIsWorkerEnabled(!0),e.reConnect()}_startMainThreadSocket(){Ce.l(this._n+"._startMainThreadSocket");const e=this._map.get(Ns);e.setIsWorkerEnabled(!1),e.reConnect()}onWorkerTimerEnabled(){Ce.l(this._n+".onWorkerTimerEnabled, disable main thread timer and socket"),this._stopMainThreadTimer(),this._stopMainThreadSocket()}onWorkerTimerDisabled(){Ce.l(this._n+".onWorkerTimerDisabled, enable main thread timer and socket"),this._startMainThreadTimer(),this._startMainThreadSocket()}onCheckTimer(){this._checkCount+=1;for(var[,e]of this._map)e.onCheckTimer&&e.onCheckTimer(this._checkCount)}_initReadyList(){this._readyList=[this._map.get(ps)],this._readyList.forEach(e=>{e.ready(()=>this._onModuleReady())})}_onModuleReady(){let t=!0;if(this._readyList.forEach(e=>{e.isReady()||(t=!1)}),t&&!this._isReady){this._isReady=!0,this._oEmitter.emit(e.SDK_READY);const t=Date.now()-this._startLoginTs;Ce.w(`SDK is ready. cost ${t} ms`),this._startLoginTs=Date.now();var s=this._ssoLogForReady.getStartTs()+he;this._ssoLogForReady.setMessage(t).start(s).end()}}login(){0===this._startLoginTs&&(ge(),this._startLoginTs=Date.now(),this._startTimer(),this._map.get(Ds).start(),this._ssoLogForReady=new mi("sdkReady"),this._reason=js.LOGGING_IN)}onLoginFailed(){this._startLoginTs=0}getOEmitInst(){return null===this._oEmitter&&(this._oEmitter=new On,Xs(this._oEmitter),this._oEmitter._emit=this._oEmitter.emit,this._oEmitter.emit=function(t,s){if(this._canIUseSignaling()&&(t===e.MESSAGE_RECEIVED&&this.get(Vs).onNewMessageList(s),t===e.MESSAGE_MODIFIED&&this.get(Vs).onMessageModified(s)),t===e.CONVERSATION_LIST_UPDATED||t===e.FRIEND_LIST_UPDATED||t===e.GROUP_LIST_UPDATED||t===e.TOTAL_UNREAD_MESSAGE_COUNT_UPDATED)if(!1!==this._eventThrottling)if(this._eventThrottleMap.has(t)){const e=Date.now(),s=this._eventThrottleMap.get(t);e-s.last<=1e3?(s.timeoutID&&clearTimeout(s.timeoutID),s.timeoutID=setTimeout(()=>{s.last=Date.now(),this._oEmitter._emit.apply(this._oEmitter,[t,{name:t,data:this._getEventData(t)}])},1e3)):(s.last=e,this._oEmitter._emit.apply(this._oEmitter,[t,{name:t,data:this._getEventData(t)}]))}else this._eventThrottleMap.set(t,{last:Date.now(),timeoutID:-1}),this._oEmitter._emit.apply(this._oEmitter,[t,{name:t,data:this._getEventData(t)}]);else this._oEmitter._emit.apply(this._oEmitter,[t,{name:t,data:this._getEventData(t)}]);else this._oEmitter._emit.apply(this._oEmitter,[t,{name:t,data:s}])}.bind(this)),this._oEmitter}_canIUseSignaling(){const e=this.get(Vs);return!!e&&e.canIUseSignaling()}_getEventData(t){return t===e.CONVERSATION_LIST_UPDATED?this._map.get(vs).isPartialUpdatedConvs()?this._map.get(ys).getPartialUpdatedConvs():this._map.get(ys).getLocalConvList():t===e.FRIEND_LIST_UPDATED?this._map.get(Cs).getLocalFriendList(!1):t===e.GROUP_LIST_UPDATED?this._map.get(Is).getLocalGroupList():t===e.TOTAL_UNREAD_MESSAGE_COUNT_UPDATED?this._map.get(ys).getTotalUnreadCount():t===e.CONVERSATION_ID_LIST_UPDATED?this._map.get(ys).getUpdatedConvIDList():void 0}getIEmitInst(){return null===this._iEmitter&&(this._iEmitter=new On,this._iEmitter._emit=this._iEmitter.emit,this._iEmitter.emit=function(e,t){e=Fe(t)&&t.data?[e,{name:e,data:t.data}]:[e,{name:e,data:t}];this._iEmitter._emit.apply(this._iEmitter,e)}.bind(this)),this._iEmitter}hasModule(e){return this._map.has(e)}get(e){return this._map.get(e)}canIUseModule(e){return!this._map.get(vs).isUsingChatCore()||this._optionalModuleMap.has(e)}canIUseInflate(){return!!this._map.get(Ws)}isReady(){return this._isReady}isIntl(){return this.get(vs).isIntl()}getNotReadyReason(){return this._reason}setNotReadyReason(e){this._reason=e}getErrMsg(e,t,s){return this._map.get(xs).get({key:e,replacement1:t,replacement2:s,isIntl:this.isIntl()})}warn(e,t,s){e=this.getErrMsg(e,t,s);e&&Ce.w(e)}onError(t){var s=`code:${t.code} message:`+t.message;Ce.w("Oops! "+s),new mi("error").setMessage(s).setLevel("error").end(),this.getOEmitInst().emit(e.ERROR,t)}restartTimer(){Ce.l(this._n+".restartTimer"),this.stopTimer(),this._startTimer();const e=this.get(Is);e&&e.restartPolling()}getTimerID(){const e=this._map.get(Us);return e.isWorkerEnabled()?e.getTimerID():this._checkTimer}getPollingTimerID(e){return this._map.get(Is).getPollingTimerID(e)}reset(){Ce.l(this._n+".reset"),ge();for(const[,e]of this._map)e.reset&&e.reset();this._startLoginTs=0,this._initReadyList(),this._isReady=!1,this.stopTimer(),this._oEmitter.emit(e.SDK_NOT_READY);for(const[,e]of this._eventThrottleMap)e.timeoutID&&clearTimeout(e.timeoutID);this._eventThrottleMap.clear()}}class Tr{constructor(e){this._funcMap=new Map,this._m=e,this._n="SafetyCallback",this._reportCount=0}defense(e,t,s){if("string"!=typeof e)return null;if(0===e.length)return null;if("function"!=typeof t)return null;if(this._funcMap.has(e)&&this._funcMap.get(e).has(t))return this._funcMap.get(e).get(t);this._funcMap.has(e)||this._funcMap.set(e,new Map);let i=null;return this._funcMap.get(e).has(t)?i=this._funcMap.get(e).get(t):(i=this._pack(e,t,s),this._funcMap.get(e).set(t,i)),i}defenseOnce(e,t,s){return"function"!=typeof t?null:this._pack(e,t,s)}find(e,t){return"string"!=typeof e||0===e.length||"function"!=typeof t?null:this._funcMap.has(e)&&this._funcMap.get(e).has(t)?this._funcMap.get(e).get(t):(this._m.warn("ListenerFnNotFound",e),null)}delete(e,t){return"function"==typeof t&&!!this._funcMap.has(e)&&!!this._funcMap.get(e).has(t)&&(this._funcMap.get(e).delete(t),0===this._funcMap.get(e).size&&this._funcMap.delete(e),!0)}_pack(s,i,o){const n=this;return function(){try{i.apply(o,Array.from(arguments))}catch(t){const i=Object.values(e).indexOf(s),o="CallbackError";if(-1!==i){const s=Object.keys(e)[i];n._m.warn(o,s,t)}n._reportCount<5&&(new mi(o).setMessage("eventName:"+s).setMoreMessage(t.message).end(),n._reportCount+=1)}}}destroy(){this._funcMap.clear()}reset(){Ce.l(this._n+".reset"),this._reportCount=0}}class yr{constructor(e){e={SDKAppID:e.SDKAppID,unlimitedAVChatRoom:e.unlimitedAVChatRoom||!1,scene:e.scene||"",oversea:e.oversea||!1,instanceID:dt(),devMode:e.devMode||!1,testEnv:e.testEnv||!1,proxyServer:e.proxyServer||void 0,fileUploadProxy:e.fileUploadProxy||void 0,fileDownloadProxy:e.fileDownloadProxy||e.fileUploadProxy||void 0,eventThrottling:!1!==e.eventThrottling,partialUpdatedConversations:!0===e.partialUpdatedConversations,modules:e.modules||void 0};this._m=new Cr(e),this._safetyCallbackFactory=new Tr(this._m)}onError(e){this._m.onError(e)}login(e){return this._m.login(),this._get(ps).login(e)}logout(){return this._get(ps).logout().then(e=>(this._safetyCallbackFactory.reset(),this._m.reset(),e))}getLoginUser(){return this._get(ps).getLoginUser()}getServerTime(){return pe()}isReady(){return this._m.isReady()}isIntl(){return this._m.isIntl()}getNotReadyReason(){return this._m.getNotReadyReason()}getErrMsg(e,t,s){return this._m.getErrMsg(e,t,s)}_get(e){return this._m.get(e)}destroy(){const t=this._get(vs),s=t.getSDKAppID();return Ce.w(`destroy ${s} `+t.getInstanceID()),this.logout().finally(()=>{this._safetyCallbackFactory.destroy(),this._m.stopTimer(),this._get(Us).terminate(),this._get(Ns).dealloc(),this._m.getOEmitInst().emit(e.SDK_DESTROY,{SDKAppID:s})})}on(e,t,s){Ce.d("on","eventName:"+e),this._m.getOEmitInst().on(e,this._safetyCallbackFactory.defense(e,t,s),s)}once(e,t,s){Ce.d("once","eventName:"+e),this._m.getOEmitInst().once(e,this._safetyCallbackFactory.defenseOnce(e,t,s),s||this)}off(e,t,s,i){Ce.d("off","eventName:"+e);var o=this._safetyCallbackFactory.find(e,t);null!==o&&(this._m.getOEmitInst().off(e,o,s,i),this._safetyCallbackFactory.delete(e,t))}registerPlugin(e){($e(e["tim-push"])?$e(e["tim-offline-push-plugin"])?this._get(Ls):this._get(Fs):this._get(Hs)).registerPlugin(e)}setLogLevel(e){if(e<=0){const e=this.getErrMsg("TIM_ASCII_ART");e&&console.log(e);var t=this.getErrMsg("API_REFER");if(t){const e="IM SDK API ->";vt()?console.log(`%c ${e} %c`,"background:#ff9d00; padding:1px; border-radius:3px; color: #fff","background:transparent",t):console.log(e,t)}t=this.getErrMsg("DOCS_GUIDE"),t=(t&&console.log(t),this.getErrMsg("IOS_WEBVIEW_WARNING"));re&&t&&console.warn(t)}Ce.setLevel(e)}createTextMessage(e){return this._get(gs).createTextMessage(e)}createTextAtMessage(e){return this._get(gs).createTextMessage(e)}createImageMessage(e){return this._get(gs).createImageMessage(e)}createAudioMessage(e){return this._get(gs).createAudioMessage(e)}createVideoMessage(e){return this._get(gs).createVideoMessage(e)}createCustomMessage(e){return this._get(gs).createCustomMessage(e)}createFaceMessage(e){return this._get(gs).createFaceMessage(e)}createFileMessage(e){return this._get(gs).createFileMessage(e)}createLocationMessage(e){return this._get(gs).createLocationMessage(e)}createMergerMessage(e){return this._get(gs).createMergerMessage(e)}downloadMergerMessage(e){return e.type!==t.MSG_MERGER?Qs({code:js.MSG_MERGER_TYPE_INVALID}):Oe(e.payload.downloadKey)?Qs({code:js.MSG_MERGER_KEY_INVALID}):this._get(gs).downloadMergerMessage(e).catch(e=>Qs({code:js.MSG_MERGER_DOWNLOAD_FAIL}))}createForwardMessage(e){return this._get(gs).createForwardMessage(e)}sendMessage(e,t){return e instanceof wi?this._get(gs).sendMessageInstance(e,t):Qs({code:js.MSG_INSTANCE_REQUIRED})}searchCloudMessages(e){return this._get(gs).searchCloudMessages(e)}callExperimentalAPI(e,t){return"sendComboMessage"===e?this._get(qs).sendMessage(t):"handleGroupInvitation"===e?this._get(Is).handleGroupInvitation(t):"isCommercialAbilityEnabled"===e?this._get(ws).isFeatureEnabled(t):"isFeatureEnabledForStat"===e?this._get(ws).isFeatureEnabledForStat(t):"isIntl"===e?this.isIntl():"sendTRTCCustomData"===e||"sendRoomCustomData"===e?this._get($s).sendTRTCCustomData(t):"getTimerID"===e?this._m.getTimerID():"getPollingTimerID"===e?this._m.getPollingTimerID(t):"setApplicationID"!==e?"getServerConfig"===e?this._get(Ps).getServerConfig(t):"canIUseModule"===e?this._m.canIUseModule(t):"startMessageLongPolling"===e?this._get(Is).startMessageLongPolling(t):"stopMessageLongPolling"===e?this._get(Is).stopMessageLongPolling(t):"disableMessagePullOnInvite"===e?this._get(ys).disableMsgPullOnInvite(t):"clearLocalMessage"===e?this._get(ys).clearMemMsg(t,!1):"setCustomLoginInfo"===e?this._get(vs).setCustomLoginInfo(t):Qs({code:js.INVALID_OPERATION}):(this._get(vs).setApplicationID(t),void this._get(Os).updateProtocolConfig())}revokeMessage(e){return this._get(gs).revokeMessage(e)}resendMessage(e,t){return e instanceof wi?this._get(gs).resendMessage(e,t):Qs({code:js.MSG_INSTANCE_REQUIRED})}deleteMessage(e){return this._get(gs).deleteMessage(e)}translateText(e){return this._get(gs).translateText(e)}convertVoiceToText(e){return this._get(gs).convertVoiceToText(e)}setMessageExtensions(e,t){return this._get(ms).setMessageExtensions(e,t)}getMessageExtensions(e){return this._get(ms).getMessageExtensions(e)}deleteMessageExtensions(e,t){return this._get(ms).deleteMessageExtensions(e,t)}addMessageReaction(e,t){return this._get(Bs).addMessageReaction(e,t)}removeMessageReaction(e,t){return this._get(Bs).removeMessageReaction(e,t)}getMessageReactions(e){return this._get(Bs).getMessageReactions(e)}getAllUserListOfMessageReaction(e){return this._get(Bs).getAllUserListOfMessageReaction(e)}modifyMessage(e){return this._get(gs).modifyRemoteMessage(e)}getMessageList(e){return this._get(ys).getMessageList(e)}getMessageListHopping(e){return this._get(ys).getMessageListHopping(e)}sendMessageReadReceipt(e){return this._get(ys).sendReadReceipt(e)}getMessageReadReceiptList(e){return this._get(ys).getReadReceiptList(e)}getGroupMessageReadMemberList(e){const t=this._get(Is);return t?t.getReadReceiptDetail(e):Qs({code:js.NO_MODULE})}findMessage(e){return this._get(ys).findMessage(e)}setMessageRead(e){return this._get(ys).setMessageRead(e)}getConversationList(e){return this._get(ys).getConvList(e)}getConversationProfile(e){return this._get(ys).getConversationProfile(e)}deleteConversation(e){return this._get(ys).deleteConversation(e)}setConversationDraft(e){return this._get(ys).setConvDraft(e)}clearHistoryMessage(e){return this._get(ys).clearHistoryMessage(e)}pinConversation(e){return this._get(ys).pinConversation(e)}setAllMessageRead(e){return this._get(ys).setAllMessageRead(e)}setMessageRemindType(e){return this._get(ys).setMessageRemindType(e)}setAllReceiveMessageOpt(e){return this._get(ys).setAllRcvMsgOpt(e)}getAllReceiveMessageOpt(){return this._get(ys).getAllRcvMsgOpt()}getTotalUnreadMessageCount(){return this._get(ys).getTotalUnreadCount()}setConversationCustomData(e){return this._get(ys).setConvCustomData(e)}markConversation(e){return this._get(ys).markConv(e)}getConversationGroupList(){return this._get(ys).getConvGroupList()}createConversationGroup(e){return this._get(ys).createConvGroup(e)}deleteConversationGroup(e){return this._get(ys).deleteConvGroup(e)}renameConversationGroup(e){return this._get(ys).renameConvGroup(e)}addConversationsToGroup(e){return this._get(ys).addConvsToGroup(e)}deleteConversationsFromGroup(e){return this._get(ys).deleteConvsFromGroup(e)}getMyProfile(){return this._get(fs).getMyProfile()}getUserProfile(e){return this._get(fs).getUserProfile(e)}updateMyProfile(e){return this._get(fs).updateMyProfile(e)}getBlacklist(){return this._get(fs).getLocalBlacklist()}addToBlacklist(e){return this._get(fs).addBlacklist(e)}removeFromBlacklist(e){return this._get(fs).deleteBlacklist(e)}setSelfStatus(e){return this._get(fs).setSelfStatus(e)}getUserStatus(e){return this._get(fs).getUserStatus(e)}subscribeUserStatus(e){return this._get(fs).subscribeUserStatus(e)}unsubscribeUserStatus(e){return this._get(fs).unsubscribeUserStatus(e)}getFriendList(){const e=this._get(Cs);return e?e.getLocalFriendList():Qs({code:js.NO_MODULE})}addFriend(e){const t=this._get(Cs);return t?t.addFriend(e):Qs({code:js.NO_MODULE})}deleteFriend(e){const t=this._get(Cs);return t?t.deleteFriend(e):Qs({code:js.NO_MODULE})}checkFriend(e){const t=this._get(Cs);return t?t.checkFriend(e):Qs({code:js.NO_MODULE})}getFriendProfile(e){const t=this._get(Cs);return t?t.getFriendProfile(e):Qs({code:js.NO_MODULE})}updateFriend(e){const t=this._get(Cs);return t?t.updateFriend(e):Qs({code:js.NO_MODULE})}getFriendApplicationList(){const e=this._get(Cs);return e?e.getLocalFriendApplicationList():Qs({code:js.NO_MODULE})}acceptFriendApplication(e){const t=this._get(Cs);return t?t.acceptFriendApplication(e):Qs({code:js.NO_MODULE})}refuseFriendApplication(e){const t=this._get(Cs);return t?t.refuseFriendApplication(e):Qs({code:js.NO_MODULE})}deleteFriendApplication(e){const t=this._get(Cs);return t?t.deleteFriendApplication(e):Qs({code:js.NO_MODULE})}setFriendApplicationRead(){const e=this._get(Cs);return e?e.setFriendApplicationRead():Qs({code:js.NO_MODULE})}getFriendGroupList(){const e=this._get(Cs);return e?e.getLocalFriendGroupList():Qs({code:js.NO_MODULE})}createFriendGroup(e){const t=this._get(Cs);return t?t.createFriendGroup(e):Qs({code:js.NO_MODULE})}deleteFriendGroup(e){const t=this._get(Cs);return t?t.deleteFriendGroup(e):Qs({code:js.NO_MODULE})}addToFriendGroup(e){const t=this._get(Cs);return t?t.addToFriendGroup(e):Qs({code:js.NO_MODULE})}removeFromFriendGroup(e){const t=this._get(Cs);return t?t.removeFromFriendGroup(e):Qs({code:js.NO_MODULE})}renameFriendGroup(e){const t=this._get(Cs);return t?t.renameFriendGroup(e):Qs({code:js.NO_MODULE})}followUser(e){const t=this._get(Ks);return t?t.followUser(e):Qs({code:js.NO_MODULE})}unfollowUser(e){const t=this._get(Ks);return t?t.unfollowUser(e):Qs({code:js.NO_MODULE})}getMyFollowersList(e){const t=this._get(Ks);return t?t.getMyFollowersList(e):Qs({code:js.NO_MODULE})}getMyFollowingList(e){const t=this._get(Ks);return t?t.getMyFollowingList(e):Qs({code:js.NO_MODULE})}getMutualFollowersList(e){const t=this._get(Ks);return t?t.getMutualFollowersList(e):Qs({code:js.NO_MODULE})}getUserFollowInfo(e){const t=this._get(Ks);return t?t.getUserFollowInfo(e):Qs({code:js.NO_MODULE})}checkFollowType(e){const t=this._get(Ks);return t?t.checkFollowType(e):Qs({code:js.NO_MODULE})}getGroupList(){const e=this._get(Is);return e?e.getGroupList():Qs({code:js.NO_MODULE})}getGroupProfile(e){const t=this._get(Is);return t?t.getGroupProfile(e):Qs({code:js.NO_MODULE})}createGroup(e){const t=this._get(Is);return t?t.createGroup(e):Qs({code:js.NO_MODULE})}dismissGroup(e){const t=this._get(Is);return t?t.dismissGroup(e):Qs({code:js.NO_MODULE})}updateGroupProfile(e){const t=this._get(Is);return t?t.updateGroupProfile(e):Qs({code:js.NO_MODULE})}joinGroup(e){const t=this._get(Is);return t?t.joinGroup(e):Qs({code:js.NO_MODULE})}quitGroup(e){const t=this._get(Is);return t?t.quitGroup(e):Qs({code:js.NO_MODULE})}searchGroupByID(e){const t=this._get(Is);return t?t.searchGroupByID(e):Qs({code:js.NO_MODULE})}getGroupOnlineMemberCount(e){const t=this._get(Is);return t?t.getGroupOnlineMemberCount(e):Qs({code:js.NO_MODULE})}changeGroupOwner(e){const t=this._get(Is);return t?t.changeGroupOwner(e):Qs({code:js.NO_MODULE})}getGroupApplicationList(){const e=this._get(Is);return e?e.getGroupApplicationList():Qs({code:js.NO_MODULE})}handleGroupApplication(e){const t=this._get(Is);return t?t.handleGroupApplication(e):Qs({code:js.NO_MODULE})}initGroupAttributes(e){const t=this._get(Is);return t?t.initGroupAttributes(e):Qs({code:js.NO_MODULE})}setGroupAttributes(e){const t=this._get(Is);return t?t.setGroupAttributes(e):Qs({code:js.NO_MODULE})}deleteGroupAttributes(e){const t=this._get(Is);return t?t.deleteGroupAttributes(e):Qs({code:js.NO_MODULE})}getGroupAttributes(e){const t=this._get(Is);return t?t.getGroupAttributes(e):Qs({code:js.NO_MODULE})}setGroupCounters(e){const t=this._get(Is);return t?t.setGroupCounters(e):Qs({code:js.NO_MODULE})}increaseGroupCounter(e){const t=this._get(Is);return t?t.increaseGroupCounter(e):Qs({code:js.NO_MODULE})}decreaseGroupCounter(e){const t=this._get(Is);return t?t.decreaseGroupCounter(e):Qs({code:js.NO_MODULE})}getGroupCounters(e){const t=this._get(Is);return t?t.getGroupCounters(e):Qs({code:js.NO_MODULE})}getGroupMemberList(e){const t=this._get(Is);return t?t.getGroupMemberList(e):Qs({code:js.NO_MODULE})}getGroupMemberProfile(e){const t=this._get(Is);return t?t.getGroupMemberProfile(e):Qs({code:js.NO_MODULE})}addGroupMember(e){const t=this._get(Is);return t?t.addGroupMember(e):Qs({code:js.NO_MODULE})}deleteGroupMember(e){const t=this._get(Is);return t?t.deleteGroupMember(e):Qs({code:js.NO_MODULE})}setGroupMemberMuteTime(e){const t=this._get(Is);return t?t.setGroupMemberMuteTime(e):Qs({code:js.NO_MODULE})}setGroupMemberRole(e){const t=this._get(Is);return t?t.setGroupMemberRole(e):Qs({code:js.NO_MODULE})}setGroupMemberNameCard(e){const t=this._get(Is);return t?t.setGroupMemberNameCard(e):Qs({code:js.NO_MODULE})}setGroupMemberCustomField(e){const t=this._get(Is);return t?t.setGroupMemberCustomField(e):Qs({code:js.NO_MODULE})}markGroupMemberList(e){const t=this._get(Is);return t?t.markGroupMemberList(e):Qs({code:js.NO_MODULE})}getJoinedCommunityList(){return this._get(Ts).getJoinedCommunityList()}createTopicInCommunity(e){return this._get(Ts).createTopicInCommunity(e)}deleteTopicFromCommunity(e){return this._get(Ts).deleteTopicFromCommunity(e)}updateTopicProfile(e){return this._get(Ts).updateTopicProfile(e)}getTopicList(e){return this._get(Ts).getTopicList(e)}addSignalingListener(e,t,s){const i=this._get(Vs);i&&i.addSignalingListener(e,this._safetyCallbackFactory.defense(e,t,s),s)}removeSignalingListener(e,t,s){var i=this._safetyCallbackFactory.find(e,t);if(null!==i){const o=this._get(Vs);o&&(o.removeSignalingListener(e,i,s),this._safetyCallbackFactory.delete(e,t))}}invite(e){const t=this._get(Vs);return t?t.invite(e):Qs({code:js.NO_MODULE})}inviteSync(e,t,s){const i=this._get(Vs);return i?i.inviteSync(e,t,s):""}inviteInGroup(e){const t=this._get(Vs);return t?t.invite(e):Qs({code:js.NO_MODULE})}inviteInGroupSync(e,t,s){const i=this._get(Vs);return i?i.inviteSync(e,t,s):""}cancel(e){const t=this._get(Vs);return t?t.cancel(e):Qs({code:js.NO_MODULE})}accept(e){const t=this._get(Vs);return t?t.accept(e):Qs({code:js.NO_MODULE})}reject(e){const t=this._get(Vs);return t?t.reject(e):Qs({code:js.NO_MODULE})}getSignalingInfo(e){const t=this._get(Vs);return t?t.getSignalingInfo(e):null}modifyInvitation(e){const t=this._get(Vs);return t?t.modifyInvitation(e):Qs({code:js.NO_MODULE})}}const vr={login:1,logout:1,getLoginUser:1,destroy:1,on:1,off:1,ready:1,setLogLevel:1,joinGroup:1,quitGroup:1,registerPlugin:1,getGroupOnlineMemberCount:1,isReady:1,addSignalingListener:1,removeSignalingListener:1,callExperimentalAPI:1};function Er(e,t){if(e.isReady()||1===vr[t])return!0;var s=e.getNotReadyReason(),s={code:s,message:e.getErrMsg(s)+` | ${t} | `+e.getErrMsg(js.SDK_IS_NOT_READY)};return e.onError(s),s}const Sr={},Dr={create:function(t){var i="TencentCloudChat.create";let o=0;var n=t["SDKAppID"];if(Ge(n))o=n;else if(o=parseInt(n),isNaN(n))return Ce.e(i+" failed. Failed to parse the SDKAppID, please check the arguments"),null;if(o&&Sr[o])return Sr[o];Ce.l(i);const r=new yr({...t,SDKAppID:o});r.on(e.SDK_DESTROY,e=>{Sr[e.data.SDKAppID]=null,delete Sr[e.data.SDKAppID]});n=function(o){const e=Object.create(null);return Object.keys(hs).forEach(i=>{if(o[i]){const t=new s;e[i]=function(){var e=Array.from(arguments);return t.use(function(e,t){var s=Er(o,i);return!0===s?t():Qs(s)}).use(function(e,t){if(!0===Rt(e,_s[i],i))return t()}).use(function(e,t){return o[i].apply(o,e)}),t.run(e)}}}),e}(r);return Sr[o]=n,_s.hookGetAPITips(r.getErrMsg.bind(r)),Ce.l(i+" ok"),n}};Dr.TYPES=t,Dr.EVENT=e,Dr.TSignaling={NEW_INVITATION_RECEIVED:"newInvitationReceived",INVITEE_ACCEPTED:"ts_invitee_accepted",INVITEE_REJECTED:"ts_invitee_rejected",INVITATION_CANCELLED:"ts_invitation_cancelled",INVITATION_TIMEOUT:"ts_invitation_timeout",INVITATION_MODIFIED:"ts_invitation_modified",ACTION_TYPE_UNKNOWN:0,ACTION_TYPE_INVITE:1,ACTION_TYPE_CANCEL_INVITE:2,ACTION_TYPE_ACCEPT_INVITE:3,ACTION_TYPE_REJECT_INVITE:4,ACTION_TYPE_INVITE_TIMEOUT:5},Dr.VERSION="3.4.8",Ce.l("TencentCloudChat.VERSION:"+Dr.VERSION);export{Dr as default};